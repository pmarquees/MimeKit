{
  "id": "run_1770388575060_22ld8l",
  "createdAt": "2026-02-06T14:40:07.617Z",
  "snapshot": {
    "version": "1.0.0",
    "repo": {
      "url": "https://github.com/hrescak/Draftboard",
      "owner": "hrescak",
      "name": "Draftboard",
      "branch": "main",
      "defaultBranch": "main",
      "sizeKb": 18940,
      "stars": 3,
      "openIssues": 6,
      "description": "Draftboard is a way to share designs in a company internally",
      "language": "TypeScript"
    },
    "metadata": {
      "scanMode": "deep",
      "fetchedAt": "2026-02-06T14:36:16.407Z",
      "totalFiles": 173,
      "selectedFiles": 38,
      "skippedBinaryFiles": 0,
      "skippedScriptFiles": 0,
      "tokenEstimate": 82273
    },
    "languages": [
      {
        "name": "TypeScript",
        "bytes": 596708,
        "share": 0.9907
      },
      {
        "name": "CSS",
        "bytes": 3150,
        "share": 0.0052
      },
      {
        "name": "MDX",
        "bytes": 2381,
        "share": 0.004
      },
      {
        "name": "JavaScript",
        "bytes": 70,
        "share": 0.0001
      }
    ],
    "fileTree": [
      {
        "path": ".DS_Store",
        "type": "blob",
        "size": 8196
      },
      {
        "path": ".env.example",
        "type": "blob",
        "size": 2065
      },
      {
        "path": ".gitignore",
        "type": "blob",
        "size": 132
      },
      {
        "path": ".storybook",
        "type": "tree"
      },
      {
        "path": ".storybook/main.ts",
        "type": "blob",
        "size": 831
      },
      {
        "path": ".storybook/preview.ts",
        "type": "blob",
        "size": 1429
      },
      {
        "path": ".storybook/preview.tsx",
        "type": "blob",
        "size": 784
      },
      {
        "path": ".storybook/vitest.setup.ts",
        "type": "blob",
        "size": 454
      },
      {
        "path": "AGENTS.MD",
        "type": "blob",
        "size": 3895
      },
      {
        "path": "CONTRIBUTING.md",
        "type": "blob",
        "size": 6672
      },
      {
        "path": "README.md",
        "type": "blob",
        "size": 5065
      },
      {
        "path": "debug-storybook.log",
        "type": "blob",
        "size": 1602
      },
      {
        "path": "docs",
        "type": "tree"
      },
      {
        "path": "docs/Deployment-vercel.md",
        "type": "blob",
        "size": 6871
      },
      {
        "path": "next-env.d.ts",
        "type": "blob",
        "size": 262
      },
      {
        "path": "next.config.ts",
        "type": "blob",
        "size": 219
      },
      {
        "path": "package.json",
        "type": "blob",
        "size": 3044
      },
      {
        "path": "postcss.config.js",
        "type": "blob",
        "size": 70
      },
      {
        "path": "prisma",
        "type": "tree"
      },
      {
        "path": "prisma/migrations",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260124010846_initial",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260124010846_initial/migration.sql",
        "type": "blob",
        "size": 8582
      },
      {
        "path": "prisma/migrations/20260131014429_add_site_settings",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260131014429_add_site_settings/migration.sql",
        "type": "blob",
        "size": 434
      },
      {
        "path": "prisma/migrations/20260131022334_add_draft_model",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260131022334_add_draft_model/migration.sql",
        "type": "blob",
        "size": 666
      },
      {
        "path": "prisma/migrations/20260201184236_add_webhook_urls",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260201184236_add_webhook_urls/migration.sql",
        "type": "blob",
        "size": 121
      },
      {
        "path": "prisma/migrations/20260203015319_add_user_deactivated",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260203015319_add_user_deactivated/migration.sql",
        "type": "blob",
        "size": 94
      },
      {
        "path": "prisma/migrations/20260204023201_add_hide_from_home",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260204023201_add_hide_from_home/migration.sql",
        "type": "blob",
        "size": 95
      },
      {
        "path": "prisma/migrations/20260204153038_add_password_reset_token",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260204153038_add_password_reset_token/migration.sql",
        "type": "blob",
        "size": 577
      },
      {
        "path": "prisma/migrations/20260205125002_add_mention_notification_type",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260205125002_add_mention_notification_type/migration.sql",
        "type": "blob",
        "size": 64
      },
      {
        "path": "prisma/migrations/migration_lock.toml",
        "type": "blob",
        "size": 128
      },
      {
        "path": "prisma/schema.prisma",
        "type": "blob",
        "size": 6722
      },
      {
        "path": "prisma.config.ts",
        "type": "blob",
        "size": 380
      },
      {
        "path": "public",
        "type": "tree"
      },
      {
        "path": "public/OG.png",
        "type": "blob",
        "size": 447996
      },
      {
        "path": "public/OG_invite.png",
        "type": "blob",
        "size": 476400
      },
      {
        "path": "public/avatar.png",
        "type": "blob",
        "size": 8655
      },
      {
        "path": "public/favicon.svg",
        "type": "blob",
        "size": 779
      },
      {
        "path": "public/icon-192.png",
        "type": "blob",
        "size": 22828
      },
      {
        "path": "public/icon-512.png",
        "type": "blob",
        "size": 108321
      },
      {
        "path": "public/logo.svg",
        "type": "blob",
        "size": 676
      },
      {
        "path": "public/manifest.json",
        "type": "blob",
        "size": 503
      },
      {
        "path": "src",
        "type": "tree"
      },
      {
        "path": "src/app",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/deactivated",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/deactivated/page.tsx",
        "type": "blob",
        "size": 570
      },
      {
        "path": "src/app/(auth)/invite",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/invite/[token]",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/invite/[token]/actions.ts",
        "type": "blob",
        "size": 344
      },
      {
        "path": "src/app/(auth)/invite/[token]/invite-processor.tsx",
        "type": "blob",
        "size": 594
      },
      {
        "path": "src/app/(auth)/invite/[token]/page.tsx",
        "type": "blob",
        "size": 1069
      },
      {
        "path": "src/app/(auth)/layout.tsx",
        "type": "blob",
        "size": 489
      },
      {
        "path": "src/app/(auth)/reset-password",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/reset-password/[token]",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/reset-password/[token]/page.tsx",
        "type": "blob",
        "size": 6189
      },
      {
        "path": "src/app/(auth)/sign-in",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/sign-in/page.tsx",
        "type": "blob",
        "size": 4010
      },
      {
        "path": "src/app/(auth)/sign-up",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/sign-up/page.tsx",
        "type": "blob",
        "size": 1042
      },
      {
        "path": "src/app/(auth)/sign-up/sign-up-form.tsx",
        "type": "blob",
        "size": 5490
      },
      {
        "path": "src/app/(main)",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/admin",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/admin/admin-nav.tsx",
        "type": "blob",
        "size": 1237
      },
      {
        "path": "src/app/(main)/admin/layout.tsx",
        "type": "blob",
        "size": 615
      },
      {
        "path": "src/app/(main)/admin/settings",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/admin/settings/page.tsx",
        "type": "blob",
        "size": 17812
      },
      {
        "path": "src/app/(main)/admin/users",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/admin/users/page.tsx",
        "type": "blob",
        "size": 8956
      },
      {
        "path": "src/app/(main)/compose",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/compose/page.tsx",
        "type": "blob",
        "size": 8610
      },
      {
        "path": "src/app/(main)/layout.tsx",
        "type": "blob",
        "size": 805
      },
      {
        "path": "src/app/(main)/notifications",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/notifications/page.tsx",
        "type": "blob",
        "size": 6017
      },
      {
        "path": "src/app/(main)/page.tsx",
        "type": "blob",
        "size": 335
      },
      {
        "path": "src/app/(main)/post",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/post/[id]",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/post/[id]/edit",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/post/[id]/edit/page.tsx",
        "type": "blob",
        "size": 3518
      },
      {
        "path": "src/app/(main)/post/[id]/page.tsx",
        "type": "blob",
        "size": 1224
      },
      {
        "path": "src/app/(main)/projects",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/projects/[id]",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/projects/[id]/edit",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/projects/[id]/edit/page.tsx",
        "type": "blob",
        "size": 9781
      },
      {
        "path": "src/app/(main)/projects/[id]/page.tsx",
        "type": "blob",
        "size": 487
      },
      {
        "path": "src/app/(main)/projects/new",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/projects/new/page.tsx",
        "type": "blob",
        "size": 6299
      },
      {
        "path": "src/app/(main)/projects/page.tsx",
        "type": "blob",
        "size": 5798
      },
      {
        "path": "src/app/(main)/settings",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/settings/page.tsx",
        "type": "blob",
        "size": 4899
      },
      {
        "path": "src/app/(main)/user",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/user/[id]",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/user/[id]/page.tsx",
        "type": "blob",
        "size": 453
      },
      {
        "path": "src/app/api",
        "type": "tree"
      },
      {
        "path": "src/app/api/auth",
        "type": "tree"
      },
      {
        "path": "src/app/api/auth/[...nextauth]",
        "type": "tree"
      },
      {
        "path": "src/app/api/auth/[...nextauth]/route.ts",
        "type": "blob",
        "size": 82
      },
      {
        "path": "src/app/api/trpc",
        "type": "tree"
      },
      {
        "path": "src/app/api/trpc/[trpc]",
        "type": "tree"
      },
      {
        "path": "src/app/api/trpc/[trpc]/route.ts",
        "type": "blob",
        "size": 703
      },
      {
        "path": "src/app/globals.css",
        "type": "blob",
        "size": 3150
      },
      {
        "path": "src/app/layout.tsx",
        "type": "blob",
        "size": 2044
      },
      {
        "path": "src/components",
        "type": "tree"
      },
      {
        "path": "src/components/comments",
        "type": "tree"
      },
      {
        "path": "src/components/comments/CommentComposer.tsx",
        "type": "blob",
        "size": 4180
      },
      {
        "path": "src/components/comments/CommentSection.tsx",
        "type": "blob",
        "size": 1178
      },
      {
        "path": "src/components/comments/CommentThread.tsx",
        "type": "blob",
        "size": 6296
      },
      {
        "path": "src/components/editor",
        "type": "tree"
      },
      {
        "path": "src/components/editor/Editor.tsx",
        "type": "blob",
        "size": 6689
      },
      {
        "path": "src/components/editor/SimpleMarkdownEditor.tsx",
        "type": "blob",
        "size": 7742
      },
      {
        "path": "src/components/editor/nodes",
        "type": "tree"
      },
      {
        "path": "src/components/editor/nodes/AttachmentNode.tsx",
        "type": "blob",
        "size": 16733
      },
      {
        "path": "src/components/editor/nodes/EmojiNode.tsx",
        "type": "blob",
        "size": 3564
      },
      {
        "path": "src/components/editor/nodes/ImageNode.tsx",
        "type": "blob",
        "size": 5313
      },
      {
        "path": "src/components/editor/nodes/MentionNode.test.ts",
        "type": "blob",
        "size": 831
      },
      {
        "path": "src/components/editor/nodes/MentionNode.tsx",
        "type": "blob",
        "size": 5062
      },
      {
        "path": "src/components/editor/plugins",
        "type": "tree"
      },
      {
        "path": "src/components/editor/plugins/DragDropPlugin.tsx",
        "type": "blob",
        "size": 2632
      },
      {
        "path": "src/components/editor/plugins/EmojiPlugin.tsx",
        "type": "blob",
        "size": 4784
      },
      {
        "path": "src/components/editor/plugins/FloatingAddButtonPlugin.tsx",
        "type": "blob",
        "size": 10469
      },
      {
        "path": "src/components/editor/plugins/KeyboardShortcutsPlugin.tsx",
        "type": "blob",
        "size": 2315
      },
      {
        "path": "src/components/editor/plugins/LinkClickPlugin.tsx",
        "type": "blob",
        "size": 994
      },
      {
        "path": "src/components/editor/plugins/MentionPlugin.tsx",
        "type": "blob",
        "size": 5861
      },
      {
        "path": "src/components/editor/plugins/NodeDeletionPlugin.tsx",
        "type": "blob",
        "size": 1284
      },
      {
        "path": "src/components/editor/plugins/PasteFilePlugin.tsx",
        "type": "blob",
        "size": 3395
      },
      {
        "path": "src/components/editor/plugins/PasteLinkPlugin.tsx",
        "type": "blob",
        "size": 1799
      },
      {
        "path": "src/components/editor/plugins/SlashCommandPlugin.tsx",
        "type": "blob",
        "size": 13392
      },
      {
        "path": "src/components/editor/toolbar",
        "type": "tree"
      },
      {
        "path": "src/components/editor/toolbar/ToolbarPlugin.tsx",
        "type": "blob",
        "size": 7312
      },
      {
        "path": "src/components/feed",
        "type": "tree"
      },
      {
        "path": "src/components/feed/AttachmentCarousel.tsx",
        "type": "blob",
        "size": 6917
      },
      {
        "path": "src/components/feed/FeedSkeleton.tsx",
        "type": "blob",
        "size": 1531
      },
      {
        "path": "src/components/feed/FeedView.tsx",
        "type": "blob",
        "size": 3770
      },
      {
        "path": "src/components/feed/GridView.tsx",
        "type": "blob",
        "size": 4041
      },
      {
        "path": "src/components/feed/PostCard.test.tsx",
        "type": "blob",
        "size": 3982
      },
      {
        "path": "src/components/feed/PostCard.tsx",
        "type": "blob",
        "size": 6923
      },
      {
        "path": "src/components/layout",
        "type": "tree"
      },
      {
        "path": "src/components/layout/main-nav.tsx",
        "type": "blob",
        "size": 18895
      },
      {
        "path": "src/components/post",
        "type": "tree"
      },
      {
        "path": "src/components/post/PostDetail.tsx",
        "type": "blob",
        "size": 8582
      },
      {
        "path": "src/components/post/PostEditor.tsx",
        "type": "blob",
        "size": 10961
      },
      {
        "path": "src/components/projects",
        "type": "tree"
      },
      {
        "path": "src/components/projects/CoverUpload.tsx",
        "type": "blob",
        "size": 5683
      },
      {
        "path": "src/components/projects/ProjectDetail.tsx",
        "type": "blob",
        "size": 10897
      },
      {
        "path": "src/components/reactions",
        "type": "tree"
      },
      {
        "path": "src/components/reactions/ReactionButton.tsx",
        "type": "blob",
        "size": 11733
      },
      {
        "path": "src/components/reactions/ReactionsDialog.tsx",
        "type": "blob",
        "size": 5011
      },
      {
        "path": "src/components/search",
        "type": "tree"
      },
      {
        "path": "src/components/search/SearchCommand.tsx",
        "type": "blob",
        "size": 8488
      },
      {
        "path": "src/components/settings",
        "type": "tree"
      },
      {
        "path": "src/components/settings/AvatarUpload.tsx",
        "type": "blob",
        "size": 3818
      },
      {
        "path": "src/components/settings/EmojiUpload.tsx",
        "type": "blob",
        "size": 6161
      },
      {
        "path": "src/components/theme-provider.tsx",
        "type": "blob",
        "size": 299
      },
      {
        "path": "src/components/ui",
        "type": "tree"
      },
      {
        "path": "src/components/ui/Avatar.stories.tsx",
        "type": "blob",
        "size": 5822
      },
      {
        "path": "src/components/ui/Badge.stories.tsx",
        "type": "blob",
        "size": 2839
      },
      {
        "path": "src/components/ui/Button.stories.tsx",
        "type": "blob",
        "size": 4885
      },
      {
        "path": "src/components/ui/Card.stories.tsx",
        "type": "blob",
        "size": 5486
      },
      {
        "path": "src/components/ui/Command.stories.tsx",
        "type": "blob",
        "size": 9845
      },
      {
        "path": "src/components/ui/DesignTokens.stories.tsx",
        "type": "blob",
        "size": 13964
      },
      {
        "path": "src/components/ui/Dialog.stories.tsx",
        "type": "blob",
        "size": 6817
      },
      {
        "path": "src/components/ui/DropdownMenu.stories.tsx",
        "type": "blob",
        "size": 8258
      },
      {
        "path": "src/components/ui/Input.stories.tsx",
        "type": "blob",
        "size": 4755
      },
      {
        "path": "src/components/ui/Introduction.mdx",
        "type": "blob",
        "size": 2381
      },
      {
        "path": "src/components/ui/Label.stories.tsx",
        "type": "blob",
        "size": 3197
      },
      {
        "path": "src/components/ui/Logo.stories.tsx",
        "type": "blob",
        "size": 2653
      },
      {
        "path": "src/components/ui/Popover.stories.tsx",
        "type": "blob",
        "size": 5680
      },
      {
        "path": "src/components/ui/Skeleton.stories.tsx",
        "type": "blob",
        "size": 4537
      },
      {
        "path": "src/components/ui/Switch.stories.tsx",
        "type": "blob",
        "size": 4162
      },
      {
        "path": "src/components/ui/Tabs.stories.tsx",
        "type": "blob",
        "size": 7719
      },
      {
        "path": "src/components/ui/Textarea.stories.tsx",
        "type": "blob",
        "size": 3493
      },
      {
        "path": "src/components/ui/Toast.stories.tsx",
        "type": "blob",
        "size": 6782
      },
      {
        "path": "src/components/ui/Tooltip.stories.tsx",
        "type": "blob",
        "size": 6386
      },
      {
        "path": "src/components/ui/avatar.tsx",
        "type": "blob",
        "size": 3157
      },
      {
        "path": "src/components/ui/badge.tsx",
        "type": "blob",
        "size": 1145
      },
      {
        "path": "src/components/ui/button.tsx",
        "type": "blob",
        "size": 1955
      },
      {
        "path": "src/components/ui/card.tsx",
        "type": "blob",
        "size": 1849
      },
      {
        "path": "src/components/ui/command.tsx",
        "type": "blob",
        "size": 4914
      },
      {
        "path": "src/components/ui/dialog.tsx",
        "type": "blob",
        "size": 3869
      },
      {
        "path": "src/components/ui/dropdown-menu.tsx",
        "type": "blob",
        "size": 7449
      },
      {
        "path": "src/components/ui/input.tsx",
        "type": "blob",
        "size": 773
      },
      {
        "path": "src/components/ui/label.tsx",
        "type": "blob",
        "size": 732
      },
      {
        "path": "src/components/ui/lightbox.tsx",
        "type": "blob",
        "size": 6434
      },
      {
        "path": "src/components/ui/logo.tsx",
        "type": "blob",
        "size": 845
      },
      {
        "path": "src/components/ui/media-lightbox-context.tsx",
        "type": "blob",
        "size": 2132
      },
      {
        "path": "src/components/ui/popover.tsx",
        "type": "blob",
        "size": 1315
      },
      {
        "path": "src/components/ui/skeleton.tsx",
        "type": "blob",
        "size": 264
      },
      {
        "path": "src/components/ui/switch.tsx",
        "type": "blob",
        "size": 1169
      },
      {
        "path": "src/components/ui/tabs.tsx",
        "type": "blob",
        "size": 1939
      },
      {
        "path": "src/components/ui/textarea.tsx",
        "type": "blob",
        "size": 654
      },
      {
        "path": "src/components/ui/toast.tsx",
        "type": "blob",
        "size": 4855
      },
      {
        "path": "src/components/ui/tooltip.tsx",
        "type": "blob",
        "size": 1226
      },
      {
        "path": "src/components/user",
        "type": "tree"
      },
      {
        "path": "src/components/user/UserProfile.tsx",
        "type": "blob",
        "size": 4831
      },
      {
        "path": "src/components/utils",
        "type": "tree"
      },
      {
        "path": "src/components/utils/ScrollToHash.tsx",
        "type": "blob",
        "size": 491
      },
      {
        "path": "src/lib",
        "type": "tree"
      },
      {
        "path": "src/lib/hooks",
        "type": "tree"
      },
      {
        "path": "src/lib/hooks/useDebounce.ts",
        "type": "blob",
        "size": 386
      },
      {
        "path": "src/lib/r2.ts",
        "type": "blob",
        "size": 3873
      },
      {
        "path": "src/lib/trpc",
        "type": "tree"
      },
      {
        "path": "src/lib/trpc/client.ts",
        "type": "blob",
        "size": 170
      },
      {
        "path": "src/lib/trpc/provider.tsx",
        "type": "blob",
        "size": 1587
      },
      {
        "path": "src/lib/trpc/server.ts",
        "type": "blob",
        "size": 486
      },
      {
        "path": "src/lib/utils.test.ts",
        "type": "blob",
        "size": 4253
      },
      {
        "path": "src/lib/utils.ts",
        "type": "blob",
        "size": 3665
      },
      {
        "path": "src/lib/validators.test.ts",
        "type": "blob",
        "size": 7349
      },
      {
        "path": "src/lib/validators.ts",
        "type": "blob",
        "size": 3973
      },
      {
        "path": "src/lib/webhooks.ts",
        "type": "blob",
        "size": 7562
      },
      {
        "path": "src/middleware.ts",
        "type": "blob",
        "size": 793
      },
      {
        "path": "src/server",
        "type": "tree"
      },
      {
        "path": "src/server/api",
        "type": "tree"
      },
      {
        "path": "src/server/api/root.ts",
        "type": "blob",
        "size": 1080
      },
      {
        "path": "src/server/api/routers",
        "type": "tree"
      },
      {
        "path": "src/server/api/routers/comment.ts",
        "type": "blob",
        "size": 7985
      },
      {
        "path": "src/server/api/routers/draft.ts",
        "type": "blob",
        "size": 4743
      },
      {
        "path": "src/server/api/routers/notification.ts",
        "type": "blob",
        "size": 2027
      },
      {
        "path": "src/server/api/routers/post.ts",
        "type": "blob",
        "size": 13316
      },
      {
        "path": "src/server/api/routers/project.ts",
        "type": "blob",
        "size": 6561
      },
      {
        "path": "src/server/api/routers/reaction.ts",
        "type": "blob",
        "size": 6352
      },
      {
        "path": "src/server/api/routers/search.ts",
        "type": "blob",
        "size": 2256
      },
      {
        "path": "src/server/api/routers/site.ts",
        "type": "blob",
        "size": 5009
      },
      {
        "path": "src/server/api/routers/upload.ts",
        "type": "blob",
        "size": 2036
      },
      {
        "path": "src/server/api/routers/user.ts",
        "type": "blob",
        "size": 10311
      },
      {
        "path": "src/server/api/trpc.ts",
        "type": "blob",
        "size": 2305
      },
      {
        "path": "src/server/auth.config.ts",
        "type": "blob",
        "size": 1079
      },
      {
        "path": "src/server/auth.ts",
        "type": "blob",
        "size": 3398
      },
      {
        "path": "src/server/db.ts",
        "type": "blob",
        "size": 397
      },
      {
        "path": "src/test",
        "type": "tree"
      },
      {
        "path": "src/test/setup.ts",
        "type": "blob",
        "size": 31
      },
      {
        "path": "tsconfig.json",
        "type": "blob",
        "size": 602
      },
      {
        "path": "tsconfig.tsbuildinfo",
        "type": "blob",
        "size": 377101
      },
      {
        "path": "vitest.config.ts",
        "type": "blob",
        "size": 1361
      },
      {
        "path": "vitest.shims.d.ts",
        "type": "blob",
        "size": 62
      }
    ],
    "files": [
      {
        "path": ".env.example",
        "size": 2065,
        "reason": "config signal",
        "content": "# =============================================================================\n# Draftboard Environment Variables\n# =============================================================================\n# Copy this file to .env and fill in the values:\n#   cp .env.example .env\n# =============================================================================\n\n# -----------------------------------------------------------------------------\n# Database (Prisma Postgres)\n# -----------------------------------------------------------------------------\n# Connection string for your Prisma Postgres database.\n# For local development, run `npx prisma dev` to get a local connection URL.\n# See: https://pris.ly/d/connection-strings\nDATABASE_URL=\"prisma+postgres://accelerate.prisma-data.net/?api_key=YOUR_API_KEY\"\n\n# -----------------------------------------------------------------------------\n# NextAuth.js\n# -----------------------------------------------------------------------------\n# Secret used to encrypt JWTs and session cookies.\n# Generate one with: openssl rand -base64 32\nNEXTAUTH_SECRET=\"generate-a-random-secret-here\"\n\n# The canonical URL of your app. Used for OAuth callbacks and redirects.\nNEXTAUTH_URL=\"http://localhost:3000\"\n\n# -----------------------------------------------------------------------------\n# Cloudflare R2 Storage (for file uploads)\n# -----------------------------------------------------------------------------\n# These are required for image/file upload functionality.\n# Get these from your Cloudflare dashboard → R2 → API Tokens.\n\n# Your Cloudflare account ID (found in the dashboard URL or account overview)\nR2_ACCOUNT_ID=your_cloudflare_account_id\n\n# R2 API token credentials (create an API token with R2 read/write access)\nR2_ACCESS_KEY_ID=your_r2_access_key_id\nR2_SECRET_ACCESS_KEY=your_r2_secret_access_key\n\n# The name of your R2 bucket\nR2_BUCKET_NAME=your_bucket_name\n\n# Public URL for accessing uploaded files.\n# Typically: https://<account_id>.r2.cloudflarestorage.com\nR2_PUBLIC_URL=https://your_account_id.r2.cloudflarestorage.com\n",
        "truncated": false
      },
      {
        "path": "AGENTS.MD",
        "size": 3895,
        "reason": "agent instructions",
        "content": "# AGENTS.MD\n\nGuidelines for AI coding agents working on this codebase.\n\n## Code Style & Conventions\n\n### Pluralization\n\nAlways use the `pluralize()` helper from `~/lib/utils` when displaying counts with text labels. Never hardcode plural forms.\n\n```tsx\n// ✅ Correct\nimport { pluralize } from \"~/lib/utils\";\n<span>{count} {pluralize(count, \"post\")}</span>\n<span>{count} {pluralize(count, \"reply\", \"replies\")}</span>\n\n// ❌ Wrong - hardcoded plural\n<span>{count} posts</span>\n<span>{count} members</span>\n```\n\nThe `pluralize(count, singular, plural?)` function:\n- Returns singular form when count === 1\n- Returns plural form (or singular + \"s\") otherwise\n- Supports irregular plurals via optional third argument\n\n### Component Structure\n\n- Use `\"use client\"` directive for interactive components\n- Keep server components as the default where possible\n- Place shared UI components in `src/components/ui/`\n- Feature-specific components go in their respective folders (e.g., `src/components/feed/`)\n\n### Imports\n\n- Use path aliases: `~/` maps to `src/`\n- Import order: React → Next.js → external libs → internal modules → types\n- Prefer named exports over default exports for components\n\n### TypeScript\n\n- Always type component props with interfaces\n- Use `unknown` for JSON data from the database (e.g., Lexical editor state)\n- Prefer explicit types over `any`\n\n### API & Data Fetching\n\n- Use tRPC for all API calls via `api` from `~/lib/trpc/client`\n- Use React Query's infinite queries for paginated data\n- Handle loading and error states explicitly\n\n### Styling\n\n- Use Tailwind CSS classes\n- Use `cn()` from `~/lib/utils` for conditional class merging\n- Follow shadcn/ui patterns for custom components\n\n#### Destructive Action Styling\n\nDestructive/negative actions with red text must have proper hover/focus states to remain readable:\n\n```tsx\n// ✅ Correct - red background with white text on hover/focus\n<DropdownMenuItem className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\">\n  Delete item\n</DropdownMenuItem>\n\n<Button className=\"text-destructive hover:bg-destructive hover:text-destructive-foreground\">\n  Sign out\n</Button>\n\n// ❌ Wrong - red text stays red on dark hover background, becomes unreadable\n<DropdownMenuItem className=\"text-destructive focus:text-destructive\">\n  Delete item\n</DropdownMenuItem>\n\n<Button className=\"text-destructive hover:text-destructive\">\n  Sign out\n</Button>\n```\n\nRule: Elements with `text-destructive` in default state should use `focus:bg-destructive focus:text-destructive-foreground` (for menu items) or `hover:bg-destructive hover:text-destructive-foreground` (for buttons) in their interactive states.\n\n## Project Architecture\n\n```\nsrc/\n├── app/                    # Next.js App Router pages\n│   ├── (auth)/            # Auth pages (public)\n│   ├── (main)/            # Protected pages\n│   └── api/               # API routes (tRPC, NextAuth)\n├── components/            # React components\n├── server/                # Server-side code\n│   └── api/routers/       # tRPC routers\n├── lib/                   # Utilities and hooks\n└── middleware.ts          # Auth middleware\n```\n\n## Testing\n\n- Use Vitest for unit tests\n- Place test files alongside source files with `.test.ts` extension\n- Run tests with `npm test`\n\n## Common Patterns\n\n### Infinite Scroll Lists\n\n```tsx\nconst { data, fetchNextPage, hasNextPage, isFetchingNextPage } = \n  api.post.list.useInfiniteQuery(\n    { limit: 10 },\n    { getNextPageParam: (lastPage) => lastPage.nextCursor }\n  );\n\nconst items = data?.pages.flatMap((page) => page.items) ?? [];\n```\n\n### Date Formatting\n\nUse `formatRelativeTime()` from `~/lib/utils` for consistent relative dates.\n\n### URL Signing for R2\n\nPrivate R2 URLs need signing. Use `api.upload.getDownloadUrl.useQuery()` for attachments and cover images.\n",
        "truncated": false
      },
      {
        "path": "CONTRIBUTING.md",
        "size": 6672,
        "reason": "contributing guide",
        "content": "# Contributing to Draftboard\n\nThanks for your interest in contributing! This guide covers everything you need to get a local development environment running and start making changes.\n\n## Development Setup\n\n### Prerequisites\n\n- Node.js 18+\n- PostgreSQL (local or hosted)\n- Cloudflare R2 bucket (for file uploads)\n\n### Getting Started\n\n```bash\n# Install dependencies\nnpm install\n\n# Copy environment file and fill in your values\ncp .env.example .env\n\n# Generate the Prisma client\nnpm run db:generate\n\n# Run database migrations\nnpm run db:migrate\n\n# Start the dev server (with Turbopack)\nnpm run dev\n```\n\nThe app will be available at [http://localhost:3000](http://localhost:3000).\n\n### Available Scripts\n\n| Command | Description |\n|---|---|\n| `npm run dev` | Start development server with Turbopack |\n| `npm run build` | Build for production |\n| `npm run build:prod` | Run migrations + build (for deployment) |\n| `npm run lint` | Run ESLint |\n| `npm test` | Run Vitest in watch mode |\n| `npm run test:run` | Run tests once |\n| `npm run storybook` | Start Storybook on port 6006 |\n| `npm run build-storybook` | Build static Storybook |\n| `npm run db:generate` | Regenerate Prisma client |\n| `npm run db:migrate` | Create and run migrations |\n| `npm run db:push` | Push schema changes without migrations |\n| `npm run db:studio` | Open Prisma Studio (database GUI) |\n\n## Project Architecture\n\n```\nsrc/\n├── app/                        # Next.js App Router\n│   ├── (auth)/                 # Public auth pages (sign-in, sign-up, invite, reset-password)\n│   ├── (main)/                 # Protected pages (feed, posts, projects, admin, settings)\n│   └── api/                    # API routes (tRPC, NextAuth)\n├── components/\n│   ├── comments/               # Comment section, threads, composer\n│   ├── editor/                 # Lexical rich text editor, plugins, and nodes\n│   ├── feed/                   # Feed list/grid views, post cards\n│   ├── layout/                 # Main navigation\n│   ├── post/                   # Post detail and editor\n│   ├── projects/               # Project detail, cover upload\n│   ├── reactions/              # Reaction button and dialog\n│   ├── search/                 # Command palette search\n│   ├── settings/               # Avatar and emoji upload\n│   ├── ui/                     # Shared UI primitives (shadcn/ui)\n│   └── user/                   # User profile\n├── server/\n│   ├── api/\n│   │   ├── routers/            # tRPC routers (post, comment, project, user, etc.)\n│   │   ├── root.ts             # Root tRPC router\n│   │   └── trpc.ts             # tRPC initialization and context\n│   ├── auth.ts                 # NextAuth full configuration\n│   ├── auth.config.ts          # Edge-compatible auth config (for middleware)\n│   └── db.ts                   # Prisma client singleton\n├── lib/\n│   ├── hooks/                  # Custom React hooks\n│   ├── trpc/                   # tRPC client, provider, and server caller\n│   ├── r2.ts                   # Cloudflare R2 upload utilities\n│   ├── utils.ts                # Shared utilities (cn, formatRelativeTime, pluralize)\n│   ├── validators.ts           # Zod validation schemas\n│   └── webhooks.ts             # Discord/Slack webhook helpers\n├── middleware.ts               # Auth middleware (Edge runtime)\n└── test/\n    └── setup.ts                # Vitest test setup\n```\n\n## Code Conventions\n\n### Imports\n\nUse the `~/` path alias which maps to `src/`:\n\n```tsx\nimport { Button } from \"~/components/ui/button\";\nimport { api } from \"~/lib/trpc/client\";\n```\n\n### Components\n\n- Use `\"use client\"` only for interactive components; keep server components as the default\n- Place shared UI primitives in `src/components/ui/` following shadcn/ui patterns\n- Feature-specific components go in their own folder (e.g. `src/components/feed/`)\n- Prefer named exports over default exports\n\n### Styling\n\n- Use Tailwind CSS classes for all styling\n- Use `cn()` from `~/lib/utils` for conditional class merging\n- Follow the existing shadcn/ui patterns for new components\n\n### TypeScript\n\n- Always type component props with interfaces\n- Use `unknown` for JSON data from the database (e.g. Lexical editor state)\n- Prefer explicit types over `any`\n\n### Data Fetching\n\nAll API calls go through tRPC:\n\n```tsx\nimport { api } from \"~/lib/trpc/client\";\n\n// Basic query\nconst { data } = api.post.getById.useQuery({ id: postId });\n\n// Infinite scroll\nconst { data, fetchNextPage, hasNextPage } = api.post.list.useInfiniteQuery(\n  { limit: 10 },\n  { getNextPageParam: (lastPage) => lastPage.nextCursor }\n);\nconst items = data?.pages.flatMap((page) => page.items) ?? [];\n```\n\n### Utilities\n\n- **Pluralization**: Always use `pluralize()` from `~/lib/utils` — never hardcode plural forms\n- **Dates**: Use `formatRelativeTime()` from `~/lib/utils` for relative timestamps\n- **R2 URLs**: Private file URLs need signing — use `api.upload.getDownloadUrl.useQuery()`\n\n## Testing\n\nWe use [Vitest](https://vitest.dev/) for unit tests and [Storybook](https://storybook.js.org/) for component development and visual testing.\n\n### Unit Tests\n\nTest files live alongside source files with a `.test.ts` or `.test.tsx` extension:\n\n```bash\n# Run tests in watch mode\nnpm test\n\n# Run tests once (CI)\nnpm run test:run\n```\n\n### Storybook\n\nStorybook stories live alongside components with a `.stories.tsx` extension. The Storybook setup includes:\n\n- **Vitest addon** — stories run as browser tests via Playwright\n- **a11y addon** — automated accessibility checks\n- **Docs addon** — auto-generated documentation from stories\n\n```bash\n# Start Storybook dev server\nnpm run storybook\n\n# Build static Storybook\nnpm run build-storybook\n```\n\nStories use the `~/` path alias and have access to the same theme/providers as the main app. See existing stories in `src/components/ui/` for examples.\n\n## Database\n\nThe database schema is managed with [Prisma](https://www.prisma.io/). The schema lives at `prisma/schema.prisma`.\n\n```bash\n# After changing the schema, create a migration\nnpm run db:migrate\n\n# Or push changes directly (useful during prototyping)\nnpm run db:push\n\n# Browse your data\nnpm run db:studio\n```\n\n## Making Changes\n\n1. Create a branch from `main`\n2. Make your changes\n3. Run `npm run lint` and `npm test` to verify nothing is broken\n4. Open a pull request\n\n## License\n\nBy contributing, you agree that your contributions will be licensed under the MIT License.\n",
        "truncated": false
      },
      {
        "path": "README.md",
        "size": 5065,
        "reason": "project readme",
        "content": "<img width=\"1280\" height=\"640\" alt=\"Draftboard logo\" src=\"https://github.com/user-attachments/assets/b68e931a-915b-4fe3-8894-bed44a6668cb\" />\n\n\n# Draftboard\n\n**Draftboard** is a shared space for teams to post designs, ideas, and work in progress. In distributed teams, meaningful work too often disappears into Slack threads or gets buried inside Figma, making it harder to learn from each other and keep ideas flowing. Draftboard brings that work back into the open with a lightweight, social feed that’s easy to deploy, pleasant to use, and flexible enough to fit into existing workflows.\n\n## Features\n\n- **Feed** — Reverse chronological feed of posts with list and grid views\n- **Rich Editor** — Lexical-based editor with markdown shortcuts, @mentions, slash commands, drag-and-drop, pasting and automatic draft saving.\n- **Attachments** — Images, videos, files, Figma links, and Loom recordings with a carousel viewer\n- **Projects** — Organize posts into projects with cover images, descriptions, and team members\n- **Comments** — Threaded comments with 2 levels of depth and attachment-specific comments\n- **Reactions** — Like, wow, cool reactions plus custom emoji support\n- **Notifications** — Notifications for comments, replies, mentions, and reactions\n- **Search** — Full-text search across posts, projects, and people\n- **Webhooks** — Optional Discord and Slack webhook integrations for new posts\n- **Admin** — User management, invite links, and site settings\n- **Dark Mode** — Full light/dark theme support\n- **Mobile PWA** — Fully mobile-optimized as a Progressive Web App, feels at home on iOS and Android home screens\n\n## Tech Stack\n\n- **Framework**: Next.js 15 (App Router, Turbopack)\n- **API**: tRPC v11 + React Query\n- **Database**: PostgreSQL with Prisma ORM\n- **Auth**: NextAuth.js v5 (Credentials provider, JWT sessions)\n- **Storage**: Cloudflare R2 (S3-compatible)\n- **UI**: shadcn/ui + Tailwind CSS v4\n- **Editor**: Lexical\n- **Testing**: Vitest + Storybook\n\n## Deploying to Vercel\n\nClick the button below to kickstart your deployment — it will clone the repo and prompt you for the required environment variables:\n\n[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fhrescak%2FDraftboard.git&env=DATABASE_URL,NEXTAUTH_SECRET,NEXTAUTH_URL,R2_ACCOUNT_ID,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_BUCKET_NAME,R2_PUBLIC_URL&envDefaults=%7B%22NEXTAUTH_SECRET%22%3A%22generate-new-secret-locally%22%2C%22NEXTAUTH_URL%22%3A%22https%3A%2F%2F%24VERCEL_PROJECT_PRODUCTION_URL%22%2C%22R2_ACCOUNT_ID%22%3A%22your_cloudflare_account_id%22%2C%22R2_ACCESS_KEY_ID%22%3A%22your_r2_access_key_id%22%2C%22R2_BUCKET_NAME%22%3A%22your_bucket_name%22%2C%22R2_PUBLIC_URL%22%3A%22https%3A%2F%2Fyour_account_id.r2.cloudflarestorage.com%22%7D&envDescription=Deployment%20guide%20for%20Draftboard&envLink=https%3A%2F%2Fgithub.com%2Fhrescak%2FDraftboard%2Fblob%2Fmain%2Fdocs%2FDeployment-vercel.md&project-name=draftboard&repository-name=draftboard)\n\nFor the full walkthrough (database setup, R2 configuration, CORS, build settings), see the [Vercel deployment guide](docs/Deployment-vercel.md).\n\n## Self-Hosting\n\n### Prerequisites\n\n- A service that runs Node.js 18+ (e.g. [Vercel](https://vercel.com))\n- A PostgreSQL database ([Prisma Postgres](https://www.prisma.io/postgres), [Supabase](https://supabase.com), or [Neon](https://neon.tech))\n- S3-compatible storage ([Cloudflare R2](https://developers.cloudflare.com/r2/) or [AWS S3](https://aws.amazon.com/s3/))\n\n### 1. Clone and install\n\n```bash\ngit clone https://github.com/your-org/draftboard.git\ncd draftboard\nnpm install\n```\n\n### 2. Configure environment\n\n```bash\ncp .env.example .env\n```\n\nFill in your `.env` with the following:\n\n| Variable | Description |\n|---|---|\n| `DATABASE_URL` | PostgreSQL connection string |\n| `NEXTAUTH_SECRET` | Random secret for signing sessions (`openssl rand -base64 32`) |\n| `NEXTAUTH_URL` | Your deployment URL (e.g. `https://draftboard.yourcompany.com`) |\n| `R2_ACCOUNT_ID` | Cloudflare account ID |\n| `R2_ACCESS_KEY_ID` | R2 API key ID |\n| `R2_SECRET_ACCESS_KEY` | R2 API secret |\n| `R2_BUCKET_NAME` | R2 bucket name |\n| `R2_PUBLIC_URL` | Public URL for the R2 bucket |\n\n### 3. Set up the database\n\n```bash\nnpm run db:generate\nnpm run db:migrate\n```\n\n### 4. Start the app\n\n```bash\n# Development\nnpm run dev\n\n# Production\nnpm run build:prod\nnpm run start\n```\n\n\n\n## Contributing\n\nSee [CONTRIBUTING.md](CONTRIBUTING.md) for development setup, architecture details, and contribution guidelines.\n\n## License\n\nMIT\n\n## Ackgnowledgements\n\nThis tool stands on the shoulders of earlier tools like [Pixelcloud](https://engineering.fb.com/2011/02/15/web/hackathon-22-redesigning-pixelcloud/) and [Campsite](https://www.campsite.com/), which helped shape many of the ideas explored here. I’ve been fortunate to work closely with both—contributing to Pixelcloud during my time at Facebook and supporting Campsite as an investor—and this project carries forward lessons learned from each.\n",
        "truncated": false
      },
      {
        "path": "package.json",
        "size": 3044,
        "reason": "dependency manifest",
        "content": "{\n  \"name\": \"draftboard\",\n  \"version\": \"1.0.0\",\n  \"private\": true,\n  \"type\": \"module\",\n  \"scripts\": {\n    \"dev\": \"next dev --turbopack\",\n    \"build\": \"next build\",\n    \"build:prod\":\"prisma migrate deploy && next build\",\n    \"start\": \"next start\",\n    \"lint\": \"next lint\",\n    \"postinstall\": \"prisma generate\",\n    \"db:generate\": \"prisma generate\",\n    \"db:migrate\": \"prisma migrate dev\",\n    \"db:push\": \"prisma db push\",\n    \"db:studio\": \"prisma studio\",\n    \"test\": \"vitest\",\n    \"test:run\": \"vitest run\",\n    \"storybook\": \"storybook dev -p 6006\",\n    \"build-storybook\": \"storybook build\"\n  },\n  \"dependencies\": {\n    \"@aws-sdk/client-s3\": \"^3.975.0\",\n    \"@aws-sdk/s3-request-presigner\": \"^3.975.0\",\n    \"@lexical/code\": \"^0.31.2\",\n    \"@lexical/link\": \"^0.31.2\",\n    \"@lexical/list\": \"^0.31.2\",\n    \"@lexical/markdown\": \"^0.31.2\",\n    \"@lexical/react\": \"^0.31.2\",\n    \"@lexical/rich-text\": \"^0.31.2\",\n    \"@lexical/selection\": \"^0.31.2\",\n    \"@lexical/utils\": \"^0.31.2\",\n    \"@prisma/client\": \"^6.8.2\",\n    \"@radix-ui/react-avatar\": \"^1.1.11\",\n    \"@radix-ui/react-dialog\": \"^1.1.15\",\n    \"@radix-ui/react-dropdown-menu\": \"^2.1.16\",\n    \"@radix-ui/react-label\": \"^2.1.8\",\n    \"@radix-ui/react-popover\": \"^1.1.15\",\n    \"@radix-ui/react-slot\": \"^1.2.4\",\n    \"@radix-ui/react-switch\": \"^1.2.6\",\n    \"@radix-ui/react-tabs\": \"^1.1.13\",\n    \"@radix-ui/react-toast\": \"^1.2.15\",\n    \"@radix-ui/react-tooltip\": \"^1.2.8\",\n    \"@tanstack/react-query\": \"^5.80.7\",\n    \"@trpc/client\": \"^11.1.2\",\n    \"@trpc/react-query\": \"^11.1.2\",\n    \"@trpc/server\": \"^11.1.2\",\n    \"bcryptjs\": \"^3.0.2\",\n    \"class-variance-authority\": \"^0.7.1\",\n    \"clsx\": \"^2.1.1\",\n    \"cmdk\": \"^1.1.1\",\n    \"lexical\": \"^0.31.2\",\n    \"lucide-react\": \"^0.513.0\",\n    \"next\": \"^15.3.7\",\n    \"next-auth\": \"^5.0.0-beta.25\",\n    \"next-themes\": \"^0.4.6\",\n    \"react\": \"^19.1.0\",\n    \"react-dom\": \"^19.1.0\",\n    \"react-masonry-css\": \"^1.0.16\",\n    \"superjson\": \"^2.2.2\",\n    \"tailwind-merge\": \"^3.0.2\",\n    \"zod\": \"^3.25.30\"\n  },\n  \"devDependencies\": {\n    \"@tailwindcss/postcss\": \"^4.1.18\",\n    \"@testing-library/dom\": \"^10.4.0\",\n    \"@testing-library/react\": \"^16.3.0\",\n    \"@types/bcryptjs\": \"^2.4.6\",\n    \"@types/node\": \"^22.15.29\",\n    \"@types/react\": \"^19.1.8\",\n    \"@types/react-dom\": \"^19.1.6\",\n    \"@typescript-eslint/eslint-plugin\": \"^8.34.0\",\n    \"@typescript-eslint/parser\": \"^8.34.0\",\n    \"@vitejs/plugin-react\": \"^4.5.2\",\n    \"autoprefixer\": \"^10.4.21\",\n    \"eslint\": \"^9.29.0\",\n    \"eslint-config-next\": \"^15.3.7\",\n    \"jsdom\": \"^26.1.0\",\n    \"postcss\": \"^8.5.6\",\n    \"prisma\": \"^6.8.2\",\n    \"tailwindcss\": \"^4.1.18\",\n    \"typescript\": \"^5.8.3\",\n    \"vitest\": \"^3.2.4\",\n    \"storybook\": \"^10.2.6\",\n    \"@storybook/nextjs-vite\": \"^10.2.6\",\n    \"@chromatic-com/storybook\": \"^5.0.0\",\n    \"@storybook/addon-vitest\": \"^10.2.6\",\n    \"@storybook/addon-a11y\": \"^10.2.6\",\n    \"@storybook/addon-docs\": \"^10.2.6\",\n    \"@storybook/addon-onboarding\": \"^10.2.6\",\n    \"vite\": \"^7.3.1\",\n    \"playwright\": \"^1.58.1\",\n    \"@vitest/browser\": \"^3.2.4\",\n    \"@vitest/coverage-v8\": \"^3.2.4\"\n  }\n}\n",
        "truncated": false
      },
      {
        "path": "prisma/schema.prisma",
        "size": 6722,
        "reason": "database schema",
        "content": "generator client {\n  provider = \"prisma-client-js\"\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n}\n\nenum Role {\n  MEMBER\n  ADMIN\n  OWNER\n}\n\nenum AttachmentType {\n  IMAGE\n  VIDEO\n  FILE\n  FIGMA\n  LOOM\n}\n\nenum NotificationType {\n  COMMENT\n  COMMENT_REPLY\n  REACTION_POST\n  REACTION_COMMENT\n  MENTION\n}\n\nmodel User {\n  id            String    @id @default(cuid())\n  email         String    @unique\n  passwordHash  String\n  displayName   String\n  avatarUrl     String?\n  role          Role      @default(MEMBER)\n  deactivated   Boolean   @default(false)\n  createdAt     DateTime  @default(now())\n  updatedAt     DateTime  @updatedAt\n\n  posts         Post[]\n  comments      Comment[]\n  reactions     Reaction[]\n  notifications Notification[] @relation(\"UserNotifications\")\n  actedNotifications Notification[] @relation(\"ActorNotifications\")\n  projects      ProjectMember[]\n  customEmoji   CustomEmoji[]\n  drafts        Draft[]\n  passwordResetTokens PasswordResetToken[]\n}\n\nmodel Post {\n  id           String       @id @default(cuid())\n  title        String?\n  content      Json\n  liveUrl      String?\n  hideFromHome Boolean      @default(false)\n  authorId     String\n  createdAt    DateTime     @default(now())\n  updatedAt    DateTime     @updatedAt\n\n  author      User         @relation(fields: [authorId], references: [id], onDelete: Cascade)\n  attachments Attachment[]\n  comments    Comment[]\n  reactions   Reaction[]\n  projects    PostProject[]\n  notifications Notification[]\n\n  @@index([authorId])\n  @@index([createdAt])\n}\n\nmodel Attachment {\n  id           String          @id @default(cuid())\n  postId       String\n  type         AttachmentType\n  url          String\n  filename     String\n  mimeType     String\n  size         Int\n  width        Int?\n  height       Int?\n  thumbnailUrl String?\n  metadata     Json?\n  order        Int\n  createdAt    DateTime        @default(now())\n\n  post         Post            @relation(fields: [postId], references: [id], onDelete: Cascade)\n  comments     Comment[]\n\n  @@index([postId])\n}\n\nmodel Project {\n  id          String          @id @default(cuid())\n  name        String\n  description Json?\n  coverUrl    String?\n  createdAt   DateTime        @default(now())\n  updatedAt   DateTime        @updatedAt\n  createdById String\n\n  posts       PostProject[]\n  urls        ProjectUrl[]\n  members     ProjectMember[]\n\n  @@index([createdAt])\n}\n\nmodel PostProject {\n  postId    String\n  projectId String\n\n  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)\n  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)\n\n  @@id([postId, projectId])\n}\n\nmodel ProjectUrl {\n  id        String  @id @default(cuid())\n  projectId String\n  title     String\n  url       String\n\n  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)\n\n  @@index([projectId])\n}\n\nmodel ProjectMember {\n  id        String   @id @default(cuid())\n  projectId String\n  userId    String\n  role      String   @default(\"MEMBER\")\n  createdAt DateTime @default(now())\n\n  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)\n  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)\n\n  @@unique([projectId, userId])\n}\n\nmodel Comment {\n  id           String    @id @default(cuid())\n  content      Json\n  authorId     String\n  postId       String\n  parentId     String?\n  attachmentId String?\n  coordinates  Json?\n  createdAt    DateTime  @default(now())\n  updatedAt    DateTime  @updatedAt\n\n  author       User      @relation(fields: [authorId], references: [id], onDelete: Cascade)\n  post         Post      @relation(fields: [postId], references: [id], onDelete: Cascade)\n  parent       Comment?  @relation(\"CommentReplies\", fields: [parentId], references: [id], onDelete: Cascade)\n  replies      Comment[] @relation(\"CommentReplies\")\n  attachment   Attachment? @relation(fields: [attachmentId], references: [id], onDelete: SetNull)\n  reactions    Reaction[]\n  notifications Notification[]\n\n  @@index([postId])\n  @@index([authorId])\n  @@index([parentId])\n  @@index([attachmentId])\n}\n\nmodel Reaction {\n  id        String   @id @default(cuid())\n  type      String\n  userId    String\n  postId    String?\n  commentId String?\n  createdAt DateTime @default(now())\n\n  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)\n  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)\n  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)\n\n  @@unique([userId, postId, type])\n  @@unique([userId, commentId, type])\n  @@index([postId])\n  @@index([commentId])\n}\n\nmodel CustomEmoji {\n  id        String   @id @default(cuid())\n  name      String   @unique\n  imageUrl  String\n  createdBy String\n  createdAt DateTime @default(now())\n\n  creator   User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)\n}\n\nmodel Notification {\n  id        String           @id @default(cuid())\n  type      NotificationType\n  userId    String\n  actorId   String\n  postId    String?\n  commentId String?\n  read      Boolean          @default(false)\n  createdAt DateTime         @default(now())\n\n  user      User             @relation(\"UserNotifications\", fields: [userId], references: [id], onDelete: Cascade)\n  actor     User             @relation(\"ActorNotifications\", fields: [actorId], references: [id], onDelete: Cascade)\n  post      Post?            @relation(fields: [postId], references: [id], onDelete: Cascade)\n  comment   Comment?         @relation(fields: [commentId], references: [id], onDelete: Cascade)\n\n  @@index([userId])\n  @@index([createdAt])\n}\n\nmodel SiteSettings {\n  id                 String   @id @default(\"default\")\n  inviteToken        String   @unique @default(cuid())\n  siteName           String   @default(\"Draftboard\")\n  discordWebhookUrl  String?\n  slackWebhookUrl    String?\n  createdAt          DateTime @default(now())\n  updatedAt          DateTime @updatedAt\n}\n\nmodel Draft {\n  id          String   @id @default(cuid())\n  title       String?\n  content     Json?\n  liveUrl     String?\n  authorId    String\n  projectIds  String[] @default([])\n  createdAt   DateTime @default(now())\n  updatedAt   DateTime @updatedAt\n\n  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)\n\n  @@index([authorId])\n  @@index([updatedAt])\n}\n\nmodel PasswordResetToken {\n  id        String    @id @default(cuid())\n  userId    String\n  expiresAt DateTime\n  usedAt    DateTime?\n  createdAt DateTime  @default(now())\n\n  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)\n\n  @@index([userId])\n}\n",
        "truncated": false
      },
      {
        "path": "src/app/globals.css",
        "size": 3150,
        "reason": "global styles",
        "content": "@import \"tailwindcss\";\n\n@theme {\n  --font-sans: \"Inter\", ui-sans-serif, system-ui, sans-serif;\n  --font-mono: \"JetBrains Mono\", ui-monospace, monospace;\n\n  /* Draftboard color palette - Warm, creative aesthetic */\n  /* Light mode colors (default) */\n  --color-background: #faf9f7;\n  --color-foreground: #1a1918;\n  --color-card: #ffffff;\n  --color-card-foreground: #1a1918;\n  --color-popover: #ffffff;\n  --color-popover-foreground: #1a1918;\n  --color-primary: #1a1918;\n  --color-primary-foreground: #ffffff;\n  --color-secondary: #f5f0eb;\n  --color-secondary-foreground: #1a1918;\n  --color-muted: #f0ebe5;\n  --color-muted-foreground: #6b6966;\n  --color-accent: #1a1918;\n  --color-accent-foreground: #ffffff;\n  --color-destructive: #dc2626;\n  --color-destructive-foreground: #ffffff;\n  --color-border: #e5e0da;\n  --color-input: #e5e0da;\n  --color-ring: #1a1918;\n\n  --radius-sm: 0.375rem;\n  --radius-md: 0.5rem;\n  --radius-lg: 0.75rem;\n  --radius-xl: 1rem;\n}\n\n/* Dark mode - applied via .dark class on html element */\n:root.dark {\n  --color-background: #0f0e0d;\n  --color-foreground: #f5f4f2;\n  --color-card: #1a1918;\n  --color-card-foreground: #f5f4f2;\n  --color-popover: #1a1918;\n  --color-popover-foreground: #f5f4f2;\n  --color-primary: #f5f4f2;\n  --color-primary-foreground: #0f0e0d;\n  --color-secondary: #262422;\n  --color-secondary-foreground: #f5f4f2;\n  --color-muted: #262422;\n  --color-muted-foreground: #a8a5a0;\n  --color-accent: #f5f4f2;\n  --color-accent-foreground: #0f0e0d;\n  --color-destructive: #ef4444;\n  --color-destructive-foreground: #f5f4f2;\n  --color-border: #2e2c2a;\n  --color-input: #2e2c2a;\n  --color-ring: #f5f4f2;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply bg-background text-foreground antialiased;\n  }\n}\n\n/* Custom scrollbar */\n@layer utilities {\n  .scrollbar-thin {\n    scrollbar-width: thin;\n    scrollbar-color: var(--color-muted) transparent;\n  }\n\n  .scrollbar-thin::-webkit-scrollbar {\n    width: 6px;\n    height: 6px;\n  }\n\n  .scrollbar-thin::-webkit-scrollbar-track {\n    background: transparent;\n  }\n\n  .scrollbar-thin::-webkit-scrollbar-thumb {\n    background: var(--color-muted);\n    border-radius: 3px;\n  }\n}\n\n/* Lexical editor styles */\n.editor-container {\n  @apply relative min-h-[200px] rounded-lg border border-input bg-background;\n}\n\n.editor-input {\n  @apply min-h-[200px] p-4 outline-none;\n}\n\n.editor-placeholder {\n  @apply pointer-events-none absolute left-4 top-4 select-none text-muted-foreground/50;\n}\n\n/* Selectable decorator nodes (images, attachments) */\n.editor-image,\n.editor-attachment {\n  @apply relative cursor-pointer;\n}\n\n.editor-image:focus,\n.editor-attachment:focus,\n.editor-image.selected,\n.editor-attachment.selected {\n  @apply outline-2 outline-primary outline-offset-2 outline;\n}\n\n/* Mention styles */\n.mention {\n  @apply rounded bg-primary/10 px-1 py-0.5 font-semibold text-primary no-underline;\n}\n\n.mention:hover {\n  @apply bg-primary/20;\n}\n\n/* Ensure mentions are clickable and look like links */\na.mention {\n  @apply cursor-pointer;\n}\n\n/* Code block styles */\n.editor-code {\n  @apply my-2 block overflow-x-auto rounded-md bg-muted p-4 font-mono text-sm;\n}\n",
        "truncated": false
      },
      {
        "path": "tsconfig.json",
        "size": 602,
        "reason": "config signal",
        "content": "{\n  \"compilerOptions\": {\n    \"target\": \"ES2017\",\n    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n    \"allowJs\": true,\n    \"skipLibCheck\": true,\n    \"strict\": true,\n    \"noEmit\": true,\n    \"esModuleInterop\": true,\n    \"module\": \"esnext\",\n    \"moduleResolution\": \"bundler\",\n    \"resolveJsonModule\": true,\n    \"isolatedModules\": true,\n    \"jsx\": \"preserve\",\n    \"incremental\": true,\n    \"plugins\": [\n      {\n        \"name\": \"next\"\n      }\n    ],\n    \"paths\": {\n      \"~/*\": [\"./src/*\"]\n    }\n  },\n  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n  \"exclude\": [\"node_modules\"]\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/layout/main-nav.tsx",
        "size": 18895,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport Link from \"next/link\";\nimport { usePathname } from \"next/navigation\";\nimport { cn } from \"~/lib/utils\";\nimport { Home, FolderOpen, Bell, Plus, Settings, User, Shield, FileText, Search, LogOut } from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"~/components/ui/tooltip\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { Logo } from \"~/components/ui/logo\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"~/components/ui/popover\";\nimport { signOut } from \"next-auth/react\";\nimport { api } from \"~/lib/trpc/client\";\nimport { useState } from \"react\";\nimport { SearchCommand } from \"~/components/search/SearchCommand\";\n\n// Thumbnail component with error handling for draft images\nfunction DraftThumbnail({ url }: { url: string | null }) {\n  const [hasError, setHasError] = useState(false);\n\n  if (!url || hasError) {\n    return (\n      <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded bg-muted\">\n        <FileText className=\"h-4 w-4 text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-8 w-8 shrink-0 overflow-hidden rounded bg-muted\">\n      {/* eslint-disable-next-line @next/next/no-img-element */}\n      <img\n        src={url}\n        alt=\"\"\n        className=\"h-full w-full object-cover\"\n        onError={() => setHasError(true)}\n      />\n    </div>\n  );\n}\n\nconst navItemsBeforeSearch = [\n  { href: \"/\", label: \"Home\", icon: Home },\n  { href: \"/projects\", label: \"Projects\", icon: FolderOpen },\n];\n\nconst navItemsAfterSearch = [\n  { href: \"/notifications\", label: \"Notifications\", icon: Bell },\n];\n\nconst mobileNavItemsBeforeSearch = [\n  { href: \"/\", label: \"Home\", icon: Home },\n  { href: \"/projects\", label: \"Projects\", icon: FolderOpen },\n];\n\nconst mobileNavItemsAfterSearch = [\n  { href: \"/notifications\", label: \"Notifications\", icon: Bell },\n];\n\ninterface MainNavProps {\n  user: {\n    id: string;\n    name: string;\n    email: string;\n    image?: string | null;\n    role: \"MEMBER\" | \"ADMIN\" | \"OWNER\";\n  };\n}\n\nexport function MainNav({ user }: MainNavProps) {\n  const pathname = usePathname();\n  const [composeOpen, setComposeOpen] = useState(false);\n  const [searchOpen, setSearchOpen] = useState(false);\n\n  // Fetch current user data to get fresh avatar URL (session may be stale)\n  const { data: currentUser } = api.user.me.useQuery();\n\n  // Fetch unread notification count\n  const { data: unreadCount } = api.notification.unreadCount.useQuery();\n  \n  // Hide badge when on notifications page\n  const isOnNotifications = pathname === \"/notifications\";\n  const showNotificationBadge = !isOnNotifications && (unreadCount ?? 0) > 0;\n\n  // Use fresh avatar from API if available, otherwise fall back to session\n  const avatarUrl = currentUser?.avatarUrl ?? user.image;\n\n  // Always fetch drafts to know whether to show popover or direct link\n  const { data: drafts, error: draftsError } = api.draft.list.useQuery();\n\n  // Log error for debugging\n  if (draftsError) {\n    console.error(\"Failed to fetch drafts:\", draftsError.message);\n  }\n\n  const hasDrafts = drafts && drafts.length > 0;\n\n  // Helper to format relative time\n  const formatRelativeTime = (date: Date) => {\n    const now = new Date();\n    const diff = now.getTime() - new Date(date).getTime();\n    const minutes = Math.floor(diff / 60000);\n    const hours = Math.floor(diff / 3600000);\n    const days = Math.floor(diff / 86400000);\n\n    if (minutes < 1) return \"Just now\";\n    if (minutes < 60) return `${minutes}m ago`;\n    if (hours < 24) return `${hours}h ago`;\n    return `${days}d ago`;\n  };\n\n  // Get display info for a draft\n  const getDraftDisplayInfo = (draft: {\n    id: string;\n    title: string | null;\n    preview: string | null;\n    firstImageUrl: string | null;\n    updatedAt: Date;\n  }) => {\n    if (draft.title) return draft.title;\n    if (draft.preview) return draft.preview.slice(0, 40) + (draft.preview.length > 40 ? \"...\" : \"\");\n    return \"Untitled draft\";\n  };\n\n  return (\n    <>\n      {/* Desktop Sidebar - hidden on mobile */}\n      <aside className=\"fixed left-0 top-0 z-50 hidden h-screen w-16 flex-col bg-background sm:flex\">\n        {/* Logo at top - aligned with content header */}\n        <div className=\"flex items-start justify-center pt-4\">\n          <Link href=\"/\" className=\"text-foreground transition-transform hover:scale-105\">\n            <Logo width={30} height={30} />\n          </Link>\n        </div>\n\n        {/* Centered navigation items */}\n        <nav className=\"flex flex-1 flex-col items-center justify-center gap-1\">\n          {navItemsBeforeSearch.map((item) => {\n            const isActive =\n              pathname === item.href ||\n              (item.href !== \"/\" && pathname.startsWith(item.href));\n            const Icon = item.icon;\n\n            return (\n              <Tooltip key={item.href} delayDuration={0}>\n                <TooltipTrigger asChild>\n                  <Link\n                    href={item.href}\n                    className={cn(\n                      \"flex h-12 w-12 items-center justify-center rounded-xl transition-colors\",\n                      isActive\n                        ? \"bg-secondary text-foreground\"\n                        : \"text-muted-foreground hover:bg-secondary/50 hover:text-foreground\"\n                    )}\n                  >\n                    <Icon className=\"h-6 w-6\" />\n                  </Link>\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">\n                  {item.label}\n                </TooltipContent>\n              </Tooltip>\n            );\n          })}\n\n          {/* Search button - after Projects */}\n          <Tooltip delayDuration={0}>\n            <TooltipTrigger asChild>\n              <button\n                onClick={() => setSearchOpen(true)}\n                className=\"flex h-12 w-12 items-center justify-center rounded-xl text-muted-foreground transition-colors hover:bg-secondary/50 hover:text-foreground\"\n              >\n                <Search className=\"h-6 w-6\" />\n              </button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              Search\n              <kbd className=\"ml-2 pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground\">\n                <span className=\"text-xs\">⌘</span>K\n              </kbd>\n            </TooltipContent>\n          </Tooltip>\n\n          {navItemsAfterSearch.map((item) => {\n            const isActive =\n              pathname === item.href ||\n              (item.href !== \"/\" && pathname.startsWith(item.href));\n            const Icon = item.icon;\n            const isNotifications = item.href === \"/notifications\";\n\n            return (\n              <Tooltip key={item.href} delayDuration={0}>\n                <TooltipTrigger asChild>\n                  <Link\n                    href={item.href}\n                    className={cn(\n                      \"relative flex h-12 w-12 items-center justify-center rounded-xl transition-colors\",\n                      isActive\n                        ? \"bg-secondary text-foreground\"\n                        : \"text-muted-foreground hover:bg-secondary/50 hover:text-foreground\"\n                    )}\n                  >\n                    <Icon className=\"h-6 w-6\" />\n                    {isNotifications && showNotificationBadge && (\n                      <span className=\"absolute right-1.5 top-1.5 flex h-4 min-w-4 items-center justify-center rounded-full bg-blue-500 px-1 text-[10px] font-medium text-white\">\n                        {(unreadCount ?? 0) > 99 ? \"99+\" : unreadCount}\n                      </span>\n                    )}\n                  </Link>\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">\n                  {item.label}\n                </TooltipContent>\n              </Tooltip>\n            );\n          })}\n\n          {/* Compose button - direct link if no drafts, popover if drafts exist */}\n          {hasDrafts ? (\n            <Popover open={composeOpen} onOpenChange={setComposeOpen}>\n              <Tooltip delayDuration={0}>\n                <TooltipTrigger asChild>\n                  <PopoverTrigger asChild>\n                    <button\n                      className={cn(\n                        \"flex h-12 w-12 items-center justify-center rounded-xl transition-colors hover:bg-secondary/50 hover:text-foreground\",\n                        composeOpen ? \"bg-secondary text-foreground\" : \"text-muted-foreground\"\n                      )}\n                    >\n                      <Plus className=\"h-6 w-6\" />\n                    </button>\n                  </PopoverTrigger>\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">New Post</TooltipContent>\n              </Tooltip>\n              <PopoverContent side=\"right\" align=\"start\" className=\"w-72 p-0\">\n                <div className=\"p-2\">\n                  <Link\n                    href=\"/compose\"\n                    onClick={() => setComposeOpen(false)}\n                    className=\"flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm font-medium hover:bg-secondary\"\n                  >\n                    <Plus className=\"h-4 w-4\" />\n                    New post\n                  </Link>\n                </div>\n                <div className=\"border-t\" />\n                <div className=\"p-2\">\n                  <p className=\"px-3 py-1.5 text-xs font-medium text-muted-foreground\">\n                    Drafts\n                  </p>\n                  <div className=\"space-y-0.5\">\n                    {drafts.map((draft) => (\n                      <Link\n                        key={draft.id}\n                        href={`/compose?draft=${draft.id}`}\n                        onClick={() => setComposeOpen(false)}\n                        className=\"flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm hover:bg-secondary\"\n                      >\n                        <DraftThumbnail url={draft.firstImageUrl} />\n                        <div className=\"flex-1 overflow-hidden\">\n                          <p className=\"truncate font-medium\">\n                            {getDraftDisplayInfo(draft)}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {formatRelativeTime(draft.updatedAt)}\n                          </p>\n                        </div>\n                      </Link>\n                    ))}\n                  </div>\n                </div>\n              </PopoverContent>\n            </Popover>\n          ) : (\n            <Tooltip delayDuration={0}>\n              <TooltipTrigger asChild>\n                <Link\n                  href=\"/compose\"\n                  className=\"flex h-12 w-12 items-center justify-center rounded-xl text-muted-foreground transition-colors hover:bg-secondary/50 hover:text-foreground\"\n                >\n                  <Plus className=\"h-6 w-6\" />\n                </Link>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\">New Post</TooltipContent>\n            </Tooltip>\n          )}\n        </nav>\n\n        {/* Profile at bottom */}\n        <div className=\"flex flex-col items-center gap-1 pb-4\">\n          <DropdownMenu>\n            <Tooltip delayDuration={0}>\n              <TooltipTrigger asChild>\n                <DropdownMenuTrigger asChild>\n                  <button className=\"flex h-12 w-12 items-center justify-center rounded-xl transition-colors cursor-pointer hover:bg-secondary/50\">\n                    <UserAvatar avatarUrl={avatarUrl} name={user.name} className=\"h-8 w-8\" />\n                  </button>\n                </DropdownMenuTrigger>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\">Profile</TooltipContent>\n            </Tooltip>\n            <DropdownMenuContent side=\"right\" align=\"end\" className=\"w-56\">\n              <DropdownMenuLabel className=\"font-normal\">\n                <div className=\"flex flex-col space-y-1\">\n                  <p className=\"text-sm font-medium leading-none\">{user.name}</p>\n                  <p className=\"text-xs leading-none text-muted-foreground\">\n                    {user.email}\n                  </p>\n                </div>\n              </DropdownMenuLabel>\n              <DropdownMenuSeparator />\n              <DropdownMenuItem asChild>\n                <Link href={`/user/${user.id}`}>\n                  <User className=\"mr-2 h-4 w-4\" />\n                  View Profile\n                </Link>\n              </DropdownMenuItem>\n              <DropdownMenuItem asChild>\n                <Link href=\"/settings\">\n                  <Settings className=\"mr-2 h-4 w-4\" />\n                  Settings\n                </Link>\n              </DropdownMenuItem>\n              {(user.role === \"ADMIN\" || user.role === \"OWNER\") && (\n                <DropdownMenuItem asChild>\n                  <Link href=\"/admin/settings\">\n                    <Shield className=\"mr-2 h-4 w-4\" />\n                    Site Admin\n                  </Link>\n                </DropdownMenuItem>\n              )}\n              <DropdownMenuSeparator />\n              <DropdownMenuItem\n                className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\"\n                onClick={() => signOut({ callbackUrl: \"/sign-in\" })}\n              >\n                <LogOut className=\"mr-2 h-4 w-4\" />\n                Sign out\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </aside>\n\n      {/* Search Command Dialog */}\n      <SearchCommand open={searchOpen} onOpenChange={setSearchOpen} />\n\n      {/* Mobile Bottom Tab Bar - shown only on mobile */}\n      <nav className=\"fixed bottom-0 left-0 right-0 z-50 flex h-16 items-center justify-around border-t bg-background px-2 sm:hidden\">\n        {mobileNavItemsBeforeSearch.map((item) => {\n          const isActive =\n            pathname === item.href ||\n            (item.href !== \"/\" && pathname.startsWith(item.href));\n          const Icon = item.icon;\n\n          return (\n            <Link\n              key={item.href}\n              href={item.href}\n              className={cn(\n                \"flex h-12 w-12 flex-col items-center justify-center rounded-xl transition-colors\",\n                isActive\n                  ? \"text-foreground\"\n                  : \"text-muted-foreground\"\n              )}\n            >\n              <Icon className=\"h-6 w-6\" />\n            </Link>\n          );\n        })}\n\n        {/* Mobile Search button - after Projects */}\n        <button\n          onClick={() => setSearchOpen(true)}\n          className=\"flex h-12 w-12 flex-col items-center justify-center rounded-xl text-muted-foreground transition-colors\"\n        >\n          <Search className=\"h-6 w-6\" />\n        </button>\n\n        {mobileNavItemsAfterSearch.map((item) => {\n          const isActive =\n            pathname === item.href ||\n            (item.href !== \"/\" && pathname.startsWith(item.href));\n          const Icon = item.icon;\n          const isNotifications = item.href === \"/notifications\";\n\n          return (\n            <Link\n              key={item.href}\n              href={item.href}\n              className={cn(\n                \"relative flex h-12 w-12 flex-col items-center justify-center rounded-xl transition-colors\",\n                isActive\n                  ? \"text-foreground\"\n                  : \"text-muted-foreground\"\n              )}\n            >\n              <Icon className=\"h-6 w-6\" />\n              {isNotifications && showNotificationBadge && (\n                <span className=\"absolute right-0 top-0 flex h-4 min-w-4 items-center justify-center rounded-full bg-blue-500 px-1 text-[10px] font-medium text-white\">\n                  {(unreadCount ?? 0) > 99 ? \"99+\" : unreadCount}\n                </span>\n              )}\n            </Link>\n          );\n        })}\n\n        {/* Mobile Compose button - direct link if no drafts, popover if drafts exist */}\n        {hasDrafts ? (\n          <Popover>\n            <PopoverTrigger asChild>\n              <button className=\"flex h-12 w-12 flex-col items-center justify-center rounded-xl text-muted-foreground transition-colors\">\n                <Plus className=\"h-6 w-6\" />\n              </button>\n            </PopoverTrigger>\n            <PopoverContent side=\"top\" align=\"center\" className=\"w-72 p-0\">\n              <div className=\"p-2\">\n                <Link\n                  href=\"/compose\"\n                  className=\"flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm font-medium hover:bg-secondary\"\n                >\n                  <Plus className=\"h-4 w-4\" />\n                  New post\n                </Link>\n              </div>\n              <div className=\"border-t\" />\n              <div className=\"max-h-64 overflow-y-auto p-2\">\n                <p className=\"px-3 py-1.5 text-xs font-medium text-muted-foreground\">\n                  Drafts\n                </p>\n                <div className=\"space-y-0.5\">\n                  {drafts.map((draft) => (\n                    <Link\n                      key={draft.id}\n                      href={`/compose?draft=${draft.id}`}\n                      className=\"flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm hover:bg-secondary\"\n                    >\n                      <DraftThumbnail url={draft.firstImageUrl} />\n                      <div className=\"flex-1 overflow-hidden\">\n                        <p className=\"truncate font-medium\">\n                          {getDraftDisplayInfo(draft)}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {formatRelativeTime(draft.updatedAt)}\n                        </p>\n                      </div>\n                    </Link>\n                  ))}\n                </div>\n              </div>\n            </PopoverContent>\n          </Popover>\n        ) : (\n          <Link\n            href=\"/compose\"\n            className=\"flex h-12 w-12 flex-col items-center justify-center rounded-xl text-muted-foreground transition-colors\"\n          >\n            <Plus className=\"h-6 w-6\" />\n          </Link>\n        )}\n\n        {/* Profile tab */}\n        <Link\n          href={`/user/${user.id}`}\n          className={cn(\n            \"flex h-12 w-12 flex-col items-center justify-center rounded-xl transition-colors\",\n            pathname.startsWith(\"/user/\")\n              ? \"text-foreground\"\n              : \"text-muted-foreground\"\n          )}\n        >\n          <User className=\"h-6 w-6\" />\n        </Link>\n      </nav>\n    </>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/app/(main)/admin/settings/page.tsx",
        "size": 17812,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { Button } from \"~/components/ui/button\";\nimport { Input } from \"~/components/ui/input\";\nimport { Label } from \"~/components/ui/label\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"~/components/ui/card\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Loader2, Copy, RefreshCw, Check, Trash2, Plus, CheckCircle2, XCircle } from \"lucide-react\";\nimport { EmojiUpload, EmojiImage } from \"~/components/settings/EmojiUpload\";\n\nexport default function AdminSettingsPage() {\n  const [copied, setCopied] = useState(false);\n  const utils = api.useUtils();\n\n  const { data: settings, isLoading } = api.site.getSettings.useQuery();\n\n  const regenerateMutation = api.site.regenerateInvite.useMutation({\n    onSuccess: () => {\n      utils.site.getSettings.invalidate();\n    },\n  });\n\n  const updateMutation = api.site.updateSettings.useMutation({\n    onSuccess: () => {\n      utils.site.getSettings.invalidate();\n    },\n  });\n\n  const inviteUrl = settings\n    ? `${typeof window !== \"undefined\" ? window.location.origin : \"\"}/invite/${settings.inviteToken}`\n    : \"\";\n\n  const copyInviteLink = async () => {\n    await navigator.clipboard.writeText(inviteUrl);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center py-8\">\n        <Loader2 className=\"h-6 w-6 animate-spin\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Invite Link</CardTitle>\n          <CardDescription>\n            Share this link with people you want to invite to Draftboard.\n            Anyone with this link can create an account.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"inviteLink\">Invite URL</Label>\n            <div className=\"flex gap-2\">\n              <Input\n                id=\"inviteLink\"\n                value={inviteUrl}\n                readOnly\n                className=\"font-mono text-sm\"\n              />\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                onClick={copyInviteLink}\n                title=\"Copy invite link\"\n              >\n                {copied ? (\n                  <Check className=\"h-4 w-4 text-green-500\" />\n                ) : (\n                  <Copy className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-4\">\n            <Button\n              variant=\"outline\"\n              onClick={() => regenerateMutation.mutate()}\n              disabled={regenerateMutation.isPending}\n            >\n              {regenerateMutation.isPending ? (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              ) : (\n                <RefreshCw className=\"mr-2 h-4 w-4\" />\n              )}\n              Regenerate Link\n            </Button>\n            <p className=\"text-sm text-muted-foreground\">\n              Regenerating will invalidate the current link.\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Site Settings</CardTitle>\n          <CardDescription>\n            Configure your Draftboard instance.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <SiteNameForm \n            currentName={settings?.siteName || \"Draftboard\"} \n            onSave={(siteName) => updateMutation.mutate({ siteName })}\n            isPending={updateMutation.isPending}\n          />\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Custom Emoji</CardTitle>\n          <CardDescription>\n            Add custom emoji that can be used as reactions throughout Draftboard.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <CustomEmojiSection />\n        </CardContent>\n      </Card>\n\n      <IntegrationsSettings />\n    </div>\n  );\n}\n\nfunction SiteNameForm({\n  currentName,\n  onSave,\n  isPending,\n}: {\n  currentName: string;\n  onSave: (name: string) => void;\n  isPending: boolean;\n}) {\n  const [siteName, setSiteName] = useState(currentName);\n\n  return (\n    <form\n      onSubmit={(e) => {\n        e.preventDefault();\n        onSave(siteName);\n      }}\n      className=\"space-y-4\"\n    >\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"siteName\">Site Name</Label>\n        <Input\n          id=\"siteName\"\n          value={siteName}\n          onChange={(e) => setSiteName(e.target.value)}\n          placeholder=\"Draftboard\"\n        />\n      </div>\n      <Button type=\"submit\" disabled={isPending || siteName === currentName}>\n        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n        Save Changes\n      </Button>\n    </form>\n  );\n}\n\nfunction CustomEmojiSection() {\n  const [isAdding, setIsAdding] = useState(false);\n  const [newEmojiName, setNewEmojiName] = useState(\"\");\n  const [newEmojiUrl, setNewEmojiUrl] = useState<string | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const utils = api.useUtils();\n\n  const { data: emojis, isLoading } = api.reaction.listEmoji.useQuery();\n\n  const createMutation = api.reaction.createEmoji.useMutation({\n    onSuccess: () => {\n      utils.reaction.listEmoji.invalidate();\n      setIsAdding(false);\n      setNewEmojiName(\"\");\n      setNewEmojiUrl(null);\n      setError(null);\n    },\n    onError: (err) => {\n      setError(err.message);\n    },\n  });\n\n  const deleteMutation = api.reaction.deleteEmoji.useMutation({\n    onSuccess: () => {\n      utils.reaction.listEmoji.invalidate();\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newEmojiName || !newEmojiUrl) {\n      setError(\"Please provide both a name and an image\");\n      return;\n    }\n    if (!/^[a-z0-9_]+$/.test(newEmojiName)) {\n      setError(\"Name can only contain lowercase letters, numbers, and underscores\");\n      return;\n    }\n    createMutation.mutate({ name: newEmojiName, imageUrl: newEmojiUrl });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center py-4\">\n        <Loader2 className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {emojis && emojis.length > 0 && (\n        <div className=\"space-y-2\">\n          <Label>Current Emoji</Label>\n          <div className=\"flex flex-wrap gap-2\">\n            {emojis.map((emoji) => (\n              <div\n                key={emoji.id}\n                className=\"group flex items-center gap-2 rounded-md border bg-muted/50 px-2 py-1\"\n              >\n                <EmojiImage url={emoji.imageUrl} alt={emoji.name} className=\"h-6 w-6\" />\n                <span className=\"text-sm\">:{emoji.name}:</span>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity\"\n                  onClick={() => deleteMutation.mutate({ id: emoji.id })}\n                  disabled={deleteMutation.isPending}\n                >\n                  <Trash2 className=\"h-3 w-3 text-muted-foreground hover:text-destructive\" />\n                </Button>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {isAdding ? (\n        <form onSubmit={handleSubmit} className=\"space-y-4 rounded-lg border p-4\">\n          <div className=\"flex items-start gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Image</Label>\n              <EmojiUpload value={newEmojiUrl} onChange={setNewEmojiUrl} />\n            </div>\n            <div className=\"flex-1 space-y-2\">\n              <Label htmlFor=\"emojiName\">Name</Label>\n              <Input\n                id=\"emojiName\"\n                value={newEmojiName}\n                onChange={(e) => setNewEmojiName(e.target.value.toLowerCase())}\n                placeholder=\"my_emoji\"\n                pattern=\"^[a-z0-9_]+$\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Lowercase letters, numbers, and underscores only\n              </p>\n            </div>\n          </div>\n          {error && <p className=\"text-sm text-destructive\">{error}</p>}\n          <div className=\"flex gap-2\">\n            <Button type=\"submit\" disabled={createMutation.isPending}>\n              {createMutation.isPending && (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              )}\n              Add Emoji\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => {\n                setIsAdding(false);\n                setNewEmojiName(\"\");\n                setNewEmojiUrl(null);\n                setError(null);\n              }}\n            >\n              Cancel\n            </Button>\n          </div>\n        </form>\n      ) : (\n        <Button variant=\"outline\" onClick={() => setIsAdding(true)}>\n          <Plus className=\"mr-2 h-4 w-4\" />\n          Add Custom Emoji\n        </Button>\n      )}\n    </div>\n  );\n}\n\nfunction IntegrationsSettings() {\n  const { data: settings, isLoading } = api.site.getSettings.useQuery();\n  const [discordUrl, setDiscordUrl] = useState(\"\");\n  const [slackUrl, setSlackUrl] = useState(\"\");\n  const [discordTestResult, setDiscordTestResult] = useState<{ success: boolean; error?: string } | null>(null);\n  const [slackTestResult, setSlackTestResult] = useState<{ success: boolean; error?: string } | null>(null);\n\n  const utils = api.useUtils();\n\n  // Initialize form values when settings load\n  useEffect(() => {\n    if (settings) {\n      setDiscordUrl(settings.discordWebhookUrl || \"\");\n      setSlackUrl(settings.slackWebhookUrl || \"\");\n    }\n  }, [settings]);\n\n  const updateMutation = api.site.updateWebhooks.useMutation({\n    onSuccess: () => {\n      utils.site.getSettings.invalidate();\n    },\n  });\n\n  const testMutation = api.site.testWebhook.useMutation();\n\n  const handleSave = (e: React.FormEvent) => {\n    e.preventDefault();\n    setDiscordTestResult(null);\n    setSlackTestResult(null);\n    updateMutation.mutate({\n      discordWebhookUrl: discordUrl,\n      slackWebhookUrl: slackUrl,\n    });\n  };\n\n  const handleTestDiscord = async () => {\n    if (!discordUrl) return;\n    setDiscordTestResult(null);\n    const result = await testMutation.mutateAsync({ type: \"discord\", url: discordUrl });\n    setDiscordTestResult(result);\n  };\n\n  const handleTestSlack = async () => {\n    if (!slackUrl) return;\n    setSlackTestResult(null);\n    const result = await testMutation.mutateAsync({ type: \"slack\", url: slackUrl });\n    setSlackTestResult(result);\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardContent className=\"py-8\">\n          <div className=\"flex justify-center\">\n            <Loader2 className=\"h-6 w-6 animate-spin\" />\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Integrations</CardTitle>\n        <CardDescription>\n          Configure webhook notifications to send new post alerts to Discord and Slack channels.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSave} className=\"space-y-6\">\n          {/* Discord Webhook */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <svg className=\"h-5 w-5\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                <path d=\"M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z\"/>\n              </svg>\n              <Label htmlFor=\"discord-webhook\">Discord Webhook URL</Label>\n            </div>\n            <div className=\"flex gap-2\">\n              <Input\n                id=\"discord-webhook\"\n                type=\"url\"\n                placeholder=\"https://discord.com/api/webhooks/...\"\n                value={discordUrl}\n                onChange={(e) => setDiscordUrl(e.target.value)}\n                className=\"flex-1\"\n              />\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={handleTestDiscord}\n                disabled={!discordUrl || testMutation.isPending}\n              >\n                {testMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                ) : (\n                  \"Test\"\n                )}\n              </Button>\n            </div>\n            {discordTestResult && (\n              <div className={`flex items-center gap-2 text-sm ${discordTestResult.success ? \"text-green-600\" : \"text-red-600\"}`}>\n                {discordTestResult.success ? (\n                  <>\n                    <CheckCircle2 className=\"h-4 w-4\" />\n                    Test message sent successfully!\n                  </>\n                ) : (\n                  <>\n                    <XCircle className=\"h-4 w-4\" />\n                    Failed: {discordTestResult.error}\n                  </>\n                )}\n              </div>\n            )}\n            <p className=\"text-xs text-muted-foreground\">\n              Create a webhook in your Discord server: Server Settings → Integrations → Webhooks → New Webhook\n            </p>\n          </div>\n\n          {/* Slack Webhook */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <svg className=\"h-5 w-5\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                <path d=\"M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z\"/>\n              </svg>\n              <Label htmlFor=\"slack-webhook\">Slack Webhook URL</Label>\n            </div>\n            <div className=\"flex gap-2\">\n              <Input\n                id=\"slack-webhook\"\n                type=\"url\"\n                placeholder=\"https://hooks.slack.com/services/...\"\n                value={slackUrl}\n                onChange={(e) => setSlackUrl(e.target.value)}\n                className=\"flex-1\"\n              />\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={handleTestSlack}\n                disabled={!slackUrl || testMutation.isPending}\n              >\n                {testMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                ) : (\n                  \"Test\"\n                )}\n              </Button>\n            </div>\n            {slackTestResult && (\n              <div className={`flex items-center gap-2 text-sm ${slackTestResult.success ? \"text-green-600\" : \"text-red-600\"}`}>\n                {slackTestResult.success ? (\n                  <>\n                    <CheckCircle2 className=\"h-4 w-4\" />\n                    Test message sent successfully!\n                  </>\n                ) : (\n                  <>\n                    <XCircle className=\"h-4 w-4\" />\n                    Failed: {slackTestResult.error}\n                  </>\n                )}\n              </div>\n            )}\n            <p className=\"text-xs text-muted-foreground\">\n              Create a Slack app and enable Incoming Webhooks: api.slack.com/apps → Create App → Incoming Webhooks\n            </p>\n          </div>\n\n          <Button type=\"submit\" disabled={updateMutation.isPending}>\n            {updateMutation.isPending && (\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            )}\n            Save Webhook Settings\n          </Button>\n\n          {updateMutation.isSuccess && (\n            <p className=\"text-sm text-green-600\">Settings saved successfully!</p>\n          )}\n        </form>\n      </CardContent>\n    </Card>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/nodes/AttachmentNode.tsx",
        "size": 16733,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport * as React from \"react\";\nimport {\n  type DOMExportOutput,\n  type EditorConfig,\n  type LexicalNode,\n  type NodeKey,\n  type SerializedLexicalNode,\n  type Spread,\n  DecoratorNode,\n  $getNodeByKey,\n} from \"lexical\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport { Suspense, useEffect, useState, useId } from \"react\";\nimport { FileIcon, Download, Play, ExternalLink, Loader2, X } from \"lucide-react\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Lightbox } from \"~/components/ui/lightbox\";\nimport { useMediaLightbox } from \"~/components/ui/media-lightbox-context\";\n\nexport type AttachmentType = \"IMAGE\" | \"VIDEO\" | \"FILE\" | \"FIGMA\" | \"LOOM\";\n\nexport type SerializedAttachmentNode = Spread<\n  {\n    attachmentType: AttachmentType;\n    url: string;\n    filename: string;\n    mimeType: string;\n    size: number;\n    thumbnailUrl?: string;\n    width?: number;\n    height?: number;\n    metadata?: Record<string, unknown>;\n  },\n  SerializedLexicalNode\n>;\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes < 1024) return `${bytes} B`;\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n}\n\n// Extract R2 key from URL if it's an R2 URL\nfunction extractR2Key(url: string): string | null {\n  // Match patterns like:\n  // https://bucket.accountid.r2.cloudflarestorage.com/uploads/userid/timestamp-filename\n  // https://custom-domain.com/uploads/userid/timestamp-filename\n  const match = url.match(/uploads\\/[^\\/]+\\/[^\\/]+$/);\n  if (match) {\n    return match[0];\n  }\n  return null;\n}\n\nfunction AttachmentComponent({\n  attachmentType,\n  url,\n  filename,\n  mimeType,\n  size,\n  thumbnailUrl,\n  width,\n  height,\n  nodeKey,\n}: {\n  attachmentType: AttachmentType;\n  url: string;\n  filename: string;\n  mimeType: string;\n  size: number;\n  thumbnailUrl?: string;\n  width?: number;\n  height?: number;\n  nodeKey: NodeKey;\n}) {\n  const [editor] = useLexicalComposerContext();\n  const [isEditable, setIsEditable] = useState(() => editor.isEditable());\n  const [displayUrl, setDisplayUrl] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [fallbackLightboxOpen, setFallbackLightboxOpen] = useState(false);\n\n  // Generate a stable unique ID for this attachment\n  const instanceId = useId();\n  const mediaId = `${instanceId}-${url}`;\n\n  // Try to use the shared media lightbox context (available on post detail pages)\n  const mediaLightbox = useMediaLightbox();\n\n  // Listen for editability changes\n  useEffect(() => {\n    return editor.registerEditableListener((editable) => {\n      setIsEditable(editable);\n    });\n  }, [editor]);\n\n  const handleDelete = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    editor.update(() => {\n      const node = $getNodeByKey(nodeKey);\n      if (node) {\n        node.remove();\n      }\n    });\n  };\n\n  const r2Key = extractR2Key(url);\n  const { data: signedUrlData, isLoading: isLoadingUrl, error: urlError } = api.upload.getDownloadUrl.useQuery(\n    { key: r2Key! },\n    {\n      enabled: !!r2Key && (attachmentType === \"IMAGE\" || attachmentType === \"VIDEO\"),\n      staleTime: 30 * 60 * 1000, // Cache for 30 minutes (URL expires in 1 hour)\n      refetchOnWindowFocus: false,\n    }\n  );\n\n  useEffect(() => {\n    if (attachmentType !== \"IMAGE\" && attachmentType !== \"VIDEO\") {\n      // For non-media types, use original URL\n      setDisplayUrl(url);\n      setIsLoading(false);\n      return;\n    }\n\n    if (!r2Key) {\n      // If we can't extract a key, try using the URL directly\n      setDisplayUrl(url);\n      setIsLoading(false);\n      return;\n    }\n\n    if (signedUrlData) {\n      setDisplayUrl(signedUrlData.url);\n      setIsLoading(false);\n    } else if (urlError) {\n      // If signed URL fails, try original URL\n      setDisplayUrl(url);\n      setIsLoading(false);\n      setError(\"Could not load signed URL, trying direct URL\");\n    } else if (isLoadingUrl) {\n      setIsLoading(true);\n    }\n  }, [attachmentType, url, r2Key, signedUrlData, urlError, isLoadingUrl]);\n\n  // Register this media item with the shared lightbox context\n  useEffect(() => {\n    if (!mediaLightbox) return;\n    if (attachmentType !== \"IMAGE\" && attachmentType !== \"VIDEO\") return;\n\n    const finalUrl = displayUrl || url;\n    if (!finalUrl || isLoading) return;\n\n    mediaLightbox.registerItem({\n      id: mediaId,\n      type: attachmentType === \"IMAGE\" ? \"image\" : \"video\",\n      url: finalUrl,\n      filename,\n      thumbnailUrl,\n    });\n\n    return () => {\n      mediaLightbox.unregisterItem(mediaId);\n    };\n  }, [mediaLightbox, mediaId, attachmentType, displayUrl, url, filename, thumbnailUrl, isLoading]);\n\n  const handleMediaClick = () => {\n    if (mediaLightbox) {\n      mediaLightbox.openAt(mediaId);\n    } else {\n      // Fallback to individual lightbox if no shared context\n      setFallbackLightboxOpen(true);\n    }\n  };\n\n  // Delete button component for reuse\n  const DeleteButton = () => (\n    <button\n      type=\"button\"\n      onClick={handleDelete}\n      className=\"absolute right-2 top-2 z-10 flex h-7 w-7 items-center justify-center rounded-full bg-black/60 text-white opacity-0 transition-opacity hover:bg-black/80 group-hover:opacity-100 focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-white\"\n      aria-label=\"Remove attachment\"\n    >\n      <X className=\"h-4 w-4\" />\n    </button>\n  );\n\n  if (attachmentType === \"IMAGE\") {\n    if (isLoading) {\n      return (\n        <div className=\"my-4 flex h-48 items-center justify-center rounded-lg bg-muted\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n        </div>\n      );\n    }\n\n    return (\n      <>\n        <div className=\"group relative my-4 inline-block\">\n          {isEditable && <DeleteButton />}\n          <button\n            type=\"button\"\n            onClick={handleMediaClick}\n            className=\"block cursor-zoom-in focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-lg\"\n          >\n            <div className=\"inline-block rounded-lg bg-muted/50\">\n              <img\n                src={displayUrl || url}\n                alt={filename}\n                width={width}\n                height={height}\n                className=\"max-w-full rounded-lg\"\n                loading=\"lazy\"\n                onError={(e) => {\n                  // If image fails to load, show error state\n                  const target = e.target as HTMLImageElement;\n                  target.style.display = 'none';\n                  console.error(\"Image failed to load:\", displayUrl || url);\n                }}\n              />\n            </div>\n          </button>\n        </div>\n        {/* Fallback lightbox when not using shared context */}\n        {!mediaLightbox && (\n          <Lightbox\n            images={[{ id: \"single\", type: \"image\", url: displayUrl || url, filename }]}\n            initialIndex={0}\n            isOpen={fallbackLightboxOpen}\n            onClose={() => setFallbackLightboxOpen(false)}\n          />\n        )}\n      </>\n    );\n  }\n\n  if (attachmentType === \"VIDEO\") {\n    if (isLoading) {\n      return (\n        <div className=\"my-4 flex h-48 items-center justify-center rounded-lg bg-muted\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n        </div>\n      );\n    }\n\n    return (\n      <>\n        <div className=\"group relative my-4 inline-block\">\n          {isEditable && <DeleteButton />}\n          <button\n            type=\"button\"\n            onClick={handleMediaClick}\n            className=\"block cursor-zoom-in focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-lg\"\n          >\n            <div className=\"inline-block rounded-lg bg-muted/50 relative\">\n              {thumbnailUrl ? (\n                <img\n                  src={thumbnailUrl}\n                  alt={filename}\n                  className=\"max-w-full rounded-lg\"\n                  loading=\"lazy\"\n                />\n              ) : (\n                <video\n                  src={displayUrl || url}\n                  className=\"max-w-full rounded-lg pointer-events-none\"\n                  muted\n                  preload=\"metadata\"\n                >\n                  <track kind=\"captions\" />\n                </video>\n              )}\n              <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n                <div className=\"rounded-full bg-black/60 p-3 transition-colors\">\n                  <Play className=\"h-8 w-8 text-white fill-white\" />\n                </div>\n              </div>\n            </div>\n          </button>\n        </div>\n        {/* Fallback lightbox when not using shared context */}\n        {!mediaLightbox && (\n          <Lightbox\n            images={[{ id: \"single\", type: \"video\", url: displayUrl || url, filename }]}\n            initialIndex={0}\n            isOpen={fallbackLightboxOpen}\n            onClose={() => setFallbackLightboxOpen(false)}\n          />\n        )}\n      </>\n    );\n  }\n\n  if (attachmentType === \"FIGMA\") {\n    return (\n      <div className=\"group relative my-4\">\n        {isEditable && <DeleteButton />}\n        <a\n          href={url}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"flex items-center gap-3 rounded-lg border border-border bg-card p-4 pr-7 transition-colors hover:bg-muted\"\n        >\n          <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-[#1e1e1e]\">\n            <svg viewBox=\"0 0 38 57\" className=\"h-6 w-6\" fill=\"none\">\n              <path\n                d=\"M19 28.5a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z\"\n                fill=\"#1ABCFE\"\n              />\n              <path\n                d=\"M0 47.5A9.5 9.5 0 0 1 9.5 38H19v9.5a9.5 9.5 0 1 1-19 0z\"\n                fill=\"#0ACF83\"\n              />\n              <path\n                d=\"M19 0v19h9.5a9.5 9.5 0 1 0 0-19H19z\"\n                fill=\"#FF7262\"\n              />\n              <path\n                d=\"M0 9.5A9.5 9.5 0 0 0 9.5 19H19V0H9.5A9.5 9.5 0 0 0 0 9.5z\"\n                fill=\"#F24E1E\"\n              />\n              <path\n                d=\"M0 28.5A9.5 9.5 0 0 0 9.5 38H19V19H9.5A9.5 9.5 0 0 0 0 28.5z\"\n                fill=\"#A259FF\"\n              />\n            </svg>\n          </div>\n          <div className=\"flex-1 overflow-hidden\">\n            <p className=\"truncate font-medium\">{filename}</p>\n            <p className=\"text-sm text-muted-foreground\">Figma Design</p>\n          </div>\n          <ExternalLink className=\"h-4 w-4 text-muted-foreground\" />\n        </a>\n      </div>\n    );\n  }\n\n  if (attachmentType === \"LOOM\") {\n    return (\n      <div className=\"group relative my-4\">\n        {isEditable && <DeleteButton />}\n        <a\n          href={url}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"flex items-center gap-3 rounded-lg border border-border bg-card p-4 pr-7 transition-colors hover:bg-muted\"\n        >\n          <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-[#625df5]\">\n            <Play className=\"h-5 w-5 fill-white text-white\" />\n          </div>\n          <div className=\"flex-1 overflow-hidden\">\n            <p className=\"truncate font-medium\">{filename}</p>\n            <p className=\"text-sm text-muted-foreground\">Loom Recording</p>\n          </div>\n          <ExternalLink className=\"h-4 w-4 text-muted-foreground\" />\n        </a>\n      </div>\n    );\n  }\n\n  // Generic file attachment - use signed URL for download\n  const downloadKey = extractR2Key(url);\n  const { data: downloadUrlData } = api.upload.getDownloadUrl.useQuery(\n    { key: downloadKey! },\n    {\n      enabled: !!downloadKey,\n      staleTime: 30 * 60 * 1000,\n      refetchOnWindowFocus: false,\n    }\n  );\n\n  return (\n    <div className=\"group relative my-4\">\n      {isEditable && <DeleteButton />}\n      <a\n        href={downloadUrlData?.url || url}\n        download={filename}\n        className=\"flex items-center gap-3 rounded-lg border border-border bg-card p-4 pr-7 transition-colors hover:bg-muted\"\n      >\n        <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-muted\">\n          <FileIcon className=\"h-5 w-5 text-muted-foreground\" />\n        </div>\n        <div className=\"flex-1 overflow-hidden\">\n          <p className=\"truncate font-medium\">{filename}</p>\n          <p className=\"text-sm text-muted-foreground\">\n            {mimeType} · {formatFileSize(size)}\n          </p>\n        </div>\n        <Download className=\"h-4 w-4 text-muted-foreground\" />\n      </a>\n    </div>\n  );\n}\n\nexport class AttachmentNode extends DecoratorNode<React.ReactElement> {\n  __attachmentType: AttachmentType;\n  __url: string;\n  __filename: string;\n  __mimeType: string;\n  __size: number;\n  __thumbnailUrl?: string;\n  __width?: number;\n  __height?: number;\n  __metadata?: Record<string, unknown>;\n\n  static getType(): string {\n    return \"attachment\";\n  }\n\n  static clone(node: AttachmentNode): AttachmentNode {\n    return new AttachmentNode(\n      node.__attachmentType,\n      node.__url,\n      node.__filename,\n      node.__mimeType,\n      node.__size,\n      node.__thumbnailUrl,\n      node.__width,\n      node.__height,\n      node.__metadata,\n      node.__key\n    );\n  }\n\n  constructor(\n    attachmentType: AttachmentType,\n    url: string,\n    filename: string,\n    mimeType: string,\n    size: number,\n    thumbnailUrl?: string,\n    width?: number,\n    height?: number,\n    metadata?: Record<string, unknown>,\n    key?: NodeKey\n  ) {\n    super(key);\n    this.__attachmentType = attachmentType;\n    this.__url = url;\n    this.__filename = filename;\n    this.__mimeType = mimeType;\n    this.__size = size;\n    this.__thumbnailUrl = thumbnailUrl;\n    this.__width = width;\n    this.__height = height;\n    this.__metadata = metadata;\n  }\n\n  createDOM(_config: EditorConfig): HTMLElement {\n    const div = document.createElement(\"div\");\n    div.className = \"editor-attachment\";\n    return div;\n  }\n\n  updateDOM(): false {\n    return false;\n  }\n\n  exportDOM(): DOMExportOutput {\n    const element = document.createElement(\"div\");\n    element.setAttribute(\"data-attachment-type\", this.__attachmentType);\n    element.setAttribute(\"data-url\", this.__url);\n    element.setAttribute(\"data-filename\", this.__filename);\n    return { element };\n  }\n\n  static importJSON(serializedNode: SerializedAttachmentNode): AttachmentNode {\n    return $createAttachmentNode({\n      attachmentType: serializedNode.attachmentType,\n      url: serializedNode.url,\n      filename: serializedNode.filename,\n      mimeType: serializedNode.mimeType,\n      size: serializedNode.size,\n      thumbnailUrl: serializedNode.thumbnailUrl,\n      width: serializedNode.width,\n      height: serializedNode.height,\n      metadata: serializedNode.metadata,\n    });\n  }\n\n  exportJSON(): SerializedAttachmentNode {\n    return {\n      type: \"attachment\",\n      version: 1,\n      attachmentType: this.__attachmentType,\n      url: this.__url,\n      filename: this.__filename,\n      mimeType: this.__mimeType,\n      size: this.__size,\n      thumbnailUrl: this.__thumbnailUrl,\n      width: this.__width,\n      height: this.__height,\n      metadata: this.__metadata,\n    };\n  }\n\n  getUrl(): string {\n    return this.__url;\n  }\n\n  getFilename(): string {\n    return this.__filename;\n  }\n\n  decorate(): React.ReactElement {\n    return (\n      <Suspense fallback={<div className=\"my-4 h-48 animate-pulse rounded-lg bg-muted\" />}>\n        <AttachmentComponent\n          attachmentType={this.__attachmentType}\n          url={this.__url}\n          filename={this.__filename}\n          mimeType={this.__mimeType}\n          size={this.__size}\n          thumbnailUrl={this.__thumbnailUrl}\n          width={this.__width}\n          height={this.__height}\n          nodeKey={this.__key}\n        />\n      </Suspense>\n    );\n  }\n\n  isInline(): boolean {\n    return false;\n  }\n\n  isKeyboardSelectable(): boolean {\n    return true;\n  }\n}\n\nexport function $createAttachmentNode({\n  attachmentType,\n  url,\n  filename,\n  mimeType,\n  size,\n  thumbnailUrl,\n  width,\n  height,\n  metadata,\n}: {\n  attachmentType: AttachmentType;\n  url: string;\n  filename: string;\n  mimeType: string;\n  size: number;\n  thumbnailUrl?: string;\n  width?: number;\n  height?: number;\n  metadata?: Record<string, unknown>;\n}): AttachmentNode {\n  return new AttachmentNode(\n    attachmentType,\n    url,\n    filename,\n    mimeType,\n    size,\n    thumbnailUrl,\n    width,\n    height,\n    metadata\n  );\n}\n\nexport function $isAttachmentNode(\n  node: LexicalNode | null | undefined\n): node is AttachmentNode {\n  return node instanceof AttachmentNode;\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/DesignTokens.stories.tsx",
        "size": 13964,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\n\nconst meta: Meta = {\n  title: \"Foundation/Design Tokens\",\n  parameters: {\n    layout: \"fullscreen\",\n  },\n};\n\nexport default meta;\ntype Story = StoryObj;\n\nconst ColorSwatch = ({\n  name,\n  variable,\n  description,\n}: {\n  name: string;\n  variable: string;\n  description?: string;\n}) => (\n  <div className=\"flex items-center gap-4 p-3 rounded-lg border border-border\">\n    <div\n      className=\"w-16 h-16 rounded-lg border border-border shadow-sm shrink-0\"\n      style={{ backgroundColor: `var(${variable})` }}\n    />\n    <div className=\"min-w-0\">\n      <p className=\"font-medium text-foreground\">{name}</p>\n      <code className=\"text-xs text-muted-foreground font-mono\">{variable}</code>\n      {description && (\n        <p className=\"text-xs text-muted-foreground mt-1\">{description}</p>\n      )}\n    </div>\n  </div>\n);\n\nconst ColorSection = ({\n  title,\n  children,\n}: {\n  title: string;\n  children: React.ReactNode;\n}) => (\n  <div className=\"space-y-4\">\n    <h3 className=\"text-lg font-semibold text-foreground border-b border-border pb-2\">\n      {title}\n    </h3>\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n      {children}\n    </div>\n  </div>\n);\n\nexport const Colors: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Color Tokens</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Draftboard uses a warm, creative color palette that adapts between\n          light and dark modes. All colors are defined as CSS custom properties.\n        </p>\n      </div>\n\n      <ColorSection title=\"Base Colors\">\n        <ColorSwatch\n          name=\"Background\"\n          variable=\"--color-background\"\n          description=\"Main page background\"\n        />\n        <ColorSwatch\n          name=\"Foreground\"\n          variable=\"--color-foreground\"\n          description=\"Primary text color\"\n        />\n        <ColorSwatch\n          name=\"Card\"\n          variable=\"--color-card\"\n          description=\"Card/surface background\"\n        />\n        <ColorSwatch\n          name=\"Card Foreground\"\n          variable=\"--color-card-foreground\"\n          description=\"Text on cards\"\n        />\n        <ColorSwatch\n          name=\"Popover\"\n          variable=\"--color-popover\"\n          description=\"Popover/dropdown background\"\n        />\n        <ColorSwatch\n          name=\"Popover Foreground\"\n          variable=\"--color-popover-foreground\"\n          description=\"Text in popovers\"\n        />\n      </ColorSection>\n\n      <ColorSection title=\"Brand Colors\">\n        <ColorSwatch\n          name=\"Primary\"\n          variable=\"--color-primary\"\n          description=\"Primary actions, CTAs\"\n        />\n        <ColorSwatch\n          name=\"Primary Foreground\"\n          variable=\"--color-primary-foreground\"\n          description=\"Text on primary color\"\n        />\n        <ColorSwatch\n          name=\"Secondary\"\n          variable=\"--color-secondary\"\n          description=\"Secondary actions\"\n        />\n        <ColorSwatch\n          name=\"Secondary Foreground\"\n          variable=\"--color-secondary-foreground\"\n          description=\"Text on secondary\"\n        />\n        <ColorSwatch\n          name=\"Accent\"\n          variable=\"--color-accent\"\n          description=\"Accent highlights\"\n        />\n        <ColorSwatch\n          name=\"Accent Foreground\"\n          variable=\"--color-accent-foreground\"\n          description=\"Text on accent\"\n        />\n      </ColorSection>\n\n      <ColorSection title=\"Semantic Colors\">\n        <ColorSwatch\n          name=\"Muted\"\n          variable=\"--color-muted\"\n          description=\"Muted backgrounds\"\n        />\n        <ColorSwatch\n          name=\"Muted Foreground\"\n          variable=\"--color-muted-foreground\"\n          description=\"Muted/secondary text\"\n        />\n        <ColorSwatch\n          name=\"Destructive\"\n          variable=\"--color-destructive\"\n          description=\"Error states, delete actions\"\n        />\n        <ColorSwatch\n          name=\"Destructive Foreground\"\n          variable=\"--color-destructive-foreground\"\n          description=\"Text on destructive\"\n        />\n      </ColorSection>\n\n      <ColorSection title=\"UI Colors\">\n        <ColorSwatch\n          name=\"Border\"\n          variable=\"--color-border\"\n          description=\"Default border color\"\n        />\n        <ColorSwatch\n          name=\"Input\"\n          variable=\"--color-input\"\n          description=\"Input field borders\"\n        />\n        <ColorSwatch\n          name=\"Ring\"\n          variable=\"--color-ring\"\n          description=\"Focus ring color\"\n        />\n      </ColorSection>\n    </div>\n  ),\n};\n\nconst RadiusExample = ({ name, size }: { name: string; size: string }) => (\n  <div className=\"flex flex-col items-center gap-2\">\n    <div\n      className=\"w-20 h-20 bg-primary\"\n      style={{ borderRadius: `var(${size})` }}\n    />\n    <div className=\"text-center\">\n      <p className=\"font-medium text-foreground text-sm\">{name}</p>\n      <code className=\"text-xs text-muted-foreground font-mono\">{size}</code>\n    </div>\n  </div>\n);\n\nexport const Radius: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Border Radius</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Consistent border radius tokens used throughout the design system.\n        </p>\n      </div>\n\n      <div className=\"flex flex-wrap gap-8\">\n        <RadiusExample name=\"Small\" size=\"--radius-sm\" />\n        <RadiusExample name=\"Medium\" size=\"--radius-md\" />\n        <RadiusExample name=\"Large\" size=\"--radius-lg\" />\n        <RadiusExample name=\"XL\" size=\"--radius-xl\" />\n      </div>\n\n      <div className=\"p-4 bg-muted rounded-lg\">\n        <h4 className=\"font-medium mb-2\">Radius Values</h4>\n        <table className=\"text-sm w-full\">\n          <thead>\n            <tr className=\"text-left text-muted-foreground\">\n              <th className=\"pb-2\">Token</th>\n              <th className=\"pb-2\">Value</th>\n              <th className=\"pb-2\">Usage</th>\n            </tr>\n          </thead>\n          <tbody className=\"font-mono\">\n            <tr>\n              <td className=\"py-1\">--radius-sm</td>\n              <td>0.375rem (6px)</td>\n              <td className=\"font-sans text-muted-foreground\">\n                Badges, small elements\n              </td>\n            </tr>\n            <tr>\n              <td className=\"py-1\">--radius-md</td>\n              <td>0.5rem (8px)</td>\n              <td className=\"font-sans text-muted-foreground\">\n                Buttons, inputs\n              </td>\n            </tr>\n            <tr>\n              <td className=\"py-1\">--radius-lg</td>\n              <td>0.75rem (12px)</td>\n              <td className=\"font-sans text-muted-foreground\">\n                Dialogs, popovers\n              </td>\n            </tr>\n            <tr>\n              <td className=\"py-1\">--radius-xl</td>\n              <td>1rem (16px)</td>\n              <td className=\"font-sans text-muted-foreground\">\n                Cards, large containers\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n    </div>\n  ),\n};\n\nexport const Typography: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Typography</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Font families and type scale used in the design system.\n        </p>\n      </div>\n\n      <div className=\"space-y-6\">\n        <h3 className=\"text-lg font-semibold border-b border-border pb-2\">\n          Font Families\n        </h3>\n\n        <div className=\"space-y-4\">\n          <div className=\"p-4 rounded-lg border border-border\">\n            <p className=\"font-sans text-2xl\">Inter (Sans Serif)</p>\n            <code className=\"text-xs text-muted-foreground font-mono\">\n              --font-sans: \"Inter\", ui-sans-serif, system-ui, sans-serif\n            </code>\n            <p className=\"mt-2 text-muted-foreground\">\n              Primary font for UI elements, body text, and headings.\n            </p>\n          </div>\n\n          <div className=\"p-4 rounded-lg border border-border\">\n            <p className=\"font-mono text-2xl\">JetBrains Mono</p>\n            <code className=\"text-xs text-muted-foreground font-mono\">\n              --font-mono: \"JetBrains Mono\", ui-monospace, monospace\n            </code>\n            <p className=\"mt-2 text-muted-foreground font-sans\">\n              Used for code blocks, technical content, and tokens.\n            </p>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"space-y-6\">\n        <h3 className=\"text-lg font-semibold border-b border-border pb-2\">\n          Type Scale\n        </h3>\n\n        <div className=\"space-y-4\">\n          {[\n            { class: \"text-xs\", name: \"Extra Small\", size: \"12px\" },\n            { class: \"text-sm\", name: \"Small\", size: \"14px\" },\n            { class: \"text-base\", name: \"Base\", size: \"16px\" },\n            { class: \"text-lg\", name: \"Large\", size: \"18px\" },\n            { class: \"text-xl\", name: \"XL\", size: \"20px\" },\n            { class: \"text-2xl\", name: \"2XL\", size: \"24px\" },\n            { class: \"text-3xl\", name: \"3XL\", size: \"30px\" },\n            { class: \"text-4xl\", name: \"4XL\", size: \"36px\" },\n          ].map((item) => (\n            <div\n              key={item.class}\n              className=\"flex items-baseline gap-4 p-3 rounded-lg border border-border\"\n            >\n              <span className={item.class}>The quick brown fox</span>\n              <span className=\"text-sm text-muted-foreground ml-auto\">\n                {item.name} ({item.size})\n              </span>\n              <code className=\"text-xs font-mono text-muted-foreground\">\n                {item.class}\n              </code>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"space-y-6\">\n        <h3 className=\"text-lg font-semibold border-b border-border pb-2\">\n          Font Weights\n        </h3>\n\n        <div className=\"space-y-4\">\n          {[\n            { class: \"font-normal\", name: \"Normal\", weight: \"400\" },\n            { class: \"font-medium\", name: \"Medium\", weight: \"500\" },\n            { class: \"font-semibold\", name: \"Semibold\", weight: \"600\" },\n            { class: \"font-bold\", name: \"Bold\", weight: \"700\" },\n          ].map((item) => (\n            <div\n              key={item.class}\n              className=\"flex items-center gap-4 p-3 rounded-lg border border-border\"\n            >\n              <span className={`text-xl ${item.class}`}>\n                The quick brown fox\n              </span>\n              <span className=\"text-sm text-muted-foreground ml-auto\">\n                {item.name} ({item.weight})\n              </span>\n              <code className=\"text-xs font-mono text-muted-foreground\">\n                {item.class}\n              </code>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  ),\n};\n\nexport const Spacing: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Spacing</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Spacing scale used for margins, padding, and gaps.\n        </p>\n      </div>\n\n      <div className=\"space-y-4\">\n        {[\n          { value: \"0.5\", px: \"2px\", name: \"0.5\" },\n          { value: \"1\", px: \"4px\", name: \"1\" },\n          { value: \"1.5\", px: \"6px\", name: \"1.5\" },\n          { value: \"2\", px: \"8px\", name: \"2\" },\n          { value: \"3\", px: \"12px\", name: \"3\" },\n          { value: \"4\", px: \"16px\", name: \"4\" },\n          { value: \"5\", px: \"20px\", name: \"5\" },\n          { value: \"6\", px: \"24px\", name: \"6\" },\n          { value: \"8\", px: \"32px\", name: \"8\" },\n          { value: \"10\", px: \"40px\", name: \"10\" },\n          { value: \"12\", px: \"48px\", name: \"12\" },\n          { value: \"16\", px: \"64px\", name: \"16\" },\n        ].map((item) => (\n          <div\n            key={item.value}\n            className=\"flex items-center gap-4 p-2 rounded-lg border border-border\"\n          >\n            <div\n              className=\"bg-primary h-4 rounded shrink-0\"\n              style={{ width: item.px }}\n            />\n            <span className=\"font-medium w-12\">{item.name}</span>\n            <code className=\"text-xs font-mono text-muted-foreground\">\n              {item.px}\n            </code>\n            <code className=\"text-xs font-mono text-muted-foreground\">\n              p-{item.name}, m-{item.name}, gap-{item.name}\n            </code>\n          </div>\n        ))}\n      </div>\n    </div>\n  ),\n};\n\nexport const Shadows: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Shadows</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Shadow utilities for depth and elevation.\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8\">\n        {[\n          { class: \"shadow-sm\", name: \"Small Shadow\" },\n          { class: \"shadow\", name: \"Default Shadow\" },\n          { class: \"shadow-md\", name: \"Medium Shadow\" },\n          { class: \"shadow-lg\", name: \"Large Shadow\" },\n          { class: \"shadow-xl\", name: \"XL Shadow\" },\n          { class: \"shadow-2xl\", name: \"2XL Shadow\" },\n        ].map((item) => (\n          <div\n            key={item.class}\n            className={`p-6 bg-card rounded-lg border border-border ${item.class}`}\n          >\n            <p className=\"font-medium\">{item.name}</p>\n            <code className=\"text-xs font-mono text-muted-foreground\">\n              {item.class}\n            </code>\n          </div>\n        ))}\n      </div>\n    </div>\n  ),\n};\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/plugins/SlashCommandPlugin.tsx",
        "size": 13392,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useEffect, useMemo, useState, useRef } from \"react\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport {\n  $createParagraphNode,\n  $getSelection,\n  $isRangeSelection,\n  COMMAND_PRIORITY_LOW,\n  KEY_ARROW_DOWN_COMMAND,\n  KEY_ARROW_UP_COMMAND,\n  KEY_ENTER_COMMAND,\n  KEY_ESCAPE_COMMAND,\n  KEY_TAB_COMMAND,\n  TextNode,\n} from \"lexical\";\nimport { $setBlocksType } from \"@lexical/selection\";\nimport { $createHeadingNode, $createQuoteNode } from \"@lexical/rich-text\";\nimport { INSERT_ORDERED_LIST_COMMAND, INSERT_UNORDERED_LIST_COMMAND } from \"@lexical/list\";\nimport { mergeRegister } from \"@lexical/utils\";\nimport { createPortal } from \"react-dom\";\nimport {\n  Heading1,\n  Heading2,\n  Heading3,\n  List,\n  ListOrdered,\n  Quote,\n  ImagePlus,\n  FileUp,\n} from \"lucide-react\";\nimport { $createAttachmentNode, type AttachmentType } from \"../nodes/AttachmentNode\";\nimport { api } from \"~/lib/trpc/client\";\nimport { cn } from \"~/lib/utils\";\n\ninterface CommandOption {\n  name: string;\n  command: string;\n  icon: React.ReactNode;\n  description?: string;\n  section: \"media\" | \"blocks\";\n}\n\nconst COMMANDS: CommandOption[] = [\n  {\n    name: \"Image\",\n    command: \"image\",\n    icon: <ImagePlus className=\"h-4 w-4\" />,\n    description: \"Upload an image\",\n    section: \"media\",\n  },\n  {\n    name: \"File\",\n    command: \"file\",\n    icon: <FileUp className=\"h-4 w-4\" />,\n    description: \"Upload any file\",\n    section: \"media\",\n  },\n  {\n    name: \"Heading 1\",\n    command: \"heading1\",\n    icon: <Heading1 className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Heading 2\",\n    command: \"heading2\",\n    icon: <Heading2 className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Heading 3\",\n    command: \"heading3\",\n    icon: <Heading3 className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Bullet List\",\n    command: \"bulletList\",\n    icon: <List className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Numbered List\",\n    command: \"numberedList\",\n    icon: <ListOrdered className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Quote\",\n    command: \"quote\",\n    icon: <Quote className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n];\n\ninterface SlashCommandPluginProps {\n  anchorElem: HTMLElement;\n}\n\nexport function SlashCommandPlugin({ anchorElem }: SlashCommandPluginProps) {\n  const [editor] = useLexicalComposerContext();\n  const [isOpen, setIsOpen] = useState(false);\n  const [query, setQuery] = useState(\"\");\n  const [selectedIndex, setSelectedIndex] = useState(0);\n  const [position, setPosition] = useState({ top: 0, left: 0 });\n  const menuRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const uploadMutation = api.upload.getUploadUrl.useMutation();\n  const pendingCommandRef = useRef<string | null>(null);\n\n  const filteredCommands = useMemo(() => {\n    if (!query) return COMMANDS;\n    const lowerQuery = query.toLowerCase();\n    return COMMANDS.filter(\n      (cmd) =>\n        cmd.name.toLowerCase().includes(lowerQuery) ||\n        cmd.description?.toLowerCase().includes(lowerQuery) ||\n        cmd.command.toLowerCase().includes(lowerQuery)\n    );\n  }, [query]);\n\n  // Reset selected index when filtered commands change\n  useEffect(() => {\n    setSelectedIndex(0);\n  }, [filteredCommands.length]);\n\n  const handleFileUpload = useCallback(\n    async (file: File) => {\n      try {\n        const result = await uploadMutation.mutateAsync({\n          filename: file.name,\n          contentType: file.type,\n          size: file.size,\n        });\n\n        const uploadResponse = await fetch(result.uploadUrl, {\n          method: \"PUT\",\n          body: file,\n          headers: {\n            \"Content-Type\": file.type,\n          },\n        });\n\n        if (!uploadResponse.ok) {\n          const errorText = await uploadResponse.text();\n          console.error(\"R2 upload failed:\", uploadResponse.status, errorText);\n          alert(`Upload failed: ${uploadResponse.status} - ${errorText || \"Unknown error\"}`);\n          return;\n        }\n\n        let attachmentType: AttachmentType = \"FILE\";\n        if (file.type.startsWith(\"image/\")) {\n          attachmentType = \"IMAGE\";\n        } else if (file.type.startsWith(\"video/\")) {\n          attachmentType = \"VIDEO\";\n        }\n\n        editor.update(() => {\n          const selection = $getSelection();\n          if ($isRangeSelection(selection)) {\n            const attachmentNode = $createAttachmentNode({\n              attachmentType,\n              url: result.publicUrl,\n              filename: file.name,\n              mimeType: file.type,\n              size: file.size,\n            });\n            selection.insertNodes([attachmentNode, $createParagraphNode()]);\n          }\n        });\n      } catch (error) {\n        console.error(\"Upload failed:\", error);\n        alert(`Upload failed: ${error instanceof Error ? error.message : \"Unknown error\"}`);\n      }\n    },\n    [editor, uploadMutation]\n  );\n\n  const executeCommand = useCallback(\n    (command: string) => {\n      editor.update(() => {\n        const selection = $getSelection();\n        if (!$isRangeSelection(selection)) return;\n\n        // Remove the slash and query text\n        const anchor = selection.anchor;\n        const anchorNode = anchor.getNode();\n        if (anchorNode instanceof TextNode) {\n          const textContent = anchorNode.getTextContent();\n          const slashIndex = textContent.lastIndexOf(\"/\");\n          if (slashIndex !== -1) {\n            const newText = textContent.slice(0, slashIndex);\n            if (newText) {\n              anchorNode.setTextContent(newText);\n              selection.setTextNodeRange(anchorNode, newText.length, anchorNode, newText.length);\n            } else {\n              anchorNode.remove();\n            }\n          }\n        }\n\n        switch (command) {\n          case \"heading1\":\n            $setBlocksType(selection, () => $createHeadingNode(\"h1\"));\n            break;\n          case \"heading2\":\n            $setBlocksType(selection, () => $createHeadingNode(\"h2\"));\n            break;\n          case \"heading3\":\n            $setBlocksType(selection, () => $createHeadingNode(\"h3\"));\n            break;\n          case \"bulletList\":\n            editor.dispatchCommand(INSERT_UNORDERED_LIST_COMMAND, undefined);\n            break;\n          case \"numberedList\":\n            editor.dispatchCommand(INSERT_ORDERED_LIST_COMMAND, undefined);\n            break;\n          case \"quote\":\n            $setBlocksType(selection, () => $createQuoteNode());\n            break;\n          case \"image\":\n          case \"file\":\n            pendingCommandRef.current = command;\n            setTimeout(() => {\n              if (fileInputRef.current) {\n                fileInputRef.current.accept = command === \"image\" ? \"image/*,video/*\" : \"*/*\";\n                fileInputRef.current.click();\n              }\n            }, 0);\n            break;\n        }\n      });\n\n      setIsOpen(false);\n      setQuery(\"\");\n    },\n    [editor]\n  );\n\n  // Listen for text changes to detect slash commands\n  useEffect(() => {\n    return editor.registerTextContentListener((text) => {\n      editor.getEditorState().read(() => {\n        const selection = $getSelection();\n        if (!$isRangeSelection(selection)) {\n          setIsOpen(false);\n          return;\n        }\n\n        const anchor = selection.anchor;\n        const anchorNode = anchor.getNode();\n\n        if (!(anchorNode instanceof TextNode)) {\n          setIsOpen(false);\n          return;\n        }\n\n        const textContent = anchorNode.getTextContent();\n        const anchorOffset = anchor.offset;\n        const textBeforeCursor = textContent.slice(0, anchorOffset);\n\n        // Find the last slash in the text before cursor\n        const slashIndex = textBeforeCursor.lastIndexOf(\"/\");\n\n        if (slashIndex === -1) {\n          setIsOpen(false);\n          return;\n        }\n\n        // Check if slash is at start of line or preceded by whitespace\n        const charBeforeSlash = textBeforeCursor[slashIndex - 1];\n        if (slashIndex > 0 && charBeforeSlash !== \" \" && charBeforeSlash !== \"\\n\") {\n          setIsOpen(false);\n          return;\n        }\n\n        // Extract query after slash\n        const queryText = textBeforeCursor.slice(slashIndex + 1);\n\n        // Don't show menu if there's a space in the query (command ended)\n        if (queryText.includes(\" \")) {\n          setIsOpen(false);\n          return;\n        }\n\n        setQuery(queryText);\n        setIsOpen(true);\n\n        // Get position for menu\n        const domSelection = window.getSelection();\n        if (domSelection && domSelection.rangeCount > 0) {\n          const range = domSelection.getRangeAt(0);\n          const rect = range.getBoundingClientRect();\n          const editorRect = anchorElem.getBoundingClientRect();\n\n          setPosition({\n            top: rect.bottom - editorRect.top + 4,\n            left: rect.left - editorRect.left,\n          });\n        }\n      });\n    });\n  }, [editor, anchorElem]);\n\n  // Handle keyboard navigation\n  useEffect(() => {\n    if (!isOpen) return;\n\n    return mergeRegister(\n      editor.registerCommand(\n        KEY_ARROW_DOWN_COMMAND,\n        (event) => {\n          event.preventDefault();\n          setSelectedIndex((prev) =>\n            prev < filteredCommands.length - 1 ? prev + 1 : 0\n          );\n          return true;\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_ARROW_UP_COMMAND,\n        (event) => {\n          event.preventDefault();\n          setSelectedIndex((prev) =>\n            prev > 0 ? prev - 1 : filteredCommands.length - 1\n          );\n          return true;\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_ENTER_COMMAND,\n        (event) => {\n          if (filteredCommands[selectedIndex]) {\n            event?.preventDefault();\n            executeCommand(filteredCommands[selectedIndex].command);\n            return true;\n          }\n          return false;\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_TAB_COMMAND,\n        (event) => {\n          if (filteredCommands[selectedIndex]) {\n            event.preventDefault();\n            executeCommand(filteredCommands[selectedIndex].command);\n            return true;\n          }\n          return false;\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_ESCAPE_COMMAND,\n        () => {\n          setIsOpen(false);\n          setQuery(\"\");\n          return true;\n        },\n        COMMAND_PRIORITY_LOW\n      )\n    );\n  }, [editor, isOpen, filteredCommands, selectedIndex, executeCommand]);\n\n  // Click outside to close\n  useEffect(() => {\n    if (!isOpen) return;\n\n    const handleClickOutside = (event: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n        setQuery(\"\");\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, [isOpen]);\n\n  return (\n    <>\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        className=\"hidden\"\n        onChange={(e) => {\n          const file = e.target.files?.[0];\n          if (file) {\n            handleFileUpload(file);\n          }\n          e.target.value = \"\";\n          pendingCommandRef.current = null;\n        }}\n      />\n      {isOpen && filteredCommands.length > 0 && createPortal(\n        <div\n          ref={menuRef}\n          className=\"absolute z-50 min-w-[200px] overflow-hidden rounded-lg border bg-popover p-1 shadow-lg animate-in fade-in-0 zoom-in-95\"\n          style={{ top: position.top, left: position.left }}\n        >\n          <p className=\"px-2 py-1 text-xs font-medium text-muted-foreground\">\n            Add blocks\n          </p>\n          {filteredCommands.map((option, index) => {\n            const prevOption = filteredCommands[index - 1];\n            const showDivider = prevOption && prevOption.section === \"media\" && option.section === \"blocks\";\n            \n            return (\n              <div key={option.command}>\n                {showDivider && <div className=\"my-1 h-px bg-border\" />}\n                <button\n                  type=\"button\"\n                  onClick={() => executeCommand(option.command)}\n                  onMouseEnter={() => setSelectedIndex(index)}\n                  className={cn(\n                    \"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm\",\n                    selectedIndex === index ? \"bg-muted\" : \"hover:bg-muted\"\n                  )}\n                >\n                  <div className=\"flex h-7 w-7 shrink-0 items-center justify-center rounded-md border bg-background\">\n                    {option.icon}\n                  </div>\n                  {option.description ? (\n                    <div className=\"text-left\">\n                      <p className=\"font-medium\">{option.name}</p>\n                      <p className=\"text-xs text-muted-foreground\">{option.description}</p>\n                    </div>\n                  ) : (\n                    <span>{option.name}</span>\n                  )}\n                </button>\n              </div>\n            );\n          })}\n        </div>,\n        anchorElem\n      )}\n    </>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/server/api/routers/post.ts",
        "size": 13316,
        "reason": "large source sample",
        "content": "import { TRPCError } from \"@trpc/server\";\nimport { z } from \"zod\";\nimport {\n  createTRPCRouter,\n  protectedProcedure,\n  activeUserProcedure,\n} from \"~/server/api/trpc\";\nimport { createPostSchema, updatePostSchema, paginationSchema } from \"~/lib/validators\";\nimport { sendPostNotifications } from \"~/lib/webhooks\";\nimport { extractUserMentions } from \"~/lib/utils\";\n\nexport const postRouter = createTRPCRouter({\n  create: activeUserProcedure\n    .input(createPostSchema)\n    .mutation(async ({ ctx, input }) => {\n      const post = await ctx.db.post.create({\n        data: {\n          title: input.title,\n          content: input.content,\n          liveUrl: input.liveUrl,\n          hideFromHome: input.hideFromHome,\n          authorId: ctx.session.user.id,\n          attachments: {\n            create: input.attachments.map((att) => ({\n              type: att.type,\n              url: att.url,\n              filename: att.filename,\n              mimeType: att.mimeType,\n              size: att.size,\n              width: att.width,\n              height: att.height,\n              thumbnailUrl: att.thumbnailUrl,\n              metadata: att.metadata,\n              order: att.order,\n            })),\n          },\n          projects: {\n            create: input.projectIds.map((projectId) => ({\n              projectId,\n            })),\n          },\n        },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n              reactions: true,\n            },\n          },\n        },\n      });\n\n      // Create mention notifications\n      const mentions = extractUserMentions(input.content);\n      if (mentions.length > 0) {\n        const mentionNotifications = mentions\n          .filter((mention) => mention.userId !== ctx.session.user.id) // Don't notify self\n          .map((mention) => ({\n            type: \"MENTION\" as const,\n            userId: mention.userId,\n            actorId: ctx.session.user.id,\n            postId: post.id,\n          }));\n\n        if (mentionNotifications.length > 0) {\n          await ctx.db.notification.createMany({\n            data: mentionNotifications,\n          });\n        }\n      }\n\n      // Send webhook notifications (fire and forget)\n      const settings = await ctx.db.siteSettings.findUnique({\n        where: { id: \"default\" },\n      });\n\n      if (settings?.discordWebhookUrl || settings?.slackWebhookUrl) {\n        // Get the base URL from headers or use environment variable\n        const host = ctx.headers.get(\"host\") || \"localhost:3000\";\n        const protocol = ctx.headers.get(\"x-forwarded-proto\") || \"http\";\n        const baseUrl = process.env.NEXTAUTH_URL || `${protocol}://${host}`;\n\n        sendPostNotifications(\n          {\n            id: post.id,\n            title: post.title,\n            content: post.content,\n            author: post.author,\n            attachments: post.attachments,\n            projects: post.projects,\n          },\n          settings,\n          baseUrl\n        );\n      }\n\n      return post;\n    }),\n\n  getById: protectedProcedure\n    .input(z.object({ id: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const post = await ctx.db.post.findUnique({\n        where: { id: input.id },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            include: {\n              user: {\n                select: {\n                  id: true,\n                  displayName: true,\n                },\n              },\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n            },\n          },\n        },\n      });\n\n      if (!post) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      return post;\n    }),\n\n  feed: protectedProcedure\n    .input(paginationSchema)\n    .query(async ({ ctx, input }) => {\n      const posts = await ctx.db.post.findMany({\n        where: {\n          hideFromHome: false,\n        },\n        take: input.limit + 1,\n        cursor: input.cursor ? { id: input.cursor } : undefined,\n        orderBy: { createdAt: \"desc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            where: { type: { in: [\"IMAGE\", \"VIDEO\"] } },\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n              reactions: true,\n              attachments: true,\n            },\n          },\n        },\n      });\n\n      let nextCursor: string | undefined;\n      if (posts.length > input.limit) {\n        const nextItem = posts.pop();\n        nextCursor = nextItem?.id;\n      }\n\n      return { posts, nextCursor };\n    }),\n\n  byUser: protectedProcedure\n    .input(\n      paginationSchema.extend({\n        userId: z.string(),\n      })\n    )\n    .query(async ({ ctx, input }) => {\n      const posts = await ctx.db.post.findMany({\n        where: {\n          authorId: input.userId,\n        },\n        take: input.limit + 1,\n        cursor: input.cursor ? { id: input.cursor } : undefined,\n        orderBy: { createdAt: \"desc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            where: { type: { in: [\"IMAGE\", \"VIDEO\"] } },\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n              reactions: true,\n              attachments: true,\n            },\n          },\n        },\n      });\n\n      let nextCursor: string | undefined;\n      if (posts.length > input.limit) {\n        const nextItem = posts.pop();\n        nextCursor = nextItem?.id;\n      }\n\n      return { posts, nextCursor };\n    }),\n\n  byProject: protectedProcedure\n    .input(\n      paginationSchema.extend({\n        projectId: z.string(),\n      })\n    )\n    .query(async ({ ctx, input }) => {\n      const posts = await ctx.db.post.findMany({\n        where: {\n          projects: {\n            some: {\n              projectId: input.projectId,\n            },\n          },\n        },\n        take: input.limit + 1,\n        cursor: input.cursor ? { id: input.cursor } : undefined,\n        orderBy: { createdAt: \"desc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            where: { type: { in: [\"IMAGE\", \"VIDEO\"] } },\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n              reactions: true,\n              attachments: true,\n            },\n          },\n        },\n      });\n\n      let nextCursor: string | undefined;\n      if (posts.length > input.limit) {\n        const nextItem = posts.pop();\n        nextCursor = nextItem?.id;\n      }\n\n      return { posts, nextCursor };\n    }),\n\n  update: activeUserProcedure\n    .input(updatePostSchema)\n    .mutation(async ({ ctx, input }) => {\n      const existingPost = await ctx.db.post.findUnique({\n        where: { id: input.id },\n        select: { authorId: true },\n      });\n\n      if (!existingPost) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      if (existingPost.authorId !== ctx.session.user.id) {\n        throw new TRPCError({ code: \"FORBIDDEN\" });\n      }\n\n      // Delete existing attachments and project links if updating\n      if (input.attachments) {\n        await ctx.db.attachment.deleteMany({\n          where: { postId: input.id },\n        });\n      }\n\n      if (input.projectIds) {\n        await ctx.db.postProject.deleteMany({\n          where: { postId: input.id },\n        });\n      }\n\n      const post = await ctx.db.post.update({\n        where: { id: input.id },\n        data: {\n          title: input.title,\n          content: input.content,\n          liveUrl: input.liveUrl,\n          hideFromHome: input.hideFromHome,\n          attachments: input.attachments\n            ? {\n                create: input.attachments.map((att) => ({\n                  type: att.type,\n                  url: att.url,\n                  filename: att.filename,\n                  mimeType: att.mimeType,\n                  size: att.size,\n                  width: att.width,\n                  height: att.height,\n                  thumbnailUrl: att.thumbnailUrl,\n                  metadata: att.metadata,\n                  order: att.order,\n                })),\n              }\n            : undefined,\n          projects: input.projectIds\n            ? {\n                create: input.projectIds.map((projectId) => ({\n                  projectId,\n                })),\n              }\n            : undefined,\n        },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Create mention notifications for new mentions in updated content\n      if (input.content) {\n        const mentions = extractUserMentions(input.content);\n        if (mentions.length > 0) {\n          // Get existing mention notifications for this post to avoid duplicates\n          const existingMentionNotifications = await ctx.db.notification.findMany({\n            where: {\n              postId: post.id,\n              type: \"MENTION\",\n            },\n            select: { userId: true },\n          });\n          const existingMentionedUserIds = new Set(\n            existingMentionNotifications.map((n) => n.userId)\n          );\n\n          const newMentionNotifications = mentions\n            .filter(\n              (mention) =>\n                mention.userId !== ctx.session.user.id && // Don't notify self\n                !existingMentionedUserIds.has(mention.userId) // Don't duplicate\n            )\n            .map((mention) => ({\n              type: \"MENTION\" as const,\n              userId: mention.userId,\n              actorId: ctx.session.user.id,\n              postId: post.id,\n            }));\n\n          if (newMentionNotifications.length > 0) {\n            await ctx.db.notification.createMany({\n              data: newMentionNotifications,\n            });\n          }\n        }\n      }\n\n      return post;\n    }),\n\n  delete: activeUserProcedure\n    .input(z.object({ id: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      const existingPost = await ctx.db.post.findUnique({\n        where: { id: input.id },\n        select: { authorId: true },\n      });\n\n      if (!existingPost) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      const isAdmin =\n        ctx.session.user.role === \"ADMIN\" ||\n        ctx.session.user.role === \"OWNER\";\n\n      if (existingPost.authorId !== ctx.session.user.id && !isAdmin) {\n        throw new TRPCError({ code: \"FORBIDDEN\" });\n      }\n\n      await ctx.db.post.delete({\n        where: { id: input.id },\n      });\n\n      return { success: true };\n    }),\n});\n",
        "truncated": false
      },
      {
        "path": "src/components/reactions/ReactionButton.tsx",
        "size": 11733,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport React, { useState, useMemo, useEffect } from \"react\";\nimport { useSession } from \"next-auth/react\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"~/components/ui/popover\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"~/components/ui/tooltip\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Heart, Sparkles, ThumbsUp, SmilePlus, type LucideIcon } from \"lucide-react\";\nimport { cn, pluralize } from \"~/lib/utils\";\nimport { EmojiImage } from \"~/components/settings/EmojiUpload\";\nimport { ReactionsDialog } from \"./ReactionsDialog\";\n\ninterface ReactionButtonProps {\n  postId?: string;\n  commentId?: string;\n  reactions: Array<{\n    type: string;\n    userId: string;\n  }>;\n  count: number;\n}\n\ninterface DefaultReaction {\n  type: string;\n  icon: LucideIcon;\n  label: string;\n}\n\ninterface CustomEmojiReaction {\n  type: string;\n  imageUrl: string;\n  label: string;\n}\n\ntype ReactionOption = DefaultReaction | CustomEmojiReaction;\n\nfunction isCustomEmoji(reaction: ReactionOption): reaction is CustomEmojiReaction {\n  return \"imageUrl\" in reaction;\n}\n\nconst DEFAULT_REACTIONS: DefaultReaction[] = [\n  { type: \"like\", icon: ThumbsUp, label: \"Like\" },\n  { type: \"wow\", icon: Sparkles, label: \"Wow\" },\n  { type: \"cool\", icon: Heart, label: \"Cool\" },\n];\n\nexport function ReactionButton({\n  postId,\n  commentId,\n  reactions,\n  count,\n}: ReactionButtonProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [dialogInitialTab, setDialogInitialTab] = useState<string | undefined>();\n  const { data: session } = useSession();\n  const utils = api.useUtils();\n  const currentUserId = session?.user?.id;\n\n  // Fetch custom emojis\n  const { data: customEmojis } = api.reaction.listEmoji.useQuery();\n\n  // Fetch detailed reactions for tooltip display (with user names)\n  const { data: detailedReactions } = api.reaction.byPost.useQuery(\n    { postId: postId! },\n    { enabled: !!postId }\n  );\n\n  const { data: detailedCommentReactions } = api.reaction.byComment.useQuery(\n    { commentId: commentId! },\n    { enabled: !!commentId }\n  );\n\n  const reactionDetails = postId ? detailedReactions : detailedCommentReactions;\n\n  // Combine default reactions with custom emojis\n  const allReactions = useMemo<ReactionOption[]>(() => {\n    const customReactions: CustomEmojiReaction[] = (customEmojis ?? []).map((emoji) => ({\n      type: `emoji:${emoji.name}`,\n      imageUrl: emoji.imageUrl,\n      label: emoji.name,\n    }));\n    return [...DEFAULT_REACTIONS, ...customReactions];\n  }, [customEmojis]);\n\n  // Get the user's current reaction from server data\n  const serverUserReaction = useMemo(\n    () => reactions.find((r) => r.userId === currentUserId)?.type ?? null,\n    [reactions, currentUserId]\n  );\n\n  // Optimistic state for the user's reaction\n  const [optimisticReaction, setOptimisticReaction] = useState<string | null>(\n    serverUserReaction\n  );\n\n  // Sync optimistic state when server data changes (after successful mutation)\n  useEffect(() => {\n    setOptimisticReaction(serverUserReaction);\n  }, [serverUserReaction]);\n\n  const toggleMutation = api.reaction.toggle.useMutation({\n    onSuccess: () => {\n      if (postId) {\n        utils.post.feed.invalidate();\n        utils.post.getById.invalidate({ id: postId });\n        utils.reaction.byPost.invalidate({ postId });\n      }\n      if (commentId) {\n        utils.comment.byPost.invalidate();\n        utils.reaction.byComment.invalidate({ commentId });\n      }\n    },\n    onError: () => {\n      // Revert to server state on error\n      setOptimisticReaction(serverUserReaction);\n    },\n  });\n\n  // Compute optimistic reactions list and counts\n  const { optimisticCount, reactionCounts } = useMemo(() => {\n    // Start with reactions from other users\n    const otherReactions = reactions.filter((r) => r.userId !== currentUserId);\n    \n    // Add optimistic user reaction if present\n    const allReactions =\n      optimisticReaction && currentUserId\n        ? [...otherReactions, { type: optimisticReaction, userId: currentUserId }]\n        : otherReactions;\n\n    // Calculate counts\n    const counts = allReactions.reduce(\n      (acc, r) => {\n        acc[r.type] = (acc[r.type] || 0) + 1;\n        return acc;\n      },\n      {} as Record<string, number>\n    );\n\n    return {\n      optimisticCount: allReactions.length,\n      reactionCounts: counts,\n    };\n  }, [reactions, currentUserId, optimisticReaction]);\n\n  const handleReaction = (type: string) => {\n    // Optimistically update\n    if (optimisticReaction === type) {\n      // Toggle off\n      setOptimisticReaction(null);\n    } else {\n      // Set new reaction (or change existing)\n      setOptimisticReaction(type);\n    }\n\n    toggleMutation.mutate({ type, postId, commentId });\n    setIsOpen(false);\n  };\n\n  const hasReactions = optimisticCount > 0;\n\n  // Helper to render a reaction icon (either Lucide icon or custom emoji)\n  const renderReactionIcon = (type: string, size: \"sm\" | \"md\" = \"md\") => {\n    const reaction = allReactions.find((r) => r.type === type);\n    if (!reaction) {\n      // Fallback for unknown reaction types\n      return <SmilePlus className={size === \"sm\" ? \"h-3 w-3\" : \"h-5 w-5\"} />;\n    }\n    \n    if (isCustomEmoji(reaction)) {\n      return (\n        <EmojiImage\n          url={reaction.imageUrl}\n          alt={reaction.label}\n          className={size === \"sm\" ? \"h-4 w-4\" : \"h-5 w-5\"}\n        />\n      );\n    }\n    \n    const Icon = reaction.icon;\n    return <Icon className={size === \"sm\" ? \"h-3 w-3\" : \"h-5 w-5\"} />;\n  };\n\n  // Get reaction label for display\n  const getReactionLabel = (type: string): string => {\n    const reaction = allReactions.find((r) => r.type === type);\n    return reaction?.label ?? type;\n  };\n\n  // Format the tooltip text for a reaction type\n  const formatReactionTooltip = (type: string): { text: string; hasMore: boolean; moreCount: number } => {\n    const users = reactionDetails?.[type] ?? [];\n    if (users.length === 0) {\n      return { text: getReactionLabel(type), hasMore: false, moreCount: 0 };\n    }\n\n    const names = users.map((u) => u.userName);\n    \n    if (names.length <= 3) {\n      return { text: names.join(\", \"), hasMore: false, moreCount: 0 };\n    }\n\n    const displayedNames = names.slice(0, 3).join(\", \");\n    const moreCount = names.length - 3;\n    return {\n      text: displayedNames,\n      hasMore: true,\n      moreCount,\n    };\n  };\n\n  const openDialogWithTab = (tab: string) => {\n    setDialogInitialTab(tab);\n    setDialogOpen(true);\n  };\n\n  return (\n    <TooltipProvider>\n      <Popover open={isOpen} onOpenChange={setIsOpen}>\n        <PopoverTrigger asChild>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className={cn(\n              \"gap-1 rounded-full px-2 text-muted-foreground\",\n              hasReactions && \"[&:not(:hover)]:text-primary\"\n            )}\n          >\n            {hasReactions ? (\n              <div className=\"flex gap-0.5\">\n                {Object.keys(reactionCounts)\n                  .slice(0, 3)\n                  .map((type) => (\n                    <ReactionIconWithTooltip\n                      key={type}\n                      type={type}\n                      renderIcon={renderReactionIcon}\n                      formatTooltip={formatReactionTooltip}\n                      onShowAll={() => openDialogWithTab(type)}\n                    />\n                  ))}\n              </div>\n            ) : (\n              <SmilePlus className=\"h-4 w-4\" />\n            )}\n            {optimisticCount > 0 && <span>{optimisticCount}</span>}\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent className=\"w-auto p-2\" side=\"top\" align=\"start\">\n          <div className=\"flex flex-wrap gap-1 max-w-[200px]\">\n            {allReactions.map((reaction) => {\n              const userReacted = optimisticReaction === reaction.type;\n              const reactionCount = reactionCounts[reaction.type] || 0;\n\n              return (\n                <Tooltip key={reaction.type}>\n                  <TooltipTrigger asChild>\n                    <button\n                      onClick={() => handleReaction(reaction.type)}\n                      className={cn(\n                        \"flex h-10 w-10 items-center justify-center rounded-full transition-all hover:scale-110 hover:bg-muted hover:text-foreground\",\n                        userReacted && \"[&:not(:hover)]:bg-primary/10 [&:not(:hover)]:text-primary\"\n                      )}\n                    >\n                      {isCustomEmoji(reaction) ? (\n                        <EmojiImage\n                          url={reaction.imageUrl}\n                          alt={reaction.label}\n                          className=\"h-5 w-5\"\n                        />\n                      ) : (\n                        <reaction.icon className=\"h-5 w-5\" />\n                      )}\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>\n                      {reaction.label}\n                      {reactionCount > 0 && ` (${reactionCount})`}\n                    </p>\n                  </TooltipContent>\n                </Tooltip>\n              );\n            })}\n          </div>\n        </PopoverContent>\n      </Popover>\n\n      {/* Reactions dialog */}\n      {reactionDetails && (\n        <ReactionsDialog\n          open={dialogOpen}\n          onOpenChange={setDialogOpen}\n          reactions={reactionDetails}\n          customEmojis={customEmojis}\n          initialTab={dialogInitialTab}\n        />\n      )}\n    </TooltipProvider>\n  );\n}\n\n// Separate component to handle individual reaction icon with hover tooltip\nfunction ReactionIconWithTooltip({\n  type,\n  renderIcon,\n  formatTooltip,\n  onShowAll,\n}: {\n  type: string;\n  renderIcon: (type: string, size: \"sm\" | \"md\") => React.ReactNode;\n  formatTooltip: (type: string) => { text: string; hasMore: boolean; moreCount: number };\n  onShowAll: () => void;\n}) {\n  const [tooltipOpen, setTooltipOpen] = useState(false);\n  const [hoverTimeout, setHoverTimeout] = useState<NodeJS.Timeout | null>(null);\n  const tooltip = formatTooltip(type);\n\n  const handleMouseEnter = () => {\n    const timeout = setTimeout(() => {\n      setTooltipOpen(true);\n    }, 500);\n    setHoverTimeout(timeout);\n  };\n\n  const handleMouseLeave = () => {\n    if (hoverTimeout) {\n      clearTimeout(hoverTimeout);\n      setHoverTimeout(null);\n    }\n    setTooltipOpen(false);\n  };\n\n  return (\n    <Popover open={tooltipOpen} onOpenChange={setTooltipOpen}>\n      <PopoverTrigger asChild>\n        <div\n          className=\"flex h-5 w-5 items-center justify-center\"\n          onMouseEnter={handleMouseEnter}\n          onMouseLeave={handleMouseLeave}\n        >\n          {renderIcon(type, \"sm\")}\n        </div>\n      </PopoverTrigger>\n      <PopoverContent\n        className=\"w-auto max-w-xs p-2 text-sm\"\n        side=\"top\"\n        align=\"center\"\n        onMouseEnter={() => setTooltipOpen(true)}\n        onMouseLeave={handleMouseLeave}\n        onOpenAutoFocus={(e) => e.preventDefault()}\n      >\n        <p>\n          {tooltip.text}\n          {tooltip.hasMore && (\n            <>\n              {\" and \"}\n              <button\n                className=\"font-medium text-primary hover:underline\"\n                onClick={(e) => {\n                  e.stopPropagation();\n                  setTooltipOpen(false);\n                  onShowAll();\n                }}\n              >\n                {tooltip.moreCount} {pluralize(tooltip.moreCount, \"other\")}\n              </button>\n            </>\n          )}\n        </p>\n      </PopoverContent>\n    </Popover>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/post/PostEditor.tsx",
        "size": 10961,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useCallback, useEffect, useRef, useMemo } from \"react\";\nimport { Link as LinkIcon, FolderOpen, Check, ChevronsUpDown } from \"lucide-react\";\nimport { Button } from \"~/components/ui/button\";\nimport { Input } from \"~/components/ui/input\";\nimport { Label } from \"~/components/ui/label\";\nimport { Switch } from \"~/components/ui/switch\";\nimport { Card, CardContent } from \"~/components/ui/card\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"~/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"~/components/ui/command\";\nimport { Editor } from \"~/components/editor/Editor\";\nimport { api } from \"~/lib/trpc/client\";\nimport type { SerializedEditorState } from \"lexical\";\nimport { cn } from \"~/lib/utils\";\n\nexport interface PostEditorData {\n  title: string;\n  content: SerializedEditorState | null;\n  liveUrl: string;\n  projects: Array<{ id: string; name: string }>;\n  hideFromHome: boolean;\n}\n\nexport interface ExtractedAttachment {\n  type: \"IMAGE\" | \"VIDEO\" | \"FILE\" | \"FIGMA\" | \"LOOM\";\n  url: string;\n  filename: string;\n  mimeType: string;\n  size: number;\n  width?: number;\n  height?: number;\n  thumbnailUrl?: string;\n  metadata?: Record<string, unknown>;\n  order: number;\n}\n\ninterface PostEditorProps {\n  initialData?: {\n    title?: string;\n    content?: SerializedEditorState | null;\n    liveUrl?: string;\n    projects?: Array<{ id: string; name: string }>;\n    hideFromHome?: boolean;\n  };\n  onChange?: (data: PostEditorData) => void;\n  editorKey?: string;\n  className?: string;\n}\n\n/**\n * Extracts attachment nodes from Lexical editor state\n */\nexport function extractAttachments(\n  content: SerializedEditorState | null\n): ExtractedAttachment[] {\n  if (!content) return [];\n\n  const attachments: ExtractedAttachment[] = [];\n  const root = content.root;\n\n  if (root && \"children\" in root && Array.isArray(root.children)) {\n    let order = 0;\n    const extract = (node: unknown): void => {\n      if (!node || typeof node !== \"object\") return;\n      const nodeObj = node as Record<string, unknown>;\n\n      if (nodeObj.type === \"attachment\") {\n        attachments.push({\n          type: nodeObj.attachmentType as ExtractedAttachment[\"type\"],\n          url: nodeObj.url as string,\n          filename: nodeObj.filename as string,\n          mimeType: nodeObj.mimeType as string,\n          size: nodeObj.size as number,\n          width: nodeObj.width as number | undefined,\n          height: nodeObj.height as number | undefined,\n          thumbnailUrl: nodeObj.thumbnailUrl as string | undefined,\n          metadata: nodeObj.metadata as Record<string, unknown> | undefined,\n          order: order++,\n        });\n      }\n\n      if (Array.isArray(nodeObj.children)) {\n        nodeObj.children.forEach(extract);\n      }\n    };\n\n    root.children.forEach(extract);\n  }\n\n  return attachments;\n}\n\nexport function PostEditor({\n  initialData,\n  onChange,\n  editorKey,\n  className,\n}: PostEditorProps) {\n  const [title, setTitle] = useState(initialData?.title || \"\");\n  const [content, setContent] = useState<SerializedEditorState | null>(\n    initialData?.content || null\n  );\n  const [liveUrl, setLiveUrl] = useState(initialData?.liveUrl || \"\");\n  const [selectedProjects, setSelectedProjects] = useState<\n    Array<{ id: string; name: string }>\n  >(initialData?.projects || []);\n  const [projectSearch, setProjectSearch] = useState(\"\");\n  const [projectsOpen, setProjectsOpen] = useState(false);\n  const [hideFromHome, setHideFromHome] = useState(initialData?.hideFromHome || false);\n\n  const titleRef = useRef<HTMLTextAreaElement>(null);\n  const isInitialMount = useRef(true);\n\n  const { data: projects } = api.project.search.useQuery(\n    { query: projectSearch || undefined },\n    { enabled: projectsOpen }\n  );\n\n  // Combine selected projects (on top) with search results, avoiding duplicates\n  const projectList = useMemo(() => {\n    const searchResults = projects || [];\n    const selectedIds = new Set(selectedProjects.map((p) => p.id));\n    const filteredResults = searchResults.filter((p) => !selectedIds.has(p.id));\n    return [...selectedProjects, ...filteredResults];\n  }, [projects, selectedProjects]);\n\n  // Button text based on selection\n  const projectButtonText = useMemo(() => {\n    if (selectedProjects.length === 0) return \"Add to project\";\n    if (selectedProjects.length === 1) return selectedProjects[0].name;\n    return `In ${selectedProjects.length} projects`;\n  }, [selectedProjects]);\n\n  // Update parent when data changes\n  useEffect(() => {\n    // Skip initial mount to avoid unnecessary callback\n    if (isInitialMount.current) {\n      isInitialMount.current = false;\n      return;\n    }\n\n    onChange?.({\n      title,\n      content,\n      liveUrl,\n      projects: selectedProjects,\n      hideFromHome,\n    });\n  }, [title, content, liveUrl, selectedProjects, hideFromHome, onChange]);\n\n  // Auto-resize title textarea on mount if it has content\n  useEffect(() => {\n    if (titleRef.current && title) {\n      titleRef.current.style.height = \"auto\";\n      titleRef.current.style.height = titleRef.current.scrollHeight + \"px\";\n    }\n  }, []);\n\n  const handleContentChange = useCallback((state: SerializedEditorState) => {\n    setContent(state);\n  }, []);\n\n  const handleTitleChange = useCallback(\n    (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n      setTitle(e.target.value);\n      // Auto-resize\n      e.target.style.height = \"auto\";\n      e.target.style.height = e.target.scrollHeight + \"px\";\n    },\n    []\n  );\n\n  const toggleProject = (project: { id: string; name: string }) => {\n    const isSelected = selectedProjects.find((p) => p.id === project.id);\n    if (isSelected) {\n      setSelectedProjects(selectedProjects.filter((p) => p.id !== project.id));\n    } else {\n      setSelectedProjects([...selectedProjects, project]);\n    }\n  };\n\n  return (\n    <div className={cn(\"flex flex-1 flex-col\", className)}>\n      {/* Title */}\n      <textarea\n        ref={titleRef}\n        placeholder=\"Add a title (optional)\"\n        value={title}\n        onChange={handleTitleChange}\n        rows={1}\n        className=\"px-4 w-full resize-none border-none bg-transparent text-3xl font-semibold placeholder:text-muted-foreground/50 focus:outline-none\"\n      />\n\n      {/* Editor */}\n      <Editor\n        key={editorKey}\n        initialContent={initialData?.content}\n        onChange={handleContentChange}\n        placeholder=\"Write something, use / for commands, @ to mention...\"\n        minHeight=\"300px\"\n        showToolbar={false}\n        className=\"border-none shadow-none\"\n      />\n\n      {/* Spacer - pushes metadata to bottom when content is short */}\n      <div className=\"flex-grow\" />\n\n      {/* Post Settings */}\n      <Card className=\"mt-6\">\n        <CardContent className=\"space-y-6 pt-6\">\n          {/* Live URL */}\n          <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"liveUrl\">Live URL</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Link to a live demo or deployed version\n              </p>\n            </div>\n            <div className=\"flex items-center gap-2 sm:w-80\">\n              <LinkIcon className=\"h-4 w-4 shrink-0 text-muted-foreground\" />\n              <Input\n                id=\"liveUrl\"\n                type=\"url\"\n                placeholder=\"https://example.com\"\n                value={liveUrl}\n                onChange={(e) => setLiveUrl(e.target.value)}\n              />\n            </div>\n          </div>\n\n          {/* Projects */}\n          <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label>Projects</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Associate this post with one or more projects\n              </p>\n            </div>\n            <Popover open={projectsOpen} onOpenChange={setProjectsOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  role=\"combobox\"\n                  aria-expanded={projectsOpen}\n                  className=\"justify-between gap-2 sm:w-52\"\n                >\n                  <FolderOpen className=\"h-4 w-4 shrink-0\" />\n                  <span className=\"truncate\">{projectButtonText}</span>\n                  <ChevronsUpDown className=\"ml-auto h-3 w-3 shrink-0 opacity-50\" />\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-52 p-0\" align=\"end\">\n                <Command shouldFilter={false}>\n                  <CommandInput\n                    placeholder=\"Search projects...\"\n                    value={projectSearch}\n                    onValueChange={setProjectSearch}\n                  />\n                  <CommandList>\n                    <CommandEmpty>No projects found.</CommandEmpty>\n                    {projectList.length > 0 && (\n                      <CommandGroup>\n                        {projectList.map((project) => {\n                          const isSelected = selectedProjects.some(\n                            (p) => p.id === project.id\n                          );\n                          return (\n                            <CommandItem\n                              key={project.id}\n                              value={project.id}\n                              onSelect={() => toggleProject(project)}\n                            >\n                              <Check\n                                className={cn(\n                                  \"h-4 w-4 shrink-0\",\n                                  isSelected ? \"opacity-100\" : \"opacity-0\"\n                                )}\n                              />\n                              <FolderOpen className=\"h-4 w-4 shrink-0 text-muted-foreground\" />\n                              <span className=\"truncate\">{project.name}</span>\n                            </CommandItem>\n                          );\n                        })}\n                      </CommandGroup>\n                    )}\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Hide from Home */}\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"hideFromHome\">Hide from Home</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Post will only appear on your profile, not the Home feed\n              </p>\n            </div>\n            <Switch\n              id=\"hideFromHome\"\n              checked={hideFromHome}\n              onCheckedChange={setHideFromHome}\n            />\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/projects/ProjectDetail.tsx",
        "size": 10897,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useEffect, useRef, useCallback } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { Button } from \"~/components/ui/button\";\nimport { Badge } from \"~/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"~/components/ui/tabs\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"~/components/ui/dialog\";\nimport { api } from \"~/lib/trpc/client\";\nimport { PostCard } from \"~/components/feed/PostCard\";\nimport { GridView } from \"~/components/feed/GridView\";\nimport { formatRelativeTime, pluralize } from \"~/lib/utils\";\nimport { Link as LinkIcon, List, LayoutGrid, Loader2, FolderOpen, MoreHorizontal, Pencil, Trash2 } from \"lucide-react\";\nimport { useSession } from \"next-auth/react\";\nimport { SimpleMarkdownContent } from \"~/components/editor/SimpleMarkdownEditor\";\nimport type { SerializedEditorState } from \"lexical\";\n\n// Extract R2 key from URL\nfunction extractR2Key(url: string): string | null {\n  const urlWithoutParams = url.split('?')[0];\n  const match = urlWithoutParams?.match(/uploads\\/[^\\/]+\\/[^\\/]+$/);\n  return match ? match[0] : null;\n}\n\n// Check if URL is already a signed URL\nfunction isSignedUrl(url: string): boolean {\n  return url.includes('X-Amz-') || url.includes('x-amz-');\n}\n\n// Check if content is a Lexical editor state\nfunction isLexicalContent(content: unknown): content is SerializedEditorState {\n  if (!content || typeof content !== \"object\") return false;\n  const c = content as Record<string, unknown>;\n  return c.root !== undefined && typeof c.root === \"object\";\n}\n\n// Render project description (handles both old { text: string } and new Lexical format)\nfunction ProjectDescription({ description }: { description: unknown }) {\n  if (!description) return null;\n\n  // New Lexical format\n  if (isLexicalContent(description)) {\n    return (\n      <div className=\"mt-2\">\n        <SimpleMarkdownContent content={description} className=\"text-base\" />\n      </div>\n    );\n  }\n\n  // Old { text: string } format\n  const desc = description as { text?: string };\n  if (desc?.text) {\n    return <p className=\"mt-2 text-base\">{desc.text}</p>;\n  }\n\n  return null;\n}\n\nfunction SignedCoverImage({ url, name }: { url: string; name: string }) {\n  const alreadySigned = isSignedUrl(url);\n  const r2Key = !alreadySigned ? extractR2Key(url) : null;\n\n  const { data: signedUrlData, isLoading } = api.upload.getDownloadUrl.useQuery(\n    { key: r2Key! },\n    {\n      enabled: !!r2Key && !alreadySigned,\n      staleTime: 30 * 60 * 1000,\n      refetchOnWindowFocus: false,\n    }\n  );\n\n  const displayUrl = alreadySigned ? url : (signedUrlData?.url || url);\n\n  if (!alreadySigned && isLoading && r2Key) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center bg-muted\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <img\n      src={displayUrl}\n      alt={name}\n      className=\"h-full w-full object-cover\"\n    />\n  );\n}\n\ninterface ProjectDetailProps {\n  project: {\n    id: string;\n    name: string;\n    description: unknown;\n    coverUrl: string | null;\n    createdAt: Date;\n    createdById: string;\n    urls: Array<{\n      id: string;\n      title: string;\n      url: string;\n    }>;\n    members: Array<{\n      user: {\n        id: string;\n        displayName: string;\n        avatarUrl: string | null;\n      };\n    }>;\n    _count: {\n      posts: number;\n    };\n  };\n}\n\nexport function ProjectDetail({ project }: ProjectDetailProps) {\n  const router = useRouter();\n  const { data: session } = useSession();\n  const [viewMode, setViewMode] = useState<\"feed\" | \"grid\">(\"feed\");\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const loadMoreRef = useRef<HTMLDivElement>(null);\n\n  const isOwner = session?.user?.id === project.createdById;\n  const isAdmin = session?.user?.role === \"ADMIN\" || session?.user?.role === \"OWNER\";\n  const canModify = isOwner || isAdmin;\n\n  const deleteMutation = api.project.delete.useMutation({\n    onSuccess: () => {\n      router.push(\"/projects\");\n    },\n  });\n\n  const handleDelete = () => {\n    deleteMutation.mutate({ id: project.id });\n  };\n\n  const {\n    data,\n    fetchNextPage,\n    hasNextPage,\n    isFetchingNextPage,\n    isLoading,\n  } = api.post.byProject.useInfiniteQuery(\n    { projectId: project.id, limit: 10 },\n    {\n      getNextPageParam: (lastPage) => lastPage.nextCursor,\n    }\n  );\n\n  const handleObserver = useCallback(\n    (entries: IntersectionObserverEntry[]) => {\n      const [target] = entries;\n      if (target?.isIntersecting && hasNextPage && !isFetchingNextPage) {\n        fetchNextPage();\n      }\n    },\n    [fetchNextPage, hasNextPage, isFetchingNextPage]\n  );\n\n  useEffect(() => {\n    const element = loadMoreRef.current;\n    if (!element) return;\n\n    const observer = new IntersectionObserver(handleObserver, {\n      root: null,\n      rootMargin: \"100px\",\n      threshold: 0,\n    });\n\n    observer.observe(element);\n    return () => observer.disconnect();\n  }, [handleObserver]);\n\n  const posts = data?.pages.flatMap((page) => page.posts) ?? [];\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Header */}\n      <header className=\"space-y-6\">\n        {project.coverUrl && (\n          <div className=\"aspect-3/1 overflow-hidden rounded-xl\">\n            <SignedCoverImage url={project.coverUrl} name={project.name} />\n          </div>\n        )}\n\n        <div className=\"flex items-start justify-between gap-4\">\n          <div className=\"flex min-w-0 flex-1 items-start gap-4\">\n            {!project.coverUrl && (\n              <div className=\"flex h-16 w-16 shrink-0 items-center justify-center rounded-xl bg-primary/10\">\n                <FolderOpen className=\"h-8 w-8 text-primary\" />\n              </div>\n            )}\n            <div className=\"space-y-1\">\n              <h1 className=\"text-3xl font-bold\">{project.name}</h1>\n              <p className=\"text-sm text-muted-foreground\">\n                Created {formatRelativeTime(new Date(project.createdAt))} ·{\" \"}\n                {project._count.posts} {pluralize(project._count.posts, \"post\")}\n              </p>\n            </div>\n          </div>\n\n          {canModify && (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\" className=\"shrink-0\">\n                  <MoreHorizontal className=\"h-5 w-5\" />\n                  <span className=\"sr-only\">Project options</span>\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem asChild>\n                  <Link href={`/projects/${project.id}/edit`} className=\"gap-2\">\n                    <Pencil className=\"h-4 w-4\" />\n                    Edit project\n                  </Link>\n                </DropdownMenuItem>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem\n                  onClick={() => setShowDeleteDialog(true)}\n                  className=\"gap-2 text-destructive focus:bg-destructive focus:text-destructive-foreground\"\n                >\n                  <Trash2 className=\"h-4 w-4\" />\n                  Delete project\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          )}\n        </div>\n\n        {/* Links */}\n        {project.urls.length > 0 && (\n          <div className=\"flex flex-wrap gap-2\">\n            {project.urls.map((url) => (\n              <a\n                key={url.id}\n                href={url.url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                <Badge variant=\"secondary\" className=\"gap-1.5 bg-muted py-1.5\">\n                  <LinkIcon className=\"h-3 w-3\" />\n                  {url.title}\n                </Badge>\n              </a>\n            ))}\n          </div>\n        )}\n\n        <ProjectDescription description={project.description} />\n\n        {/* Delete confirmation dialog */}\n        <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Delete project?</DialogTitle>\n              <DialogDescription>\n                This action cannot be undone. This will permanently delete the project\n                &quot;{project.name}&quot; and remove it from all posts.\n              </DialogDescription>\n            </DialogHeader>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowDeleteDialog(false)}\n                disabled={deleteMutation.isPending}\n              >\n                Cancel\n              </Button>\n              <Button\n                variant=\"destructive\"\n                onClick={handleDelete}\n                disabled={deleteMutation.isPending}\n              >\n                {deleteMutation.isPending && (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                )}\n                Delete\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </header>\n\n      {/* Posts */}\n      <section className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-lg font-semibold\">Posts</h2>\n          <Tabs value={viewMode} onValueChange={(v) => setViewMode(v as \"feed\" | \"grid\")}>\n            <TabsList>\n              <TabsTrigger value=\"feed\" className=\"gap-2\">\n                <List className=\"h-4 w-4\" />\n              </TabsTrigger>\n              <TabsTrigger value=\"grid\" className=\"gap-2\">\n                <LayoutGrid className=\"h-4 w-4\" />\n              </TabsTrigger>\n            </TabsList>\n          </Tabs>\n        </div>\n\n        {isLoading ? (\n          <div className=\"flex justify-center py-8\">\n            <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n          </div>\n        ) : posts.length === 0 ? (\n          <p className=\"py-8 text-center text-sm text-muted-foreground\">\n            No posts in this project yet\n          </p>\n        ) : viewMode === \"feed\" ? (\n          <div className=\"space-y-4\">\n            {posts.map((post) => (\n              <PostCard key={post.id} post={post} />\n            ))}\n          </div>\n        ) : (\n          <GridView posts={posts} />\n        )}\n\n        <div ref={loadMoreRef} className=\"flex justify-center py-4\">\n          {isFetchingNextPage && (\n            <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n          )}\n        </div>\n      </section>\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/plugins/FloatingAddButtonPlugin.tsx",
        "size": 10469,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport {\n  $getSelection,\n  $isRangeSelection,\n  $createParagraphNode,\n  $getNodeByKey,\n  $isParagraphNode,\n  COMMAND_PRIORITY_LOW,\n  KEY_ARROW_DOWN_COMMAND,\n  KEY_ARROW_UP_COMMAND,\n} from \"lexical\";\nimport { createPortal } from \"react-dom\";\nimport {\n  Plus,\n  ImagePlus,\n  FileUp,\n  Heading1,\n  Heading2,\n  List,\n  ListOrdered,\n  Quote,\n  X,\n} from \"lucide-react\";\nimport { $createAttachmentNode, type AttachmentType } from \"../nodes/AttachmentNode\";\nimport { $setBlocksType } from \"@lexical/selection\";\nimport { $createHeadingNode, $createQuoteNode } from \"@lexical/rich-text\";\nimport { INSERT_ORDERED_LIST_COMMAND, INSERT_UNORDERED_LIST_COMMAND } from \"@lexical/list\";\nimport { api } from \"~/lib/trpc/client\";\nimport { cn } from \"~/lib/utils\";\n\ninterface FloatingAddButtonPluginProps {\n  anchorElem: HTMLElement;\n}\n\nexport function FloatingAddButtonPlugin({ anchorElem }: FloatingAddButtonPluginProps) {\n  const [editor] = useLexicalComposerContext();\n  const [isVisible, setIsVisible] = useState(false);\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\n  const [position, setPosition] = useState({ top: 0 });\n  const [isEmpty, setIsEmpty] = useState(false);\n  const buttonRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const uploadMutation = api.upload.getUploadUrl.useMutation();\n\n  const updatePosition = useCallback(() => {\n    editor.getEditorState().read(() => {\n      const selection = $getSelection();\n      if (!$isRangeSelection(selection)) {\n        setIsVisible(false);\n        return;\n      }\n\n      const anchor = selection.anchor;\n      const anchorNode = anchor.getNode();\n      const topLevelElement = anchorNode.getTopLevelElement();\n\n      if (!topLevelElement) {\n        setIsVisible(false);\n        return;\n      }\n\n      // Check if the current block is empty (only for paragraphs)\n      const isEmptyParagraph = $isParagraphNode(topLevelElement) &&\n        topLevelElement.getTextContent().trim() === \"\";\n\n      setIsEmpty(isEmptyParagraph);\n\n      const key = topLevelElement.getKey();\n      const elem = editor.getElementByKey(key);\n\n      if (!elem) {\n        setIsVisible(false);\n        return;\n      }\n\n      const editorRect = anchorElem.getBoundingClientRect();\n      const elemRect = elem.getBoundingClientRect();\n\n      setPosition({\n        top: elemRect.top - editorRect.top,\n      });\n      setIsVisible(true);\n    });\n  }, [editor, anchorElem]);\n\n  useEffect(() => {\n    return editor.registerUpdateListener(({ editorState }) => {\n      editorState.read(() => {\n        updatePosition();\n      });\n    });\n  }, [editor, updatePosition]);\n\n  // Close menu when clicking outside\n  useEffect(() => {\n    if (!isMenuOpen) return;\n\n    const handleClickOutside = (e: MouseEvent) => {\n      if (buttonRef.current && !buttonRef.current.contains(e.target as Node)) {\n        setIsMenuOpen(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, [isMenuOpen]);\n\n  const handleFileUpload = useCallback(\n    async (file: File) => {\n      setIsMenuOpen(false);\n      try {\n        const result = await uploadMutation.mutateAsync({\n          filename: file.name,\n          contentType: file.type,\n          size: file.size,\n        });\n\n        // Upload to R2\n        const uploadResponse = await fetch(result.uploadUrl, {\n          method: \"PUT\",\n          body: file,\n          headers: {\n            \"Content-Type\": file.type,\n          },\n        });\n\n        if (!uploadResponse.ok) {\n          const errorText = await uploadResponse.text();\n          console.error(\"R2 upload failed:\", uploadResponse.status, errorText);\n          alert(`Upload failed: ${uploadResponse.status} - Check CORS configuration on R2 bucket`);\n          return;\n        }\n\n        // Determine attachment type\n        let attachmentType: AttachmentType = \"FILE\";\n        if (file.type.startsWith(\"image/\")) {\n          attachmentType = \"IMAGE\";\n        } else if (file.type.startsWith(\"video/\")) {\n          attachmentType = \"VIDEO\";\n        }\n\n        // Insert attachment node\n        editor.update(() => {\n          const selection = $getSelection();\n          if ($isRangeSelection(selection)) {\n            const attachmentNode = $createAttachmentNode({\n              attachmentType,\n              url: result.publicUrl,\n              filename: file.name,\n              mimeType: file.type,\n              size: file.size,\n            });\n            selection.insertNodes([attachmentNode, $createParagraphNode()]);\n          }\n        });\n      } catch (error) {\n        console.error(\"Upload failed:\", error);\n        const message = error instanceof Error ? error.message : \"Unknown error\";\n        alert(`Upload failed: ${message}`);\n      }\n    },\n    [editor, uploadMutation]\n  );\n\n  const triggerFileInput = (accept: string) => {\n    if (fileInputRef.current) {\n      fileInputRef.current.accept = accept;\n      fileInputRef.current.click();\n    }\n  };\n\n  const insertBlock = (type: string) => {\n    setIsMenuOpen(false);\n    editor.update(() => {\n      const selection = $getSelection();\n      if (!$isRangeSelection(selection)) return;\n\n      switch (type) {\n        case \"h1\":\n          $setBlocksType(selection, () => $createHeadingNode(\"h1\"));\n          break;\n        case \"h2\":\n          $setBlocksType(selection, () => $createHeadingNode(\"h2\"));\n          break;\n        case \"bulletList\":\n          editor.dispatchCommand(INSERT_UNORDERED_LIST_COMMAND, undefined);\n          break;\n        case \"numberedList\":\n          editor.dispatchCommand(INSERT_ORDERED_LIST_COMMAND, undefined);\n          break;\n        case \"quote\":\n          $setBlocksType(selection, () => $createQuoteNode());\n          break;\n      }\n    });\n  };\n\n  if (!isVisible) return null;\n\n  return createPortal(\n    <div\n      ref={buttonRef}\n      className=\"absolute -left-5 z-10 transition-opacity\"\n      style={{ top: position.top }}\n    >\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        className=\"hidden\"\n        onChange={(e) => {\n          const file = e.target.files?.[0];\n          if (file) {\n            handleFileUpload(file);\n          }\n          e.target.value = \"\";\n        }}\n      />\n\n      <button\n        type=\"button\"\n        onClick={() => setIsMenuOpen(!isMenuOpen)}\n        className={cn(\n          \"flex h-6 w-6 items-center justify-center rounded-full border bg-background text-muted-foreground transition-all hover:bg-muted hover:text-foreground\",\n          isMenuOpen && \"rotate-45 bg-muted text-foreground\",\n          !isEmpty && \"opacity-0 hover:opacity-100\"\n        )}\n      >\n        <Plus className=\"h-4 w-4\" />\n      </button>\n\n      {isMenuOpen && (\n        <div className=\"absolute left-0 top-8 z-50 min-w-[200px] overflow-hidden rounded-lg border bg-popover p-1 shadow-lg animate-in fade-in-0 zoom-in-95\">\n          <p className=\"px-2 py-1 text-xs font-medium text-muted-foreground\">\n            Add blocks\n          </p>\n          <button\n            onClick={() => triggerFileInput(\"image/*\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <ImagePlus className=\"h-4 w-4\" />\n            </div>\n            <div className=\"text-left\">\n              <p className=\"font-medium\">Image</p>\n              <p className=\"text-xs text-muted-foreground\">Upload an image</p>\n            </div>\n          </button>\n          <button\n            onClick={() => triggerFileInput(\"*/*\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <FileUp className=\"h-4 w-4\" />\n            </div>\n            <div className=\"text-left\">\n              <p className=\"font-medium\">File</p>\n              <p className=\"text-xs text-muted-foreground\">Upload any file</p>\n            </div>\n          </button>\n          <div className=\"my-1 h-px bg-border\" />\n          <button\n            onClick={() => insertBlock(\"h1\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <Heading1 className=\"h-4 w-4\" />\n            </div>\n            <span>Heading 1</span>\n          </button>\n          <button\n            onClick={() => insertBlock(\"h2\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <Heading2 className=\"h-4 w-4\" />\n            </div>\n            <span>Heading 2</span>\n          </button>\n          <button\n            onClick={() => insertBlock(\"bulletList\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <List className=\"h-4 w-4\" />\n            </div>\n            <span>Bullet List</span>\n          </button>\n          <button\n            onClick={() => insertBlock(\"numberedList\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <ListOrdered className=\"h-4 w-4\" />\n            </div>\n            <span>Numbered List</span>\n          </button>\n          <button\n            onClick={() => insertBlock(\"quote\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <Quote className=\"h-4 w-4\" />\n            </div>\n            <span>Quote</span>\n          </button>\n        </div>\n      )}\n    </div>,\n    anchorElem\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/server/api/routers/user.ts",
        "size": 10311,
        "reason": "large source sample",
        "content": "import { TRPCError } from \"@trpc/server\";\nimport { hash } from \"bcryptjs\";\nimport { z } from \"zod\";\nimport {\n  createTRPCRouter,\n  publicProcedure,\n  protectedProcedure,\n  adminProcedure,\n} from \"~/server/api/trpc\";\nimport { signUpSchema, updateProfileSchema, resetPasswordSchema } from \"~/lib/validators\";\n\n// Token expiration time: 24 hours\nconst PASSWORD_RESET_TOKEN_EXPIRY_HOURS = 24;\n\n// Extended signup schema that accepts optional invite token\nconst registerSchema = signUpSchema.extend({\n  inviteToken: z.string().optional(),\n});\n\nexport const userRouter = createTRPCRouter({\n  register: publicProcedure\n    .input(registerSchema)\n    .mutation(async ({ ctx, input }) => {\n      // Check if this is the first user (no invite needed)\n      const userCount = await ctx.db.user.count();\n      const isFirstUser = userCount === 0;\n\n      // If not first user, require valid invite token\n      if (!isFirstUser) {\n        if (!input.inviteToken) {\n          throw new TRPCError({\n            code: \"FORBIDDEN\",\n            message: \"Registration requires an invite link\",\n          });\n        }\n\n        // Validate invite token\n        const settings = await ctx.db.siteSettings.findFirst({\n          where: { inviteToken: input.inviteToken },\n        });\n\n        if (!settings) {\n          throw new TRPCError({\n            code: \"FORBIDDEN\",\n            message: \"Invalid or expired invite link\",\n          });\n        }\n      }\n\n      const existingUser = await ctx.db.user.findUnique({\n        where: { email: input.email },\n      });\n\n      if (existingUser) {\n        throw new TRPCError({\n          code: \"CONFLICT\",\n          message: \"User with this email already exists\",\n        });\n      }\n\n      const passwordHash = await hash(input.password, 12);\n\n      // First user becomes OWNER, others are MEMBER\n      const role = isFirstUser ? \"OWNER\" : \"MEMBER\";\n\n      const user = await ctx.db.user.create({\n        data: {\n          email: input.email,\n          passwordHash,\n          displayName: input.displayName,\n          role,\n        },\n        select: {\n          id: true,\n          email: true,\n          displayName: true,\n          role: true,\n        },\n      });\n\n      return { ...user, isFirstUser };\n    }),\n\n  me: protectedProcedure.query(async ({ ctx }) => {\n    const user = await ctx.db.user.findUnique({\n      where: { id: ctx.session.user.id },\n      select: {\n        id: true,\n        email: true,\n        displayName: true,\n        avatarUrl: true,\n        role: true,\n        createdAt: true,\n      },\n    });\n\n    if (!user) {\n      throw new TRPCError({ code: \"NOT_FOUND\" });\n    }\n\n    return user;\n  }),\n\n  getById: protectedProcedure\n    .input(z.object({ id: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const user = await ctx.db.user.findUnique({\n        where: { id: input.id },\n        select: {\n          id: true,\n          email: true,\n          displayName: true,\n          avatarUrl: true,\n          deactivated: true,\n          createdAt: true,\n        },\n      });\n\n      if (!user) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      return user;\n    }),\n\n  updateProfile: protectedProcedure\n    .input(updateProfileSchema)\n    .mutation(async ({ ctx, input }) => {\n      const user = await ctx.db.user.update({\n        where: { id: ctx.session.user.id },\n        data: input,\n        select: {\n          id: true,\n          email: true,\n          displayName: true,\n          avatarUrl: true,\n        },\n      });\n\n      return user;\n    }),\n\n  search: protectedProcedure\n    .input(z.object({ query: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const users = await ctx.db.user.findMany({\n        where: input.query\n          ? {\n              deactivated: false,\n              OR: [\n                { displayName: { contains: input.query, mode: \"insensitive\" } },\n                { email: { contains: input.query, mode: \"insensitive\" } },\n              ],\n            }\n          : {\n              deactivated: false,\n            },\n        select: {\n          id: true,\n          displayName: true,\n          avatarUrl: true,\n        },\n        orderBy: { displayName: \"asc\" },\n        take: 10,\n      });\n\n      return users;\n    }),\n\n  // Admin endpoints\n  list: adminProcedure\n    .input(\n      z.object({\n        cursor: z.string().optional(),\n        limit: z.number().min(1).max(100).default(50),\n      })\n    )\n    .query(async ({ ctx, input }) => {\n      const users = await ctx.db.user.findMany({\n        take: input.limit + 1,\n        cursor: input.cursor ? { id: input.cursor } : undefined,\n        orderBy: { createdAt: \"desc\" },\n        select: {\n          id: true,\n          email: true,\n          displayName: true,\n          avatarUrl: true,\n          role: true,\n          deactivated: true,\n          createdAt: true,\n        },\n      });\n\n      let nextCursor: string | undefined;\n      if (users.length > input.limit) {\n        const nextItem = users.pop();\n        nextCursor = nextItem?.id;\n      }\n\n      return { users, nextCursor };\n    }),\n\n  updateRole: adminProcedure\n    .input(\n      z.object({\n        userId: z.string(),\n        role: z.enum([\"MEMBER\", \"ADMIN\"]),\n      })\n    )\n    .mutation(async ({ ctx, input }) => {\n      // Can't change owner's role or their own role\n      const targetUser = await ctx.db.user.findUnique({\n        where: { id: input.userId },\n      });\n\n      if (!targetUser) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      if (targetUser.role === \"OWNER\") {\n        throw new TRPCError({\n          code: \"FORBIDDEN\",\n          message: \"Cannot change owner's role\",\n        });\n      }\n\n      if (input.userId === ctx.session.user.id) {\n        throw new TRPCError({\n          code: \"FORBIDDEN\",\n          message: \"Cannot change your own role\",\n        });\n      }\n\n      const user = await ctx.db.user.update({\n        where: { id: input.userId },\n        data: { role: input.role },\n        select: {\n          id: true,\n          role: true,\n        },\n      });\n\n      return user;\n    }),\n\n  setDeactivated: adminProcedure\n    .input(\n      z.object({\n        userId: z.string(),\n        deactivated: z.boolean(),\n      })\n    )\n    .mutation(async ({ ctx, input }) => {\n      // Can't deactivate owner or self\n      const targetUser = await ctx.db.user.findUnique({\n        where: { id: input.userId },\n      });\n\n      if (!targetUser) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      if (targetUser.role === \"OWNER\") {\n        throw new TRPCError({\n          code: \"FORBIDDEN\",\n          message: \"Cannot deactivate the owner account\",\n        });\n      }\n\n      if (input.userId === ctx.session.user.id) {\n        throw new TRPCError({\n          code: \"FORBIDDEN\",\n          message: \"Cannot deactivate your own account\",\n        });\n      }\n\n      const user = await ctx.db.user.update({\n        where: { id: input.userId },\n        data: { deactivated: input.deactivated },\n        select: {\n          id: true,\n          deactivated: true,\n        },\n      });\n\n      return user;\n    }),\n\n  // Password reset endpoints\n  generatePasswordResetToken: adminProcedure\n    .input(z.object({ userId: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      const targetUser = await ctx.db.user.findUnique({\n        where: { id: input.userId },\n        select: { id: true, displayName: true, email: true },\n      });\n\n      if (!targetUser) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      // Invalidate any existing unused tokens for this user\n      await ctx.db.passwordResetToken.updateMany({\n        where: {\n          userId: input.userId,\n          usedAt: null,\n        },\n        data: {\n          usedAt: new Date(), // Mark as used/expired\n        },\n      });\n\n      // Create new token\n      const expiresAt = new Date();\n      expiresAt.setHours(expiresAt.getHours() + PASSWORD_RESET_TOKEN_EXPIRY_HOURS);\n\n      const token = await ctx.db.passwordResetToken.create({\n        data: {\n          userId: input.userId,\n          expiresAt,\n        },\n      });\n\n      return {\n        token: token.id,\n        expiresAt: token.expiresAt,\n        user: targetUser,\n      };\n    }),\n\n  validatePasswordResetToken: publicProcedure\n    .input(z.object({ token: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const resetToken = await ctx.db.passwordResetToken.findUnique({\n        where: { id: input.token },\n        include: {\n          user: {\n            select: {\n              id: true,\n              displayName: true,\n              email: true,\n            },\n          },\n        },\n      });\n\n      if (!resetToken) {\n        return { valid: false, reason: \"Token not found\" };\n      }\n\n      if (resetToken.usedAt) {\n        return { valid: false, reason: \"Token has already been used\" };\n      }\n\n      if (resetToken.expiresAt < new Date()) {\n        return { valid: false, reason: \"Token has expired\" };\n      }\n\n      return {\n        valid: true,\n        user: resetToken.user,\n      };\n    }),\n\n  resetPassword: publicProcedure\n    .input(resetPasswordSchema)\n    .mutation(async ({ ctx, input }) => {\n      const resetToken = await ctx.db.passwordResetToken.findUnique({\n        where: { id: input.token },\n        include: { user: true },\n      });\n\n      if (!resetToken) {\n        throw new TRPCError({\n          code: \"NOT_FOUND\",\n          message: \"Invalid reset token\",\n        });\n      }\n\n      if (resetToken.usedAt) {\n        throw new TRPCError({\n          code: \"BAD_REQUEST\",\n          message: \"This reset link has already been used\",\n        });\n      }\n\n      if (resetToken.expiresAt < new Date()) {\n        throw new TRPCError({\n          code: \"BAD_REQUEST\",\n          message: \"This reset link has expired\",\n        });\n      }\n\n      // Hash new password\n      const passwordHash = await hash(input.password, 12);\n\n      // Update user's password and mark token as used\n      await ctx.db.$transaction([\n        ctx.db.user.update({\n          where: { id: resetToken.userId },\n          data: { passwordHash },\n        }),\n        ctx.db.passwordResetToken.update({\n          where: { id: input.token },\n          data: { usedAt: new Date() },\n        }),\n      ]);\n\n      return { success: true };\n    }),\n});\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/Command.stories.tsx",
        "size": 9845,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n} from \"./command\";\nimport { Button } from \"./button\";\nimport {\n  Calculator,\n  Calendar,\n  CreditCard,\n  Settings,\n  User,\n  Smile,\n  Search,\n  FileText,\n  Mail,\n  MessageSquare,\n} from \"lucide-react\";\nimport { useState } from \"react\";\n\nconst meta: Meta<typeof Command> = {\n  title: \"UI/Command\",\n  component: Command,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A command palette component for quick actions and search. Built on cmdk library.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof Command>;\n\nexport const Default: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Type a command or search...\" />\n      <CommandList>\n        <CommandEmpty>No results found.</CommandEmpty>\n        <CommandGroup heading=\"Suggestions\">\n          <CommandItem>\n            <Calendar className=\"mr-2 h-4 w-4\" />\n            <span>Calendar</span>\n          </CommandItem>\n          <CommandItem>\n            <Smile className=\"mr-2 h-4 w-4\" />\n            <span>Search Emoji</span>\n          </CommandItem>\n          <CommandItem>\n            <Calculator className=\"mr-2 h-4 w-4\" />\n            <span>Calculator</span>\n          </CommandItem>\n        </CommandGroup>\n        <CommandSeparator />\n        <CommandGroup heading=\"Settings\">\n          <CommandItem>\n            <User className=\"mr-2 h-4 w-4\" />\n            <span>Profile</span>\n            <CommandShortcut>⌘P</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <CreditCard className=\"mr-2 h-4 w-4\" />\n            <span>Billing</span>\n            <CommandShortcut>⌘B</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <Settings className=\"mr-2 h-4 w-4\" />\n            <span>Settings</span>\n            <CommandShortcut>⌘S</CommandShortcut>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n};\n\nexport const WithSearch: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Search documents...\" />\n      <CommandList>\n        <CommandEmpty>No documents found.</CommandEmpty>\n        <CommandGroup heading=\"Recent Documents\">\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Project Proposal.docx</span>\n          </CommandItem>\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Meeting Notes.md</span>\n          </CommandItem>\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Budget 2024.xlsx</span>\n          </CommandItem>\n        </CommandGroup>\n        <CommandSeparator />\n        <CommandGroup heading=\"Shared with me\">\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Design Guidelines.pdf</span>\n          </CommandItem>\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Brand Assets.zip</span>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Command menu configured as a document search interface.\",\n      },\n    },\n  },\n};\n\nexport const Navigation: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Go to...\" />\n      <CommandList>\n        <CommandEmpty>No pages found.</CommandEmpty>\n        <CommandGroup heading=\"Quick Navigation\">\n          <CommandItem>\n            <span className=\"mr-2\">🏠</span>\n            <span>Home</span>\n            <CommandShortcut>G H</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <span className=\"mr-2\">📊</span>\n            <span>Dashboard</span>\n            <CommandShortcut>G D</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <span className=\"mr-2\">📁</span>\n            <span>Projects</span>\n            <CommandShortcut>G P</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <span className=\"mr-2\">⚙️</span>\n            <span>Settings</span>\n            <CommandShortcut>G S</CommandShortcut>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Command menu for quick page navigation.\",\n      },\n    },\n  },\n};\n\nconst DialogDemo = () => {\n  const [open, setOpen] = useState(false);\n\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        onClick={() => setOpen(true)}\n        className=\"justify-between w-[250px]\"\n      >\n        <span className=\"flex items-center\">\n          <Search className=\"mr-2 h-4 w-4\" />\n          Search...\n        </span>\n        <kbd className=\"pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground\">\n          <span className=\"text-xs\">⌘</span>K\n        </kbd>\n      </Button>\n      <CommandDialog open={open} onOpenChange={setOpen}>\n        <CommandInput placeholder=\"Type a command or search...\" />\n        <CommandList>\n          <CommandEmpty>No results found.</CommandEmpty>\n          <CommandGroup heading=\"Actions\">\n            <CommandItem onSelect={() => setOpen(false)}>\n              <Mail className=\"mr-2 h-4 w-4\" />\n              <span>Compose Email</span>\n            </CommandItem>\n            <CommandItem onSelect={() => setOpen(false)}>\n              <MessageSquare className=\"mr-2 h-4 w-4\" />\n              <span>New Message</span>\n            </CommandItem>\n            <CommandItem onSelect={() => setOpen(false)}>\n              <FileText className=\"mr-2 h-4 w-4\" />\n              <span>New Document</span>\n            </CommandItem>\n          </CommandGroup>\n          <CommandSeparator />\n          <CommandGroup heading=\"Settings\">\n            <CommandItem onSelect={() => setOpen(false)}>\n              <User className=\"mr-2 h-4 w-4\" />\n              <span>Profile</span>\n              <CommandShortcut>⌘P</CommandShortcut>\n            </CommandItem>\n            <CommandItem onSelect={() => setOpen(false)}>\n              <Settings className=\"mr-2 h-4 w-4\" />\n              <span>Settings</span>\n              <CommandShortcut>⌘,</CommandShortcut>\n            </CommandItem>\n          </CommandGroup>\n        </CommandList>\n      </CommandDialog>\n    </>\n  );\n};\n\nexport const AsDialog: Story = {\n  render: () => <DialogDemo />,\n  parameters: {\n    docs: {\n      description: {\n        story:\n          \"Command menu as a modal dialog, commonly triggered by ⌘K or a search button.\",\n      },\n    },\n  },\n};\n\nexport const UserSearch: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Search users...\" />\n      <CommandList>\n        <CommandEmpty>No users found.</CommandEmpty>\n        <CommandGroup heading=\"Team Members\">\n          <CommandItem>\n            <div className=\"flex items-center\">\n              <div className=\"h-8 w-8 rounded-full bg-muted mr-2 flex items-center justify-center text-xs font-medium\">\n                JD\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">John Doe</p>\n                <p className=\"text-xs text-muted-foreground\">john@example.com</p>\n              </div>\n            </div>\n          </CommandItem>\n          <CommandItem>\n            <div className=\"flex items-center\">\n              <div className=\"h-8 w-8 rounded-full bg-muted mr-2 flex items-center justify-center text-xs font-medium\">\n                JS\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">Jane Smith</p>\n                <p className=\"text-xs text-muted-foreground\">jane@example.com</p>\n              </div>\n            </div>\n          </CommandItem>\n          <CommandItem>\n            <div className=\"flex items-center\">\n              <div className=\"h-8 w-8 rounded-full bg-muted mr-2 flex items-center justify-center text-xs font-medium\">\n                BJ\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">Bob Johnson</p>\n                <p className=\"text-xs text-muted-foreground\">bob@example.com</p>\n              </div>\n            </div>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Command menu for searching and selecting users.\",\n      },\n    },\n  },\n};\n\nexport const Disabled: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Type a command...\" />\n      <CommandList>\n        <CommandEmpty>No results found.</CommandEmpty>\n        <CommandGroup heading=\"Actions\">\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Create Document</span>\n          </CommandItem>\n          <CommandItem disabled>\n            <Mail className=\"mr-2 h-4 w-4\" />\n            <span>Send Email (Coming Soon)</span>\n          </CommandItem>\n          <CommandItem>\n            <Settings className=\"mr-2 h-4 w-4\" />\n            <span>Settings</span>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Command menu with a disabled item.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/app/(main)/projects/[id]/edit/page.tsx",
        "size": 9781,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useRouter, useParams } from \"next/navigation\";\nimport { Button } from \"~/components/ui/button\";\nimport { Input } from \"~/components/ui/input\";\nimport { Label } from \"~/components/ui/label\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"~/components/ui/card\";\nimport { CoverUpload } from \"~/components/projects/CoverUpload\";\nimport { SimpleMarkdownEditor } from \"~/components/editor/SimpleMarkdownEditor\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Loader2, Plus, Trash2, ArrowLeft } from \"lucide-react\";\nimport Link from \"next/link\";\nimport type { SerializedEditorState } from \"lexical\";\n\ninterface ProjectUrl {\n  title: string;\n  url: string;\n}\n\n// Check if editor state has actual content\nfunction hasContent(editorState: SerializedEditorState | null): boolean {\n  if (!editorState) return false;\n\n  const root = editorState.root;\n  if (!root || !Array.isArray(root.children)) return false;\n\n  for (const child of root.children) {\n    const childNode = child as { type: string; children?: Array<{ type: string; text?: string }> };\n    if (childNode.type === \"paragraph\" && Array.isArray(childNode.children)) {\n      for (const textNode of childNode.children) {\n        if (textNode.type === \"text\" && textNode.text?.trim()) {\n          return true;\n        }\n        // Mentions count as content\n        if (textNode.type === \"mention\") {\n          return true;\n        }\n      }\n    }\n    if (childNode.type === \"list\") {\n      return true;\n    }\n  }\n\n  return false;\n}\n\n// Check if content is a Lexical editor state\nfunction isLexicalContent(content: unknown): content is SerializedEditorState {\n  if (!content || typeof content !== \"object\") return false;\n  const c = content as Record<string, unknown>;\n  return c.root !== undefined && typeof c.root === \"object\";\n}\n\n// Convert old { text: string } format to Lexical editor state\nfunction convertOldFormatToLexical(content: unknown): SerializedEditorState | null {\n  if (!content || typeof content !== \"object\") return null;\n\n  // If it's already Lexical format, return it\n  if (isLexicalContent(content)) {\n    return content;\n  }\n\n  // Convert old { text: string } format\n  const c = content as Record<string, unknown>;\n  if (typeof c.text === \"string\" && c.text.trim()) {\n    return {\n      root: {\n        children: [\n          {\n            children: [\n              {\n                detail: 0,\n                format: 0,\n                mode: \"normal\",\n                style: \"\",\n                text: c.text,\n                type: \"text\",\n                version: 1,\n              },\n            ],\n            direction: \"ltr\",\n            format: \"\",\n            indent: 0,\n            type: \"paragraph\",\n            version: 1,\n          },\n        ],\n        direction: \"ltr\",\n        format: \"\",\n        indent: 0,\n        type: \"root\",\n        version: 1,\n      },\n    } as unknown as SerializedEditorState;\n  }\n\n  return null;\n}\n\nexport default function EditProjectPage() {\n  const router = useRouter();\n  const params = useParams();\n  const projectId = params.id as string;\n\n  const [name, setName] = useState(\"\");\n  const [description, setDescription] = useState<SerializedEditorState | null>(null);\n  const [initialDescription, setInitialDescription] = useState<SerializedEditorState | null>(null);\n  const [coverUrl, setCoverUrl] = useState<string | null>(null);\n  const [urls, setUrls] = useState<ProjectUrl[]>([]);\n  const [isInitialized, setIsInitialized] = useState(false);\n\n  const { data: project, isLoading } = api.project.getById.useQuery(\n    { id: projectId },\n    { enabled: !!projectId }\n  );\n\n  const updateMutation = api.project.update.useMutation({\n    onSuccess: () => {\n      router.push(`/projects/${projectId}`);\n    },\n  });\n\n  // Initialize form with project data\n  useEffect(() => {\n    if (project && !isInitialized) {\n      setName(project.name);\n      // Convert description to Lexical format (handles both old and new format)\n      const lexicalDesc = convertOldFormatToLexical(project.description);\n      setInitialDescription(lexicalDesc);\n      setDescription(lexicalDesc);\n      setCoverUrl(project.coverUrl);\n      setUrls(\n        project.urls.map((u) => ({\n          title: u.title,\n          url: u.url,\n        }))\n      );\n      setIsInitialized(true);\n    }\n  }, [project, isInitialized]);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!name.trim()) return;\n\n    updateMutation.mutate({\n      id: projectId,\n      name: name.trim(),\n      description: hasContent(description) ? description : null,\n      coverUrl: coverUrl,\n      urls: urls.filter((u) => u.title && u.url),\n    });\n  };\n\n  const addUrl = () => {\n    setUrls([...urls, { title: \"\", url: \"\" }]);\n  };\n\n  const updateUrl = (index: number, field: \"title\" | \"url\", value: string) => {\n    const newUrls = [...urls];\n    newUrls[index] = { ...newUrls[index]!, [field]: value };\n    setUrls(newUrls);\n  };\n\n  const removeUrl = (index: number) => {\n    setUrls(urls.filter((_, i) => i !== index));\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center py-20\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (!project) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-20\">\n        <p className=\"text-lg text-muted-foreground\">Project not found</p>\n        <Button asChild variant=\"link\" className=\"mt-2\">\n          <Link href=\"/projects\">Back to Projects</Link>\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"mx-auto max-w-2xl\">\n      <div className=\"mb-6\">\n        <Link\n          href={`/projects/${projectId}`}\n          className=\"inline-flex items-center text-sm text-muted-foreground hover:text-foreground\"\n        >\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back to project\n        </Link>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Edit Project</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Project Name *</Label>\n              <Input\n                id=\"name\"\n                value={name}\n                onChange={(e) => setName(e.target.value)}\n                placeholder=\"My Awesome Project\"\n                required\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Description (optional)</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Supports **bold**, *italic*, [links](url), and lists\n              </p>\n              <div className=\"rounded-md border bg-background px-3 py-2 focus-within:ring-1 focus-within:ring-ring\">\n                {isInitialized && (\n                  <SimpleMarkdownEditor\n                    key={projectId} // Reset editor when project changes\n                    initialContent={initialDescription}\n                    onChange={setDescription}\n                    placeholder=\"What is this project about?\"\n                    minHeight=\"60px\"\n                  />\n                )}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Cover Image (optional)</Label>\n              <CoverUpload value={coverUrl} onChange={setCoverUrl} />\n            </div>\n\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <Label>Related Links</Label>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={addUrl}\n                >\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Add Link\n                </Button>\n              </div>\n\n              {urls.length === 0 && (\n                <p className=\"text-sm text-muted-foreground\">\n                  No links added yet\n                </p>\n              )}\n\n              {urls.map((projectUrl, index) => (\n                <div key={index} className=\"flex gap-2\">\n                  <Input\n                    placeholder=\"Link title\"\n                    value={projectUrl.title}\n                    onChange={(e) => updateUrl(index, \"title\", e.target.value)}\n                    className=\"flex-1\"\n                  />\n                  <Input\n                    type=\"url\"\n                    placeholder=\"https://...\"\n                    value={projectUrl.url}\n                    onChange={(e) => updateUrl(index, \"url\", e.target.value)}\n                    className=\"flex-2\"\n                  />\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => removeUrl(index)}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n\n            <div className=\"flex gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => router.push(`/projects/${projectId}`)}\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={!name.trim() || updateMutation.isPending}\n              >\n                {updateMutation.isPending && (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                )}\n                Save Changes\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/app/(main)/admin/users/page.tsx",
        "size": 8956,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"~/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"~/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport { Input } from \"~/components/ui/input\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Loader2, Copy, Check, MoreHorizontal, KeyRound, Shield, ShieldOff, UserX, UserCheck } from \"lucide-react\";\n\ninterface ResetLinkData {\n  url: string;\n  userName: string;\n  expiresAt: Date;\n}\n\nexport default function AdminUsersPage() {\n  const { data, isLoading } = api.user.list.useQuery({ limit: 50 });\n  const utils = api.useUtils();\n  const [resetLinkData, setResetLinkData] = useState<ResetLinkData | null>(null);\n  const [copied, setCopied] = useState(false);\n\n  const updateRoleMutation = api.user.updateRole.useMutation({\n    onSuccess: () => {\n      utils.user.list.invalidate();\n    },\n  });\n\n  const setDeactivatedMutation = api.user.setDeactivated.useMutation({\n    onSuccess: () => {\n      utils.user.list.invalidate();\n    },\n  });\n\n  const generateResetTokenMutation = api.user.generatePasswordResetToken.useMutation({\n    onSuccess: (data) => {\n      const baseUrl = window.location.origin;\n      const resetUrl = `${baseUrl}/reset-password/${data.token}`;\n      setResetLinkData({\n        url: resetUrl,\n        userName: data.user.displayName,\n        expiresAt: data.expiresAt,\n      });\n    },\n  });\n\n  const handleCopyLink = async () => {\n    if (resetLinkData) {\n      await navigator.clipboard.writeText(resetLinkData.url);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    }\n  };\n\n  const handleCloseDialog = () => {\n    setResetLinkData(null);\n    setCopied(false);\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardContent className=\"py-8\">\n          <div className=\"flex justify-center\">\n            <Loader2 className=\"h-6 w-6 animate-spin\" />\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <>\n      <Card>\n        <CardHeader>\n          <CardTitle>User Management</CardTitle>\n          <CardDescription>\n            Manage user roles and permissions. Users can be promoted to Admin to\n            give them access to these settings.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"divide-y\">\n            {data?.users.map((user) => (\n              <div\n                key={user.id}\n                className=\"flex items-center justify-between py-4\"\n              >\n                <div className=\"flex items-center gap-3\">\n                  <UserAvatar avatarUrl={user.avatarUrl} name={user.displayName} />\n                  <div>\n                    <div className=\"flex items-center gap-2\">\n                      <p className=\"font-medium\">{user.displayName}</p>\n                      {user.deactivated && <DeactivatedBadge />}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">{user.email}</p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <RoleBadge role={user.role} />\n                  {user.role !== \"OWNER\" && (\n                    <DropdownMenu>\n                      <DropdownMenuTrigger asChild>\n                        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\n                          <MoreHorizontal className=\"h-4 w-4\" />\n                          <span className=\"sr-only\">Actions</span>\n                        </Button>\n                      </DropdownMenuTrigger>\n                      <DropdownMenuContent align=\"end\">\n                        {!user.deactivated && (\n                          <>\n                            <DropdownMenuItem\n                              onClick={() =>\n                                generateResetTokenMutation.mutate({ userId: user.id })\n                              }\n                              disabled={generateResetTokenMutation.isPending}\n                            >\n                              <KeyRound className=\"h-4 w-4\" />\n                              Reset Password\n                            </DropdownMenuItem>\n                            <DropdownMenuItem\n                              onClick={() =>\n                                updateRoleMutation.mutate({\n                                  userId: user.id,\n                                  role: user.role === \"ADMIN\" ? \"MEMBER\" : \"ADMIN\",\n                                })\n                              }\n                              disabled={updateRoleMutation.isPending}\n                            >\n                              {user.role === \"ADMIN\" ? (\n                                <>\n                                  <ShieldOff className=\"h-4 w-4\" />\n                                  Remove Admin\n                                </>\n                              ) : (\n                                <>\n                                  <Shield className=\"h-4 w-4\" />\n                                  Make Admin\n                                </>\n                              )}\n                            </DropdownMenuItem>\n                            <DropdownMenuSeparator />\n                          </>\n                        )}\n                        <DropdownMenuItem\n                          onClick={() =>\n                            setDeactivatedMutation.mutate({\n                              userId: user.id,\n                              deactivated: !user.deactivated,\n                            })\n                          }\n                          disabled={setDeactivatedMutation.isPending}\n                          className={user.deactivated ? \"\" : \"text-destructive focus:bg-destructive focus:text-destructive-foreground\"}\n                        >\n                          {user.deactivated ? (\n                            <>\n                              <UserCheck className=\"h-4 w-4\" />\n                              Reactivate\n                            </>\n                          ) : (\n                            <>\n                              <UserX className=\"h-4 w-4\" />\n                              Deactivate\n                            </>\n                          )}\n                        </DropdownMenuItem>\n                      </DropdownMenuContent>\n                    </DropdownMenu>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Dialog open={resetLinkData !== null} onOpenChange={(open) => !open && handleCloseDialog()}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Password Reset Link Generated</DialogTitle>\n            <DialogDescription>\n              Share this one-time link with {resetLinkData?.userName} to reset their password.\n              This link will expire in 24 hours.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"flex gap-2\">\n              <Input\n                value={resetLinkData?.url ?? \"\"}\n                readOnly\n                className=\"font-mono text-sm\"\n              />\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                onClick={handleCopyLink}\n                className=\"shrink-0\"\n              >\n                {copied ? (\n                  <Check className=\"h-4 w-4 text-green-500\" />\n                ) : (\n                  <Copy className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n            <p className=\"text-sm text-muted-foreground\">\n              This link can only be used once. After the password is reset, the link becomes invalid.\n            </p>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n\nfunction RoleBadge({ role }: { role: string }) {\n  const styles = {\n    OWNER: \"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400\",\n    ADMIN: \"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400\",\n    MEMBER: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400\",\n  };\n\n  return (\n    <span\n      className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${styles[role as keyof typeof styles] || styles.MEMBER}`}\n    >\n      {role}\n    </span>\n  );\n}\n\nfunction DeactivatedBadge() {\n  return (\n    <span className=\"inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900/30 dark:text-red-400\">\n      Deactivated\n    </span>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/app/(main)/compose/page.tsx",
        "size": 8610,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useCallback, useEffect, useRef } from \"react\";\nimport { useRouter, useSearchParams } from \"next/navigation\";\nimport { ArrowLeft, Loader2, Trash2 } from \"lucide-react\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  PostEditor,\n  extractAttachments,\n  type PostEditorData,\n} from \"~/components/post/PostEditor\";\nimport { api } from \"~/lib/trpc/client\";\nimport type { SerializedEditorState } from \"lexical\";\n\nconst AUTOSAVE_DELAY = 1500; // 1.5 seconds debounce\n\nexport default function ComposePage() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const draftId = searchParams.get(\"draft\");\n\n  const [editorData, setEditorData] = useState<PostEditorData>({\n    title: \"\",\n    content: null,\n    liveUrl: \"\",\n    projects: [],\n    hideFromHome: false,\n  });\n  const [currentDraftId, setCurrentDraftId] = useState<string | null>(draftId);\n  const [isSaving, setIsSaving] = useState(false);\n  const [lastSaved, setLastSaved] = useState<Date | null>(null);\n  const [hasScrolled, setHasScrolled] = useState(false);\n\n  const autosaveTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const isLoadedRef = useRef(false);\n  const isInitialRenderRef = useRef(true);\n  const currentDraftIdRef = useRef<string | null>(draftId);\n  // Stable key for Editor - only set once on mount to prevent remount after first save\n  const editorKeyRef = useRef<string>(draftId || \"new\");\n\n  // Load existing draft if draftId is provided\n  const { data: existingDraft, isLoading: isDraftLoading } =\n    api.draft.getById.useQuery(\n      { id: draftId! },\n      { enabled: !!draftId && !isLoadedRef.current }\n    );\n\n  // Initialize form with draft data\n  useEffect(() => {\n    if (existingDraft && !isLoadedRef.current) {\n      setEditorData({\n        title: existingDraft.title || \"\",\n        content: existingDraft.content as SerializedEditorState | null,\n        liveUrl: existingDraft.liveUrl || \"\",\n        projects: [], // Drafts don't store projects currently\n        hideFromHome: false,\n      });\n      setCurrentDraftId(existingDraft.id);\n      isLoadedRef.current = true;\n    }\n  }, [existingDraft]);\n\n  const utils = api.useUtils();\n\n  const saveDraftMutation = api.draft.save.useMutation({\n    onSuccess: (draft) => {\n      const isNewDraft = !currentDraftIdRef.current;\n      currentDraftIdRef.current = draft.id;\n      setCurrentDraftId(draft.id);\n      setLastSaved(new Date());\n      setIsSaving(false);\n      // Mark as loaded so we don't show the loading screen\n      isLoadedRef.current = true;\n      // Invalidate draft list so it appears in the menu immediately\n      utils.draft.list.invalidate();\n      // Update URL with draft ID if it's a new draft (without causing navigation)\n      if (isNewDraft && draft.id) {\n        window.history.replaceState(null, \"\", `/compose?draft=${draft.id}`);\n      }\n    },\n    onError: () => {\n      setIsSaving(false);\n    },\n  });\n\n  const deleteDraftMutation = api.draft.delete.useMutation({\n    onSuccess: () => {\n      utils.draft.list.invalidate();\n      router.push(\"/\");\n    },\n  });\n\n  const createMutation = api.post.create.useMutation({\n    onSuccess: (post) => {\n      // Delete the draft after successful publish\n      if (currentDraftId) {\n        deleteDraftMutation.mutate({ id: currentDraftId });\n      }\n      utils.draft.list.invalidate();\n      router.push(`/post/${post.id}`);\n    },\n  });\n\n  // Debounced autosave effect - watches state changes and saves after delay\n  useEffect(() => {\n    // Skip autosave on initial render\n    if (isInitialRenderRef.current) {\n      isInitialRenderRef.current = false;\n      return;\n    }\n\n    // Skip if still loading draft data\n    if (draftId && !isLoadedRef.current) {\n      return;\n    }\n\n    // Clear any existing timeout\n    if (autosaveTimeoutRef.current) {\n      clearTimeout(autosaveTimeoutRef.current);\n    }\n\n    // Only save if there's content or title\n    if (!editorData.title && !editorData.content) {\n      return;\n    }\n\n    autosaveTimeoutRef.current = setTimeout(() => {\n      setIsSaving(true);\n      saveDraftMutation.mutate({\n        id: currentDraftIdRef.current || undefined,\n        title: editorData.title || null,\n        content: editorData.content || null,\n        liveUrl: editorData.liveUrl || null,\n        projectIds: editorData.projects.map((p) => p.id),\n      });\n    }, AUTOSAVE_DELAY);\n\n    // Cleanup timeout on unmount or when dependencies change\n    return () => {\n      if (autosaveTimeoutRef.current) {\n        clearTimeout(autosaveTimeoutRef.current);\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [editorData, draftId]);\n\n  const handleEditorChange = useCallback((data: PostEditorData) => {\n    setEditorData(data);\n  }, []);\n\n  const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {\n    setHasScrolled(e.currentTarget.scrollTop > 0);\n  }, []);\n\n  const handleSubmit = () => {\n    if (!editorData.content) return;\n\n    const attachments = extractAttachments(editorData.content);\n\n    createMutation.mutate({\n      title: editorData.title || undefined,\n      content: editorData.content,\n      liveUrl: editorData.liveUrl || undefined,\n      hideFromHome: editorData.hideFromHome,\n      projectIds: editorData.projects.map((p) => p.id),\n      attachments,\n    });\n  };\n\n  const handleDeleteDraft = () => {\n    if (currentDraftId) {\n      if (confirm(\"Are you sure you want to discard this draft?\")) {\n        deleteDraftMutation.mutate({ id: currentDraftId });\n      }\n    } else {\n      router.back();\n    }\n  };\n\n  // Only show loading screen when loading an existing draft from URL (not after creating a new one)\n  if (isDraftLoading && draftId && !isLoadedRef.current) {\n    return (\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-background\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex flex-col bg-background\">\n      {/* Header */}\n      <header className={`relative z-10 flex h-14 shrink-0 items-center justify-between px-4 transition-shadow ${hasScrolled ? \"shadow-sm\" : \"\"}`}>\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => router.back()}\n            className=\"h-9 w-9\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          {currentDraftId && (\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={handleDeleteDraft}\n              className=\"h-9 w-9 text-muted-foreground hover:bg-destructive hover:text-destructive-foreground\"\n              disabled={deleteDraftMutation.isPending}\n            >\n              {deleteDraftMutation.isPending ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <Trash2 className=\"h-4 w-4\" />\n              )}\n            </Button>\n          )}\n        </div>\n        <div className=\"flex items-center gap-3\">\n          {/* Save indicator */}\n          <span className=\"text-xs text-muted-foreground\">\n            {isSaving ? (\n              <span className=\"flex items-center gap-1\">\n                <Loader2 className=\"h-3 w-3 animate-spin\" />\n                Saving...\n              </span>\n            ) : lastSaved ? (\n              \"Draft saved\"\n            ) : currentDraftId ? (\n              \"Draft\"\n            ) : null}\n          </span>\n          <Button\n            onClick={handleSubmit}\n            disabled={!editorData.content || createMutation.isPending}\n          >\n            {createMutation.isPending && (\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            )}\n            Publish\n          </Button>\n        </div>\n      </header>\n\n      {/* Content - scrollable */}\n      <div onScroll={handleScroll} className=\"flex-1 overflow-y-auto\">\n        <div className=\"mx-auto flex min-h-[calc(100dvh-3.5rem)] max-w-3xl flex-col px-4 py-4\">\n          <PostEditor\n            initialData={\n              existingDraft\n                ? {\n                    title: existingDraft.title || \"\",\n                    content:\n                      existingDraft.content as SerializedEditorState | null,\n                    liveUrl: existingDraft.liveUrl || \"\",\n                    projects: [],\n                  }\n                : undefined\n            }\n            onChange={handleEditorChange}\n            editorKey={editorKeyRef.current}\n          />\n        </div>\n      </div>\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/post/PostDetail.tsx",
        "size": 8582,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"~/components/ui/dialog\";\nimport { formatRelativeTime, pluralize } from \"~/lib/utils\";\nimport { ExternalLink, MoreHorizontal, Pencil, Trash2, Loader2, ChevronDown } from \"lucide-react\";\nimport { EditorContent } from \"~/components/editor/Editor\";\nimport { ReactionButton } from \"~/components/reactions/ReactionButton\";\nimport { api } from \"~/lib/trpc/client\";\nimport type { SerializedEditorState } from \"lexical\";\nimport { useSession } from \"next-auth/react\";\nimport { MediaLightboxProvider } from \"~/components/ui/media-lightbox-context\";\n\ninterface PostDetailProps {\n  post: {\n    id: string;\n    title: string | null;\n    content: unknown;\n    liveUrl: string | null;\n    createdAt: Date;\n    author: {\n      id: string;\n      displayName: string;\n      avatarUrl: string | null;\n    };\n    attachments: Array<{\n      id: string;\n      type: string;\n      url: string;\n      filename: string;\n      mimeType: string;\n      size: number;\n      thumbnailUrl: string | null;\n      width: number | null;\n      height: number | null;\n    }>;\n    projects: Array<{\n      project: {\n        id: string;\n        name: string;\n      };\n    }>;\n    reactions: Array<{\n      type: string;\n      userId: string;\n      user: {\n        id: string;\n        displayName: string;\n      };\n    }>;\n    _count: {\n      comments: number;\n    };\n  };\n}\n\nexport function PostDetail({ post }: PostDetailProps) {\n  const router = useRouter();\n  const { data: session } = useSession();\n  const isAuthor = session?.user?.id === post.author.id;\n  const isAdmin = session?.user?.role === \"ADMIN\" || session?.user?.role === \"OWNER\";\n  const canModify = isAuthor || isAdmin;\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n\n  const deleteMutation = api.post.delete.useMutation({\n    onSuccess: () => {\n      router.push(\"/\");\n    },\n  });\n\n  const handleDelete = () => {\n    deleteMutation.mutate({ id: post.id });\n  };\n\n  return (\n    <article className=\"space-y-6\">\n      {/* Header */}\n      <header className=\"space-y-4\">\n        {/* Author info */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Link href={`/user/${post.author.id}`}>\n              <UserAvatar avatarUrl={post.author.avatarUrl} name={post.author.displayName} className=\"h-10 w-10\" />\n            </Link>\n            <div className=\"flex flex-col\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Link\n                  href={`/user/${post.author.id}`}\n                  className=\"font-medium hover:underline\"\n                >\n                  {post.author.displayName}\n                </Link>\n                {post.projects.length > 0 && (\n                  <>\n                    <span className=\"text-muted-foreground\">·</span>\n                    {post.projects.length === 1 ? (\n                      <Link\n                        href={`/projects/${post.projects[0]?.project.id}`}\n                        className=\"text-muted-foreground hover:text-foreground hover:underline\"\n                      >\n                        in {post.projects[0]?.project.name}\n                      </Link>\n                    ) : (\n                      <DropdownMenu>\n                        <DropdownMenuTrigger className=\"flex items-center gap-1 text-muted-foreground hover:text-foreground\">\n                          in {post.projects.length} projects\n                          <ChevronDown className=\"h-3 w-3\" />\n                        </DropdownMenuTrigger>\n                        <DropdownMenuContent>\n                          {post.projects.map(({ project }) => (\n                            <DropdownMenuItem key={project.id} asChild>\n                              <Link href={`/projects/${project.id}`}>\n                                {project.name}\n                              </Link>\n                            </DropdownMenuItem>\n                          ))}\n                        </DropdownMenuContent>\n                      </DropdownMenu>\n                    )}\n                  </>\n                )}\n              </div>\n              <p className=\"text-xs text-muted-foreground\">\n                {formatRelativeTime(new Date(post.createdAt))}\n              </p>\n            </div>\n          </div>\n          {canModify && (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\">\n                  <MoreHorizontal className=\"h-5 w-5\" />\n                  <span className=\"sr-only\">Post options</span>\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {isAuthor && (\n                  <DropdownMenuItem asChild>\n                    <Link href={`/post/${post.id}/edit`} className=\"gap-2\">\n                      <Pencil className=\"h-4 w-4\" />\n                      Edit post\n                    </Link>\n                  </DropdownMenuItem>\n                )}\n                {(isAuthor || isAdmin) && (\n                  <>\n                    {isAuthor && <DropdownMenuSeparator />}\n                    <DropdownMenuItem\n                      onClick={() => setShowDeleteDialog(true)}\n                      className=\"gap-2 text-destructive focus:bg-destructive focus:text-destructive-foreground\"\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                      Delete post\n                    </DropdownMenuItem>\n                  </>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          )}\n        </div>\n\n        {/* Delete confirmation dialog */}\n        <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Delete post?</DialogTitle>\n              <DialogDescription>\n                This action cannot be undone. This will permanently delete the post\n                and all associated comments and reactions.\n              </DialogDescription>\n            </DialogHeader>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowDeleteDialog(false)}\n                disabled={deleteMutation.isPending}\n              >\n                Cancel\n              </Button>\n              <Button\n                variant=\"destructive\"\n                onClick={handleDelete}\n                disabled={deleteMutation.isPending}\n              >\n                {deleteMutation.isPending && (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                )}\n                Delete\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Title */}\n        {post.title && (\n          <h1 className=\"text-3xl font-bold tracking-tight\">{post.title}</h1>\n        )}\n\n      </header>\n\n      {/* Content - attachments are rendered inline via EditorContent */}\n      <MediaLightboxProvider>\n        <div className=\"prose prose-neutral dark:prose-invert max-w-none\">\n          <EditorContent content={post.content as SerializedEditorState} />\n        </div>\n      </MediaLightboxProvider>\n\n      {/* Footer */}\n      <footer className=\"flex items-center justify-between border-t pt-4\">\n        <div className=\"flex items-center gap-4\">\n          <ReactionButton\n            postId={post.id}\n            reactions={post.reactions}\n            count={post.reactions.length}\n          />\n          <span className=\"text-sm text-muted-foreground\">\n            {post._count.comments} {pluralize(post._count.comments, \"comment\")}\n          </span>\n        </div>\n\n        {post.liveUrl && (\n          <Button variant=\"outline\" asChild>\n            <a\n              href={post.liveUrl}\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"gap-2\"\n            >\n              View live\n              <ExternalLink className=\"h-4 w-4\" />\n            </a>\n          </Button>\n        )}\n      </footer>\n    </article>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/search/SearchCommand.tsx",
        "size": 8488,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport * as React from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Command } from \"cmdk\";\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\";\nimport * as VisuallyHidden from \"@radix-ui/react-visually-hidden\";\nimport { Search, FileText, FolderOpen, Loader2 } from \"lucide-react\";\nimport { cn } from \"~/lib/utils\";\nimport { api } from \"~/lib/trpc/client\";\nimport { skipToken } from \"@tanstack/react-query\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { useDebounce } from \"~/lib/hooks/useDebounce\";\n\ninterface SearchCommandProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\n// Thumbnail component with error handling\nfunction SearchThumbnail({ \n  url, \n  fallbackIcon: FallbackIcon \n}: { \n  url: string | null; \n  fallbackIcon: React.ElementType;\n}) {\n  const [hasError, setHasError] = React.useState(false);\n\n  // Reset error state when url changes\n  React.useEffect(() => {\n    setHasError(false);\n  }, [url]);\n\n  if (!url || hasError) {\n    return (\n      <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded bg-muted\">\n        <FallbackIcon className=\"h-4 w-4 text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-8 w-8 shrink-0 overflow-hidden rounded bg-muted\">\n      {/* eslint-disable-next-line @next/next/no-img-element */}\n      <img\n        src={url}\n        alt=\"\"\n        className=\"h-full w-full object-cover\"\n        onError={() => setHasError(true)}\n      />\n    </div>\n  );\n}\n\nexport function SearchCommand({ open, onOpenChange }: SearchCommandProps) {\n  const router = useRouter();\n  const [query, setQuery] = React.useState(\"\");\n  const debouncedQuery = useDebounce(query, 300);\n\n  const { data, isLoading } = api.search.global.useQuery(\n    debouncedQuery.length > 0 ? { query: debouncedQuery } : skipToken,\n    {\n      staleTime: 1000 * 60, // 1 minute\n    }\n  );\n\n  // Reset query when closing\n  React.useEffect(() => {\n    if (!open) {\n      setQuery(\"\");\n    }\n  }, [open]);\n\n  // Handle keyboard shortcut\n  React.useEffect(() => {\n    const down = (e: KeyboardEvent) => {\n      if (e.key === \"k\" && (e.metaKey || e.ctrlKey)) {\n        e.preventDefault();\n        onOpenChange(!open);\n      }\n    };\n\n    document.addEventListener(\"keydown\", down);\n    return () => document.removeEventListener(\"keydown\", down);\n  }, [open, onOpenChange]);\n\n  const handleSelect = (href: string) => {\n    onOpenChange(false);\n    router.push(href);\n  };\n\n  const hasResults =\n    data &&\n    (data.users.length > 0 || data.posts.length > 0 || data.projects.length > 0);\n  const showEmpty = debouncedQuery.length > 0 && !isLoading && !hasResults;\n\n  return (\n    <Command.Dialog\n      open={open}\n      onOpenChange={onOpenChange}\n      label=\"Global Search\"\n      className={cn(\n        \"fixed left-1/2 top-[20%] z-50 w-full max-w-lg -translate-x-1/2\",\n        \"overflow-hidden rounded-xl border bg-background shadow-2xl\"\n      )}\n    >\n      <VisuallyHidden.Root>\n        <DialogPrimitive.Title>Search</DialogPrimitive.Title>\n      </VisuallyHidden.Root>\n      <div className=\"flex items-center border-b px-3\">\n        <Search className=\"mr-2 h-4 w-4 shrink-0 text-muted-foreground\" />\n        <Command.Input\n          value={query}\n          onValueChange={setQuery}\n          placeholder=\"Search people, posts, projects...\"\n          className=\"flex h-12 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\"\n        />\n        {isLoading && (\n          <Loader2 className=\"h-4 w-4 shrink-0 animate-spin text-muted-foreground\" />\n        )}\n      </div>\n      <Command.List className=\"max-h-[400px] overflow-y-auto p-2\">\n        {query.length === 0 && (\n          <div className=\"py-6 text-center text-sm text-muted-foreground\">\n            Start typing to search...\n          </div>\n        )}\n\n        {showEmpty && (\n          <Command.Empty className=\"py-6 text-center text-sm text-muted-foreground\">\n            No results found.\n          </Command.Empty>\n        )}\n\n        {data && data.users.length > 0 && (\n          <Command.Group className=\"mb-2\">\n            <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n              People\n            </div>\n            {data.users.map((user) => (\n              <Command.Item\n                key={user.id}\n                value={`user-${user.id}-${user.displayName}`}\n                onSelect={() => handleSelect(`/user/${user.id}`)}\n                className=\"flex cursor-pointer items-center gap-3 rounded-md px-2 py-2 text-sm outline-none aria-selected:bg-foreground/5\"\n              >\n                <UserAvatar\n                  avatarUrl={user.avatarUrl}\n                  name={user.displayName}\n                  className=\"h-8 w-8\"\n                />\n                <div className=\"flex flex-col\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"font-medium\">{user.displayName}</span>\n                    {user.deactivated && (\n                      <span className=\"inline-flex items-center rounded-full bg-red-100 px-1.5 py-0.5 text-[10px] font-medium text-red-800 dark:bg-red-900/30 dark:text-red-400\">\n                        Deactivated\n                      </span>\n                    )}\n                  </div>\n                  <span className=\"text-xs text-muted-foreground\">\n                    {user.email}\n                  </span>\n                </div>\n              </Command.Item>\n            ))}\n          </Command.Group>\n        )}\n\n        {data && data.posts.length > 0 && (\n          <Command.Group className=\"mb-2\">\n            <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n              Posts\n            </div>\n            {data.posts.map((post) => (\n              <Command.Item\n                key={post.id}\n                value={`post-${post.id}-${post.title || \"untitled\"}`}\n                onSelect={() => handleSelect(`/post/${post.id}`)}\n                className=\"flex cursor-pointer items-center gap-3 rounded-md px-2 py-2 text-sm outline-none aria-selected:bg-foreground/5\"\n              >\n                <SearchThumbnail\n                  url={post.attachments[0]?.thumbnailUrl || post.attachments[0]?.url || null}\n                  fallbackIcon={FileText}\n                />\n                <div className=\"flex flex-1 flex-col overflow-hidden\">\n                  <span className=\"truncate font-medium\">\n                    {post.title || \"Untitled post\"}\n                  </span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    by {post.author.displayName}\n                  </span>\n                </div>\n              </Command.Item>\n            ))}\n          </Command.Group>\n        )}\n\n        {data && data.projects.length > 0 && (\n          <Command.Group className=\"mb-2\">\n            <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n              Projects\n            </div>\n            {data.projects.map((project) => (\n              <Command.Item\n                key={project.id}\n                value={`project-${project.id}-${project.name}`}\n                onSelect={() => handleSelect(`/projects/${project.id}`)}\n                className=\"flex cursor-pointer items-center gap-3 rounded-md px-2 py-2 text-sm outline-none aria-selected:bg-foreground/5\"\n              >\n                <SearchThumbnail\n                  url={project.coverUrl}\n                  fallbackIcon={FolderOpen}\n                />\n                <div className=\"flex flex-1 flex-col overflow-hidden\">\n                  <span className=\"truncate font-medium\">{project.name}</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    {project._count.posts} post{project._count.posts !== 1 ? \"s\" : \"\"}\n                  </span>\n                </div>\n              </Command.Item>\n            ))}\n          </Command.Group>\n        )}\n      </Command.List>\n      <div className=\"border-t px-3 py-2 text-xs text-muted-foreground\">\n        <kbd className=\"pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground\">\n          <span className=\"text-xs\">⌘</span>K\n        </kbd>\n        <span className=\"ml-2\">to toggle search</span>\n      </div>\n    </Command.Dialog>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/DropdownMenu.stories.tsx",
        "size": 8258,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n} from \"./dropdown-menu\";\nimport { Button } from \"./button\";\nimport {\n  User,\n  Settings,\n  LogOut,\n  Plus,\n  Trash2,\n  Edit,\n  Copy,\n  MoreHorizontal,\n  ChevronDown,\n} from \"lucide-react\";\nimport { useState } from \"react\";\n\nconst meta: Meta<typeof DropdownMenu> = {\n  title: \"UI/DropdownMenu\",\n  component: DropdownMenu,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A dropdown menu component for displaying a list of actions or options. Built on Radix UI DropdownMenu.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof DropdownMenu>;\n\nexport const Default: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">\n          Options\n          <ChevronDown className=\"ml-2 h-4 w-4\" />\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuLabel>My Account</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem>\n          <User className=\"mr-2 h-4 w-4\" />\n          Profile\n        </DropdownMenuItem>\n        <DropdownMenuItem>\n          <Settings className=\"mr-2 h-4 w-4\" />\n          Settings\n        </DropdownMenuItem>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\">\n          <LogOut className=\"mr-2 h-4 w-4\" />\n          Log out\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n};\n\nexport const WithShortcuts: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">Edit</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuItem>\n          <Copy className=\"mr-2 h-4 w-4\" />\n          Copy\n          <DropdownMenuShortcut>⌘C</DropdownMenuShortcut>\n        </DropdownMenuItem>\n        <DropdownMenuItem>\n          <Edit className=\"mr-2 h-4 w-4\" />\n          Edit\n          <DropdownMenuShortcut>⌘E</DropdownMenuShortcut>\n        </DropdownMenuItem>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\">\n          <Trash2 className=\"mr-2 h-4 w-4\" />\n          Delete\n          <DropdownMenuShortcut>⌘⌫</DropdownMenuShortcut>\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu items with keyboard shortcuts displayed.\",\n      },\n    },\n  },\n};\n\nconst CheckboxDemo = () => {\n  const [showPanel, setShowPanel] = useState(true);\n  const [showGrid, setShowGrid] = useState(false);\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">View Options</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuLabel>Appearance</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <DropdownMenuCheckboxItem\n          checked={showPanel}\n          onCheckedChange={setShowPanel}\n        >\n          Show Panel\n        </DropdownMenuCheckboxItem>\n        <DropdownMenuCheckboxItem\n          checked={showGrid}\n          onCheckedChange={setShowGrid}\n        >\n          Show Grid\n        </DropdownMenuCheckboxItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n};\n\nexport const WithCheckboxes: Story = {\n  render: () => <CheckboxDemo />,\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu with checkbox items for toggle options.\",\n      },\n    },\n  },\n};\n\nconst RadioDemo = () => {\n  const [position, setPosition] = useState(\"bottom\");\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">Position</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuLabel>Panel Position</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <DropdownMenuRadioGroup value={position} onValueChange={setPosition}>\n          <DropdownMenuRadioItem value=\"top\">Top</DropdownMenuRadioItem>\n          <DropdownMenuRadioItem value=\"bottom\">Bottom</DropdownMenuRadioItem>\n          <DropdownMenuRadioItem value=\"right\">Right</DropdownMenuRadioItem>\n        </DropdownMenuRadioGroup>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n};\n\nexport const WithRadioGroup: Story = {\n  render: () => <RadioDemo />,\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu with radio items for single selection.\",\n      },\n    },\n  },\n};\n\nexport const WithSubmenu: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">Menu with Submenu</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuItem>\n          <Plus className=\"mr-2 h-4 w-4\" />\n          New Item\n        </DropdownMenuItem>\n        <DropdownMenuSub>\n          <DropdownMenuSubTrigger>\n            <User className=\"mr-2 h-4 w-4\" />\n            Invite Users\n          </DropdownMenuSubTrigger>\n          <DropdownMenuSubContent>\n            <DropdownMenuItem>Email</DropdownMenuItem>\n            <DropdownMenuItem>Message</DropdownMenuItem>\n            <DropdownMenuSeparator />\n            <DropdownMenuItem>More...</DropdownMenuItem>\n          </DropdownMenuSubContent>\n        </DropdownMenuSub>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem>\n          <Settings className=\"mr-2 h-4 w-4\" />\n          Settings\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu with nested submenus for hierarchical options.\",\n      },\n    },\n  },\n};\n\nexport const IconButton: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"ghost\" size=\"icon\">\n          <MoreHorizontal className=\"h-4 w-4\" />\n          <span className=\"sr-only\">More options</span>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\">\n        <DropdownMenuItem>\n          <Edit className=\"mr-2 h-4 w-4\" />\n          Edit\n        </DropdownMenuItem>\n        <DropdownMenuItem>\n          <Copy className=\"mr-2 h-4 w-4\" />\n          Duplicate\n        </DropdownMenuItem>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\">\n          <Trash2 className=\"mr-2 h-4 w-4\" />\n          Delete\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Dropdown triggered by an icon button, commonly used for row actions.\",\n      },\n    },\n  },\n};\n\nexport const WithGroups: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">Actions</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuGroup>\n          <DropdownMenuLabel>Edit</DropdownMenuLabel>\n          <DropdownMenuItem>Cut</DropdownMenuItem>\n          <DropdownMenuItem>Copy</DropdownMenuItem>\n          <DropdownMenuItem>Paste</DropdownMenuItem>\n        </DropdownMenuGroup>\n        <DropdownMenuSeparator />\n        <DropdownMenuGroup>\n          <DropdownMenuLabel>View</DropdownMenuLabel>\n          <DropdownMenuItem>Zoom In</DropdownMenuItem>\n          <DropdownMenuItem>Zoom Out</DropdownMenuItem>\n          <DropdownMenuItem>Reset Zoom</DropdownMenuItem>\n        </DropdownMenuGroup>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu items organized into labeled groups.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/server/api/routers/comment.ts",
        "size": 7985,
        "reason": "large source sample",
        "content": "import { TRPCError } from \"@trpc/server\";\nimport { z } from \"zod\";\nimport {\n  createTRPCRouter,\n  protectedProcedure,\n  activeUserProcedure,\n} from \"~/server/api/trpc\";\nimport { createCommentSchema, updateCommentSchema } from \"~/lib/validators\";\nimport { extractUserMentions } from \"~/lib/utils\";\n\nexport const commentRouter = createTRPCRouter({\n  create: activeUserProcedure\n    .input(createCommentSchema)\n    .mutation(async ({ ctx, input }) => {\n      // Verify post exists\n      const post = await ctx.db.post.findUnique({\n        where: { id: input.postId },\n        select: { id: true, authorId: true },\n      });\n\n      if (!post) {\n        throw new TRPCError({ code: \"NOT_FOUND\", message: \"Post not found\" });\n      }\n\n      // If replying, verify parent exists and is not already a reply\n      if (input.parentId) {\n        const parent = await ctx.db.comment.findUnique({\n          where: { id: input.parentId },\n          select: { parentId: true, authorId: true },\n        });\n\n        if (!parent) {\n          throw new TRPCError({ code: \"NOT_FOUND\", message: \"Parent comment not found\" });\n        }\n\n        // Enforce max 2 levels of nesting\n        if (parent.parentId) {\n          throw new TRPCError({\n            code: \"BAD_REQUEST\",\n            message: \"Cannot reply to a reply\",\n          });\n        }\n      }\n\n      const comment = await ctx.db.comment.create({\n        data: {\n          content: input.content,\n          postId: input.postId,\n          authorId: ctx.session.user.id,\n          parentId: input.parentId,\n          attachmentId: input.attachmentId,\n          coordinates: input.coordinates,\n        },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          replies: {\n            include: {\n              author: {\n                select: {\n                  id: true,\n                  displayName: true,\n                  avatarUrl: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Create notification for post author (if not self)\n      if (post.authorId !== ctx.session.user.id) {\n        await ctx.db.notification.create({\n          data: {\n            type: input.parentId ? \"COMMENT_REPLY\" : \"COMMENT\",\n            userId: post.authorId,\n            actorId: ctx.session.user.id,\n            postId: input.postId,\n            commentId: comment.id,\n          },\n        });\n      }\n\n      // If replying, also notify the parent comment author\n      if (input.parentId) {\n        const parent = await ctx.db.comment.findUnique({\n          where: { id: input.parentId },\n          select: { authorId: true },\n        });\n\n        if (parent && parent.authorId !== ctx.session.user.id && parent.authorId !== post.authorId) {\n          await ctx.db.notification.create({\n            data: {\n              type: \"COMMENT_REPLY\",\n              userId: parent.authorId,\n              actorId: ctx.session.user.id,\n              postId: input.postId,\n              commentId: comment.id,\n            },\n          });\n        }\n      }\n\n      // Create mention notifications\n      const mentions = extractUserMentions(input.content);\n      if (mentions.length > 0) {\n        // Collect user IDs that should NOT receive mention notifications\n        // (already notified via COMMENT or COMMENT_REPLY)\n        const excludedUserIds = new Set<string>([ctx.session.user.id]);\n        \n        // Don't send mention notification if they're already getting a comment notification\n        if (post.authorId !== ctx.session.user.id) {\n          excludedUserIds.add(post.authorId);\n        }\n\n        // Don't send mention notification to parent comment author (already notified)\n        if (input.parentId) {\n          const parent = await ctx.db.comment.findUnique({\n            where: { id: input.parentId },\n            select: { authorId: true },\n          });\n          if (parent && parent.authorId !== ctx.session.user.id) {\n            excludedUserIds.add(parent.authorId);\n          }\n        }\n\n        const mentionNotifications = mentions\n          .filter((mention) => !excludedUserIds.has(mention.userId))\n          .map((mention) => ({\n            type: \"MENTION\" as const,\n            userId: mention.userId,\n            actorId: ctx.session.user.id,\n            postId: input.postId,\n            commentId: comment.id,\n          }));\n\n        if (mentionNotifications.length > 0) {\n          await ctx.db.notification.createMany({\n            data: mentionNotifications,\n          });\n        }\n      }\n\n      return comment;\n    }),\n\n  byPost: protectedProcedure\n    .input(z.object({ postId: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const comments = await ctx.db.comment.findMany({\n        where: {\n          postId: input.postId,\n          parentId: null, // Only top-level comments\n        },\n        orderBy: { createdAt: \"asc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          replies: {\n            orderBy: { createdAt: \"asc\" },\n            include: {\n              author: {\n                select: {\n                  id: true,\n                  displayName: true,\n                  avatarUrl: true,\n                },\n              },\n              reactions: {\n                select: {\n                  type: true,\n                  userId: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n        },\n      });\n\n      return comments;\n    }),\n\n  byAttachment: protectedProcedure\n    .input(z.object({ attachmentId: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const comments = await ctx.db.comment.findMany({\n        where: {\n          attachmentId: input.attachmentId,\n        },\n        orderBy: { createdAt: \"asc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n        },\n      });\n\n      return comments;\n    }),\n\n  update: activeUserProcedure\n    .input(updateCommentSchema)\n    .mutation(async ({ ctx, input }) => {\n      const existingComment = await ctx.db.comment.findUnique({\n        where: { id: input.id },\n        select: { authorId: true },\n      });\n\n      if (!existingComment) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      if (existingComment.authorId !== ctx.session.user.id) {\n        throw new TRPCError({ code: \"FORBIDDEN\" });\n      }\n\n      const comment = await ctx.db.comment.update({\n        where: { id: input.id },\n        data: { content: input.content },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n        },\n      });\n\n      return comment;\n    }),\n\n  delete: activeUserProcedure\n    .input(z.object({ id: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      const existingComment = await ctx.db.comment.findUnique({\n        where: { id: input.id },\n        select: { authorId: true },\n      });\n\n      if (!existingComment) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      const isAdmin =\n        ctx.session.user.role === \"ADMIN\" ||\n        ctx.session.user.role === \"OWNER\";\n\n      if (existingComment.authorId !== ctx.session.user.id && !isAdmin) {\n        throw new TRPCError({ code: \"FORBIDDEN\" });\n      }\n\n      await ctx.db.comment.delete({\n        where: { id: input.id },\n      });\n\n      return { success: true };\n    }),\n});\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/SimpleMarkdownEditor.tsx",
        "size": 7742,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useEffect, useRef } from \"react\";\nimport {\n  LexicalComposer,\n  type InitialConfigType,\n} from \"@lexical/react/LexicalComposer\";\nimport { RichTextPlugin } from \"@lexical/react/LexicalRichTextPlugin\";\nimport { ContentEditable } from \"@lexical/react/LexicalContentEditable\";\nimport { HistoryPlugin } from \"@lexical/react/LexicalHistoryPlugin\";\nimport { OnChangePlugin } from \"@lexical/react/LexicalOnChangePlugin\";\nimport { LexicalErrorBoundary } from \"@lexical/react/LexicalErrorBoundary\";\nimport { MarkdownShortcutPlugin } from \"@lexical/react/LexicalMarkdownShortcutPlugin\";\nimport { ListPlugin } from \"@lexical/react/LexicalListPlugin\";\nimport { LinkPlugin } from \"@lexical/react/LexicalLinkPlugin\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport { ListItemNode, ListNode } from \"@lexical/list\";\nimport { LinkNode, AutoLinkNode } from \"@lexical/link\";\nimport {\n  BOLD_ITALIC_STAR,\n  BOLD_ITALIC_UNDERSCORE,\n  BOLD_STAR,\n  BOLD_UNDERSCORE,\n  ITALIC_STAR,\n  ITALIC_UNDERSCORE,\n  LINK,\n  ORDERED_LIST,\n  UNORDERED_LIST,\n} from \"@lexical/markdown\";\nimport type { EditorState, SerializedEditorState } from \"lexical\";\n\nimport { MentionNode } from \"./nodes/MentionNode\";\nimport { EmojiNode } from \"./nodes/EmojiNode\";\nimport { MentionPlugin } from \"./plugins/MentionPlugin\";\nimport { EmojiPlugin } from \"./plugins/EmojiPlugin\";\nimport { KeyboardShortcutsPlugin } from \"./plugins/KeyboardShortcutsPlugin\";\nimport { PasteLinkPlugin } from \"./plugins/PasteLinkPlugin\";\nimport { LinkClickPlugin } from \"./plugins/LinkClickPlugin\";\nimport { cn } from \"~/lib/utils\";\n\n// Only include the transformers we want for simple markdown\nconst SIMPLE_TRANSFORMERS = [\n  BOLD_ITALIC_STAR,\n  BOLD_ITALIC_UNDERSCORE,\n  BOLD_STAR,\n  BOLD_UNDERSCORE,\n  ITALIC_STAR,\n  ITALIC_UNDERSCORE,\n  LINK,\n  ORDERED_LIST,\n  UNORDERED_LIST,\n];\n\ninterface SimpleMarkdownEditorProps {\n  initialContent?: SerializedEditorState | null;\n  onChange?: (editorState: SerializedEditorState) => void;\n  placeholder?: string;\n  disabled?: boolean;\n  minHeight?: string;\n  className?: string;\n  autoFocus?: boolean;\n}\n\nconst theme = {\n  paragraph: \"\",\n  list: {\n    ul: \"list-disc ml-4\",\n    ol: \"list-decimal ml-4\",\n    listitem: \"\",\n  },\n  link: \"text-primary underline cursor-pointer hover:text-primary/80\",\n  text: {\n    bold: \"font-bold\",\n    italic: \"italic\",\n  },\n};\n\n// Plugin to handle submit on Enter (without shift)\nfunction SubmitOnEnterPlugin({\n  onSubmit,\n}: {\n  onSubmit?: () => void;\n}) {\n  const [editor] = useLexicalComposerContext();\n\n  useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (event.key === \"Enter\" && !event.shiftKey && onSubmit) {\n        // Check if there's an active typeahead menu (for mentions)\n        // The LexicalTypeaheadMenuPlugin adds a specific element to the DOM when active\n        const typeaheadMenu = document.querySelector('[role=\"listbox\"]');\n        if (typeaheadMenu) {\n          // Don't submit if mention dropdown is open - let the typeahead handle it\n          return;\n        }\n        \n        event.preventDefault();\n        onSubmit();\n      }\n    };\n\n    const rootElement = editor.getRootElement();\n    if (rootElement) {\n      rootElement.addEventListener(\"keydown\", handleKeyDown);\n      return () => {\n        rootElement.removeEventListener(\"keydown\", handleKeyDown);\n      };\n    }\n  }, [editor, onSubmit]);\n\n  return null;\n}\n\n// Plugin to auto-focus the editor\nfunction AutoFocusPlugin() {\n  const [editor] = useLexicalComposerContext();\n\n  useEffect(() => {\n    editor.focus();\n  }, [editor]);\n\n  return null;\n}\n\n// Internal editor component with ref access\nfunction SimpleMarkdownEditorInner({\n  initialContent,\n  onChange,\n  placeholder = \"Write something...\",\n  disabled = false,\n  minHeight = \"60px\",\n  className,\n  autoFocus = false,\n  onSubmit,\n  editorRef,\n}: SimpleMarkdownEditorProps & {\n  onSubmit?: () => void;\n  editorRef?: React.MutableRefObject<{ clear: () => void } | null>;\n}) {\n  const handleChange = useCallback(\n    (editorState: EditorState) => {\n      if (onChange) {\n        onChange(editorState.toJSON());\n      }\n    },\n    [onChange]\n  );\n\n  const initialConfig: InitialConfigType = {\n    namespace: \"SimpleMarkdownEditor\",\n    theme,\n    onError: (error: Error) => {\n      console.error(\"SimpleMarkdownEditor error:\", error);\n    },\n    nodes: [ListNode, ListItemNode, LinkNode, AutoLinkNode, MentionNode, EmojiNode],\n    editorState: initialContent ? JSON.stringify(initialContent) : undefined,\n    editable: !disabled,\n  };\n\n  return (\n    <LexicalComposer initialConfig={initialConfig}>\n      <div className={cn(\"simple-markdown-editor relative\", className)}>\n        <RichTextPlugin\n          contentEditable={\n            <ContentEditable\n              className={cn(\n                \"outline-none text-sm\",\n                disabled && \"opacity-50 cursor-not-allowed\"\n              )}\n              style={{ minHeight }}\n            />\n          }\n          placeholder={\n            <div\n              className=\"pointer-events-none absolute left-0 top-0 text-sm text-muted-foreground\"\n              style={{ minHeight }}\n            >\n              {placeholder}\n            </div>\n          }\n          ErrorBoundary={LexicalErrorBoundary}\n        />\n        <HistoryPlugin />\n        <ListPlugin />\n        <LinkPlugin />\n        <MarkdownShortcutPlugin transformers={SIMPLE_TRANSFORMERS} />\n        <OnChangePlugin onChange={handleChange} />\n        {!disabled && <KeyboardShortcutsPlugin />}\n        {!disabled && <PasteLinkPlugin />}\n        <LinkClickPlugin />\n        {!disabled && <MentionPlugin />}\n        {!disabled && <EmojiPlugin />}\n        {!disabled && onSubmit && <SubmitOnEnterPlugin onSubmit={onSubmit} />}\n        {autoFocus && <AutoFocusPlugin />}\n        {editorRef && <EditorRefPlugin editorRef={editorRef} />}\n      </div>\n    </LexicalComposer>\n  );\n}\n\n// Plugin to expose editor methods via ref\nfunction EditorRefPlugin({\n  editorRef,\n}: {\n  editorRef: React.MutableRefObject<{ clear: () => void } | null>;\n}) {\n  const [editor] = useLexicalComposerContext();\n\n  useEffect(() => {\n    editorRef.current = {\n      clear: () => {\n        editor.update(() => {\n          const root = editor.getRootElement();\n          if (root) {\n            editor.setEditorState(editor.parseEditorState('{\"root\":{\"children\":[{\"children\":[],\"direction\":null,\"format\":\"\",\"indent\":0,\"type\":\"paragraph\",\"version\":1}],\"direction\":null,\"format\":\"\",\"indent\":0,\"type\":\"root\",\"version\":1}}'));\n          }\n        });\n      },\n    };\n  }, [editor, editorRef]);\n\n  return null;\n}\n\nexport function SimpleMarkdownEditor(\n  props: SimpleMarkdownEditorProps & {\n    onSubmit?: () => void;\n    editorRef?: React.MutableRefObject<{ clear: () => void } | null>;\n  }\n) {\n  return <SimpleMarkdownEditorInner {...props} />;\n}\n\n// Read-only version for displaying content\nexport function SimpleMarkdownContent({\n  content,\n  className,\n}: {\n  content: SerializedEditorState;\n  className?: string;\n}) {\n  const initialConfig: InitialConfigType = {\n    namespace: \"SimpleMarkdownContent\",\n    theme,\n    onError: (error: Error) => {\n      console.error(\"SimpleMarkdownContent error:\", error);\n    },\n    nodes: [ListNode, ListItemNode, LinkNode, AutoLinkNode, MentionNode, EmojiNode],\n    editorState: JSON.stringify(content),\n    editable: false,\n  };\n\n  return (\n    <LexicalComposer initialConfig={initialConfig}>\n      <RichTextPlugin\n        contentEditable={\n          <ContentEditable className={cn(\"outline-none text-sm\", className)} />\n        }\n        placeholder={null}\n        ErrorBoundary={LexicalErrorBoundary}\n      />\n      <LinkClickPlugin />\n    </LexicalComposer>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/Tabs.stories.tsx",
        "size": 7719,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"./tabs\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"./card\";\nimport { Input } from \"./input\";\nimport { Label } from \"./label\";\nimport { Button } from \"./button\";\n\nconst meta: Meta<typeof Tabs> = {\n  title: \"UI/Tabs\",\n  component: Tabs,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A tabs component for switching between different views or content sections. Built on Radix UI Tabs.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof Tabs>;\n\nexport const Default: Story = {\n  render: () => (\n    <Tabs defaultValue=\"account\" className=\"w-[400px]\">\n      <TabsList>\n        <TabsTrigger value=\"account\">Account</TabsTrigger>\n        <TabsTrigger value=\"password\">Password</TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"account\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Account</CardTitle>\n            <CardDescription>\n              Make changes to your account here.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <div className=\"space-y-1\">\n              <Label htmlFor=\"name\">Name</Label>\n              <Input id=\"name\" defaultValue=\"John Doe\" />\n            </div>\n            <div className=\"space-y-1\">\n              <Label htmlFor=\"username\">Username</Label>\n              <Input id=\"username\" defaultValue=\"@johndoe\" />\n            </div>\n          </CardContent>\n        </Card>\n      </TabsContent>\n      <TabsContent value=\"password\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Password</CardTitle>\n            <CardDescription>\n              Change your password here.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <div className=\"space-y-1\">\n              <Label htmlFor=\"current\">Current password</Label>\n              <Input id=\"current\" type=\"password\" />\n            </div>\n            <div className=\"space-y-1\">\n              <Label htmlFor=\"new\">New password</Label>\n              <Input id=\"new\" type=\"password\" />\n            </div>\n          </CardContent>\n        </Card>\n      </TabsContent>\n    </Tabs>\n  ),\n};\n\nexport const Simple: Story = {\n  render: () => (\n    <Tabs defaultValue=\"overview\" className=\"w-[400px]\">\n      <TabsList>\n        <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n        <TabsTrigger value=\"analytics\">Analytics</TabsTrigger>\n        <TabsTrigger value=\"reports\">Reports</TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"overview\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Overview content goes here. This is the main dashboard view.\n        </p>\n      </TabsContent>\n      <TabsContent value=\"analytics\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Analytics data and charts would be displayed here.\n        </p>\n      </TabsContent>\n      <TabsContent value=\"reports\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Report generation and export options.\n        </p>\n      </TabsContent>\n    </Tabs>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Simple tabs with text content.\",\n      },\n    },\n  },\n};\n\nexport const FullWidth: Story = {\n  render: () => (\n    <Tabs defaultValue=\"all\" className=\"w-[500px]\">\n      <TabsList className=\"w-full\">\n        <TabsTrigger value=\"all\" className=\"flex-1\">All</TabsTrigger>\n        <TabsTrigger value=\"active\" className=\"flex-1\">Active</TabsTrigger>\n        <TabsTrigger value=\"draft\" className=\"flex-1\">Draft</TabsTrigger>\n        <TabsTrigger value=\"archived\" className=\"flex-1\">Archived</TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"all\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Showing all items (24 total)\n        </p>\n      </TabsContent>\n      <TabsContent value=\"active\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Showing active items (12 total)\n        </p>\n      </TabsContent>\n      <TabsContent value=\"draft\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Showing draft items (8 total)\n        </p>\n      </TabsContent>\n      <TabsContent value=\"archived\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Showing archived items (4 total)\n        </p>\n      </TabsContent>\n    </Tabs>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Tabs with full-width triggers that expand to fill the container.\",\n      },\n    },\n  },\n};\n\nexport const Disabled: Story = {\n  render: () => (\n    <Tabs defaultValue=\"tab1\" className=\"w-[400px]\">\n      <TabsList>\n        <TabsTrigger value=\"tab1\">Available</TabsTrigger>\n        <TabsTrigger value=\"tab2\">Also Available</TabsTrigger>\n        <TabsTrigger value=\"tab3\" disabled>\n          Coming Soon\n        </TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"tab1\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          This tab is available and accessible.\n        </p>\n      </TabsContent>\n      <TabsContent value=\"tab2\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          This tab is also available.\n        </p>\n      </TabsContent>\n    </Tabs>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Tabs with a disabled trigger for unavailable options.\",\n      },\n    },\n  },\n};\n\nexport const WithForms: Story = {\n  render: () => (\n    <Tabs defaultValue=\"signup\" className=\"w-[400px]\">\n      <TabsList className=\"grid w-full grid-cols-2\">\n        <TabsTrigger value=\"signup\">Sign Up</TabsTrigger>\n        <TabsTrigger value=\"login\">Log In</TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"signup\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Create Account</CardTitle>\n            <CardDescription>\n              Enter your details to create a new account.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input id=\"email\" type=\"email\" placeholder=\"name@example.com\" />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input id=\"password\" type=\"password\" />\n            </div>\n            <Button className=\"w-full\">Create Account</Button>\n          </CardContent>\n        </Card>\n      </TabsContent>\n      <TabsContent value=\"login\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Welcome Back</CardTitle>\n            <CardDescription>\n              Enter your credentials to sign in.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"login-email\">Email</Label>\n              <Input id=\"login-email\" type=\"email\" placeholder=\"name@example.com\" />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"login-password\">Password</Label>\n              <Input id=\"login-password\" type=\"password\" />\n            </div>\n            <Button className=\"w-full\">Sign In</Button>\n          </CardContent>\n        </Card>\n      </TabsContent>\n    </Tabs>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Tabs switching between sign up and login forms.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/lib/webhooks.ts",
        "size": 7562,
        "reason": "large source sample",
        "content": "/**\n * Webhook integrations for Discord and Slack\n * Sends notifications when new posts are created\n */\n\nimport { getWebhookImageUrl } from \"./r2\";\n\n// Extract R2 key from URL\nfunction extractR2Key(url: string): string | null {\n  const match = url.match(/uploads\\/[^\\/]+\\/[^\\/]+$/);\n  return match ? match[0] : null;\n}\n\n// Get a signed URL for webhook images (valid for 7 days)\nasync function getSignedImageUrl(url: string | null): Promise<string | null> {\n  if (!url) return null;\n  \n  const r2Key = extractR2Key(url);\n  if (!r2Key) return url; // Not an R2 URL, return as-is\n  \n  try {\n    return await getWebhookImageUrl(r2Key);\n  } catch (error) {\n    console.error(\"Failed to sign image URL for webhook:\", error);\n    return null;\n  }\n}\n\ninterface PostData {\n  id: string;\n  title: string | null;\n  content: unknown;\n  author: {\n    displayName: string;\n    avatarUrl: string | null;\n  };\n  attachments: {\n    type: string;\n    url: string;\n    thumbnailUrl: string | null;\n  }[];\n  projects: {\n    project: {\n      name: string;\n    };\n  }[];\n}\n\n/**\n * Extract plain text from Lexical JSON content\n */\nfunction extractTextFromContent(content: unknown): string {\n  if (!content || typeof content !== \"object\") return \"\";\n  \n  const root = content as { root?: { children?: unknown[] } };\n  if (!root.root?.children) return \"\";\n\n  const extractText = (nodes: unknown[]): string => {\n    return nodes\n      .map((node) => {\n        const n = node as { type?: string; text?: string; children?: unknown[] };\n        if (n.type === \"text\" && n.text) {\n          return n.text;\n        }\n        if (n.children && Array.isArray(n.children)) {\n          return extractText(n.children);\n        }\n        return \"\";\n      })\n      .join(\" \");\n  };\n\n  return extractText(root.root.children).trim();\n}\n\n/**\n * Send a notification to Discord via webhook\n */\nexport async function sendDiscordWebhook(\n  webhookUrl: string,\n  post: PostData,\n  baseUrl: string\n): Promise<boolean> {\n  try {\n    const postUrl = `${baseUrl}/post/${post.id}`;\n    const description = extractTextFromContent(post.content);\n    const projectNames = post.projects.map((p) => p.project.name).join(\", \");\n    \n    // Find the first image attachment for the embed\n    const imageAttachment = post.attachments.find((a) => a.type === \"IMAGE\");\n    const rawImageUrl = imageAttachment?.thumbnailUrl || imageAttachment?.url || null;\n    \n    // Get signed URLs for the image and avatar (valid for 7 days)\n    const [signedImageUrl, signedAvatarUrl] = await Promise.all([\n      getSignedImageUrl(rawImageUrl),\n      getSignedImageUrl(post.author.avatarUrl),\n    ]);\n\n    // Draftboard bot identity\n    const botAvatarUrl = `${baseUrl}/avatar.png`;\n\n    const embed: Record<string, unknown> = {\n      title: post.title || \"New Design Post\",\n      description: description.slice(0, 300) + (description.length > 300 ? \"...\" : \"\"),\n      url: postUrl,\n      color: 0x7c3aed, // Purple color\n      author: {\n        name: post.author.displayName,\n        icon_url: signedAvatarUrl || undefined,\n      },\n      timestamp: new Date().toISOString(),\n    };\n\n    if (projectNames) {\n      embed.fields = [\n        {\n          name: \"Projects\",\n          value: projectNames,\n          inline: true,\n        },\n      ];\n    }\n\n    if (signedImageUrl) {\n      embed.image = { url: signedImageUrl };\n    }\n\n    const response = await fetch(webhookUrl, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        username: \"Draftboard\",\n        avatar_url: botAvatarUrl,\n        embeds: [embed],\n      }),\n    });\n\n    if (!response.ok) {\n      console.error(`Discord webhook failed: ${response.status} ${response.statusText}`);\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error(\"Discord webhook error:\", error);\n    return false;\n  }\n}\n\n/**\n * Send a notification to Slack via webhook\n */\nexport async function sendSlackWebhook(\n  webhookUrl: string,\n  post: PostData,\n  baseUrl: string\n): Promise<boolean> {\n  try {\n    const postUrl = `${baseUrl}/post/${post.id}`;\n    const description = extractTextFromContent(post.content);\n    const projectNames = post.projects.map((p) => p.project.name).join(\", \");\n    \n    // Draftboard bot identity\n    const botAvatarUrl = `${baseUrl}/avatar.png`;\n    \n    // Find the first image attachment for the preview\n    const imageAttachment = post.attachments.find((a) => a.type === \"IMAGE\");\n    const rawImageUrl = imageAttachment?.thumbnailUrl || imageAttachment?.url || null;\n    \n    // Get signed URLs for the image and avatar (valid for 7 days)\n    const [imageUrl, signedAvatarUrl] = await Promise.all([\n      getSignedImageUrl(rawImageUrl),\n      getSignedImageUrl(post.author.avatarUrl),\n    ]);\n\n    const blocks: Record<string, unknown>[] = [\n      {\n        type: \"section\",\n        text: {\n          type: \"mrkdwn\",\n          text: `*<${postUrl}|${post.title || \"New Design Post\"}>*`,\n        },\n      },\n      {\n        type: \"context\",\n        elements: [\n          ...(signedAvatarUrl\n            ? [\n                {\n                  type: \"image\",\n                  image_url: signedAvatarUrl,\n                  alt_text: post.author.displayName,\n                },\n              ]\n            : []),\n          {\n            type: \"mrkdwn\",\n            text: `Posted by *${post.author.displayName}*${projectNames ? ` in ${projectNames}` : \"\"}`,\n          },\n        ],\n      },\n    ];\n\n    if (description) {\n      blocks.push({\n        type: \"section\",\n        text: {\n          type: \"plain_text\",\n          text: description.slice(0, 300) + (description.length > 300 ? \"...\" : \"\"),\n          emoji: true,\n        },\n      });\n    }\n\n    if (imageUrl) {\n      blocks.push({\n        type: \"image\",\n        image_url: imageUrl,\n        alt_text: post.title || \"Design preview\",\n      });\n    }\n\n    blocks.push({\n      type: \"actions\",\n      elements: [\n        {\n          type: \"button\",\n          text: {\n            type: \"plain_text\",\n            text: \"View Post\",\n            emoji: true,\n          },\n          url: postUrl,\n          style: \"primary\",\n        },\n      ],\n    });\n\n    const response = await fetch(webhookUrl, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        username: \"Draftboard\",\n        icon_url: botAvatarUrl,\n        blocks,\n      }),\n    });\n\n    if (!response.ok) {\n      console.error(`Slack webhook failed: ${response.status} ${response.statusText}`);\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error(\"Slack webhook error:\", error);\n    return false;\n  }\n}\n\n/**\n * Send notifications to all configured webhooks\n */\nexport async function sendPostNotifications(\n  post: PostData,\n  settings: { discordWebhookUrl: string | null; slackWebhookUrl: string | null },\n  baseUrl: string\n): Promise<void> {\n  const promises: Promise<boolean>[] = [];\n\n  if (settings.discordWebhookUrl) {\n    promises.push(sendDiscordWebhook(settings.discordWebhookUrl, post, baseUrl));\n  }\n\n  if (settings.slackWebhookUrl) {\n    promises.push(sendSlackWebhook(settings.slackWebhookUrl, post, baseUrl));\n  }\n\n  if (promises.length > 0) {\n    // Fire and forget - don't block the response\n    Promise.allSettled(promises).then((results) => {\n      results.forEach((result, index) => {\n        if (result.status === \"rejected\") {\n          console.error(`Webhook ${index} failed:`, result.reason);\n        }\n      });\n    });\n  }\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/dropdown-menu.tsx",
        "size": 7449,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport * as React from \"react\";\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\";\nimport { Check, ChevronRight, Circle } from \"lucide-react\";\nimport { cn } from \"~/lib/utils\";\n\nconst DropdownMenu = DropdownMenuPrimitive.Root;\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group;\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal;\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub;\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean;\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n));\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName;\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n));\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName;\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n));\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean;\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n));\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n));\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName;\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n));\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean;\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n));\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n));\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  );\n};\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\";\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n};\n",
        "truncated": false
      },
      {
        "path": "src/lib/validators.test.ts",
        "size": 7349,
        "reason": "large source sample",
        "content": "import { describe, it, expect } from \"vitest\";\nimport {\n  signUpSchema,\n  signInSchema,\n  updateProfileSchema,\n  createPostSchema,\n  createCommentSchema,\n  toggleReactionSchema,\n  createProjectSchema,\n  paginationSchema,\n  presignedUrlSchema,\n  createEmojiSchema,\n} from \"./validators\";\n\ndescribe(\"signUpSchema\", () => {\n  it(\"should validate valid sign up data\", () => {\n    const result = signUpSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"password123\",\n      displayName: \"John Doe\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject invalid email\", () => {\n    const result = signUpSchema.safeParse({\n      email: \"invalid-email\",\n      password: \"password123\",\n      displayName: \"John Doe\",\n    });\n    expect(result.success).toBe(false);\n  });\n\n  it(\"should reject short password\", () => {\n    const result = signUpSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"short\",\n      displayName: \"John Doe\",\n    });\n    expect(result.success).toBe(false);\n  });\n\n  it(\"should reject short display name\", () => {\n    const result = signUpSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"password123\",\n      displayName: \"J\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"signInSchema\", () => {\n  it(\"should validate valid sign in data\", () => {\n    const result = signInSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"password\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject empty password\", () => {\n    const result = signInSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"updateProfileSchema\", () => {\n  it(\"should validate partial updates\", () => {\n    const result = updateProfileSchema.safeParse({\n      displayName: \"New Name\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate avatar URL\", () => {\n    const result = updateProfileSchema.safeParse({\n      avatarUrl: \"https://example.com/avatar.jpg\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should allow null avatar URL\", () => {\n    const result = updateProfileSchema.safeParse({\n      avatarUrl: null,\n    });\n    expect(result.success).toBe(true);\n  });\n});\n\ndescribe(\"createPostSchema\", () => {\n  it(\"should validate minimal post\", () => {\n    const result = createPostSchema.safeParse({\n      content: { root: {} },\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate post with all fields\", () => {\n    const result = createPostSchema.safeParse({\n      title: \"My Post\",\n      content: { root: {} },\n      liveUrl: \"https://example.com\",\n      projectIds: [\"proj1\", \"proj2\"],\n      attachments: [\n        {\n          type: \"IMAGE\",\n          url: \"https://example.com/image.jpg\",\n          filename: \"image.jpg\",\n          mimeType: \"image/jpeg\",\n          size: 1000,\n          order: 0,\n        },\n      ],\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject invalid attachment type\", () => {\n    const result = createPostSchema.safeParse({\n      content: { root: {} },\n      attachments: [\n        {\n          type: \"INVALID\",\n          url: \"https://example.com/file\",\n          filename: \"file.txt\",\n          mimeType: \"text/plain\",\n          size: 100,\n          order: 0,\n        },\n      ],\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"createCommentSchema\", () => {\n  it(\"should validate basic comment\", () => {\n    const result = createCommentSchema.safeParse({\n      postId: \"post123\",\n      content: { root: {} },\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate reply comment\", () => {\n    const result = createCommentSchema.safeParse({\n      postId: \"post123\",\n      content: { root: {} },\n      parentId: \"comment456\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate attachment comment\", () => {\n    const result = createCommentSchema.safeParse({\n      postId: \"post123\",\n      content: { root: {} },\n      attachmentId: \"att789\",\n      coordinates: { x: 100, y: 200 },\n    });\n    expect(result.success).toBe(true);\n  });\n});\n\ndescribe(\"toggleReactionSchema\", () => {\n  it(\"should validate reaction on post\", () => {\n    const result = toggleReactionSchema.safeParse({\n      type: \"like\",\n      postId: \"post123\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate reaction on comment\", () => {\n    const result = toggleReactionSchema.safeParse({\n      type: \"wow\",\n      commentId: \"comment456\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject reaction without target\", () => {\n    const result = toggleReactionSchema.safeParse({\n      type: \"like\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"createProjectSchema\", () => {\n  it(\"should validate minimal project\", () => {\n    const result = createProjectSchema.safeParse({\n      name: \"My Project\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate project with URLs\", () => {\n    const result = createProjectSchema.safeParse({\n      name: \"My Project\",\n      urls: [\n        { title: \"Brief\", url: \"https://docs.google.com/brief\" },\n      ],\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject empty name\", () => {\n    const result = createProjectSchema.safeParse({\n      name: \"\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"paginationSchema\", () => {\n  it(\"should use default values\", () => {\n    const result = paginationSchema.parse({});\n    expect(result.limit).toBe(20);\n    expect(result.cursor).toBeUndefined();\n  });\n\n  it(\"should validate cursor\", () => {\n    const result = paginationSchema.safeParse({\n      cursor: \"cursor123\",\n      limit: 10,\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject invalid limit\", () => {\n    const result = paginationSchema.safeParse({\n      limit: 100,\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"presignedUrlSchema\", () => {\n  it(\"should validate upload request\", () => {\n    const result = presignedUrlSchema.safeParse({\n      filename: \"image.jpg\",\n      contentType: \"image/jpeg\",\n      size: 1024 * 1024, // 1MB\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject files over 100MB\", () => {\n    const result = presignedUrlSchema.safeParse({\n      filename: \"large-file.zip\",\n      contentType: \"application/zip\",\n      size: 150 * 1024 * 1024, // 150MB\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"createEmojiSchema\", () => {\n  it(\"should validate valid emoji\", () => {\n    const result = createEmojiSchema.safeParse({\n      name: \"party_parrot\",\n      imageUrl: \"https://example.com/emoji.png\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject invalid characters in name\", () => {\n    const result = createEmojiSchema.safeParse({\n      name: \"Party-Parrot\",\n      imageUrl: \"https://example.com/emoji.png\",\n    });\n    expect(result.success).toBe(false);\n  });\n\n  it(\"should reject short name\", () => {\n    const result = createEmojiSchema.safeParse({\n      name: \"x\",\n      imageUrl: \"https://example.com/emoji.png\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/toolbar/ToolbarPlugin.tsx",
        "size": 7312,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useEffect, useState, useRef } from \"react\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport {\n  $getSelection,\n  $isRangeSelection,\n  $createParagraphNode,\n  FORMAT_TEXT_COMMAND,\n  SELECTION_CHANGE_COMMAND,\n  COMMAND_PRIORITY_CRITICAL,\n} from \"lexical\";\nimport { mergeRegister } from \"@lexical/utils\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  Bold,\n  Italic,\n  Underline,\n  Strikethrough,\n  Code,\n  ImagePlus,\n  Paperclip,\n} from \"lucide-react\";\nimport { cn } from \"~/lib/utils\";\nimport { $createAttachmentNode, type AttachmentType } from \"../nodes/AttachmentNode\";\nimport { api } from \"~/lib/trpc/client\";\n\nexport function ToolbarPlugin() {\n  const [editor] = useLexicalComposerContext();\n  const [isBold, setIsBold] = useState(false);\n  const [isItalic, setIsItalic] = useState(false);\n  const [isUnderline, setIsUnderline] = useState(false);\n  const [isStrikethrough, setIsStrikethrough] = useState(false);\n  const [isCode, setIsCode] = useState(false);\n  const [isUploading, setIsUploading] = useState(false);\n  const imageInputRef = useRef<HTMLInputElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const uploadMutation = api.upload.getUploadUrl.useMutation();\n\n  const updateToolbar = useCallback(() => {\n    const selection = $getSelection();\n    if ($isRangeSelection(selection)) {\n      setIsBold(selection.hasFormat(\"bold\"));\n      setIsItalic(selection.hasFormat(\"italic\"));\n      setIsUnderline(selection.hasFormat(\"underline\"));\n      setIsStrikethrough(selection.hasFormat(\"strikethrough\"));\n      setIsCode(selection.hasFormat(\"code\"));\n    }\n  }, []);\n\n  useEffect(() => {\n    return mergeRegister(\n      editor.registerUpdateListener(({ editorState }) => {\n        editorState.read(() => {\n          updateToolbar();\n        });\n      }),\n      editor.registerCommand(\n        SELECTION_CHANGE_COMMAND,\n        () => {\n          updateToolbar();\n          return false;\n        },\n        COMMAND_PRIORITY_CRITICAL\n      )\n    );\n  }, [editor, updateToolbar]);\n\n  const handleFileUpload = useCallback(\n    async (file: File) => {\n      setIsUploading(true);\n      try {\n        // Get presigned URL\n        const result = await uploadMutation.mutateAsync({\n          filename: file.name,\n          contentType: file.type,\n          size: file.size,\n        });\n\n        // Upload to R2\n        const uploadResponse = await fetch(result.uploadUrl, {\n          method: \"PUT\",\n          body: file,\n          headers: {\n            \"Content-Type\": file.type,\n          },\n        });\n\n        if (!uploadResponse.ok) {\n          const errorText = await uploadResponse.text();\n          console.error(\"R2 upload failed:\", uploadResponse.status, errorText);\n          alert(`Upload failed: ${uploadResponse.status} - Check CORS configuration on R2 bucket`);\n          return;\n        }\n\n        // Determine attachment type\n        let attachmentType: AttachmentType = \"FILE\";\n        if (file.type.startsWith(\"image/\")) {\n          attachmentType = \"IMAGE\";\n        } else if (file.type.startsWith(\"video/\")) {\n          attachmentType = \"VIDEO\";\n        }\n\n        // Insert attachment node\n        editor.update(() => {\n          const selection = $getSelection();\n          if ($isRangeSelection(selection)) {\n            const attachmentNode = $createAttachmentNode({\n              attachmentType,\n              url: result.publicUrl,\n              filename: file.name,\n              mimeType: file.type,\n              size: file.size,\n            });\n            selection.insertNodes([attachmentNode, $createParagraphNode()]);\n          }\n        });\n      } catch (error) {\n        console.error(\"Upload failed:\", error);\n        const message = error instanceof Error ? error.message : \"Unknown error\";\n        alert(`Upload failed: ${message}`);\n      } finally {\n        setIsUploading(false);\n      }\n    },\n    [editor, uploadMutation]\n  );\n\n  return (\n    <div className=\"relative z-20 flex items-center gap-0.5 border-b border-border px-2 py-1\">\n      {/* Hidden file inputs */}\n      <input\n        ref={imageInputRef}\n        type=\"file\"\n        accept=\"image/*,video/*\"\n        className=\"hidden\"\n        onChange={(e) => {\n          const file = e.target.files?.[0];\n          if (file) {\n            handleFileUpload(file);\n          }\n          e.target.value = \"\";\n        }}\n      />\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\"*/*\"\n        className=\"hidden\"\n        onChange={(e) => {\n          const file = e.target.files?.[0];\n          if (file) {\n            handleFileUpload(file);\n          }\n          e.target.value = \"\";\n        }}\n      />\n\n      {/* Text formatting buttons */}\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isBold && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"bold\")}\n        title=\"Bold (⌘B)\"\n      >\n        <Bold className=\"h-4 w-4\" />\n      </Button>\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isItalic && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"italic\")}\n        title=\"Italic (⌘I)\"\n      >\n        <Italic className=\"h-4 w-4\" />\n      </Button>\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isUnderline && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"underline\")}\n        title=\"Underline (⌘U)\"\n      >\n        <Underline className=\"h-4 w-4\" />\n      </Button>\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isStrikethrough && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"strikethrough\")}\n        title=\"Strikethrough\"\n      >\n        <Strikethrough className=\"h-4 w-4\" />\n      </Button>\n      <div className=\"mx-1 h-4 w-px bg-border\" />\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isCode && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"code\")}\n        title=\"Inline Code\"\n      >\n        <Code className=\"h-4 w-4\" />\n      </Button>\n\n      <div className=\"mx-1 h-4 w-px bg-border\" />\n\n      {/* Direct attachment buttons */}\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"h-8 gap-1.5 px-2\"\n        disabled={isUploading}\n        onClick={() => imageInputRef.current?.click()}\n        title=\"Add image or video\"\n      >\n        <ImagePlus className=\"h-4 w-4\" />\n        <span className=\"text-xs\">Image</span>\n      </Button>\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"h-8 gap-1.5 px-2\"\n        disabled={isUploading}\n        onClick={() => fileInputRef.current?.click()}\n        title=\"Add file\"\n      >\n        <Paperclip className=\"h-4 w-4\" />\n        <span className=\"text-xs\">File</span>\n      </Button>\n\n      {isUploading && (\n        <span className=\"ml-2 text-xs text-muted-foreground\">Uploading...</span>\n      )}\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/feed/PostCard.tsx",
        "size": 6923,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport Link from \"next/link\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { Button } from \"~/components/ui/button\";\nimport { Card, CardContent, CardFooter, CardHeader } from \"~/components/ui/card\";\nimport { Badge } from \"~/components/ui/badge\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport {\n  formatRelativeTime,\n  truncateText,\n} from \"~/lib/utils\";\nimport { MessageCircle, ExternalLink, ChevronDown, Image as ImageIcon, Play, FileIcon } from \"lucide-react\";\nimport { ReactionButton } from \"~/components/reactions/ReactionButton\";\nimport { AttachmentCarousel } from \"./AttachmentCarousel\";\n\ninterface PostCardProps {\n  post: {\n    id: string;\n    title: string | null;\n    content: unknown;\n    liveUrl: string | null;\n    createdAt: Date;\n    author: {\n      id: string;\n      displayName: string;\n      avatarUrl: string | null;\n    };\n    attachments: Array<{\n      id: string;\n      type: string;\n      url: string;\n      filename: string;\n      thumbnailUrl: string | null;\n    }>;\n    projects: Array<{\n      project: {\n        id: string;\n        name: string;\n      };\n    }>;\n    reactions: Array<{\n      type: string;\n      userId: string;\n    }>;\n    _count: {\n      comments: number;\n      reactions: number;\n      attachments: number;\n    };\n  };\n}\n\nfunction extractPlainText(content: unknown): string {\n  if (!content || typeof content !== \"object\") return \"\";\n\n  const root = (content as Record<string, unknown>).root;\n  if (!root || typeof root !== \"object\") return \"\";\n\n  const children = (root as Record<string, unknown>).children;\n  if (!Array.isArray(children)) return \"\";\n\n  const texts: string[] = [];\n\n  function extractFromNode(node: unknown): void {\n    if (!node || typeof node !== \"object\") return;\n\n    const nodeObj = node as Record<string, unknown>;\n\n    if (nodeObj.type === \"text\" && typeof nodeObj.text === \"string\") {\n      texts.push(nodeObj.text);\n    }\n\n    // Handle mention nodes - extract the display name\n    if (nodeObj.type === \"mention\" && typeof nodeObj.mentionName === \"string\") {\n      texts.push(nodeObj.mentionName);\n    }\n\n    if (Array.isArray(nodeObj.children)) {\n      nodeObj.children.forEach(extractFromNode);\n    }\n  }\n\n  children.forEach(extractFromNode);\n  return texts.join(\" \");\n}\n\nexport function PostCard({ post }: PostCardProps) {\n  const plainText = extractPlainText(post.content);\n  const truncatedContent = truncateText(plainText, 300);\n  const projectCount = post.projects.length;\n\n  return (\n    <Card className=\"overflow-hidden transition-shadow\">\n      <CardHeader className=\"px-5 pt-5 pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Link href={`/user/${post.author.id}`}>\n              <UserAvatar avatarUrl={post.author.avatarUrl} name={post.author.displayName} className=\"h-10 w-10\" />\n            </Link>\n            <div className=\"flex flex-col\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Link\n                  href={`/user/${post.author.id}`}\n                  className=\"font-medium hover:underline\"\n                >\n                  {post.author.displayName}\n                </Link>\n                {projectCount > 0 && (\n                  <>\n                    <span className=\"text-muted-foreground\">·</span>\n                    {projectCount === 1 ? (\n                      <Link\n                        href={`/projects/${post.projects[0]?.project.id}`}\n                        className=\"text-muted-foreground hover:text-foreground hover:underline\"\n                      >\n                        in {post.projects[0]?.project.name}\n                      </Link>\n                    ) : (\n                      <DropdownMenu>\n                        <DropdownMenuTrigger className=\"flex items-center gap-1 text-muted-foreground hover:text-foreground\">\n                          in {projectCount} projects\n                          <ChevronDown className=\"h-3 w-3\" />\n                        </DropdownMenuTrigger>\n                        <DropdownMenuContent>\n                          {post.projects.map(({ project }) => (\n                            <DropdownMenuItem key={project.id} asChild>\n                              <Link href={`/projects/${project.id}`}>\n                                {project.name}\n                              </Link>\n                            </DropdownMenuItem>\n                          ))}\n                        </DropdownMenuContent>\n                      </DropdownMenu>\n                    )}\n                  </>\n                )}\n              </div>\n              <Link\n                href={`/post/${post.id}`}\n                className=\"text-xs text-muted-foreground hover:underline\"\n              >\n                {formatRelativeTime(new Date(post.createdAt))}\n              </Link>\n            </div>\n          </div>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"px-5 pb-3\">\n        <Link href={`/post/${post.id}`} className=\"block\">\n          {post.title && (\n            <h2 className=\"mb-2 text-lg font-semibold hover:underline\">\n              {post.title}\n            </h2>\n          )}\n          {truncatedContent && (\n            <p className=\"text-sm text-muted-foreground line-clamp-3\">\n              {truncatedContent}\n            </p>\n          )}\n        </Link>\n\n        {post.attachments.length > 0 && (\n          <div className=\"mt-4\">\n            <AttachmentCarousel\n              attachments={post.attachments}\n              postId={post.id}\n              totalCount={post._count.attachments}\n            />\n          </div>\n        )}\n      </CardContent>\n\n      <CardFooter className=\"px-5 pt-1 pb-3\">\n        <div className=\"flex w-full items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <ReactionButton\n              postId={post.id}\n              reactions={post.reactions}\n              count={post._count.reactions}\n            />\n            <Link href={`/post/${post.id}#comments`} scroll={false}>\n              <Button variant=\"ghost\" size=\"sm\" className=\"gap-1 rounded-full px-2 text-muted-foreground\">\n                <MessageCircle className=\"h-4 w-4\" />\n                {post._count.comments > 0 && post._count.comments}\n              </Button>\n            </Link>\n          </div>\n          {post.liveUrl && (\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <a\n                href={post.liveUrl}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"gap-2\"\n              >\n                View live\n                <ExternalLink className=\"h-3.5 w-3.5\" />\n              </a>\n            </Button>\n          )}\n        </div>\n      </CardFooter>\n    </Card>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/feed/AttachmentCarousel.tsx",
        "size": 6917,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { Play, FileIcon, Image as ImageIcon, Loader2 } from \"lucide-react\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Lightbox, type LightboxMedia } from \"~/components/ui/lightbox\";\n\ninterface Attachment {\n  id: string;\n  type: string;\n  url: string;\n  filename: string;\n  thumbnailUrl: string | null;\n}\n\ninterface AttachmentCarouselProps {\n  attachments: Attachment[];\n  postId: string;\n  totalCount: number;\n}\n\n// Extract R2 key from URL\nfunction extractR2Key(url: string): string | null {\n  const match = url.match(/uploads\\/[^\\/]+\\/[^\\/]+$/);\n  return match ? match[0] : null;\n}\n\nfunction getAttachmentIcon(type: string) {\n  switch (type) {\n    case \"IMAGE\":\n      return <ImageIcon className=\"h-8 w-8\" />;\n    case \"VIDEO\":\n    case \"LOOM\":\n      return <Play className=\"h-8 w-8\" />;\n    case \"FIGMA\":\n      return (\n        <svg viewBox=\"0 0 38 57\" className=\"h-8 w-8\" fill=\"none\">\n          <path d=\"M19 28.5a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z\" fill=\"#1ABCFE\" />\n          <path d=\"M0 47.5A9.5 9.5 0 0 1 9.5 38H19v9.5a9.5 9.5 0 1 1-19 0z\" fill=\"#0ACF83\" />\n          <path d=\"M19 0v19h9.5a9.5 9.5 0 1 0 0-19H19z\" fill=\"#FF7262\" />\n          <path d=\"M0 9.5A9.5 9.5 0 0 0 9.5 19H19V0H9.5A9.5 9.5 0 0 0 0 9.5z\" fill=\"#F24E1E\" />\n          <path d=\"M0 28.5A9.5 9.5 0 0 0 9.5 38H19V19H9.5A9.5 9.5 0 0 0 0 28.5z\" fill=\"#A259FF\" />\n        </svg>\n      );\n    default:\n      return <FileIcon className=\"h-8 w-8\" />;\n  }\n}\n\nfunction SignedImage({ url, filename, className }: { url: string; filename: string; className?: string }) {\n  const r2Key = extractR2Key(url);\n  const { data: signedUrlData, isLoading } = api.upload.getDownloadUrl.useQuery(\n    { key: r2Key! },\n    {\n      enabled: !!r2Key,\n      staleTime: 30 * 60 * 1000,\n      refetchOnWindowFocus: false,\n    }\n  );\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center bg-muted\">\n        <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <img\n      src={signedUrlData?.url || url}\n      alt={filename}\n      className={className}\n    />\n  );\n}\n\nexport function AttachmentCarousel({\n  attachments,\n  postId,\n  totalCount,\n}: AttachmentCarouselProps) {\n  const [lightboxOpen, setLightboxOpen] = useState(false);\n  const [lightboxIndex, setLightboxIndex] = useState(0);\n\n  const visibleAttachments = attachments.slice(0, 2);\n  const remaining = totalCount - 2;\n\n  // Get all media attachments (images and videos) for the lightbox\n  const mediaAttachments: LightboxMedia[] = attachments\n    .filter((a) => a.type === \"IMAGE\" || a.type === \"VIDEO\")\n    .map((a) => ({\n      id: a.id,\n      type: a.type === \"IMAGE\" ? \"image\" as const : \"video\" as const,\n      url: a.url,\n      filename: a.filename,\n      thumbnailUrl: a.thumbnailUrl,\n    }));\n\n  const handleMediaClick = (attachmentId: string, e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const mediaIndex = mediaAttachments.findIndex((a) => a.id === attachmentId);\n    if (mediaIndex >= 0) {\n      setLightboxIndex(mediaIndex);\n      setLightboxOpen(true);\n    }\n  };\n\n  return (\n    <>\n      <div className=\"flex gap-2\">\n        {visibleAttachments.map((attachment, index) => {\n          // Images and videos open in the lightbox carousel\n          if (attachment.type === \"IMAGE\" || attachment.type === \"VIDEO\") {\n            return (\n              <button\n                key={attachment.id}\n                onClick={(e) => handleMediaClick(attachment.id, e)}\n                className=\"group relative flex-1 cursor-pointer overflow-hidden rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2\"\n              >\n                <div className=\"relative aspect-video w-full overflow-hidden bg-muted\">\n                  {attachment.type === \"IMAGE\" ? (\n                    <SignedImage\n                      url={attachment.thumbnailUrl || attachment.url}\n                      filename={attachment.filename}\n                      className=\"h-full w-full object-cover transition-transform duration-200 ease-in-out group-hover:scale-[1.02]\"\n                    />\n                  ) : (\n                    <>\n                      {attachment.thumbnailUrl ? (\n                        <SignedImage\n                          url={attachment.thumbnailUrl}\n                          filename={attachment.filename}\n                          className=\"h-full w-full object-cover transition-transform duration-200 ease-in-out group-hover:scale-[1.02]\"\n                        />\n                      ) : (\n                        <div className=\"flex h-full items-center justify-center\">\n                          <Play className=\"h-8 w-8 text-muted-foreground\" />\n                        </div>\n                      )}\n                      <div className=\"absolute inset-0 flex items-center justify-center bg-black/20 pointer-events-none\">\n                        <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-white/90\">\n                          <Play className=\"h-5 w-5 text-foreground\" />\n                        </div>\n                      </div>\n                    </>\n                  )}\n                  {index === 1 && remaining > 0 && (\n                    <div className=\"absolute inset-0 flex items-center justify-center bg-black/60 text-white\">\n                      <span className=\"text-2xl font-semibold\">+{remaining}</span>\n                    </div>\n                  )}\n                </div>\n              </button>\n            );\n          }\n\n          // Other attachment types link to the post\n          return (\n            <Link\n              key={attachment.id}\n              href={`/post/${postId}#attachment-${attachment.id}`}\n              className=\"group relative flex-1 cursor-pointer overflow-hidden rounded-lg\"\n            >\n              <div className=\"relative flex aspect-video w-full items-center justify-center bg-muted\">\n                <div className=\"flex flex-col items-center gap-2 text-muted-foreground\">\n                  {getAttachmentIcon(attachment.type)}\n                  <span className=\"max-w-[80%] truncate text-sm\">\n                    {attachment.filename}\n                  </span>\n                </div>\n                {index === 1 && remaining > 0 && (\n                  <div className=\"absolute inset-0 flex items-center justify-center bg-black/60 text-white\">\n                    <span className=\"text-2xl font-semibold\">+{remaining}</span>\n                  </div>\n                )}\n              </div>\n            </Link>\n          );\n        })}\n      </div>\n\n      <Lightbox\n        images={mediaAttachments}\n        initialIndex={lightboxIndex}\n        isOpen={lightboxOpen}\n        onClose={() => setLightboxOpen(false)}\n      />\n    </>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/Dialog.stories.tsx",
        "size": 6817,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport {\n  Dialog,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n  DialogClose,\n} from \"./dialog\";\nimport { Button } from \"./button\";\nimport { Input } from \"./input\";\nimport { Label } from \"./label\";\nimport { Textarea } from \"./textarea\";\n\nconst meta: Meta<typeof Dialog> = {\n  title: \"UI/Dialog\",\n  component: Dialog,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A modal dialog component for focused user interactions. Built on Radix UI Dialog for accessibility.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof Dialog>;\n\nexport const Default: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\">Open Dialog</Button>\n      </DialogTrigger>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Dialog Title</DialogTitle>\n          <DialogDescription>\n            This is a description of what this dialog does.\n          </DialogDescription>\n        </DialogHeader>\n        <p className=\"text-sm text-muted-foreground\">\n          Dialog content goes here. You can put any content you want.\n        </p>\n        <DialogFooter>\n          <DialogClose asChild>\n            <Button variant=\"outline\">Cancel</Button>\n          </DialogClose>\n          <Button>Confirm</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n};\n\nexport const WithForm: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button>Create Project</Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-[425px]\">\n        <DialogHeader>\n          <DialogTitle>Create Project</DialogTitle>\n          <DialogDescription>\n            Add a new project to your workspace. Click save when you're done.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"grid gap-4 py-4\">\n          <div className=\"grid gap-2\">\n            <Label htmlFor=\"name\">Name</Label>\n            <Input id=\"name\" placeholder=\"Project name\" />\n          </div>\n          <div className=\"grid gap-2\">\n            <Label htmlFor=\"description\">Description</Label>\n            <Textarea\n              id=\"description\"\n              placeholder=\"Describe your project...\"\n              rows={3}\n            />\n          </div>\n        </div>\n        <DialogFooter>\n          <DialogClose asChild>\n            <Button variant=\"outline\">Cancel</Button>\n          </DialogClose>\n          <Button type=\"submit\">Save Project</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Dialog with a form for creating new content.\",\n      },\n    },\n  },\n};\n\nexport const Confirmation: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button variant=\"destructive\">Delete Item</Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-[400px]\">\n        <DialogHeader>\n          <DialogTitle>Are you sure?</DialogTitle>\n          <DialogDescription>\n            This action cannot be undone. This will permanently delete the item\n            and remove it from our servers.\n          </DialogDescription>\n        </DialogHeader>\n        <DialogFooter>\n          <DialogClose asChild>\n            <Button variant=\"outline\">Cancel</Button>\n          </DialogClose>\n          <Button variant=\"destructive\">Delete</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Confirmation dialog for destructive actions.\",\n      },\n    },\n  },\n};\n\nexport const LongContent: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\">View Terms</Button>\n      </DialogTrigger>\n      <DialogContent className=\"max-h-[80vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>Terms of Service</DialogTitle>\n          <DialogDescription>\n            Please read our terms of service carefully.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"space-y-4 text-sm text-muted-foreground\">\n          <p>\n            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do\n            eiusmod tempor incididunt ut labore et dolore magna aliqua.\n          </p>\n          <p>\n            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris\n            nisi ut aliquip ex ea commodo consequat.\n          </p>\n          <p>\n            Duis aute irure dolor in reprehenderit in voluptate velit esse\n            cillum dolore eu fugiat nulla pariatur.\n          </p>\n          <p>\n            Excepteur sint occaecat cupidatat non proident, sunt in culpa qui\n            officia deserunt mollit anim id est laborum.\n          </p>\n          <p>\n            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do\n            eiusmod tempor incididunt ut labore et dolore magna aliqua.\n          </p>\n          <p>\n            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris\n            nisi ut aliquip ex ea commodo consequat.\n          </p>\n        </div>\n        <DialogFooter>\n          <DialogClose asChild>\n            <Button variant=\"outline\">Decline</Button>\n          </DialogClose>\n          <Button>Accept</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Dialog with scrollable long content.\",\n      },\n    },\n  },\n};\n\nexport const CustomWidth: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\">Wide Dialog</Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-[700px]\">\n        <DialogHeader>\n          <DialogTitle>Wide Dialog</DialogTitle>\n          <DialogDescription>\n            This dialog is wider for displaying more content.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"grid grid-cols-2 gap-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label>Column 1</Label>\n            <Input placeholder=\"First input\" />\n            <Input placeholder=\"Second input\" />\n          </div>\n          <div className=\"space-y-2\">\n            <Label>Column 2</Label>\n            <Input placeholder=\"Third input\" />\n            <Input placeholder=\"Fourth input\" />\n          </div>\n        </div>\n        <DialogFooter>\n          <Button>Save Changes</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Dialog with custom width for more complex layouts.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/Toast.stories.tsx",
        "size": 6782,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport {\n  Toast,\n  ToastProvider,\n  ToastViewport,\n  ToastTitle,\n  ToastDescription,\n  ToastAction,\n  ToastClose,\n} from \"./toast\";\nimport { Button } from \"./button\";\nimport { useState } from \"react\";\n\nconst meta: Meta<typeof Toast> = {\n  title: \"UI/Toast\",\n  component: Toast,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A toast notification component for displaying brief messages. Built on Radix UI Toast.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof Toast>;\n\n// Static toast examples (not interactive)\nexport const Default: Story = {\n  render: () => (\n    <div className=\"relative w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg bg-background\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Scheduled: Catch up</div>\n          <div className=\"text-sm opacity-90\">\n            Friday, February 10, 2024 at 5:57 PM\n          </div>\n        </div>\n      </div>\n    </div>\n  ),\n};\n\nexport const Variants: Story = {\n  render: () => (\n    <div className=\"space-y-4 w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg bg-background\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Default Toast</div>\n          <div className=\"text-sm opacity-90\">\n            This is a default toast notification.\n          </div>\n        </div>\n      </div>\n\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border-destructive bg-destructive text-destructive-foreground p-4 pr-6 shadow-lg\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Destructive Toast</div>\n          <div className=\"text-sm opacity-90\">\n            Something went wrong. Please try again.\n          </div>\n        </div>\n      </div>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Toast variants for different message types - default and destructive.\",\n      },\n    },\n  },\n};\n\nexport const WithAction: Story = {\n  render: () => (\n    <div className=\"w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg bg-background\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Item deleted</div>\n          <div className=\"text-sm opacity-90\">\n            The item has been moved to trash.\n          </div>\n        </div>\n        <Button variant=\"outline\" size=\"sm\" className=\"shrink-0\">\n          Undo\n        </Button>\n      </div>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Toast with an action button for undo or other quick actions.\",\n      },\n    },\n  },\n};\n\nexport const SuccessMessage: Story = {\n  render: () => (\n    <div className=\"w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border border-green-200 bg-green-50 text-green-900 p-4 pr-6 shadow-lg dark:border-green-800 dark:bg-green-950 dark:text-green-100\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Success!</div>\n          <div className=\"text-sm opacity-90\">\n            Your changes have been saved successfully.\n          </div>\n        </div>\n      </div>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Custom styled success toast using Tailwind classes.\",\n      },\n    },\n  },\n};\n\nexport const TitleOnly: Story = {\n  render: () => (\n    <div className=\"w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg bg-background\">\n        <div className=\"text-sm font-semibold\">Copied to clipboard!</div>\n      </div>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Simple toast with just a title for quick confirmations.\",\n      },\n    },\n  },\n};\n\n// Interactive demo\nconst ToastDemo = () => {\n  const [open, setOpen] = useState(false);\n  const [variant, setVariant] = useState<\"default\" | \"destructive\">(\"default\");\n\n  return (\n    <ToastProvider>\n      <div className=\"flex gap-2\">\n        <Button\n          variant=\"outline\"\n          onClick={() => {\n            setVariant(\"default\");\n            setOpen(true);\n          }}\n        >\n          Show Toast\n        </Button>\n        <Button\n          variant=\"destructive\"\n          onClick={() => {\n            setVariant(\"destructive\");\n            setOpen(true);\n          }}\n        >\n          Show Error\n        </Button>\n      </div>\n\n      <Toast open={open} onOpenChange={setOpen} variant={variant}>\n        <div className=\"grid gap-1\">\n          <ToastTitle>\n            {variant === \"default\" ? \"Notification\" : \"Error\"}\n          </ToastTitle>\n          <ToastDescription>\n            {variant === \"default\"\n              ? \"Your action was completed successfully.\"\n              : \"Something went wrong. Please try again.\"}\n          </ToastDescription>\n        </div>\n        <ToastClose />\n      </Toast>\n\n      <ToastViewport />\n    </ToastProvider>\n  );\n};\n\nexport const Interactive: Story = {\n  render: () => <ToastDemo />,\n  parameters: {\n    docs: {\n      description: {\n        story:\n          \"Interactive demo showing how to trigger toasts programmatically. Click the buttons to show different toast types.\",\n      },\n    },\n  },\n};\n\nexport const UsageExample: Story = {\n  render: () => (\n    <div className=\"space-y-4 p-4 bg-muted/50 rounded-lg max-w-md\">\n      <h4 className=\"font-medium\">Using Toasts in Your App</h4>\n      <p className=\"text-sm text-muted-foreground\">\n        Draftboard uses a toast hook pattern for triggering notifications. Import and use it like this:\n      </p>\n      <pre className=\"p-3 bg-background rounded text-xs overflow-x-auto\">\n{`import { useToast } from \"~/components/ui/use-toast\"\n\nfunction MyComponent() {\n  const { toast } = useToast()\n\n  return (\n    <Button onClick={() => {\n      toast({\n        title: \"Saved!\",\n        description: \"Your changes have been saved.\",\n      })\n    }}>\n      Save\n    </Button>\n  )\n}`}\n      </pre>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Code example showing how to use the toast system in your components.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/Editor.tsx",
        "size": 6689,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useState } from \"react\";\nimport {\n  LexicalComposer,\n  type InitialConfigType,\n} from \"@lexical/react/LexicalComposer\";\nimport { RichTextPlugin } from \"@lexical/react/LexicalRichTextPlugin\";\nimport { ContentEditable } from \"@lexical/react/LexicalContentEditable\";\nimport { HistoryPlugin } from \"@lexical/react/LexicalHistoryPlugin\";\nimport { OnChangePlugin } from \"@lexical/react/LexicalOnChangePlugin\";\nimport { LexicalErrorBoundary } from \"@lexical/react/LexicalErrorBoundary\";\nimport { MarkdownShortcutPlugin } from \"@lexical/react/LexicalMarkdownShortcutPlugin\";\nimport { ListPlugin } from \"@lexical/react/LexicalListPlugin\";\nimport { LinkPlugin } from \"@lexical/react/LexicalLinkPlugin\";\nimport { HeadingNode, QuoteNode } from \"@lexical/rich-text\";\nimport { ListItemNode, ListNode } from \"@lexical/list\";\nimport { LinkNode, AutoLinkNode } from \"@lexical/link\";\nimport { CodeNode, CodeHighlightNode } from \"@lexical/code\";\nimport { TRANSFORMERS } from \"@lexical/markdown\";\nimport type { EditorState, SerializedEditorState } from \"lexical\";\n\nimport { MentionNode } from \"./nodes/MentionNode\";\nimport { EmojiNode } from \"./nodes/EmojiNode\";\nimport { ImageNode } from \"./nodes/ImageNode\";\nimport { AttachmentNode } from \"./nodes/AttachmentNode\";\nimport { MentionPlugin } from \"./plugins/MentionPlugin\";\nimport { EmojiPlugin } from \"./plugins/EmojiPlugin\";\nimport { SlashCommandPlugin } from \"./plugins/SlashCommandPlugin\";\nimport { DragDropPlugin } from \"./plugins/DragDropPlugin\";\nimport { FloatingAddButtonPlugin } from \"./plugins/FloatingAddButtonPlugin\";\nimport { NodeDeletionPlugin } from \"./plugins/NodeDeletionPlugin\";\nimport { PasteLinkPlugin } from \"./plugins/PasteLinkPlugin\";\nimport { PasteFilePlugin } from \"./plugins/PasteFilePlugin\";\nimport { LinkClickPlugin } from \"./plugins/LinkClickPlugin\";\nimport { ToolbarPlugin } from \"./toolbar/ToolbarPlugin\";\nimport { cn } from \"~/lib/utils\";\n\ninterface EditorProps {\n  initialContent?: SerializedEditorState | null;\n  onChange?: (editorState: SerializedEditorState) => void;\n  placeholder?: string;\n  editable?: boolean;\n  showToolbar?: boolean;\n  minHeight?: string;\n  className?: string;\n}\n\nconst theme = {\n  paragraph: \"mb-2\",\n  heading: {\n    h1: \"text-3xl font-semibold mb-4 mt-6\",\n    h2: \"text-2xl font-semibold mb-3 mt-5\",\n    h3: \"text-xl font-semibold mb-2 mt-4\",\n  },\n  list: {\n    ul: \"list-disc ml-4 mb-2\",\n    ol: \"list-decimal ml-4 mb-2\",\n    listitem: \"mb-1\",\n  },\n  quote: \"border-l-4 border-primary/30 pl-4 italic text-muted-foreground my-4\",\n  code: \"font-mono bg-muted px-1.5 py-0.5 rounded text-sm\",\n  codeHighlight: {\n    atrule: \"text-purple-500\",\n    attr: \"text-yellow-500\",\n    boolean: \"text-purple-500\",\n    builtin: \"text-cyan-500\",\n    cdata: \"text-gray-500\",\n    char: \"text-green-500\",\n    class: \"text-yellow-500\",\n    \"class-name\": \"text-yellow-500\",\n    comment: \"text-gray-500\",\n    constant: \"text-purple-500\",\n    deleted: \"text-red-500\",\n    doctype: \"text-gray-500\",\n    entity: \"text-red-500\",\n    function: \"text-blue-500\",\n    important: \"text-purple-500\",\n    inserted: \"text-green-500\",\n    keyword: \"text-purple-500\",\n    namespace: \"text-purple-500\",\n    number: \"text-purple-500\",\n    operator: \"text-gray-500\",\n    prolog: \"text-gray-500\",\n    property: \"text-red-500\",\n    punctuation: \"text-gray-500\",\n    regex: \"text-green-500\",\n    selector: \"text-green-500\",\n    string: \"text-green-500\",\n    symbol: \"text-purple-500\",\n    tag: \"text-red-500\",\n    url: \"text-blue-500\",\n    variable: \"text-orange-500\",\n  },\n  link: \"text-primary underline cursor-pointer hover:text-primary/80\",\n  text: {\n    bold: \"font-bold\",\n    italic: \"italic\",\n    underline: \"underline\",\n    strikethrough: \"line-through\",\n    code: \"font-mono bg-muted px-1.5 py-0.5 rounded text-sm\",\n  },\n};\n\nexport function Editor({\n  initialContent,\n  onChange,\n  placeholder = \"Start writing, type / for commands or click + to add...\",\n  editable = true,\n  showToolbar = true,\n  minHeight = \"200px\",\n  className,\n}: EditorProps) {\n  const [floatingAnchorElem, setFloatingAnchorElem] =\n    useState<HTMLDivElement | null>(null);\n\n  const onRef = useCallback((elem: HTMLDivElement | null) => {\n    if (elem !== null) {\n      setFloatingAnchorElem(elem);\n    }\n  }, []);\n\n  const handleChange = useCallback(\n    (editorState: EditorState) => {\n      if (onChange) {\n        onChange(editorState.toJSON());\n      }\n    },\n    [onChange]\n  );\n\n  const initialConfig: InitialConfigType = {\n    namespace: \"DraftboardEditor\",\n    theme,\n    onError: (error: Error) => {\n      console.error(\"Lexical error:\", error);\n    },\n    nodes: [\n      HeadingNode,\n      QuoteNode,\n      ListNode,\n      ListItemNode,\n      LinkNode,\n      AutoLinkNode,\n      CodeNode,\n      CodeHighlightNode,\n      MentionNode,\n      EmojiNode,\n      ImageNode,\n      AttachmentNode,\n    ],\n    editorState: initialContent ? JSON.stringify(initialContent) : undefined,\n    editable,\n  };\n\n  return (\n    <LexicalComposer initialConfig={initialConfig}>\n      <div className={cn(editable && \"editor-container\", \"relative\", className)}>\n        {showToolbar && editable && <ToolbarPlugin />}\n        <div className=\"relative\" ref={onRef}>\n          <RichTextPlugin\n            contentEditable={\n              <ContentEditable\n                className={cn(editable && \"editor-input\", \"outline-none\")}\n                style={{ minHeight }}\n              />\n            }\n            placeholder={\n              <div className=\"editor-placeholder\">{placeholder}</div>\n            }\n            ErrorBoundary={LexicalErrorBoundary}\n          />\n        </div>\n        <HistoryPlugin />\n        <ListPlugin />\n        <LinkPlugin />\n        <MarkdownShortcutPlugin transformers={TRANSFORMERS} />\n        <OnChangePlugin onChange={handleChange} />\n        {editable && <MentionPlugin />}\n        {editable && <EmojiPlugin />}\n        {editable && <NodeDeletionPlugin />}\n        {editable && <PasteLinkPlugin />}\n        {editable && <PasteFilePlugin />}\n        <LinkClickPlugin />\n        {editable && floatingAnchorElem && (\n          <>\n            <SlashCommandPlugin anchorElem={floatingAnchorElem} />\n            <DragDropPlugin />\n            <FloatingAddButtonPlugin anchorElem={floatingAnchorElem} />\n          </>\n        )}\n      </div>\n    </LexicalComposer>\n  );\n}\n\n// Read-only version for displaying content\nexport function EditorContent({\n  content,\n  className,\n}: {\n  content: SerializedEditorState;\n  className?: string;\n}) {\n  return (\n    <Editor\n      initialContent={content}\n      editable={false}\n      showToolbar={false}\n      minHeight=\"auto\"\n      className={className}\n    />\n  );\n}\n",
        "truncated": false
      }
    ]
  },
  "stack": {
    "version": "1.0.0",
    "frontend": [
      {
        "category": "frontend",
        "name": "Next.js",
        "version": "15.3.7",
        "confidence": 0.85,
        "evidence": [
          "package.json: dependency next"
        ]
      },
      {
        "category": "frontend",
        "name": "React",
        "version": "19.1.0",
        "confidence": 0.8,
        "evidence": [
          "package.json: dependency react"
        ]
      }
    ],
    "backend": [],
    "db": [
      {
        "category": "db",
        "name": "Prisma",
        "version": "6.8.2",
        "confidence": 0.8,
        "evidence": [
          "package.json: dependency prisma"
        ]
      }
    ],
    "auth": [
      {
        "category": "auth",
        "name": "NextAuth",
        "version": "5.0.0-beta.25",
        "confidence": 0.78,
        "evidence": [
          "package.json: auth dependency"
        ]
      }
    ],
    "infra": [],
    "language": [
      {
        "category": "language",
        "name": "TypeScript",
        "confidence": 0.76,
        "evidence": [
          "GitHub languages API (99.07000000000001% share)"
        ]
      },
      {
        "category": "language",
        "name": "CSS",
        "confidence": 0.76,
        "evidence": [
          "GitHub languages API (0.52% share)"
        ]
      },
      {
        "category": "language",
        "name": "MDX",
        "confidence": 0.76,
        "evidence": [
          "GitHub languages API (0.4% share)"
        ]
      }
    ],
    "lowConfidenceFindings": []
  },
  "architecture": {
    "version": "1.0.0",
    "components": [
      {
        "id": "nextjs_app",
        "name": "Next.js Application",
        "role": "Full-stack web application serving frontend and API routes",
        "tech": [
          "Next.js 15",
          "React 19",
          "TypeScript",
          "Tailwind CSS",
          "App Router"
        ],
        "inputs": [
          "HTTP requests",
          "User interactions",
          "File uploads"
        ],
        "outputs": [
          "HTML pages",
          "API responses",
          "WebSocket events"
        ],
        "confidence": 0.95
      },
      {
        "id": "trpc_api",
        "name": "tRPC API Layer",
        "role": "Type-safe API layer handling business logic and data operations",
        "tech": [
          "tRPC v11",
          "React Query",
          "Zod",
          "SuperJSON"
        ],
        "inputs": [
          "Client API calls",
          "Authentication tokens"
        ],
        "outputs": [
          "Typed API responses",
          "Paginated data",
          "Real-time updates"
        ],
        "confidence": 0.9
      },
      {
        "id": "auth_system",
        "name": "Authentication System",
        "role": "User authentication and session management",
        "tech": [
          "NextAuth.js v5",
          "JWT",
          "bcryptjs",
          "Credentials Provider"
        ],
        "inputs": [
          "Login credentials",
          "Session tokens",
          "Password reset requests"
        ],
        "outputs": [
          "Session cookies",
          "JWT tokens",
          "Auth redirects"
        ],
        "confidence": 0.9
      },
      {
        "id": "postgres_db",
        "name": "PostgreSQL Database",
        "role": "Primary data store for all application data",
        "tech": [
          "PostgreSQL",
          "Prisma ORM",
          "Prisma Client"
        ],
        "inputs": [
          "Database queries",
          "Migrations",
          "CRUD operations"
        ],
        "outputs": [
          "Query results",
          "Data models",
          "Relational data"
        ],
        "confidence": 0.95
      },
      {
        "id": "r2_storage",
        "name": "Cloudflare R2 Storage",
        "role": "Object storage for media files and attachments",
        "tech": [
          "Cloudflare R2",
          "AWS SDK S3 Client",
          "Presigned URLs"
        ],
        "inputs": [
          "File uploads",
          "Presigned URL requests"
        ],
        "outputs": [
          "Stored files",
          "Public URLs",
          "Presigned download URLs"
        ],
        "confidence": 0.85
      },
      {
        "id": "lexical_editor",
        "name": "Rich Text Editor",
        "role": "Interactive content editor with rich formatting capabilities",
        "tech": [
          "Lexical",
          "Markdown",
          "Custom plugins"
        ],
        "inputs": [
          "User text input",
          "Paste events",
          "Drag and drop",
          "Slash commands"
        ],
        "outputs": [
          "Structured content JSON",
          "Draft autosaves",
          "Mentions and formatting"
        ],
        "confidence": 0.85
      },
      {
        "id": "notification_system",
        "name": "Notification System",
        "role": "Manages user notifications for comments, reactions, and mentions",
        "tech": [
          "TypeScript",
          "Prisma",
          "React Query"
        ],
        "inputs": [
          "User actions",
          "Comment events",
          "Reaction events",
          "Mention events"
        ],
        "outputs": [
          "User notifications",
          "Notification badges",
          "Notification feed"
        ],
        "confidence": 0.8
      },
      {
        "id": "webhook_integrations",
        "name": "Webhook Integrations",
        "role": "External notification delivery to Discord and Slack",
        "tech": [
          "Discord Webhooks",
          "Slack Webhooks",
          "HTTP POST"
        ],
        "inputs": [
          "New post events",
          "Configured webhook URLs"
        ],
        "outputs": [
          "Discord messages",
          "Slack messages"
        ],
        "confidence": 0.75
      },
      {
        "id": "search_system",
        "name": "Search System",
        "role": "Full-text search across posts, projects, and users",
        "tech": [
          "PostgreSQL FTS",
          "cmdk",
          "React"
        ],
        "inputs": [
          "Search queries",
          "Command palette input"
        ],
        "outputs": [
          "Search results",
          "Filtered content"
        ],
        "confidence": 0.75
      },
      {
        "id": "ui_components",
        "name": "UI Component Library",
        "role": "Reusable UI components and design system",
        "tech": [
          "shadcn/ui",
          "Radix UI",
          "Tailwind CSS",
          "Storybook"
        ],
        "inputs": [
          "Component props",
          "Theme configuration"
        ],
        "outputs": [
          "Rendered components",
          "Interactive UI elements"
        ],
        "confidence": 0.8
      }
    ],
    "edges": [
      {
        "from": "nextjs_app",
        "to": "trpc_api",
        "type": "request"
      },
      {
        "from": "nextjs_app",
        "to": "auth_system",
        "type": "request"
      },
      {
        "from": "nextjs_app",
        "to": "ui_components",
        "type": "request"
      },
      {
        "from": "nextjs_app",
        "to": "lexical_editor",
        "type": "event"
      },
      {
        "from": "trpc_api",
        "to": "postgres_db",
        "type": "data"
      },
      {
        "from": "trpc_api",
        "to": "r2_storage",
        "type": "request"
      },
      {
        "from": "trpc_api",
        "to": "notification_system",
        "type": "event"
      },
      {
        "from": "trpc_api",
        "to": "webhook_integrations",
        "type": "event"
      },
      {
        "from": "trpc_api",
        "to": "search_system",
        "type": "request"
      },
      {
        "from": "auth_system",
        "to": "postgres_db",
        "type": "data"
      },
      {
        "from": "lexical_editor",
        "to": "trpc_api",
        "type": "data"
      },
      {
        "from": "notification_system",
        "to": "postgres_db",
        "type": "data"
      },
      {
        "from": "search_system",
        "to": "postgres_db",
        "type": "request"
      },
      {
        "from": "webhook_integrations",
        "to": "postgres_db",
        "type": "data"
      }
    ]
  },
  "intent": {
    "version": "1.0.0",
    "system_purpose": "Draftboard is a shared workspace for distributed teams to post designs, ideas, and work-in-progress content. It provides a lightweight, social feed that brings creative work into the open, making it easy to share and discover team output that would otherwise disappear into chat threads or design tool comments.",
    "core_features": [
      "Reverse chronological feed with list and grid view modes",
      "Rich text editor with markdown shortcuts, @mentions, slash commands, drag-and-drop, and automatic draft saving",
      "Multi-format attachment support (images, videos, files, Figma links, Loom recordings) with carousel viewer",
      "Project organization system with cover images, descriptions, and team member management",
      "Threaded comments with 2-level depth and attachment-specific commenting",
      "Reaction system with predefined reactions (like, wow, cool) and custom emoji support",
      "Notification system for comments, replies, mentions, and reactions",
      "Full-text search across posts, projects, and people",
      "Webhook integrations for Discord and Slack notifications on new posts",
      "Admin panel with user management, invite link generation, and site settings",
      "Dark mode with full light/dark theme support",
      "Progressive Web App with mobile optimization for iOS and Android"
    ],
    "user_flows": [
      "User signs up via invite token with email and password, setting display name",
      "User signs in with email and password credentials",
      "User browses feed in list or grid view, scrolling infinitely to load more posts",
      "User composes new post with rich text editor, adding attachments via drag-drop or paste, @mentioning teammates, and assigning to projects",
      "User views post detail with full content, attachments, comments, and reactions",
      "User edits own post, modifying content, attachments, and project assignments",
      "User creates project with name, description, cover image, and team members",
      "User views project detail showing all associated posts and project information",
      "User adds comment to post or attachment, optionally replying to existing comment (2-level threading)",
      "User reacts to post or comment with emoji, viewing who reacted via reactions dialog",
      "User searches for posts, projects, or people via command palette (Cmd+K)",
      "User views and manages notifications for comments, replies, mentions, and reactions",
      "User updates profile settings including display name, avatar, and password",
      "User requests password reset via email, completing reset with token link",
      "Admin manages users, viewing list, deactivating accounts, promoting/demoting roles",
      "Admin configures site settings including custom emoji and webhook URLs for Discord/Slack",
      "Admin generates invite links for new team members",
      "Deactivated user sees deactivation message and cannot access main application"
    ],
    "business_rules": [
      "All users must authenticate via NextAuth credentials (email/password) to access protected routes",
      "Users are assigned one of three roles: MEMBER, ADMIN, or OWNER",
      "Deactivated users cannot access the main application and see only the deactivation page",
      "Only active users (non-deactivated) can create posts, comments, and reactions",
      "Users can only edit or delete their own posts",
      "Comments support maximum 2-level threading (parent comments and direct replies only)",
      "Mentions in post content trigger MENTION notifications to mentioned users (excluding self-mentions)",
      "Comments on posts create COMMENT notifications to post author",
      "Replies to comments create COMMENT_REPLY notifications to parent comment author",
      "Reactions on posts create REACTION_POST notifications to post author",
      "Reactions on comments create REACTION_COMMENT notifications to comment author",
      "Users do not receive notifications for their own actions",
      "Attachments are stored in Cloudflare R2 with signed URLs for private access",
      "Posts can have optional hideFromHome flag to exclude from main feed",
      "Posts can be assigned to multiple projects via many-to-many relationship",
      "Projects can have multiple team members with roles",
      "Custom emoji can be uploaded by admins and used in reactions",
      "Webhook notifications for new posts are sent to configured Discord/Slack URLs if enabled",
      "Invite tokens are single-use and tied to specific email addresses",
      "Password reset tokens expire and are single-use",
      "Draft posts are automatically saved and tied to user account",
      "Search performs full-text search across post titles, content, project names, and user display names",
      "Pagination uses cursor-based infinite scroll with configurable page limits",
      "File uploads support multiple attachment types: IMAGE, VIDEO, FILE, FIGMA, LOOM",
      "Attachments store metadata including dimensions, thumbnails, MIME types, and file size"
    ],
    "data_contracts": [
      "Post content stored as JSON (Lexical editor state)",
      "Comment content stored as JSON (Lexical editor state)",
      "Project description stored as JSON (Lexical editor state)",
      "Attachment metadata stored as JSON (type-specific metadata like Figma file keys)",
      "Comment coordinates stored as JSON for attachment-specific comments",
      "User roles enum: MEMBER, ADMIN, OWNER",
      "Attachment types enum: IMAGE, VIDEO, FILE, FIGMA, LOOM",
      "Notification types enum: COMMENT, COMMENT_REPLY, REACTION_POST, REACTION_COMMENT, MENTION",
      "Posts have optional title (string), required content (JSON), optional liveUrl (string)",
      "Users have required email (unique), passwordHash, displayName, optional avatarUrl",
      "Projects have required name, optional description (JSON), optional coverUrl",
      "Attachments have required url, filename, mimeType, size, order, optional width/height/thumbnailUrl",
      "Notifications have required type, userId, actorId, postId, optional commentId",
      "All models have cuid primary keys",
      "All models with user-generated content have createdAt and updatedAt timestamps",
      "Cascade deletes: deleting user deletes their posts, comments, reactions; deleting post deletes attachments, comments, reactions; deleting project deletes project memberships"
    ],
    "invariants": [
      "Every post must have an author who is a valid user",
      "Every comment must reference a valid post and author",
      "Every notification must reference a valid user (recipient) and actor (initiator)",
      "Attachment order values must be unique within a post",
      "Comment threading depth never exceeds 2 levels (parent and reply only)",
      "Email addresses are unique across all users",
      "Project member relationships are unique per user-project pair",
      "Signed R2 URLs expire and must be regenerated for private content access",
      "User sessions use JWT tokens managed by NextAuth",
      "All API calls from client go through tRPC with type safety",
      "All protected routes require valid authentication session",
      "Deactivated users cannot pass activeUserProcedure authorization",
      "Site settings use singleton pattern with id 'default'",
      "Custom emoji must have unique names within the system",
      "Drafts are tied to single user and automatically cleaned up on post creation"
    ],
    "assumptions": [
      "PostgreSQL database is available and properly configured",
      "Cloudflare R2 bucket is configured with appropriate CORS settings for file uploads",
      "NEXTAUTH_SECRET is securely generated and kept private",
      "NEXTAUTH_URL matches the deployment domain",
      "Webhook URLs for Discord/Slack are valid and active if configured",
      "Users have modern browsers supporting Progressive Web App features",
      "File upload size limits are enforced at storage layer (R2)",
      "Network latency is acceptable for signed URL generation on-demand",
      "Database connection pooling is properly configured for concurrent access",
      "R2 public URLs are configured for thumbnail and public asset access",
      "Email addresses provided during invite are valid and deliverable",
      "Users manage password reset tokens within expiration window",
      "Lexical editor state JSON is forward-compatible across editor versions",
      "Search queries are reasonably short and don't cause performance issues",
      "Cursor-based pagination provides sufficient performance for expected data volumes",
      "Turbopack development server provides adequate hot-reload performance",
      "Vercel deployment handles Next.js App Router correctly",
      "Environment variables are properly set in deployment environment"
    ],
    "unknowns": [
      "Maximum file size limits for R2 uploads are not explicitly documented",
      "Rate limiting strategy for API endpoints is not visible",
      "Email delivery mechanism for password reset tokens is not implemented",
      "Actual webhook retry logic and error handling not detailed",
      "Image processing pipeline for thumbnails not fully specified",
      "Search indexing strategy and performance characteristics unclear",
      "Cleanup strategy for expired password reset tokens not documented",
      "Draft auto-save frequency and conflict resolution not specified",
      "Notification delivery mechanism (push vs polling) not defined",
      "Maximum notification retention period not specified",
      "Attachment virus scanning or content validation not mentioned",
      "User data export or GDPR compliance features not visible",
      "Audit logging for admin actions not implemented",
      "Backup and disaster recovery procedures not documented",
      "Multi-tenancy support or future plans not indicated",
      "Performance optimization strategies for large feeds not detailed",
      "Caching strategy for frequently accessed data not specified",
      "Mobile app native features beyond PWA not mentioned"
    ],
    "confidenceBySection": {
      "system_purpose": 0.95,
      "core_features": 0.95,
      "user_flows": 0.9,
      "business_rules": 0.9,
      "data_contracts": 0.95,
      "invariants": 0.85,
      "assumptions": 0.75,
      "unknowns": 0.8
    }
  },
  "plan": {
    "version": "1.0.0",
    "targetAgent": "claude-code",
    "structured": {
      "systemOverview": "Draftboard is a Next.js 15 full-stack team collaboration platform with tRPC API, NextAuth credentials authentication, Prisma + PostgreSQL persistence, Cloudflare R2 storage, and Lexical rich-text editing. Users post designs and ideas to a reverse-chronological feed with projects, threaded comments, reactions, mentions, notifications, and Discord/Slack webhooks.",
      "architectureDescription": "App Router with server/client components, tRPC v11 procedures, NextAuth v5 session middleware, Prisma ORM with PostgreSQL, R2 presigned URLs for attachments, React Query for data fetching, shadcn/ui + Radix primitives with Tailwind composition, Lexical editor with custom plugins, cmdk search palette, and webhook integrations.",
      "routeMap": [
        {
          "path": "/",
          "purpose": "Main feed displaying posts in list or grid view with infinite scroll and project filters.",
          "layout": "Sticky top header with view-mode toggle (list/grid) and compose button. Content area streams post cards. Floating action menu bottom-right for quick compose. Empty state when no posts.",
          "components": [
            "TopNav",
            "FeedViewToggle",
            "PostCard",
            "InfiniteScroll",
            "FloatingActionMenu",
            "EmptyState"
          ],
          "logic": [
            "Fetch paginated posts via tRPC with cursor-based infinite scroll",
            "Filter by project if query param present",
            "Exclude hideFromHome posts",
            "Require active session",
            "Show skeleton loaders during fetch"
          ]
        },
        {
          "path": "/compose",
          "purpose": "Create new post with rich-text editor, attachments, mentions, and project assignment.",
          "layout": "Sticky top header with publish/save-draft actions. Main editor area with Lexical instance. Right sidebar for project picker, attachment upload zone, and post settings. Auto-save draft every 30s.",
          "components": [
            "StickyHeader",
            "LexicalEditor",
            "AttachmentUploader",
            "ProjectPicker",
            "DraftAutoSave",
            "PublishButton"
          ],
          "logic": [
            "Validate content not empty before publish",
            "Upload attachments to R2, store URLs in draft",
            "Parse @mentions from editor state, validate user IDs",
            "Create post with attachments, project relations, and mention notifications",
            "Delete draft on successful publish"
          ]
        },
        {
          "path": "/post/[id]",
          "purpose": "Post detail with full content, attachment carousel, threaded comments, reactions, and edit/delete actions.",
          "layout": "Context header with post metadata (author, date, projects). Main content area with Lexical render, attachment carousel below. Comments section beneath with 2-level threading. Floating reaction bar on hover.",
          "components": [
            "ContextHeader",
            "LexicalRenderer",
            "AttachmentCarousel",
            "CommentThread",
            "ReactionBar",
            "EditDeleteMenu"
          ],
          "logic": [
            "Fetch post with comments, attachments, reactions via tRPC",
            "Show edit/delete only if current user is author",
            "Handle attachment-specific comments with coordinate metadata",
            "Trigger COMMENT notification to post author on new comment",
            "Trigger MENTION notifications on @mentions in comments"
          ]
        },
        {
          "path": "/post/[id]/edit",
          "purpose": "Edit existing post content, attachments, and project assignments.",
          "layout": "Same as /compose but pre-populated with existing post data. Sticky header shows 'Editing post' label and update/cancel actions.",
          "components": [
            "StickyHeader",
            "LexicalEditor",
            "AttachmentUploader",
            "ProjectPicker",
            "UpdateButton",
            "CancelButton"
          ],
          "logic": [
            "Validate current user is post author or throw 403",
            "Load post data into editor state",
            "Allow adding/removing attachments and projects",
            "Preserve existing mention notifications, create new ones for added mentions",
            "Update post record with new content, attachments, projects"
          ]
        },
        {
          "path": "/projects/[id]",
          "purpose": "Project detail showing cover, description, team members, and all associated posts.",
          "layout": "Hero section with cover image, project name, description (Lexical render), and team member avatars. Below, filterable post feed showing only posts assigned to this project.",
          "components": [
            "ProjectHero",
            "LexicalRenderer",
            "TeamMemberList",
            "PostFeed",
            "EditProjectButton"
          ],
          "logic": [
            "Fetch project with members and posts via tRPC",
            "Show edit button if user is project member or admin",
            "Filter posts by project ID",
            "Display empty state if no posts assigned"
          ]
        },
        {
          "path": "/projects/new",
          "purpose": "Create new project with name, description, cover image, and team member selection.",
          "layout": "Top action bar with create/cancel. Form with name input, Lexical editor for description, cover image uploader, and multi-select for team members.",
          "components": [
            "PageHeader",
            "FormInput",
            "LexicalEditor",
            "ImageUploader",
            "TeamMemberPicker",
            "CreateButton"
          ],
          "logic": [
            "Validate name is not empty",
            "Upload cover image to R2 if provided",
            "Create project with description JSON, cover URL, and member relations",
            "Redirect to project detail on success"
          ]
        },
        {
          "path": "/notifications",
          "purpose": "Notification feed showing comments, replies, mentions, and reactions with mark-as-read functionality.",
          "layout": "Top action bar with mark-all-read action. Grouped notification list by date. Each notification shows actor avatar, action description, and link to post/comment context.",
          "components": [
            "PageHeader",
            "MarkAllReadButton",
            "NotificationList",
            "NotificationItem",
            "EmptyState"
          ],
          "logic": [
            "Fetch notifications via tRPC ordered by createdAt desc",
            "Group by date (today, yesterday, older)",
            "Mark notification as read on click",
            "Link to post detail with comment anchor if applicable",
            "Show unread badge count in top nav"
          ]
        },
        {
          "path": "/admin/users",
          "purpose": "Admin user management: view users, deactivate/reactivate, promote/demote roles, generate invite links.",
          "layout": "Top action bar with generate-invite button. User table with columns: avatar, name, email, role, status, actions. Floating action menu for quick invite generation.",
          "components": [
            "PageHeader",
            "GenerateInviteButton",
            "UserTable",
            "RoleSelect",
            "DeactivateToggle",
            "InviteDialog",
            "FloatingActionMenu"
          ],
          "logic": [
            "Require ADMIN or OWNER role via activeAdminProcedure",
            "Fetch all users via tRPC",
            "Allow role change for non-OWNER users",
            "Toggle deactivatedAt timestamp to deactivate/reactivate",
            "Generate single-use invite token tied to email"
          ]
        },
        {
          "path": "/admin/settings",
          "purpose": "Admin site configuration: custom emoji upload, Discord/Slack webhook URLs, site-wide settings.",
          "layout": "Card grid with sections: Site Settings, Custom Emoji, Webhooks. Each card has form inputs and save action. Emoji section shows uploaded emoji list with delete option.",
          "components": [
            "Card",
            "CardHeader",
            "FormInput",
            "EmojiUploader",
            "EmojiList",
            "WebhookForm",
            "SaveButton"
          ],
          "logic": [
            "Require ADMIN or OWNER role",
            "Fetch site settings singleton (id: 'default')",
            "Upload emoji images to R2, store URL and name in customEmojis JSON",
            "Validate Discord/Slack webhook URLs are valid HTTPS",
            "Update site settings record on save"
          ]
        },
        {
          "path": "/deactivated",
          "purpose": "Deactivation notice page shown to deactivated users blocking access to main app.",
          "layout": "Centered message card with deactivation notice, support contact info, and sign-out button. No navigation header.",
          "components": [
            "CenteredCard",
            "DeactivationMessage",
            "SignOutButton"
          ],
          "logic": [
            "Show only if session user has deactivatedAt timestamp",
            "Prevent access to all other routes via middleware redirect",
            "Allow sign-out to clear session"
          ]
        }
      ],
      "moduleList": [
        "src/server/api/routers/post.ts - tRPC procedures for post CRUD, feed pagination, draft management",
        "src/server/api/routers/project.ts - tRPC procedures for project CRUD, member management",
        "src/server/api/routers/comment.ts - tRPC procedures for comment creation, threading, attachment comments",
        "src/server/api/routers/reaction.ts - tRPC procedures for reaction creation, deletion, listing",
        "src/server/api/routers/notification.ts - tRPC procedures for notification fetching, marking read",
        "src/server/api/routers/user.ts - tRPC procedures for user profile, role management, deactivation",
        "src/server/api/routers/admin.ts - tRPC procedures for admin actions: invite generation, site settings",
        "src/server/api/routers/search.ts - tRPC procedures for full-text search across posts, projects, users",
        "src/components/editor/lexical-editor.tsx - Lexical editor with plugins: mentions, slash commands, markdown shortcuts, drag-drop",
        "src/lib/storage.ts - R2 client wrapper for presigned URL generation, file upload, deletion"
      ],
      "functionalityLogic": [
        "activeUserProcedure middleware: verify session exists and user.deactivatedAt is null, else throw UNAUTHORIZED",
        "activeAdminProcedure middleware: verify user role is ADMIN or OWNER, else throw FORBIDDEN",
        "Post creation: parse editor JSON for @mentions, create MENTION notifications excluding self, trigger Discord/Slack webhooks if enabled",
        "Comment creation: create COMMENT notification to post author, or COMMENT_REPLY to parent comment author, exclude self-notifications",
        "Reaction creation: create REACTION_POST or REACTION_COMMENT notification to content author, exclude self",
        "Attachment upload: generate presigned POST URL for R2, client uploads directly, server saves attachment record with URL and metadata",
        "Draft auto-save: debounce editor changes by 30s, call tRPC mutation to upsert draft record with editor JSON and attachment IDs",
        "Infinite scroll: use cursor-based pagination with post.id, fetch next page when sentinel element enters viewport",
        "Search: full-text query against post.title, post.content (cast to text), project.name, user.displayName with ILIKE or PostgreSQL FTS",
        "Invite generation: create invite token with email, expiration timestamp, single-use flag; validate email uniqueness before creating user"
      ],
      "interfaces": [
        "tRPC router exports: postRouter, projectRouter, commentRouter, reactionRouter, notificationRouter, userRouter, adminRouter, searchRouter",
        "NextAuth callbacks: jwt callback to include user.id, user.role, user.deactivatedAt; session callback to expose user object",
        "Prisma client singleton export for server-side queries with connection pooling",
        "R2 storage interface: uploadFile(file, key), getPresignedUrl(key, expiresIn), deleteFile(key)",
        "Lexical editor props: initialState, onChange, onMentionSearch, onSlashCommand, placeholder",
        "Attachment metadata JSON schemas: ImageMetadata { width, height, thumbnailUrl }, FigmaMetadata { fileKey, nodeId }, LoomMetadata { videoId }",
        "Notification type discriminated union: CommentNotification, MentionNotification, ReactionNotification with type-specific fields",
        "Search result union: PostResult, ProjectResult, UserResult with shared fields (id, type, title, snippet)"
      ],
      "dataModels": [
        "User: id (cuid), email (unique), passwordHash, displayName, avatarUrl, role (MEMBER|ADMIN|OWNER), deactivatedAt (nullable), createdAt, updatedAt",
        "Post: id (cuid), authorId (FK User), title (nullable), content (JSON), liveUrl (nullable), hideFromHome (boolean), createdAt, updatedAt",
        "Project: id (cuid), name, description (JSON), coverUrl (nullable), createdAt, updatedAt",
        "Attachment: id (cuid), postId (FK Post), url, filename, mimeType, size, order, type (IMAGE|VIDEO|FILE|FIGMA|LOOM), metadata (JSON), width (nullable), height (nullable), thumbnailUrl (nullable), createdAt",
        "Comment: id (cuid), postId (FK Post), authorId (FK User), attachmentId (nullable FK Attachment), parentCommentId (nullable FK Comment), content (JSON), coordinates (nullable JSON), createdAt, updatedAt",
        "Reaction: id (cuid), userId (FK User), postId (nullable FK Post), commentId (nullable FK Comment), emoji, createdAt; unique constraint on (userId, postId, emoji) and (userId, commentId, emoji)",
        "Notification: id (cuid), type (COMMENT|COMMENT_REPLY|REACTION_POST|REACTION_COMMENT|MENTION), userId (FK User), actorId (FK User), postId (FK Post), commentId (nullable FK Comment), read (boolean), createdAt",
        "ProjectMember: id (cuid), projectId (FK Project), userId (FK User), createdAt; unique constraint on (projectId, userId)",
        "Draft: id (cuid), userId (FK User), content (JSON), attachmentIds (JSON array), projectIds (JSON array), createdAt, updatedAt",
        "InviteToken: id (cuid), email, token (unique), expiresAt, usedAt (nullable), createdAt",
        "PasswordResetToken: id (cuid), userId (FK User), token (unique), expiresAt, usedAt (nullable), createdAt",
        "SiteSettings: id ('default'), customEmojis (JSON array), discordWebhookUrl (nullable), slackWebhookUrl (nullable), updatedAt"
      ],
      "databaseDesign": [
        "Add indexes: User(email), Post(authorId, createdAt), Comment(postId, authorId, parentCommentId), Notification(userId, read, createdAt), Reaction(postId), Reaction(commentId), ProjectMember(projectId, userId)",
        "Enable PostgreSQL full-text search extensions if using native FTS; alternatively use ILIKE on text-cast JSON fields",
        "Set cascade deletes: User cascade to Post, Comment, Reaction, Notification (as actor), Draft; Post cascade to Attachment, Comment, Reaction, Notification; Project cascade to ProjectMember",
        "Use cuid for all primary keys to avoid enumeration and ensure globally unique identifiers",
        "Store Lexical editor state as JSONB for efficient querying and indexing",
        "Store attachment metadata as JSONB with type-specific schemas validated in application layer",
        "Add unique constraints: User(email), Reaction(userId, postId, emoji), Reaction(userId, commentId, emoji), ProjectMember(projectId, userId), InviteToken(token), PasswordResetToken(token)",
        "Add check constraints: Comment.parentCommentId must reference comment with null parentCommentId (2-level threading); Reaction must have exactly one of postId or commentId not null"
      ],
      "designSystem": {
        "visualDirection": "High-clarity technical workspace with strong hierarchy, restrained accents, subtle layered surfaces, and explicit state feedback. Mono + UI typography pairing for technical identity.",
        "styleLanguage": [
          "Information-dense layout with disciplined spacing (4px base unit, 8/12/16/24/32px scale)",
          "Crisp 1px borders for surface separation, 2px for focus rings",
          "Restrained accent bursts on primary actions and notifications",
          "Layered elevation via border + subtle shadow, not heavy drop shadows"
        ],
        "colorPalette": [
          "Primary: #1A1918 (base dark), #2D2B2A (hover), #3F3D3C (active)",
          "Secondary: #F5F4F2 (light surface), #E8E6E4 (border), #D1CFC8 (muted text)",
          "Accent: #3B82F6 (primary action), #2563EB (hover), #1D4ED8 (active)",
          "Success: #10B981, Warning: #F59E0B, Danger: #EF4444, Info: #3B82F6",
          "Surface: #FFFFFF (light bg), #1A1918 (dark bg), #F9FAFB (light elevated), #2D2B2A (dark elevated)",
          "Text: #1A1918 (primary), #6B7280 (secondary), #9CA3AF (tertiary), #F9FAFB (dark mode primary)",
          "Border: #E5E7EB (light), #374151 (dark)"
        ],
        "typography": [
          "Primary UI: Inter or system-ui, 14px body, 16px large body, 12px caption",
          "Mono: 'JetBrains Mono' or 'Fira Code', 13px for metadata/timestamps",
          "Heading scale: h1 32px/bold, h2 24px/semibold, h3 20px/semibold, h4 18px/medium, h5 16px/medium, h6 14px/medium",
          "Line height: 1.5 for body, 1.25 for headings, 1.75 for long-form content"
        ],
        "radiusSystem": [
          "r-xs: 3px for buttons, inputs, badges",
          "r-sm: 6px for cards, dropdown menus",
          "r-md: 8px for modals, sheets, overlays",
          "r-lg: 12px for special hero cards",
          "r-full: 9999px for avatars, pills"
        ],
        "pageLayoutPatterns": [
          "Shell: sticky top nav (60px height), optional side rail (240px width), main content (max-width 1280px centered)",
          "Dense workspace: top action bar (48px), content grid/list with infinite scroll, floating action menu bottom-right (56px FAB)",
          "Detail page: context header (80-120px hero), primary content column (max 720px), optional right sidebar (320px) for metadata/actions",
          "Form/settings: card-based layout, max 640px width, sticky save bar at bottom on mobile"
        ],
        "components": [
          "Button: variants (primary, ghost, destructive, outline), sizes (sm 32px, md 40px, lg 48px), loading spinner state, disabled 50% opacity",
          "Input: 40px height, r-xs radius, border #E5E7EB, focus ring 2px #3B82F6, error border #EF4444 with helper text below",
          "Card: bg white, border 1px #E5E7EB, r-sm radius, padding 16px, hover border #D1CFC8",
          "Modal: r-md radius, max-width 600px, backdrop blur-sm + bg-black/50, slide-up animation 200ms",
          "Toast: fixed bottom-right, r-xs radius, auto-dismiss 5s, variants (success, error, info, warning) with icon + message",
          "Avatar: r-full, sizes (sm 32px, md 40px, lg 48px, xl 64px), fallback initials on colored background",
          "Badge: r-xs radius, padding 4px 8px, 12px text, variants (default, success, warning, danger, info)",
          "Skeleton: bg #E5E7EB animate-pulse, match target component dimensions"
        ],
        "motion": [
          "Fast: 100ms for micro-interactions (hover, focus)",
          "Standard: 200ms for component state changes (modal open, dropdown)",
          "Slow: 300ms for page transitions, large surface movements",
          "Easing: ease-out for entrances, ease-in for exits, spring for draggable elements",
          "Reduced motion: disable all animations except essential state feedback when prefers-reduced-motion is set"
        ],
        "distinctiveTraits": [
          "Consistent 3px radius on high-density controls creates recognizable visual rhythm",
          "Mono typography for timestamps and metadata reinforces technical identity",
          "Floating action menu with 56px FAB bottom-right for quick compose without disrupting reading flow",
          "Layered cards with subtle border + shadow instead of heavy elevation"
        ],
        "statesAndFeedback": [
          "Hover: border color shift, background lightness +5%, cursor pointer",
          "Focus: 2px ring in accent color, 4px offset, preserve background state",
          "Active: background lightness -5%, scale 0.98 for buttons",
          "Disabled: 50% opacity, cursor not-allowed, no hover state",
          "Loading: spinner icon with 'Loading...' text, disable interaction",
          "Error: red border, red text helper below input, inline error icon",
          "Success: green toast bottom-right, checkmark icon, 5s auto-dismiss",
          "Empty state: centered icon + heading + description + primary action, max 400px width"
        ]
      },
      "behaviorRules": [
        "All routes except /signin, /signup, /invite/[token], /reset-password/[token], /deactivated require authenticated session; redirect to /signin if unauthenticated",
        "Deactivated users redirect to /deactivated on all protected routes; check session.user.deactivatedAt in middleware",
        "tRPC procedures throw UNAUTHORIZED if session invalid, FORBIDDEN if insufficient role, NOT_FOUND if resource missing or user lacks access",
        "File uploads: client requests presigned POST URL from tRPC, uploads directly to R2, then sends URL to server for attachment record creation",
        "Draft auto-save: debounce editor onChange by 30s, call draft.upsert mutation with user ID, editor JSON, attachment IDs, project IDs",
        "Infinite scroll: fetch next page when IntersectionObserver detects sentinel element, append to existing list, update cursor",
        "Notifications: mark as read on click, link to post detail with comment anchor, show unread count badge in top nav",
        "Comment threading: allow replies only to top-level comments (parentCommentId null), reject replies to replies (2-level max)",
        "Reaction deduplication: unique constraint on (userId, postId, emoji) and (userId, commentId, emoji); toggle reaction if already exists",
        "Mention parsing: extract @mentions from Lexical editor JSON, validate user IDs exist, create MENTION notifications excluding self",
        "Webhook delivery: on post publish, if discordWebhookUrl or slackWebhookUrl configured, POST JSON payload with post data; log errors, do not block post creation",
        "Search: debounce input by 300ms, query via tRPC, show results grouped by type (posts, projects, users), limit 20 per type"
      ],
      "buildSteps": [
        "1. Initialize Next.js 15 project with TypeScript, Tailwind, App Router; install tRPC v11, NextAuth v5, Prisma, React Query, Lexical, shadcn/ui, Radix UI, cmdk, AWS SDK S3 client",
        "2. Define Prisma schema with all models (User, Post, Project, Attachment, Comment, Reaction, Notification, ProjectMember, Draft, InviteToken, PasswordResetToken, SiteSettings), indexes, constraints, and cascade rules; run migrations",
        "3. Configure NextAuth v5 with credentials provider, Prisma adapter, JWT strategy, callbacks to include user.id, user.role, user.deactivatedAt in session",
        "4. Create tRPC context with session extraction, Prisma client injection; define activeUserProcedure and activeAdminProcedure middlewares",
        "5. Implement tRPC routers: post (CRUD, feed, draft), project (CRUD, members), comment (create, thread), reaction (create, delete), notification (fetch, markRead), user (profile, role), admin (invite, settings), search (full-text query)",
        "6. Build Lexical editor component with plugins: mention autocomplete (query users via tRPC), slash commands (insert blocks), markdown shortcuts, drag-drop file upload (presigned R2 URLs), auto-save draft every 30s",
        "7. Implement R2 storage module: uploadFile (presigned POST), getPresignedUrl (GET with expiration), deleteFile; configure CORS for direct client uploads",
        "8. Build UI components using shadcn/ui + Radix primitives: Button, Input, Card, Modal, Toast, Avatar, Badge, Skeleton, CommentThread, ReactionBar, AttachmentCarousel, ProjectPicker, NotificationList, UserTable, InviteDialog",
        "9. Implement pages: / (feed with infinite scroll), /compose (editor + attachments + projects), /post/[id] (detail + comments + reactions), /projects/[id] (detail + posts), /admin/users (user table), /admin/settings (site config), /notifications (feed), /deactivated (notice)",
        "10. Add middleware: redirect unauthenticated users to /signin, redirect deactivated users to /deactivated, inject session into tRPC context; implement search command palette (Cmd+K) with cmdk; configure Discord/Slack webhook POST on post publish; add dark mode toggle with next-themes; deploy to Vercel with environment variables for DATABASE_URL, R2 credentials, NEXTAUTH_SECRET, NEXTAUTH_URL"
      ],
      "testExpectations": [
        "Authenticated user can create post with title, content, attachments, mentions, and project assignments; verify post record, attachment records, mention notifications created",
        "User can edit own post but not others; verify 403 error when attempting to edit another user's post",
        "Comment on post creates COMMENT notification to post author; reply to comment creates COMMENT_REPLY to parent author; verify notifications exclude self",
        "Reaction on post creates REACTION_POST notification; reaction on comment creates REACTION_COMMENT; verify deduplication and toggle behavior",
        "Draft auto-saves every 30s during editing; verify draft record updates with latest content and attachment IDs; verify draft deletion on publish",
        "Infinite scroll loads next page when sentinel element enters viewport; verify cursor-based pagination and append behavior",
        "Search returns posts, projects, users matching query; verify full-text search across post.title, post.content, project.name, user.displayName",
        "Admin can deactivate user; verify user redirected to /deactivated on next request and cannot access protected routes",
        "Admin can generate invite link; verify invite token created with email, expiration; verify user creation consumes token",
        "Webhook POST sent to Discord/Slack on post publish if configured; verify payload includes post data and webhook URL called; verify post creation succeeds even if webhook fails",
        "Attachment upload: verify presigned URL generated, client uploads to R2, attachment record created with correct URL and metadata",
        "Comment threading: verify replies only allowed on top-level comments; verify 2-level depth enforced via validation error on reply to reply"
      ],
      "constraints": [
        "Next.js 15 App Router with server/client component split; no Pages Router",
        "tRPC v11 with React Query for type-safe API calls; no REST or GraphQL",
        "NextAuth v5 credentials provider only; no OAuth or magic links",
        "Prisma ORM with PostgreSQL; no raw SQL or other databases",
        "Cloudflare R2 for file storage; presigned URLs for direct client uploads",
        "Lexical editor for rich text; preserve JSON editor state, no HTML or Markdown storage",
        "shadcn/ui + Radix UI primitives with Tailwind composition; no custom CSS frameworks",
        "Comment threading limited to 2 levels (parent + reply); no deeper nesting",
        "Cursor-based pagination for infinite scroll; no offset-based pagination",
        "Single-tenant application; no multi-tenancy or workspace separation",
        "Emoji reactions limited to predefined set + custom admin-uploaded emoji; no arbitrary Unicode",
        "Webhook delivery best-effort; do not block post creation on webhook failure",
        "File upload size and type validation at R2 layer; no application-level scanning",
        "No email sending implemented; password reset and invite flows assume external email delivery"
      ],
      "nonGoals": [
        "Real-time collaboration or multiplayer editing in Lexical editor",
        "Native mobile apps beyond Progressive Web App capabilities",
        "Multi-tenancy, workspace switching, or organization hierarchy",
        "Advanced search features like faceted filtering, saved searches, or ML-based relevance",
        "Email sending infrastructure for password reset or invite delivery",
        "Video transcoding, image optimization, or content moderation pipelines",
        "Audit logging, compliance reports, or GDPR data export automation",
        "Third-party OAuth providers (Google, GitHub, etc.)",
        "Activity feeds, user profiles, or social graph features beyond mentions",
        "Advanced admin analytics, usage dashboards, or billing integration",
        "Content versioning, revision history, or rollback functionality",
        "Keyboard shortcuts beyond Cmd+K search palette and Lexical editor defaults",
        "Accessibility beyond semantic HTML and ARIA labels; no WCAG AA certification",
        "Internationalization or localization; UI is English-only",
        "Performance monitoring, error tracking, or observability beyond console logs"
      ]
    },
    "prompt": "# Plan: Draftboard Implementation Blueprint\n\n## TL;DR\n- Goal: Draftboard is a Next.js 15 full-stack team collaboration platform with tRPC API, NextAuth credentials authentication, Prisma + PostgreSQL persistence, Cloudflare R2 storage, and Lexical rich-text editing. Users post designs and ideas to a reverse-chronological feed with projects, threaded comments, reactions, mentions, notifications, and Discord/Slack webhooks.\n- Recommended approach: incremental implementation aligned to existing architecture boundaries and route-level layout fidelity.\n- This plan is intentionally concise on context and verbose on implementation details, design fidelity, and UI behavior.\n\n## Phase 1: Initial Understanding\n### Repository Context\n- Repository: `hrescak/Draftboard`\n- Branch analyzed: `main`\n- Scan mode: `deep` | sampled files: 38 | token estimate: 82273\n- Target agent: `claude-code`\n\n### Key Files Inspected\n- `README.md` - project readme\n- `package.json` - dependency manifest\n- `src/app/(main)/admin/settings/page.tsx` - large source sample\n- `src/app/(main)/projects/[id]/edit/page.tsx` - large source sample\n- `src/app/(main)/admin/users/page.tsx` - large source sample\n- `src/app/(main)/compose/page.tsx` - large source sample\n- `src/server/api/routers/post.ts` - large source sample\n- `src/server/api/routers/user.ts` - large source sample\n- `src/server/api/routers/comment.ts` - large source sample\n- `tsconfig.json` - config signal\n\n### Confirmed Stack + Architecture Signals\n- Frontend: Next.js, React\n- Backend: Not detected\n- Database: Prisma\n- Auth: NextAuth\n- Infrastructure: Not detected\n- Language: TypeScript, CSS, MDX\n\n- Next.js Application (Full-stack web application serving frontend and API routes) -> Next.js 15, React 19, TypeScript\n- tRPC API Layer (Type-safe API layer handling business logic and data operations) -> tRPC v11, React Query, Zod\n- Authentication System (User authentication and session management) -> NextAuth.js v5, JWT, bcryptjs\n- PostgreSQL Database (Primary data store for all application data) -> PostgreSQL, Prisma ORM, Prisma Client\n- Cloudflare R2 Storage (Object storage for media files and attachments) -> Cloudflare R2, AWS SDK S3 Client, Presigned URLs\n- Rich Text Editor (Interactive content editor with rich formatting capabilities) -> Lexical, Markdown, Custom plugins\n- Notification System (Manages user notifications for comments, reactions, and mentions) -> TypeScript, Prisma, React Query\n- Webhook Integrations (External notification delivery to Discord and Slack) -> Discord Webhooks, Slack Webhooks, HTTP POST\n\n## Phase 2: Design\n### Requirements and Constraints\n- All routes except /signin, /signup, /invite/[token], /reset-password/[token], /deactivated require authenticated session; redirect to /signin if unauthenticated\n- Deactivated users redirect to /deactivated on all protected routes; check session.user.deactivatedAt in middleware\n- tRPC procedures throw UNAUTHORIZED if session invalid, FORBIDDEN if insufficient role, NOT_FOUND if resource missing or user lacks access\n- File uploads: client requests presigned POST URL from tRPC, uploads directly to R2, then sends URL to server for attachment record creation\n- Draft auto-save: debounce editor onChange by 30s, call draft.upsert mutation with user ID, editor JSON, attachment IDs, project IDs\n- Infinite scroll: fetch next page when IntersectionObserver detects sentinel element, append to existing list, update cursor\n- Notifications: mark as read on click, link to post detail with comment anchor, show unread count badge in top nav\n- Comment threading: allow replies only to top-level comments (parentCommentId null), reject replies to replies (2-level max)\n- Reaction deduplication: unique constraint on (userId, postId, emoji) and (userId, commentId, emoji); toggle reaction if already exists\n- Mention parsing: extract @mentions from Lexical editor JSON, validate user IDs exist, create MENTION notifications excluding self\n- Webhook delivery: on post publish, if discordWebhookUrl or slackWebhookUrl configured, POST JSON payload with post data; log errors, do not block post creation\n- Search: debounce input by 300ms, query via tRPC, show results grouped by type (posts, projects, users), limit 20 per type\n\n### Route Blueprints (Layout + Interaction Fidelity)\n### `/`\n- Purpose: Main feed displaying posts in list or grid view with infinite scroll and project filters.\n- Layout: Sticky top header with view-mode toggle (list/grid) and compose button. Content area streams post cards. Floating action menu bottom-right for quick compose. Empty state when no posts.\n- Components: TopNav, FeedViewToggle, PostCard, InfiniteScroll, FloatingActionMenu, EmptyState\n- Functionality logic: Fetch paginated posts via tRPC with cursor-based infinite scroll | Filter by project if query param present | Exclude hideFromHome posts | Require active session | Show skeleton loaders during fetch\n\n### `/compose`\n- Purpose: Create new post with rich-text editor, attachments, mentions, and project assignment.\n- Layout: Sticky top header with publish/save-draft actions. Main editor area with Lexical instance. Right sidebar for project picker, attachment upload zone, and post settings. Auto-save draft every 30s.\n- Components: StickyHeader, LexicalEditor, AttachmentUploader, ProjectPicker, DraftAutoSave, PublishButton\n- Functionality logic: Validate content not empty before publish | Upload attachments to R2, store URLs in draft | Parse @mentions from editor state, validate user IDs | Create post with attachments, project relations, and mention notifications | Delete draft on successful publish\n\n### `/post/[id]`\n- Purpose: Post detail with full content, attachment carousel, threaded comments, reactions, and edit/delete actions.\n- Layout: Context header with post metadata (author, date, projects). Main content area with Lexical render, attachment carousel below. Comments section beneath with 2-level threading. Floating reaction bar on hover.\n- Components: ContextHeader, LexicalRenderer, AttachmentCarousel, CommentThread, ReactionBar, EditDeleteMenu\n- Functionality logic: Fetch post with comments, attachments, reactions via tRPC | Show edit/delete only if current user is author | Handle attachment-specific comments with coordinate metadata | Trigger COMMENT notification to post author on new comment | Trigger MENTION notifications on @mentions in comments\n\n### `/post/[id]/edit`\n- Purpose: Edit existing post content, attachments, and project assignments.\n- Layout: Same as /compose but pre-populated with existing post data. Sticky header shows 'Editing post' label and update/cancel actions.\n- Components: StickyHeader, LexicalEditor, AttachmentUploader, ProjectPicker, UpdateButton, CancelButton\n- Functionality logic: Validate current user is post author or throw 403 | Load post data into editor state | Allow adding/removing attachments and projects | Preserve existing mention notifications, create new ones for added mentions | Update post record with new content, attachments, projects\n\n### `/projects/[id]`\n- Purpose: Project detail showing cover, description, team members, and all associated posts.\n- Layout: Hero section with cover image, project name, description (Lexical render), and team member avatars. Below, filterable post feed showing only posts assigned to this project.\n- Components: ProjectHero, LexicalRenderer, TeamMemberList, PostFeed, EditProjectButton\n- Functionality logic: Fetch project with members and posts via tRPC | Show edit button if user is project member or admin | Filter posts by project ID | Display empty state if no posts assigned\n\n### `/projects/new`\n- Purpose: Create new project with name, description, cover image, and team member selection.\n- Layout: Top action bar with create/cancel. Form with name input, Lexical editor for description, cover image uploader, and multi-select for team members.\n- Components: PageHeader, FormInput, LexicalEditor, ImageUploader, TeamMemberPicker, CreateButton\n- Functionality logic: Validate name is not empty | Upload cover image to R2 if provided | Create project with description JSON, cover URL, and member relations | Redirect to project detail on success\n\n### `/notifications`\n- Purpose: Notification feed showing comments, replies, mentions, and reactions with mark-as-read functionality.\n- Layout: Top action bar with mark-all-read action. Grouped notification list by date. Each notification shows actor avatar, action description, and link to post/comment context.\n- Components: PageHeader, MarkAllReadButton, NotificationList, NotificationItem, EmptyState\n- Functionality logic: Fetch notifications via tRPC ordered by createdAt desc | Group by date (today, yesterday, older) | Mark notification as read on click | Link to post detail with comment anchor if applicable | Show unread badge count in top nav\n\n### `/admin/users`\n- Purpose: Admin user management: view users, deactivate/reactivate, promote/demote roles, generate invite links.\n- Layout: Top action bar with generate-invite button. User table with columns: avatar, name, email, role, status, actions. Floating action menu for quick invite generation.\n- Components: PageHeader, GenerateInviteButton, UserTable, RoleSelect, DeactivateToggle, InviteDialog, FloatingActionMenu\n- Functionality logic: Require ADMIN or OWNER role via activeAdminProcedure | Fetch all users via tRPC | Allow role change for non-OWNER users | Toggle deactivatedAt timestamp to deactivate/reactivate | Generate single-use invite token tied to email\n\n### `/admin/settings`\n- Purpose: Admin site configuration: custom emoji upload, Discord/Slack webhook URLs, site-wide settings.\n- Layout: Card grid with sections: Site Settings, Custom Emoji, Webhooks. Each card has form inputs and save action. Emoji section shows uploaded emoji list with delete option.\n- Components: Card, CardHeader, FormInput, EmojiUploader, EmojiList, WebhookForm, SaveButton\n- Functionality logic: Require ADMIN or OWNER role | Fetch site settings singleton (id: 'default') | Upload emoji images to R2, store URL and name in customEmojis JSON | Validate Discord/Slack webhook URLs are valid HTTPS | Update site settings record on save\n\n### `/deactivated`\n- Purpose: Deactivation notice page shown to deactivated users blocking access to main app.\n- Layout: Centered message card with deactivation notice, support contact info, and sign-out button. No navigation header.\n- Components: CenteredCard, DeactivationMessage, SignOutButton\n- Functionality logic: Show only if session user has deactivatedAt timestamp | Prevent access to all other routes via middleware redirect | Allow sign-out to clear session\n\n### Module + Interface Implementation Plan\n#### Modules\n- src/server/api/routers/post.ts - tRPC procedures for post CRUD, feed pagination, draft management\n- src/server/api/routers/project.ts - tRPC procedures for project CRUD, member management\n- src/server/api/routers/comment.ts - tRPC procedures for comment creation, threading, attachment comments\n- src/server/api/routers/reaction.ts - tRPC procedures for reaction creation, deletion, listing\n- src/server/api/routers/notification.ts - tRPC procedures for notification fetching, marking read\n- src/server/api/routers/user.ts - tRPC procedures for user profile, role management, deactivation\n- src/server/api/routers/admin.ts - tRPC procedures for admin actions: invite generation, site settings\n- src/server/api/routers/search.ts - tRPC procedures for full-text search across posts, projects, users\n- src/components/editor/lexical-editor.tsx - Lexical editor with plugins: mentions, slash commands, markdown shortcuts, drag-drop\n- src/lib/storage.ts - R2 client wrapper for presigned URL generation, file upload, deletion\n\n#### Functionality logic\n- activeUserProcedure middleware: verify session exists and user.deactivatedAt is null, else throw UNAUTHORIZED\n- activeAdminProcedure middleware: verify user role is ADMIN or OWNER, else throw FORBIDDEN\n- Post creation: parse editor JSON for @mentions, create MENTION notifications excluding self, trigger Discord/Slack webhooks if enabled\n- Comment creation: create COMMENT notification to post author, or COMMENT_REPLY to parent comment author, exclude self-notifications\n- Reaction creation: create REACTION_POST or REACTION_COMMENT notification to content author, exclude self\n- Attachment upload: generate presigned POST URL for R2, client uploads directly, server saves attachment record with URL and metadata\n- Draft auto-save: debounce editor changes by 30s, call tRPC mutation to upsert draft record with editor JSON and attachment IDs\n- Infinite scroll: use cursor-based pagination with post.id, fetch next page when sentinel element enters viewport\n- Search: full-text query against post.title, post.content (cast to text), project.name, user.displayName with ILIKE or PostgreSQL FTS\n- Invite generation: create invite token with email, expiration timestamp, single-use flag; validate email uniqueness before creating user\n\n#### Interfaces\n- tRPC router exports: postRouter, projectRouter, commentRouter, reactionRouter, notificationRouter, userRouter, adminRouter, searchRouter\n- NextAuth callbacks: jwt callback to include user.id, user.role, user.deactivatedAt; session callback to expose user object\n- Prisma client singleton export for server-side queries with connection pooling\n- R2 storage interface: uploadFile(file, key), getPresignedUrl(key, expiresIn), deleteFile(key)\n- Lexical editor props: initialState, onChange, onMentionSearch, onSlashCommand, placeholder\n- Attachment metadata JSON schemas: ImageMetadata { width, height, thumbnailUrl }, FigmaMetadata { fileKey, nodeId }, LoomMetadata { videoId }\n- Notification type discriminated union: CommentNotification, MentionNotification, ReactionNotification with type-specific fields\n- Search result union: PostResult, ProjectResult, UserResult with shared fields (id, type, title, snippet)\n\n### Data + Database Design\n#### Data Models (Priority Set)\n- User: id (cuid), email (unique), passwordHash, displayName, avatarUrl, role (MEMBER|ADMIN|OWNER), deactivatedAt (nullable), createdAt, updatedAt\n- Post: id (cuid), authorId (FK User), title (nullable), content (JSON), liveUrl (nullable), hideFromHome (boolean), createdAt, updatedAt\n- Project: id (cuid), name, description (JSON), coverUrl (nullable), createdAt, updatedAt\n- Attachment: id (cuid), postId (FK Post), url, filename, mimeType, size, order, type (IMAGE|VIDEO|FILE|FIGMA|LOOM), metadata (JSON), width (nullable), height (nullable), thumbnailUrl (nullable), createdAt\n- Comment: id (cuid), postId (FK Post), authorId (FK User), attachmentId (nullable FK Attachment), parentCommentId (nullable FK Comment), content (JSON), coordinates (nullable JSON), createdAt, updatedAt\n- Reaction: id (cuid), userId (FK User), postId (nullable FK Post), commentId (nullable FK Comment), emoji, createdAt; unique constraint on (userId, postId, emoji) and (userId, commentId, emoji)\n- Notification: id (cuid), type (COMMENT|COMMENT_REPLY|REACTION_POST|REACTION_COMMENT|MENTION), userId (FK User), actorId (FK User), postId (FK Post), commentId (nullable FK Comment), read (boolean), createdAt\n- ProjectMember: id (cuid), projectId (FK Project), userId (FK User), createdAt; unique constraint on (projectId, userId)\n\n#### Database design\n- Add indexes: User(email), Post(authorId, createdAt), Comment(postId, authorId, parentCommentId), Notification(userId, read, createdAt), Reaction(postId), Reaction(commentId), ProjectMember(projectId, userId)\n- Enable PostgreSQL full-text search extensions if using native FTS; alternatively use ILIKE on text-cast JSON fields\n- Set cascade deletes: User cascade to Post, Comment, Reaction, Notification (as actor), Draft; Post cascade to Attachment, Comment, Reaction, Notification; Project cascade to ProjectMember\n- Use cuid for all primary keys to avoid enumeration and ensure globally unique identifiers\n- Store Lexical editor state as JSONB for efficient querying and indexing\n- Store attachment metadata as JSONB with type-specific schemas validated in application layer\n- Add unique constraints: User(email), Reaction(userId, postId, emoji), Reaction(userId, commentId, emoji), ProjectMember(projectId, userId), InviteToken(token), PasswordResetToken(token)\n- Add check constraints: Comment.parentCommentId must reference comment with null parentCommentId (2-level threading); Reaction must have exactly one of postId or commentId not null\n\n### Design System (Detailed, Implementable)\n#### Visual Direction\n- High-clarity technical workspace with strong hierarchy, restrained accents, subtle layered surfaces, and explicit state feedback. Mono + UI typography pairing for technical identity.\n\n#### Color Tokens (Use Exact Hex)\n- Background: `#0F0E0D`\n- Surface: `#1A1918` | Surface Alt: `#262422`\n- Text: `#F3F4F6` | Muted Text: `#9CA3AF`\n- Border: `#374151`\n- Primary: `#3B82F6` | Primary Hover: `#2563EB`\n- Accent: `#14B8A6`\n- Semantic: success `#22C55E`, warning `#F59E0B`, danger `#EF4444`\n\n#### Typography + Radius\n- Primary UI: Inter or system-ui, 14px body, 16px large body, 12px caption\n- Mono: 'JetBrains Mono' or 'Fira Code', 13px for metadata/timestamps\n- Heading scale: h1 32px/bold, h2 24px/semibold, h3 20px/semibold, h4 18px/medium, h5 16px/medium, h6 14px/medium\n- Radius scale: sm=8px, md=12px, lg=16px, xl=24px\n\n#### Button and Component Styling Contract\n- Primary buttons: filled style with strong contrast text, subtle lift on hover, and medium radius.\n- Secondary buttons: bordered surface-alt background with same vertical rhythm as primary buttons.\n- Ghost buttons: low-emphasis text style for tertiary actions without losing focus states.\n- Cards and panels: thin border, medium-to-large radius, and restrained elevation to maintain dense information layout.\n- Inputs: surface-alt background, explicit border, and predictable focus ring behavior.\n\n#### Layout + Positioning Contract\n- Preserve left navigation shell instead of replacing with full-height sidebar alternatives unless original uses it.\n- Preserve floating action/menu behavior (bottom-right fixed, elevated, quick-access) and avoid replacing it with static side navigation.\n- Keep sticky top navigation/action bar behavior to preserve browsing context during scroll.\n- Retain keyboard command palette entry points (Cmd/Ctrl+K) with matching action taxonomy.\n\n#### Motion + Interaction\n- Fast: 100ms for micro-interactions (hover, focus)\n- Standard: 200ms for component state changes (modal open, dropdown)\n- Slow: 300ms for page transitions, large surface movements\n- Detected transition/animation signals in source; keep micro-motion concise and functional.\n\n#### CSS Blueprint (Reference Implementation)\n```css\n:root {\n  --color-bg: #0F0E0D;\n  --color-surface: #1A1918;\n  --color-surface-alt: #262422;\n  --color-text: #F3F4F6;\n  --color-text-muted: #9CA3AF;\n  --color-border: #374151;\n  --color-primary: #3B82F6;\n  --color-primary-hover: #2563EB;\n  --color-accent: #14B8A6;\n  --color-success: #22C55E;\n  --color-warning: #F59E0B;\n  --color-danger: #EF4444;\n  --radius-sm: 8px;\n  --radius-md: 12px;\n  --radius-lg: 16px;\n  --radius-xl: 24px;\n}\n\n.btn-primary {\n  border: 1px solid transparent;\n  background: var(--color-primary);\n  color: #ffffff;\n  border-radius: var(--radius-md);\n  padding: 10px 14px;\n  font-weight: 600;\n  transition: transform 120ms ease, background-color 120ms ease;\n}\n.btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); }\n.btn-secondary {\n  border: 1px solid var(--color-border);\n  background: var(--color-surface-alt);\n  color: var(--color-text);\n  border-radius: var(--radius-md);\n  padding: 10px 14px;\n}\n.btn-ghost {\n  border: 1px solid transparent;\n  background: transparent;\n  color: var(--color-text-muted);\n  border-radius: var(--radius-sm);\n  padding: 8px 12px;\n}\n.app-shell { display: grid; grid-template-columns: 240px minmax(0, 1fr); min-height: 100vh; }\n.app-sidebar { position: sticky; top: 0; height: 100vh; border-right: 1px solid var(--color-border); background: var(--color-surface); }\n.floating-menu { position: fixed; right: 24px; bottom: 24px; display: flex; gap: 8px; padding: 10px; border: 1px solid var(--color-border); border-radius: 999px; background: var(--color-surface); box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18); }\n.surface-card { border: 1px solid var(--color-border); border-radius: var(--radius-lg); background: var(--color-surface); }\n.input { border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface-alt); color: var(--color-text); }\n@keyframes menu-in { from { opacity: 0; transform: translateY(8px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }\n```\n\n## Phase 3: Review\n### Alignment Checklist\n- Each user-facing route has explicit purpose, layout, component plan, and functionality logic.\n- Layout fidelity is preserved (floating menus, sticky headers, command palettes, shell pattern) from source signals.\n- Behavior rules map to enforceable logic paths and interface contracts.\n- Data contracts are reflected in data models and database/index/migration guidance.\n- Design system tokens and distinctive UI traits are consistently applied across routes.\n\n### Assumptions to Confirm\n- PostgreSQL database is available and properly configured\n- Cloudflare R2 bucket is configured with appropriate CORS settings for file uploads\n- NEXTAUTH_SECRET is securely generated and kept private\n- NEXTAUTH_URL matches the deployment domain\n- Webhook URLs for Discord/Slack are valid and active if configured\n- Users have modern browsers supporting Progressive Web App features\n\n### Risks and Edge Cases\n- Unknown to validate: Maximum file size limits for R2 uploads are not explicitly documented\n- Unknown to validate: Rate limiting strategy for API endpoints is not visible\n- Unknown to validate: Email delivery mechanism for password reset tokens is not implemented\n- Unknown to validate: Actual webhook retry logic and error handling not detailed\n- Unknown to validate: Image processing pipeline for thumbnails not fully specified\n- Unknown to validate: Search indexing strategy and performance characteristics unclear\n- Scope boundary: Real-time collaboration or multiplayer editing in Lexical editor\n- Scope boundary: Native mobile apps beyond Progressive Web App capabilities\n\n## Phase 4: Final Plan\n### Recommended Approach\n- Implement the plan as a single coherent approach (no parallel competing implementations).\n- Follow the ordered steps below; preserve interaction and visual behavior before introducing structural changes.\n\n### Implementation Steps\n1. 1. Initialize Next.js 15 project with TypeScript, Tailwind, App Router; install tRPC v11, NextAuth v5, Prisma, React Query, Lexical, shadcn/ui, Radix UI, cmdk, AWS SDK S3 client\n2. 2. Define Prisma schema with all models (User, Post, Project, Attachment, Comment, Reaction, Notification, ProjectMember, Draft, InviteToken, PasswordResetToken, SiteSettings), indexes, constraints, and cascade rules; run migrations\n3. 3. Configure NextAuth v5 with credentials provider, Prisma adapter, JWT strategy, callbacks to include user.id, user.role, user.deactivatedAt in session\n4. 4. Create tRPC context with session extraction, Prisma client injection; define activeUserProcedure and activeAdminProcedure middlewares\n5. 5. Implement tRPC routers: post (CRUD, feed, draft), project (CRUD, members), comment (create, thread), reaction (create, delete), notification (fetch, markRead), user (profile, role), admin (invite, settings), search (full-text query)\n6. 6. Build Lexical editor component with plugins: mention autocomplete (query users via tRPC), slash commands (insert blocks), markdown shortcuts, drag-drop file upload (presigned R2 URLs), auto-save draft every 30s\n7. 7. Implement R2 storage module: uploadFile (presigned POST), getPresignedUrl (GET with expiration), deleteFile; configure CORS for direct client uploads\n8. 8. Build UI components using shadcn/ui + Radix primitives: Button, Input, Card, Modal, Toast, Avatar, Badge, Skeleton, CommentThread, ReactionBar, AttachmentCarousel, ProjectPicker, NotificationList, UserTable, InviteDialog\n9. 9. Implement pages: / (feed with infinite scroll), /compose (editor + attachments + projects), /post/[id] (detail + comments + reactions), /projects/[id] (detail + posts), /admin/users (user table), /admin/settings (site config), /notifications (feed), /deactivated (notice)\n10. 10. Add middleware: redirect unauthenticated users to /signin, redirect deactivated users to /deactivated, inject session into tRPC context; implement search command palette (Cmd+K) with cmdk; configure Discord/Slack webhook POST on post publish; add dark mode toggle with next-themes; deploy to Vercel with environment variables for DATABASE_URL, R2 credentials, NEXTAUTH_SECRET, NEXTAUTH_URL\n\n### Testing\n- Authenticated user can create post with title, content, attachments, mentions, and project assignments; verify post record, attachment records, mention notifications created\n- User can edit own post but not others; verify 403 error when attempting to edit another user's post\n- Comment on post creates COMMENT notification to post author; reply to comment creates COMMENT_REPLY to parent author; verify notifications exclude self\n- Reaction on post creates REACTION_POST notification; reaction on comment creates REACTION_COMMENT; verify deduplication and toggle behavior\n- Draft auto-saves every 30s during editing; verify draft record updates with latest content and attachment IDs; verify draft deletion on publish\n- Infinite scroll loads next page when sentinel element enters viewport; verify cursor-based pagination and append behavior\n- Search returns posts, projects, users matching query; verify full-text search across post.title, post.content, project.name, user.displayName\n- Admin can deactivate user; verify user redirected to /deactivated on next request and cannot access protected routes\n- Admin can generate invite link; verify invite token created with email, expiration; verify user creation consumes token\n- Webhook POST sent to Discord/Slack on post publish if configured; verify payload includes post data and webhook URL called; verify post creation succeeds even if webhook fails\n- Attachment upload: verify presigned URL generated, client uploads to R2, attachment record created with correct URL and metadata\n- Comment threading: verify replies only allowed on top-level comments; verify 2-level depth enforced via validation error on reply to reply\n\n### Rollout and Migration Notes\n- Add indexes: User(email), Post(authorId, createdAt), Comment(postId, authorId, parentCommentId), Notification(userId, read, createdAt), Reaction(postId), Reaction(commentId), ProjectMember(projectId, userId)\n- Enable PostgreSQL full-text search extensions if using native FTS; alternatively use ILIKE on text-cast JSON fields\n- Set cascade deletes: User cascade to Post, Comment, Reaction, Notification (as actor), Draft; Post cascade to Attachment, Comment, Reaction, Notification; Project cascade to ProjectMember\n- Use cuid for all primary keys to avoid enumeration and ensure globally unique identifiers\n- Store Lexical editor state as JSONB for efficient querying and indexing\n- Store attachment metadata as JSONB with type-specific schemas validated in application layer\n\n## Implementation Prompt (LLM Ready)\n```markdown\nImplement hrescak/Draftboard using this plan.\nTarget agent: claude-code.\n\n## Priority Order\n1. Preserve original route/layout interaction model (do not replace floating menus with static sidebars unless source actually uses sidebar-first shell).\n2. Preserve business behavior and data contracts with explicit validations.\n3. Apply the specified design tokens and component recipes consistently.\n\n## Objective\nDraftboard is a Next.js 15 full-stack team collaboration platform with tRPC API, NextAuth credentials authentication, Prisma + PostgreSQL persistence, Cloudflare R2 storage, and Lexical rich-text editing. Users post designs and ideas to a reverse-chronological feed with projects, threaded comments, reactions, mentions, notifications, and Discord/Slack webhooks.\n\n## Route Fidelity Requirements\n- /: Sticky top header with view-mode toggle (list/grid) and compose button. Content area streams post cards. Floating action menu bottom-right for quick compose. Empty state when no posts. Components: TopNav, FeedViewToggle, PostCard, InfiniteScroll. Logic: Fetch paginated posts via tRPC with cursor-based infinite scroll | Filter by project if query param present | Exclude hideFromHome posts | Require active session | Show skeleton loaders during fetch\n- /compose: Sticky top header with publish/save-draft actions. Main editor area with Lexical instance. Right sidebar for project picker, attachment upload zone, and post settings. Auto-save draft every 30s. Components: StickyHeader, LexicalEditor, AttachmentUploader, ProjectPicker. Logic: Validate content not empty before publish | Upload attachments to R2, store URLs in draft | Parse @mentions from editor state, validate user IDs | Create post with attachments, project relations, and mention notifications | Delete draft on successful publish\n- /post/[id]: Context header with post metadata (author, date, projects). Main content area with Lexical render, attachment carousel below. Comments section beneath with 2-level threading. Floating reaction bar on hover. Components: ContextHeader, LexicalRenderer, AttachmentCarousel, CommentThread. Logic: Fetch post with comments, attachments, reactions via tRPC | Show edit/delete only if current user is author | Handle attachment-specific comments with coordinate metadata | Trigger COMMENT notification to post author on new comment | Trigger MENTION notifications on @mentions in comments\n- /post/[id]/edit: Same as /compose but pre-populated with existing post data. Sticky header shows 'Editing post' label and update/cancel actions. Components: StickyHeader, LexicalEditor, AttachmentUploader, ProjectPicker. Logic: Validate current user is post author or throw 403 | Load post data into editor state | Allow adding/removing attachments and projects | Preserve existing mention notifications, create new ones for added mentions | Update post record with new content, attachments, projects\n- /projects/[id]: Hero section with cover image, project name, description (Lexical render), and team member avatars. Below, filterable post feed showing only posts assigned to this project. Components: ProjectHero, LexicalRenderer, TeamMemberList, PostFeed. Logic: Fetch project with members and posts via tRPC | Show edit button if user is project member or admin | Filter posts by project ID | Display empty state if no posts assigned\n- /projects/new: Top action bar with create/cancel. Form with name input, Lexical editor for description, cover image uploader, and multi-select for team members. Components: PageHeader, FormInput, LexicalEditor, ImageUploader. Logic: Validate name is not empty | Upload cover image to R2 if provided | Create project with description JSON, cover URL, and member relations | Redirect to project detail on success\n- /notifications: Top action bar with mark-all-read action. Grouped notification list by date. Each notification shows actor avatar, action description, and link to post/comment context. Components: PageHeader, MarkAllReadButton, NotificationList, NotificationItem. Logic: Fetch notifications via tRPC ordered by createdAt desc | Group by date (today, yesterday, older) | Mark notification as read on click | Link to post detail with comment anchor if applicable | Show unread badge count in top nav\n- /admin/users: Top action bar with generate-invite button. User table with columns: avatar, name, email, role, status, actions. Floating action menu for quick invite generation. Components: PageHeader, GenerateInviteButton, UserTable, RoleSelect. Logic: Require ADMIN or OWNER role via activeAdminProcedure | Fetch all users via tRPC | Allow role change for non-OWNER users | Toggle deactivatedAt timestamp to deactivate/reactivate | Generate single-use invite token tied to email\n- /admin/settings: Card grid with sections: Site Settings, Custom Emoji, Webhooks. Each card has form inputs and save action. Emoji section shows uploaded emoji list with delete option. Components: Card, CardHeader, FormInput, EmojiUploader. Logic: Require ADMIN or OWNER role | Fetch site settings singleton (id: 'default') | Upload emoji images to R2, store URL and name in customEmojis JSON | Validate Discord/Slack webhook URLs are valid HTTPS | Update site settings record on save\n- /deactivated: Centered message card with deactivation notice, support contact info, and sign-out button. No navigation header. Components: CenteredCard, DeactivationMessage, SignOutButton. Logic: Show only if session user has deactivatedAt timestamp | Prevent access to all other routes via middleware redirect | Allow sign-out to clear session\n\n## Non-negotiable Rules\n- All routes except /signin, /signup, /invite/[token], /reset-password/[token], /deactivated require authenticated session; redirect to /signin if unauthenticated\n- Deactivated users redirect to /deactivated on all protected routes; check session.user.deactivatedAt in middleware\n- tRPC procedures throw UNAUTHORIZED if session invalid, FORBIDDEN if insufficient role, NOT_FOUND if resource missing or user lacks access\n- File uploads: client requests presigned POST URL from tRPC, uploads directly to R2, then sends URL to server for attachment record creation\n- Draft auto-save: debounce editor onChange by 30s, call draft.upsert mutation with user ID, editor JSON, attachment IDs, project IDs\n- Infinite scroll: fetch next page when IntersectionObserver detects sentinel element, append to existing list, update cursor\n- Notifications: mark as read on click, link to post detail with comment anchor, show unread count badge in top nav\n- Comment threading: allow replies only to top-level comments (parentCommentId null), reject replies to replies (2-level max)\n- Reaction deduplication: unique constraint on (userId, postId, emoji) and (userId, commentId, emoji); toggle reaction if already exists\n- Mention parsing: extract @mentions from Lexical editor JSON, validate user IDs exist, create MENTION notifications excluding self\n\n## Build Order\n1. 1. Initialize Next.js 15 project with TypeScript, Tailwind, App Router; install tRPC v11, NextAuth v5, Prisma, React Query, Lexical, shadcn/ui, Radix UI, cmdk, AWS SDK S3 client\n2. 2. Define Prisma schema with all models (User, Post, Project, Attachment, Comment, Reaction, Notification, ProjectMember, Draft, InviteToken, PasswordResetToken, SiteSettings), indexes, constraints, and cascade rules; run migrations\n3. 3. Configure NextAuth v5 with credentials provider, Prisma adapter, JWT strategy, callbacks to include user.id, user.role, user.deactivatedAt in session\n4. 4. Create tRPC context with session extraction, Prisma client injection; define activeUserProcedure and activeAdminProcedure middlewares\n5. 5. Implement tRPC routers: post (CRUD, feed, draft), project (CRUD, members), comment (create, thread), reaction (create, delete), notification (fetch, markRead), user (profile, role), admin (invite, settings), search (full-text query)\n6. 6. Build Lexical editor component with plugins: mention autocomplete (query users via tRPC), slash commands (insert blocks), markdown shortcuts, drag-drop file upload (presigned R2 URLs), auto-save draft every 30s\n7. 7. Implement R2 storage module: uploadFile (presigned POST), getPresignedUrl (GET with expiration), deleteFile; configure CORS for direct client uploads\n8. 8. Build UI components using shadcn/ui + Radix primitives: Button, Input, Card, Modal, Toast, Avatar, Badge, Skeleton, CommentThread, ReactionBar, AttachmentCarousel, ProjectPicker, NotificationList, UserTable, InviteDialog\n9. 9. Implement pages: / (feed with infinite scroll), /compose (editor + attachments + projects), /post/[id] (detail + comments + reactions), /projects/[id] (detail + posts), /admin/users (user table), /admin/settings (site config), /notifications (feed), /deactivated (notice)\n10. 10. Add middleware: redirect unauthenticated users to /signin, redirect deactivated users to /deactivated, inject session into tRPC context; implement search command palette (Cmd+K) with cmdk; configure Discord/Slack webhook POST on post publish; add dark mode toggle with next-themes; deploy to Vercel with environment variables for DATABASE_URL, R2 credentials, NEXTAUTH_SECRET, NEXTAUTH_URL\n\n## Test Gates\n- Authenticated user can create post with title, content, attachments, mentions, and project assignments; verify post record, attachment records, mention notifications created\n- User can edit own post but not others; verify 403 error when attempting to edit another user's post\n- Comment on post creates COMMENT notification to post author; reply to comment creates COMMENT_REPLY to parent author; verify notifications exclude self\n- Reaction on post creates REACTION_POST notification; reaction on comment creates REACTION_COMMENT; verify deduplication and toggle behavior\n- Draft auto-saves every 30s during editing; verify draft record updates with latest content and attachment IDs; verify draft deletion on publish\n- Infinite scroll loads next page when sentinel element enters viewport; verify cursor-based pagination and append behavior\n- Search returns posts, projects, users matching query; verify full-text search across post.title, post.content, project.name, user.displayName\n- Admin can deactivate user; verify user redirected to /deactivated on next request and cannot access protected routes\n- Admin can generate invite link; verify invite token created with email, expiration; verify user creation consumes token\n- Webhook POST sent to Discord/Slack on post publish if configured; verify payload includes post data and webhook URL called; verify post creation succeeds even if webhook fails\n- Attachment upload: verify presigned URL generated, client uploads to R2, attachment record created with correct URL and metadata\n- Comment threading: verify replies only allowed on top-level comments; verify 2-level depth enforced via validation error on reply to reply\n```"
  },
  "stages": [
    {
      "id": "fetch",
      "label": "Fetch repository",
      "status": "done",
      "startedAt": "2026-02-06T14:36:15.076Z",
      "finishedAt": "2026-02-06T14:36:15.834Z"
    },
    {
      "id": "ingest",
      "label": "Ingest workspace",
      "status": "done",
      "startedAt": "2026-02-06T14:36:15.834Z",
      "finishedAt": "2026-02-06T14:36:16.409Z"
    },
    {
      "id": "stack",
      "label": "Stack detection",
      "status": "done",
      "startedAt": "2026-02-06T14:36:16.409Z",
      "finishedAt": "2026-02-06T14:36:16.410Z"
    },
    {
      "id": "arch",
      "label": "Architecture extraction",
      "status": "done",
      "startedAt": "2026-02-06T14:36:16.410Z",
      "finishedAt": "2026-02-06T14:36:41.939Z"
    },
    {
      "id": "intent",
      "label": "Intent extraction",
      "status": "done",
      "startedAt": "2026-02-06T14:36:41.939Z",
      "finishedAt": "2026-02-06T14:37:32.449Z"
    },
    {
      "id": "plan",
      "label": "Plan compilation",
      "status": "done",
      "startedAt": "2026-02-06T14:37:32.449Z",
      "finishedAt": "2026-02-06T14:40:07.615Z"
    }
  ]
}