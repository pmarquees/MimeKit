{
  "id": "run_1770387593940_3vbn2w",
  "createdAt": "2026-02-06T14:27:00.040Z",
  "snapshot": {
    "version": "1.0.0",
    "repo": {
      "url": "https://github.com/hrescak/Draftboard",
      "owner": "hrescak",
      "name": "Draftboard",
      "branch": "main",
      "defaultBranch": "main",
      "sizeKb": 18940,
      "stars": 3,
      "openIssues": 7,
      "description": "Draftboard is a way to share designs in a company internally",
      "language": "TypeScript"
    },
    "metadata": {
      "scanMode": "deep",
      "fetchedAt": "2026-02-06T14:19:55.610Z",
      "totalFiles": 173,
      "selectedFiles": 38,
      "skippedBinaryFiles": 0,
      "skippedScriptFiles": 0,
      "tokenEstimate": 82273
    },
    "languages": [
      {
        "name": "TypeScript",
        "bytes": 596381,
        "share": 0.9907
      },
      {
        "name": "CSS",
        "bytes": 3150,
        "share": 0.0052
      },
      {
        "name": "MDX",
        "bytes": 2381,
        "share": 0.004
      },
      {
        "name": "JavaScript",
        "bytes": 70,
        "share": 0.0001
      }
    ],
    "fileTree": [
      {
        "path": ".DS_Store",
        "type": "blob",
        "size": 8196
      },
      {
        "path": ".env.example",
        "type": "blob",
        "size": 2065
      },
      {
        "path": ".gitignore",
        "type": "blob",
        "size": 132
      },
      {
        "path": ".storybook",
        "type": "tree"
      },
      {
        "path": ".storybook/main.ts",
        "type": "blob",
        "size": 831
      },
      {
        "path": ".storybook/preview.ts",
        "type": "blob",
        "size": 1429
      },
      {
        "path": ".storybook/preview.tsx",
        "type": "blob",
        "size": 784
      },
      {
        "path": ".storybook/vitest.setup.ts",
        "type": "blob",
        "size": 454
      },
      {
        "path": "AGENTS.MD",
        "type": "blob",
        "size": 3895
      },
      {
        "path": "CONTRIBUTING.md",
        "type": "blob",
        "size": 6672
      },
      {
        "path": "README.md",
        "type": "blob",
        "size": 5065
      },
      {
        "path": "debug-storybook.log",
        "type": "blob",
        "size": 1602
      },
      {
        "path": "docs",
        "type": "tree"
      },
      {
        "path": "docs/Deployment-vercel.md",
        "type": "blob",
        "size": 6871
      },
      {
        "path": "next-env.d.ts",
        "type": "blob",
        "size": 262
      },
      {
        "path": "next.config.ts",
        "type": "blob",
        "size": 219
      },
      {
        "path": "package.json",
        "type": "blob",
        "size": 3044
      },
      {
        "path": "postcss.config.js",
        "type": "blob",
        "size": 70
      },
      {
        "path": "prisma",
        "type": "tree"
      },
      {
        "path": "prisma/migrations",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260124010846_initial",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260124010846_initial/migration.sql",
        "type": "blob",
        "size": 8582
      },
      {
        "path": "prisma/migrations/20260131014429_add_site_settings",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260131014429_add_site_settings/migration.sql",
        "type": "blob",
        "size": 434
      },
      {
        "path": "prisma/migrations/20260131022334_add_draft_model",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260131022334_add_draft_model/migration.sql",
        "type": "blob",
        "size": 666
      },
      {
        "path": "prisma/migrations/20260201184236_add_webhook_urls",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260201184236_add_webhook_urls/migration.sql",
        "type": "blob",
        "size": 121
      },
      {
        "path": "prisma/migrations/20260203015319_add_user_deactivated",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260203015319_add_user_deactivated/migration.sql",
        "type": "blob",
        "size": 94
      },
      {
        "path": "prisma/migrations/20260204023201_add_hide_from_home",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260204023201_add_hide_from_home/migration.sql",
        "type": "blob",
        "size": 95
      },
      {
        "path": "prisma/migrations/20260204153038_add_password_reset_token",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260204153038_add_password_reset_token/migration.sql",
        "type": "blob",
        "size": 577
      },
      {
        "path": "prisma/migrations/20260205125002_add_mention_notification_type",
        "type": "tree"
      },
      {
        "path": "prisma/migrations/20260205125002_add_mention_notification_type/migration.sql",
        "type": "blob",
        "size": 64
      },
      {
        "path": "prisma/migrations/migration_lock.toml",
        "type": "blob",
        "size": 128
      },
      {
        "path": "prisma/schema.prisma",
        "type": "blob",
        "size": 6722
      },
      {
        "path": "prisma.config.ts",
        "type": "blob",
        "size": 380
      },
      {
        "path": "public",
        "type": "tree"
      },
      {
        "path": "public/OG.png",
        "type": "blob",
        "size": 447996
      },
      {
        "path": "public/OG_invite.png",
        "type": "blob",
        "size": 476400
      },
      {
        "path": "public/avatar.png",
        "type": "blob",
        "size": 8655
      },
      {
        "path": "public/favicon.svg",
        "type": "blob",
        "size": 779
      },
      {
        "path": "public/icon-192.png",
        "type": "blob",
        "size": 22828
      },
      {
        "path": "public/icon-512.png",
        "type": "blob",
        "size": 108321
      },
      {
        "path": "public/logo.svg",
        "type": "blob",
        "size": 676
      },
      {
        "path": "public/manifest.json",
        "type": "blob",
        "size": 503
      },
      {
        "path": "src",
        "type": "tree"
      },
      {
        "path": "src/app",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/deactivated",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/deactivated/page.tsx",
        "type": "blob",
        "size": 570
      },
      {
        "path": "src/app/(auth)/invite",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/invite/[token]",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/invite/[token]/actions.ts",
        "type": "blob",
        "size": 344
      },
      {
        "path": "src/app/(auth)/invite/[token]/invite-processor.tsx",
        "type": "blob",
        "size": 594
      },
      {
        "path": "src/app/(auth)/invite/[token]/page.tsx",
        "type": "blob",
        "size": 1069
      },
      {
        "path": "src/app/(auth)/layout.tsx",
        "type": "blob",
        "size": 489
      },
      {
        "path": "src/app/(auth)/reset-password",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/reset-password/[token]",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/reset-password/[token]/page.tsx",
        "type": "blob",
        "size": 6189
      },
      {
        "path": "src/app/(auth)/sign-in",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/sign-in/page.tsx",
        "type": "blob",
        "size": 4010
      },
      {
        "path": "src/app/(auth)/sign-up",
        "type": "tree"
      },
      {
        "path": "src/app/(auth)/sign-up/page.tsx",
        "type": "blob",
        "size": 1042
      },
      {
        "path": "src/app/(auth)/sign-up/sign-up-form.tsx",
        "type": "blob",
        "size": 5490
      },
      {
        "path": "src/app/(main)",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/admin",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/admin/admin-nav.tsx",
        "type": "blob",
        "size": 1237
      },
      {
        "path": "src/app/(main)/admin/layout.tsx",
        "type": "blob",
        "size": 615
      },
      {
        "path": "src/app/(main)/admin/settings",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/admin/settings/page.tsx",
        "type": "blob",
        "size": 17812
      },
      {
        "path": "src/app/(main)/admin/users",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/admin/users/page.tsx",
        "type": "blob",
        "size": 8956
      },
      {
        "path": "src/app/(main)/compose",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/compose/page.tsx",
        "type": "blob",
        "size": 8610
      },
      {
        "path": "src/app/(main)/layout.tsx",
        "type": "blob",
        "size": 805
      },
      {
        "path": "src/app/(main)/notifications",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/notifications/page.tsx",
        "type": "blob",
        "size": 6017
      },
      {
        "path": "src/app/(main)/page.tsx",
        "type": "blob",
        "size": 335
      },
      {
        "path": "src/app/(main)/post",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/post/[id]",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/post/[id]/edit",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/post/[id]/edit/page.tsx",
        "type": "blob",
        "size": 3518
      },
      {
        "path": "src/app/(main)/post/[id]/page.tsx",
        "type": "blob",
        "size": 1224
      },
      {
        "path": "src/app/(main)/projects",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/projects/[id]",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/projects/[id]/edit",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/projects/[id]/edit/page.tsx",
        "type": "blob",
        "size": 9781
      },
      {
        "path": "src/app/(main)/projects/[id]/page.tsx",
        "type": "blob",
        "size": 487
      },
      {
        "path": "src/app/(main)/projects/new",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/projects/new/page.tsx",
        "type": "blob",
        "size": 6299
      },
      {
        "path": "src/app/(main)/projects/page.tsx",
        "type": "blob",
        "size": 5798
      },
      {
        "path": "src/app/(main)/settings",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/settings/page.tsx",
        "type": "blob",
        "size": 4899
      },
      {
        "path": "src/app/(main)/user",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/user/[id]",
        "type": "tree"
      },
      {
        "path": "src/app/(main)/user/[id]/page.tsx",
        "type": "blob",
        "size": 453
      },
      {
        "path": "src/app/api",
        "type": "tree"
      },
      {
        "path": "src/app/api/auth",
        "type": "tree"
      },
      {
        "path": "src/app/api/auth/[...nextauth]",
        "type": "tree"
      },
      {
        "path": "src/app/api/auth/[...nextauth]/route.ts",
        "type": "blob",
        "size": 82
      },
      {
        "path": "src/app/api/trpc",
        "type": "tree"
      },
      {
        "path": "src/app/api/trpc/[trpc]",
        "type": "tree"
      },
      {
        "path": "src/app/api/trpc/[trpc]/route.ts",
        "type": "blob",
        "size": 703
      },
      {
        "path": "src/app/globals.css",
        "type": "blob",
        "size": 3150
      },
      {
        "path": "src/app/layout.tsx",
        "type": "blob",
        "size": 2044
      },
      {
        "path": "src/components",
        "type": "tree"
      },
      {
        "path": "src/components/comments",
        "type": "tree"
      },
      {
        "path": "src/components/comments/CommentComposer.tsx",
        "type": "blob",
        "size": 3853
      },
      {
        "path": "src/components/comments/CommentSection.tsx",
        "type": "blob",
        "size": 1178
      },
      {
        "path": "src/components/comments/CommentThread.tsx",
        "type": "blob",
        "size": 6296
      },
      {
        "path": "src/components/editor",
        "type": "tree"
      },
      {
        "path": "src/components/editor/Editor.tsx",
        "type": "blob",
        "size": 6689
      },
      {
        "path": "src/components/editor/SimpleMarkdownEditor.tsx",
        "type": "blob",
        "size": 7742
      },
      {
        "path": "src/components/editor/nodes",
        "type": "tree"
      },
      {
        "path": "src/components/editor/nodes/AttachmentNode.tsx",
        "type": "blob",
        "size": 16733
      },
      {
        "path": "src/components/editor/nodes/EmojiNode.tsx",
        "type": "blob",
        "size": 3564
      },
      {
        "path": "src/components/editor/nodes/ImageNode.tsx",
        "type": "blob",
        "size": 5313
      },
      {
        "path": "src/components/editor/nodes/MentionNode.test.ts",
        "type": "blob",
        "size": 831
      },
      {
        "path": "src/components/editor/nodes/MentionNode.tsx",
        "type": "blob",
        "size": 5062
      },
      {
        "path": "src/components/editor/plugins",
        "type": "tree"
      },
      {
        "path": "src/components/editor/plugins/DragDropPlugin.tsx",
        "type": "blob",
        "size": 2632
      },
      {
        "path": "src/components/editor/plugins/EmojiPlugin.tsx",
        "type": "blob",
        "size": 4784
      },
      {
        "path": "src/components/editor/plugins/FloatingAddButtonPlugin.tsx",
        "type": "blob",
        "size": 10469
      },
      {
        "path": "src/components/editor/plugins/KeyboardShortcutsPlugin.tsx",
        "type": "blob",
        "size": 2315
      },
      {
        "path": "src/components/editor/plugins/LinkClickPlugin.tsx",
        "type": "blob",
        "size": 994
      },
      {
        "path": "src/components/editor/plugins/MentionPlugin.tsx",
        "type": "blob",
        "size": 5861
      },
      {
        "path": "src/components/editor/plugins/NodeDeletionPlugin.tsx",
        "type": "blob",
        "size": 1284
      },
      {
        "path": "src/components/editor/plugins/PasteFilePlugin.tsx",
        "type": "blob",
        "size": 3395
      },
      {
        "path": "src/components/editor/plugins/PasteLinkPlugin.tsx",
        "type": "blob",
        "size": 1799
      },
      {
        "path": "src/components/editor/plugins/SlashCommandPlugin.tsx",
        "type": "blob",
        "size": 13392
      },
      {
        "path": "src/components/editor/toolbar",
        "type": "tree"
      },
      {
        "path": "src/components/editor/toolbar/ToolbarPlugin.tsx",
        "type": "blob",
        "size": 7312
      },
      {
        "path": "src/components/feed",
        "type": "tree"
      },
      {
        "path": "src/components/feed/AttachmentCarousel.tsx",
        "type": "blob",
        "size": 6917
      },
      {
        "path": "src/components/feed/FeedSkeleton.tsx",
        "type": "blob",
        "size": 1531
      },
      {
        "path": "src/components/feed/FeedView.tsx",
        "type": "blob",
        "size": 3770
      },
      {
        "path": "src/components/feed/GridView.tsx",
        "type": "blob",
        "size": 4041
      },
      {
        "path": "src/components/feed/PostCard.test.tsx",
        "type": "blob",
        "size": 3982
      },
      {
        "path": "src/components/feed/PostCard.tsx",
        "type": "blob",
        "size": 6923
      },
      {
        "path": "src/components/layout",
        "type": "tree"
      },
      {
        "path": "src/components/layout/main-nav.tsx",
        "type": "blob",
        "size": 18895
      },
      {
        "path": "src/components/post",
        "type": "tree"
      },
      {
        "path": "src/components/post/PostDetail.tsx",
        "type": "blob",
        "size": 8582
      },
      {
        "path": "src/components/post/PostEditor.tsx",
        "type": "blob",
        "size": 10961
      },
      {
        "path": "src/components/projects",
        "type": "tree"
      },
      {
        "path": "src/components/projects/CoverUpload.tsx",
        "type": "blob",
        "size": 5683
      },
      {
        "path": "src/components/projects/ProjectDetail.tsx",
        "type": "blob",
        "size": 10897
      },
      {
        "path": "src/components/reactions",
        "type": "tree"
      },
      {
        "path": "src/components/reactions/ReactionButton.tsx",
        "type": "blob",
        "size": 11733
      },
      {
        "path": "src/components/reactions/ReactionsDialog.tsx",
        "type": "blob",
        "size": 5011
      },
      {
        "path": "src/components/search",
        "type": "tree"
      },
      {
        "path": "src/components/search/SearchCommand.tsx",
        "type": "blob",
        "size": 8488
      },
      {
        "path": "src/components/settings",
        "type": "tree"
      },
      {
        "path": "src/components/settings/AvatarUpload.tsx",
        "type": "blob",
        "size": 3818
      },
      {
        "path": "src/components/settings/EmojiUpload.tsx",
        "type": "blob",
        "size": 6161
      },
      {
        "path": "src/components/theme-provider.tsx",
        "type": "blob",
        "size": 299
      },
      {
        "path": "src/components/ui",
        "type": "tree"
      },
      {
        "path": "src/components/ui/Avatar.stories.tsx",
        "type": "blob",
        "size": 5822
      },
      {
        "path": "src/components/ui/Badge.stories.tsx",
        "type": "blob",
        "size": 2839
      },
      {
        "path": "src/components/ui/Button.stories.tsx",
        "type": "blob",
        "size": 4885
      },
      {
        "path": "src/components/ui/Card.stories.tsx",
        "type": "blob",
        "size": 5486
      },
      {
        "path": "src/components/ui/Command.stories.tsx",
        "type": "blob",
        "size": 9845
      },
      {
        "path": "src/components/ui/DesignTokens.stories.tsx",
        "type": "blob",
        "size": 13964
      },
      {
        "path": "src/components/ui/Dialog.stories.tsx",
        "type": "blob",
        "size": 6817
      },
      {
        "path": "src/components/ui/DropdownMenu.stories.tsx",
        "type": "blob",
        "size": 8258
      },
      {
        "path": "src/components/ui/Input.stories.tsx",
        "type": "blob",
        "size": 4755
      },
      {
        "path": "src/components/ui/Introduction.mdx",
        "type": "blob",
        "size": 2381
      },
      {
        "path": "src/components/ui/Label.stories.tsx",
        "type": "blob",
        "size": 3197
      },
      {
        "path": "src/components/ui/Logo.stories.tsx",
        "type": "blob",
        "size": 2653
      },
      {
        "path": "src/components/ui/Popover.stories.tsx",
        "type": "blob",
        "size": 5680
      },
      {
        "path": "src/components/ui/Skeleton.stories.tsx",
        "type": "blob",
        "size": 4537
      },
      {
        "path": "src/components/ui/Switch.stories.tsx",
        "type": "blob",
        "size": 4162
      },
      {
        "path": "src/components/ui/Tabs.stories.tsx",
        "type": "blob",
        "size": 7719
      },
      {
        "path": "src/components/ui/Textarea.stories.tsx",
        "type": "blob",
        "size": 3493
      },
      {
        "path": "src/components/ui/Toast.stories.tsx",
        "type": "blob",
        "size": 6782
      },
      {
        "path": "src/components/ui/Tooltip.stories.tsx",
        "type": "blob",
        "size": 6386
      },
      {
        "path": "src/components/ui/avatar.tsx",
        "type": "blob",
        "size": 3157
      },
      {
        "path": "src/components/ui/badge.tsx",
        "type": "blob",
        "size": 1145
      },
      {
        "path": "src/components/ui/button.tsx",
        "type": "blob",
        "size": 1955
      },
      {
        "path": "src/components/ui/card.tsx",
        "type": "blob",
        "size": 1849
      },
      {
        "path": "src/components/ui/command.tsx",
        "type": "blob",
        "size": 4914
      },
      {
        "path": "src/components/ui/dialog.tsx",
        "type": "blob",
        "size": 3869
      },
      {
        "path": "src/components/ui/dropdown-menu.tsx",
        "type": "blob",
        "size": 7449
      },
      {
        "path": "src/components/ui/input.tsx",
        "type": "blob",
        "size": 773
      },
      {
        "path": "src/components/ui/label.tsx",
        "type": "blob",
        "size": 732
      },
      {
        "path": "src/components/ui/lightbox.tsx",
        "type": "blob",
        "size": 6434
      },
      {
        "path": "src/components/ui/logo.tsx",
        "type": "blob",
        "size": 845
      },
      {
        "path": "src/components/ui/media-lightbox-context.tsx",
        "type": "blob",
        "size": 2132
      },
      {
        "path": "src/components/ui/popover.tsx",
        "type": "blob",
        "size": 1315
      },
      {
        "path": "src/components/ui/skeleton.tsx",
        "type": "blob",
        "size": 264
      },
      {
        "path": "src/components/ui/switch.tsx",
        "type": "blob",
        "size": 1169
      },
      {
        "path": "src/components/ui/tabs.tsx",
        "type": "blob",
        "size": 1939
      },
      {
        "path": "src/components/ui/textarea.tsx",
        "type": "blob",
        "size": 654
      },
      {
        "path": "src/components/ui/toast.tsx",
        "type": "blob",
        "size": 4855
      },
      {
        "path": "src/components/ui/tooltip.tsx",
        "type": "blob",
        "size": 1226
      },
      {
        "path": "src/components/user",
        "type": "tree"
      },
      {
        "path": "src/components/user/UserProfile.tsx",
        "type": "blob",
        "size": 4831
      },
      {
        "path": "src/components/utils",
        "type": "tree"
      },
      {
        "path": "src/components/utils/ScrollToHash.tsx",
        "type": "blob",
        "size": 491
      },
      {
        "path": "src/lib",
        "type": "tree"
      },
      {
        "path": "src/lib/hooks",
        "type": "tree"
      },
      {
        "path": "src/lib/hooks/useDebounce.ts",
        "type": "blob",
        "size": 386
      },
      {
        "path": "src/lib/r2.ts",
        "type": "blob",
        "size": 3873
      },
      {
        "path": "src/lib/trpc",
        "type": "tree"
      },
      {
        "path": "src/lib/trpc/client.ts",
        "type": "blob",
        "size": 170
      },
      {
        "path": "src/lib/trpc/provider.tsx",
        "type": "blob",
        "size": 1587
      },
      {
        "path": "src/lib/trpc/server.ts",
        "type": "blob",
        "size": 486
      },
      {
        "path": "src/lib/utils.test.ts",
        "type": "blob",
        "size": 4253
      },
      {
        "path": "src/lib/utils.ts",
        "type": "blob",
        "size": 3665
      },
      {
        "path": "src/lib/validators.test.ts",
        "type": "blob",
        "size": 7349
      },
      {
        "path": "src/lib/validators.ts",
        "type": "blob",
        "size": 3973
      },
      {
        "path": "src/lib/webhooks.ts",
        "type": "blob",
        "size": 7562
      },
      {
        "path": "src/middleware.ts",
        "type": "blob",
        "size": 793
      },
      {
        "path": "src/server",
        "type": "tree"
      },
      {
        "path": "src/server/api",
        "type": "tree"
      },
      {
        "path": "src/server/api/root.ts",
        "type": "blob",
        "size": 1080
      },
      {
        "path": "src/server/api/routers",
        "type": "tree"
      },
      {
        "path": "src/server/api/routers/comment.ts",
        "type": "blob",
        "size": 7985
      },
      {
        "path": "src/server/api/routers/draft.ts",
        "type": "blob",
        "size": 4743
      },
      {
        "path": "src/server/api/routers/notification.ts",
        "type": "blob",
        "size": 2027
      },
      {
        "path": "src/server/api/routers/post.ts",
        "type": "blob",
        "size": 13316
      },
      {
        "path": "src/server/api/routers/project.ts",
        "type": "blob",
        "size": 6561
      },
      {
        "path": "src/server/api/routers/reaction.ts",
        "type": "blob",
        "size": 6352
      },
      {
        "path": "src/server/api/routers/search.ts",
        "type": "blob",
        "size": 2256
      },
      {
        "path": "src/server/api/routers/site.ts",
        "type": "blob",
        "size": 5009
      },
      {
        "path": "src/server/api/routers/upload.ts",
        "type": "blob",
        "size": 2036
      },
      {
        "path": "src/server/api/routers/user.ts",
        "type": "blob",
        "size": 10311
      },
      {
        "path": "src/server/api/trpc.ts",
        "type": "blob",
        "size": 2305
      },
      {
        "path": "src/server/auth.config.ts",
        "type": "blob",
        "size": 1079
      },
      {
        "path": "src/server/auth.ts",
        "type": "blob",
        "size": 3398
      },
      {
        "path": "src/server/db.ts",
        "type": "blob",
        "size": 397
      },
      {
        "path": "src/test",
        "type": "tree"
      },
      {
        "path": "src/test/setup.ts",
        "type": "blob",
        "size": 31
      },
      {
        "path": "tsconfig.json",
        "type": "blob",
        "size": 602
      },
      {
        "path": "tsconfig.tsbuildinfo",
        "type": "blob",
        "size": 377101
      },
      {
        "path": "vitest.config.ts",
        "type": "blob",
        "size": 1361
      },
      {
        "path": "vitest.shims.d.ts",
        "type": "blob",
        "size": 62
      }
    ],
    "files": [
      {
        "path": ".env.example",
        "size": 2065,
        "reason": "config signal",
        "content": "# =============================================================================\n# Draftboard Environment Variables\n# =============================================================================\n# Copy this file to .env and fill in the values:\n#   cp .env.example .env\n# =============================================================================\n\n# -----------------------------------------------------------------------------\n# Database (Prisma Postgres)\n# -----------------------------------------------------------------------------\n# Connection string for your Prisma Postgres database.\n# For local development, run `npx prisma dev` to get a local connection URL.\n# See: https://pris.ly/d/connection-strings\nDATABASE_URL=\"prisma+postgres://accelerate.prisma-data.net/?api_key=YOUR_API_KEY\"\n\n# -----------------------------------------------------------------------------\n# NextAuth.js\n# -----------------------------------------------------------------------------\n# Secret used to encrypt JWTs and session cookies.\n# Generate one with: openssl rand -base64 32\nNEXTAUTH_SECRET=\"generate-a-random-secret-here\"\n\n# The canonical URL of your app. Used for OAuth callbacks and redirects.\nNEXTAUTH_URL=\"http://localhost:3000\"\n\n# -----------------------------------------------------------------------------\n# Cloudflare R2 Storage (for file uploads)\n# -----------------------------------------------------------------------------\n# These are required for image/file upload functionality.\n# Get these from your Cloudflare dashboard → R2 → API Tokens.\n\n# Your Cloudflare account ID (found in the dashboard URL or account overview)\nR2_ACCOUNT_ID=your_cloudflare_account_id\n\n# R2 API token credentials (create an API token with R2 read/write access)\nR2_ACCESS_KEY_ID=your_r2_access_key_id\nR2_SECRET_ACCESS_KEY=your_r2_secret_access_key\n\n# The name of your R2 bucket\nR2_BUCKET_NAME=your_bucket_name\n\n# Public URL for accessing uploaded files.\n# Typically: https://<account_id>.r2.cloudflarestorage.com\nR2_PUBLIC_URL=https://your_account_id.r2.cloudflarestorage.com\n",
        "truncated": false
      },
      {
        "path": "AGENTS.MD",
        "size": 3895,
        "reason": "agent instructions",
        "content": "# AGENTS.MD\n\nGuidelines for AI coding agents working on this codebase.\n\n## Code Style & Conventions\n\n### Pluralization\n\nAlways use the `pluralize()` helper from `~/lib/utils` when displaying counts with text labels. Never hardcode plural forms.\n\n```tsx\n// ✅ Correct\nimport { pluralize } from \"~/lib/utils\";\n<span>{count} {pluralize(count, \"post\")}</span>\n<span>{count} {pluralize(count, \"reply\", \"replies\")}</span>\n\n// ❌ Wrong - hardcoded plural\n<span>{count} posts</span>\n<span>{count} members</span>\n```\n\nThe `pluralize(count, singular, plural?)` function:\n- Returns singular form when count === 1\n- Returns plural form (or singular + \"s\") otherwise\n- Supports irregular plurals via optional third argument\n\n### Component Structure\n\n- Use `\"use client\"` directive for interactive components\n- Keep server components as the default where possible\n- Place shared UI components in `src/components/ui/`\n- Feature-specific components go in their respective folders (e.g., `src/components/feed/`)\n\n### Imports\n\n- Use path aliases: `~/` maps to `src/`\n- Import order: React → Next.js → external libs → internal modules → types\n- Prefer named exports over default exports for components\n\n### TypeScript\n\n- Always type component props with interfaces\n- Use `unknown` for JSON data from the database (e.g., Lexical editor state)\n- Prefer explicit types over `any`\n\n### API & Data Fetching\n\n- Use tRPC for all API calls via `api` from `~/lib/trpc/client`\n- Use React Query's infinite queries for paginated data\n- Handle loading and error states explicitly\n\n### Styling\n\n- Use Tailwind CSS classes\n- Use `cn()` from `~/lib/utils` for conditional class merging\n- Follow shadcn/ui patterns for custom components\n\n#### Destructive Action Styling\n\nDestructive/negative actions with red text must have proper hover/focus states to remain readable:\n\n```tsx\n// ✅ Correct - red background with white text on hover/focus\n<DropdownMenuItem className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\">\n  Delete item\n</DropdownMenuItem>\n\n<Button className=\"text-destructive hover:bg-destructive hover:text-destructive-foreground\">\n  Sign out\n</Button>\n\n// ❌ Wrong - red text stays red on dark hover background, becomes unreadable\n<DropdownMenuItem className=\"text-destructive focus:text-destructive\">\n  Delete item\n</DropdownMenuItem>\n\n<Button className=\"text-destructive hover:text-destructive\">\n  Sign out\n</Button>\n```\n\nRule: Elements with `text-destructive` in default state should use `focus:bg-destructive focus:text-destructive-foreground` (for menu items) or `hover:bg-destructive hover:text-destructive-foreground` (for buttons) in their interactive states.\n\n## Project Architecture\n\n```\nsrc/\n├── app/                    # Next.js App Router pages\n│   ├── (auth)/            # Auth pages (public)\n│   ├── (main)/            # Protected pages\n│   └── api/               # API routes (tRPC, NextAuth)\n├── components/            # React components\n├── server/                # Server-side code\n│   └── api/routers/       # tRPC routers\n├── lib/                   # Utilities and hooks\n└── middleware.ts          # Auth middleware\n```\n\n## Testing\n\n- Use Vitest for unit tests\n- Place test files alongside source files with `.test.ts` extension\n- Run tests with `npm test`\n\n## Common Patterns\n\n### Infinite Scroll Lists\n\n```tsx\nconst { data, fetchNextPage, hasNextPage, isFetchingNextPage } = \n  api.post.list.useInfiniteQuery(\n    { limit: 10 },\n    { getNextPageParam: (lastPage) => lastPage.nextCursor }\n  );\n\nconst items = data?.pages.flatMap((page) => page.items) ?? [];\n```\n\n### Date Formatting\n\nUse `formatRelativeTime()` from `~/lib/utils` for consistent relative dates.\n\n### URL Signing for R2\n\nPrivate R2 URLs need signing. Use `api.upload.getDownloadUrl.useQuery()` for attachments and cover images.\n",
        "truncated": false
      },
      {
        "path": "CONTRIBUTING.md",
        "size": 6672,
        "reason": "contributing guide",
        "content": "# Contributing to Draftboard\n\nThanks for your interest in contributing! This guide covers everything you need to get a local development environment running and start making changes.\n\n## Development Setup\n\n### Prerequisites\n\n- Node.js 18+\n- PostgreSQL (local or hosted)\n- Cloudflare R2 bucket (for file uploads)\n\n### Getting Started\n\n```bash\n# Install dependencies\nnpm install\n\n# Copy environment file and fill in your values\ncp .env.example .env\n\n# Generate the Prisma client\nnpm run db:generate\n\n# Run database migrations\nnpm run db:migrate\n\n# Start the dev server (with Turbopack)\nnpm run dev\n```\n\nThe app will be available at [http://localhost:3000](http://localhost:3000).\n\n### Available Scripts\n\n| Command | Description |\n|---|---|\n| `npm run dev` | Start development server with Turbopack |\n| `npm run build` | Build for production |\n| `npm run build:prod` | Run migrations + build (for deployment) |\n| `npm run lint` | Run ESLint |\n| `npm test` | Run Vitest in watch mode |\n| `npm run test:run` | Run tests once |\n| `npm run storybook` | Start Storybook on port 6006 |\n| `npm run build-storybook` | Build static Storybook |\n| `npm run db:generate` | Regenerate Prisma client |\n| `npm run db:migrate` | Create and run migrations |\n| `npm run db:push` | Push schema changes without migrations |\n| `npm run db:studio` | Open Prisma Studio (database GUI) |\n\n## Project Architecture\n\n```\nsrc/\n├── app/                        # Next.js App Router\n│   ├── (auth)/                 # Public auth pages (sign-in, sign-up, invite, reset-password)\n│   ├── (main)/                 # Protected pages (feed, posts, projects, admin, settings)\n│   └── api/                    # API routes (tRPC, NextAuth)\n├── components/\n│   ├── comments/               # Comment section, threads, composer\n│   ├── editor/                 # Lexical rich text editor, plugins, and nodes\n│   ├── feed/                   # Feed list/grid views, post cards\n│   ├── layout/                 # Main navigation\n│   ├── post/                   # Post detail and editor\n│   ├── projects/               # Project detail, cover upload\n│   ├── reactions/              # Reaction button and dialog\n│   ├── search/                 # Command palette search\n│   ├── settings/               # Avatar and emoji upload\n│   ├── ui/                     # Shared UI primitives (shadcn/ui)\n│   └── user/                   # User profile\n├── server/\n│   ├── api/\n│   │   ├── routers/            # tRPC routers (post, comment, project, user, etc.)\n│   │   ├── root.ts             # Root tRPC router\n│   │   └── trpc.ts             # tRPC initialization and context\n│   ├── auth.ts                 # NextAuth full configuration\n│   ├── auth.config.ts          # Edge-compatible auth config (for middleware)\n│   └── db.ts                   # Prisma client singleton\n├── lib/\n│   ├── hooks/                  # Custom React hooks\n│   ├── trpc/                   # tRPC client, provider, and server caller\n│   ├── r2.ts                   # Cloudflare R2 upload utilities\n│   ├── utils.ts                # Shared utilities (cn, formatRelativeTime, pluralize)\n│   ├── validators.ts           # Zod validation schemas\n│   └── webhooks.ts             # Discord/Slack webhook helpers\n├── middleware.ts               # Auth middleware (Edge runtime)\n└── test/\n    └── setup.ts                # Vitest test setup\n```\n\n## Code Conventions\n\n### Imports\n\nUse the `~/` path alias which maps to `src/`:\n\n```tsx\nimport { Button } from \"~/components/ui/button\";\nimport { api } from \"~/lib/trpc/client\";\n```\n\n### Components\n\n- Use `\"use client\"` only for interactive components; keep server components as the default\n- Place shared UI primitives in `src/components/ui/` following shadcn/ui patterns\n- Feature-specific components go in their own folder (e.g. `src/components/feed/`)\n- Prefer named exports over default exports\n\n### Styling\n\n- Use Tailwind CSS classes for all styling\n- Use `cn()` from `~/lib/utils` for conditional class merging\n- Follow the existing shadcn/ui patterns for new components\n\n### TypeScript\n\n- Always type component props with interfaces\n- Use `unknown` for JSON data from the database (e.g. Lexical editor state)\n- Prefer explicit types over `any`\n\n### Data Fetching\n\nAll API calls go through tRPC:\n\n```tsx\nimport { api } from \"~/lib/trpc/client\";\n\n// Basic query\nconst { data } = api.post.getById.useQuery({ id: postId });\n\n// Infinite scroll\nconst { data, fetchNextPage, hasNextPage } = api.post.list.useInfiniteQuery(\n  { limit: 10 },\n  { getNextPageParam: (lastPage) => lastPage.nextCursor }\n);\nconst items = data?.pages.flatMap((page) => page.items) ?? [];\n```\n\n### Utilities\n\n- **Pluralization**: Always use `pluralize()` from `~/lib/utils` — never hardcode plural forms\n- **Dates**: Use `formatRelativeTime()` from `~/lib/utils` for relative timestamps\n- **R2 URLs**: Private file URLs need signing — use `api.upload.getDownloadUrl.useQuery()`\n\n## Testing\n\nWe use [Vitest](https://vitest.dev/) for unit tests and [Storybook](https://storybook.js.org/) for component development and visual testing.\n\n### Unit Tests\n\nTest files live alongside source files with a `.test.ts` or `.test.tsx` extension:\n\n```bash\n# Run tests in watch mode\nnpm test\n\n# Run tests once (CI)\nnpm run test:run\n```\n\n### Storybook\n\nStorybook stories live alongside components with a `.stories.tsx` extension. The Storybook setup includes:\n\n- **Vitest addon** — stories run as browser tests via Playwright\n- **a11y addon** — automated accessibility checks\n- **Docs addon** — auto-generated documentation from stories\n\n```bash\n# Start Storybook dev server\nnpm run storybook\n\n# Build static Storybook\nnpm run build-storybook\n```\n\nStories use the `~/` path alias and have access to the same theme/providers as the main app. See existing stories in `src/components/ui/` for examples.\n\n## Database\n\nThe database schema is managed with [Prisma](https://www.prisma.io/). The schema lives at `prisma/schema.prisma`.\n\n```bash\n# After changing the schema, create a migration\nnpm run db:migrate\n\n# Or push changes directly (useful during prototyping)\nnpm run db:push\n\n# Browse your data\nnpm run db:studio\n```\n\n## Making Changes\n\n1. Create a branch from `main`\n2. Make your changes\n3. Run `npm run lint` and `npm test` to verify nothing is broken\n4. Open a pull request\n\n## License\n\nBy contributing, you agree that your contributions will be licensed under the MIT License.\n",
        "truncated": false
      },
      {
        "path": "README.md",
        "size": 5065,
        "reason": "project readme",
        "content": "<img width=\"1280\" height=\"640\" alt=\"Draftboard logo\" src=\"https://github.com/user-attachments/assets/b68e931a-915b-4fe3-8894-bed44a6668cb\" />\n\n\n# Draftboard\n\n**Draftboard** is a shared space for teams to post designs, ideas, and work in progress. In distributed teams, meaningful work too often disappears into Slack threads or gets buried inside Figma, making it harder to learn from each other and keep ideas flowing. Draftboard brings that work back into the open with a lightweight, social feed that’s easy to deploy, pleasant to use, and flexible enough to fit into existing workflows.\n\n## Features\n\n- **Feed** — Reverse chronological feed of posts with list and grid views\n- **Rich Editor** — Lexical-based editor with markdown shortcuts, @mentions, slash commands, drag-and-drop, pasting and automatic draft saving.\n- **Attachments** — Images, videos, files, Figma links, and Loom recordings with a carousel viewer\n- **Projects** — Organize posts into projects with cover images, descriptions, and team members\n- **Comments** — Threaded comments with 2 levels of depth and attachment-specific comments\n- **Reactions** — Like, wow, cool reactions plus custom emoji support\n- **Notifications** — Notifications for comments, replies, mentions, and reactions\n- **Search** — Full-text search across posts, projects, and people\n- **Webhooks** — Optional Discord and Slack webhook integrations for new posts\n- **Admin** — User management, invite links, and site settings\n- **Dark Mode** — Full light/dark theme support\n- **Mobile PWA** — Fully mobile-optimized as a Progressive Web App, feels at home on iOS and Android home screens\n\n## Tech Stack\n\n- **Framework**: Next.js 15 (App Router, Turbopack)\n- **API**: tRPC v11 + React Query\n- **Database**: PostgreSQL with Prisma ORM\n- **Auth**: NextAuth.js v5 (Credentials provider, JWT sessions)\n- **Storage**: Cloudflare R2 (S3-compatible)\n- **UI**: shadcn/ui + Tailwind CSS v4\n- **Editor**: Lexical\n- **Testing**: Vitest + Storybook\n\n## Deploying to Vercel\n\nClick the button below to kickstart your deployment — it will clone the repo and prompt you for the required environment variables:\n\n[![Deploy with Vercel](https://vercel.com/button)](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fhrescak%2FDraftboard.git&env=DATABASE_URL,NEXTAUTH_SECRET,NEXTAUTH_URL,R2_ACCOUNT_ID,R2_ACCESS_KEY_ID,R2_SECRET_ACCESS_KEY,R2_BUCKET_NAME,R2_PUBLIC_URL&envDefaults=%7B%22NEXTAUTH_SECRET%22%3A%22generate-new-secret-locally%22%2C%22NEXTAUTH_URL%22%3A%22https%3A%2F%2F%24VERCEL_PROJECT_PRODUCTION_URL%22%2C%22R2_ACCOUNT_ID%22%3A%22your_cloudflare_account_id%22%2C%22R2_ACCESS_KEY_ID%22%3A%22your_r2_access_key_id%22%2C%22R2_BUCKET_NAME%22%3A%22your_bucket_name%22%2C%22R2_PUBLIC_URL%22%3A%22https%3A%2F%2Fyour_account_id.r2.cloudflarestorage.com%22%7D&envDescription=Deployment%20guide%20for%20Draftboard&envLink=https%3A%2F%2Fgithub.com%2Fhrescak%2FDraftboard%2Fblob%2Fmain%2Fdocs%2FDeployment-vercel.md&project-name=draftboard&repository-name=draftboard)\n\nFor the full walkthrough (database setup, R2 configuration, CORS, build settings), see the [Vercel deployment guide](docs/Deployment-vercel.md).\n\n## Self-Hosting\n\n### Prerequisites\n\n- A service that runs Node.js 18+ (e.g. [Vercel](https://vercel.com))\n- A PostgreSQL database ([Prisma Postgres](https://www.prisma.io/postgres), [Supabase](https://supabase.com), or [Neon](https://neon.tech))\n- S3-compatible storage ([Cloudflare R2](https://developers.cloudflare.com/r2/) or [AWS S3](https://aws.amazon.com/s3/))\n\n### 1. Clone and install\n\n```bash\ngit clone https://github.com/your-org/draftboard.git\ncd draftboard\nnpm install\n```\n\n### 2. Configure environment\n\n```bash\ncp .env.example .env\n```\n\nFill in your `.env` with the following:\n\n| Variable | Description |\n|---|---|\n| `DATABASE_URL` | PostgreSQL connection string |\n| `NEXTAUTH_SECRET` | Random secret for signing sessions (`openssl rand -base64 32`) |\n| `NEXTAUTH_URL` | Your deployment URL (e.g. `https://draftboard.yourcompany.com`) |\n| `R2_ACCOUNT_ID` | Cloudflare account ID |\n| `R2_ACCESS_KEY_ID` | R2 API key ID |\n| `R2_SECRET_ACCESS_KEY` | R2 API secret |\n| `R2_BUCKET_NAME` | R2 bucket name |\n| `R2_PUBLIC_URL` | Public URL for the R2 bucket |\n\n### 3. Set up the database\n\n```bash\nnpm run db:generate\nnpm run db:migrate\n```\n\n### 4. Start the app\n\n```bash\n# Development\nnpm run dev\n\n# Production\nnpm run build:prod\nnpm run start\n```\n\n\n\n## Contributing\n\nSee [CONTRIBUTING.md](CONTRIBUTING.md) for development setup, architecture details, and contribution guidelines.\n\n## License\n\nMIT\n\n## Ackgnowledgements\n\nThis tool stands on the shoulders of earlier tools like [Pixelcloud](https://engineering.fb.com/2011/02/15/web/hackathon-22-redesigning-pixelcloud/) and [Campsite](https://www.campsite.com/), which helped shape many of the ideas explored here. I’ve been fortunate to work closely with both—contributing to Pixelcloud during my time at Facebook and supporting Campsite as an investor—and this project carries forward lessons learned from each.\n",
        "truncated": false
      },
      {
        "path": "package.json",
        "size": 3044,
        "reason": "dependency manifest",
        "content": "{\n  \"name\": \"draftboard\",\n  \"version\": \"1.0.0\",\n  \"private\": true,\n  \"type\": \"module\",\n  \"scripts\": {\n    \"dev\": \"next dev --turbopack\",\n    \"build\": \"next build\",\n    \"build:prod\":\"prisma migrate deploy && next build\",\n    \"start\": \"next start\",\n    \"lint\": \"next lint\",\n    \"postinstall\": \"prisma generate\",\n    \"db:generate\": \"prisma generate\",\n    \"db:migrate\": \"prisma migrate dev\",\n    \"db:push\": \"prisma db push\",\n    \"db:studio\": \"prisma studio\",\n    \"test\": \"vitest\",\n    \"test:run\": \"vitest run\",\n    \"storybook\": \"storybook dev -p 6006\",\n    \"build-storybook\": \"storybook build\"\n  },\n  \"dependencies\": {\n    \"@aws-sdk/client-s3\": \"^3.975.0\",\n    \"@aws-sdk/s3-request-presigner\": \"^3.975.0\",\n    \"@lexical/code\": \"^0.31.2\",\n    \"@lexical/link\": \"^0.31.2\",\n    \"@lexical/list\": \"^0.31.2\",\n    \"@lexical/markdown\": \"^0.31.2\",\n    \"@lexical/react\": \"^0.31.2\",\n    \"@lexical/rich-text\": \"^0.31.2\",\n    \"@lexical/selection\": \"^0.31.2\",\n    \"@lexical/utils\": \"^0.31.2\",\n    \"@prisma/client\": \"^6.8.2\",\n    \"@radix-ui/react-avatar\": \"^1.1.11\",\n    \"@radix-ui/react-dialog\": \"^1.1.15\",\n    \"@radix-ui/react-dropdown-menu\": \"^2.1.16\",\n    \"@radix-ui/react-label\": \"^2.1.8\",\n    \"@radix-ui/react-popover\": \"^1.1.15\",\n    \"@radix-ui/react-slot\": \"^1.2.4\",\n    \"@radix-ui/react-switch\": \"^1.2.6\",\n    \"@radix-ui/react-tabs\": \"^1.1.13\",\n    \"@radix-ui/react-toast\": \"^1.2.15\",\n    \"@radix-ui/react-tooltip\": \"^1.2.8\",\n    \"@tanstack/react-query\": \"^5.80.7\",\n    \"@trpc/client\": \"^11.1.2\",\n    \"@trpc/react-query\": \"^11.1.2\",\n    \"@trpc/server\": \"^11.1.2\",\n    \"bcryptjs\": \"^3.0.2\",\n    \"class-variance-authority\": \"^0.7.1\",\n    \"clsx\": \"^2.1.1\",\n    \"cmdk\": \"^1.1.1\",\n    \"lexical\": \"^0.31.2\",\n    \"lucide-react\": \"^0.513.0\",\n    \"next\": \"^15.3.7\",\n    \"next-auth\": \"^5.0.0-beta.25\",\n    \"next-themes\": \"^0.4.6\",\n    \"react\": \"^19.1.0\",\n    \"react-dom\": \"^19.1.0\",\n    \"react-masonry-css\": \"^1.0.16\",\n    \"superjson\": \"^2.2.2\",\n    \"tailwind-merge\": \"^3.0.2\",\n    \"zod\": \"^3.25.30\"\n  },\n  \"devDependencies\": {\n    \"@tailwindcss/postcss\": \"^4.1.18\",\n    \"@testing-library/dom\": \"^10.4.0\",\n    \"@testing-library/react\": \"^16.3.0\",\n    \"@types/bcryptjs\": \"^2.4.6\",\n    \"@types/node\": \"^22.15.29\",\n    \"@types/react\": \"^19.1.8\",\n    \"@types/react-dom\": \"^19.1.6\",\n    \"@typescript-eslint/eslint-plugin\": \"^8.34.0\",\n    \"@typescript-eslint/parser\": \"^8.34.0\",\n    \"@vitejs/plugin-react\": \"^4.5.2\",\n    \"autoprefixer\": \"^10.4.21\",\n    \"eslint\": \"^9.29.0\",\n    \"eslint-config-next\": \"^15.3.7\",\n    \"jsdom\": \"^26.1.0\",\n    \"postcss\": \"^8.5.6\",\n    \"prisma\": \"^6.8.2\",\n    \"tailwindcss\": \"^4.1.18\",\n    \"typescript\": \"^5.8.3\",\n    \"vitest\": \"^3.2.4\",\n    \"storybook\": \"^10.2.6\",\n    \"@storybook/nextjs-vite\": \"^10.2.6\",\n    \"@chromatic-com/storybook\": \"^5.0.0\",\n    \"@storybook/addon-vitest\": \"^10.2.6\",\n    \"@storybook/addon-a11y\": \"^10.2.6\",\n    \"@storybook/addon-docs\": \"^10.2.6\",\n    \"@storybook/addon-onboarding\": \"^10.2.6\",\n    \"vite\": \"^7.3.1\",\n    \"playwright\": \"^1.58.1\",\n    \"@vitest/browser\": \"^3.2.4\",\n    \"@vitest/coverage-v8\": \"^3.2.4\"\n  }\n}\n",
        "truncated": false
      },
      {
        "path": "prisma/schema.prisma",
        "size": 6722,
        "reason": "database schema",
        "content": "generator client {\n  provider = \"prisma-client-js\"\n}\n\ndatasource db {\n  provider = \"postgresql\"\n  url      = env(\"DATABASE_URL\")\n}\n\nenum Role {\n  MEMBER\n  ADMIN\n  OWNER\n}\n\nenum AttachmentType {\n  IMAGE\n  VIDEO\n  FILE\n  FIGMA\n  LOOM\n}\n\nenum NotificationType {\n  COMMENT\n  COMMENT_REPLY\n  REACTION_POST\n  REACTION_COMMENT\n  MENTION\n}\n\nmodel User {\n  id            String    @id @default(cuid())\n  email         String    @unique\n  passwordHash  String\n  displayName   String\n  avatarUrl     String?\n  role          Role      @default(MEMBER)\n  deactivated   Boolean   @default(false)\n  createdAt     DateTime  @default(now())\n  updatedAt     DateTime  @updatedAt\n\n  posts         Post[]\n  comments      Comment[]\n  reactions     Reaction[]\n  notifications Notification[] @relation(\"UserNotifications\")\n  actedNotifications Notification[] @relation(\"ActorNotifications\")\n  projects      ProjectMember[]\n  customEmoji   CustomEmoji[]\n  drafts        Draft[]\n  passwordResetTokens PasswordResetToken[]\n}\n\nmodel Post {\n  id           String       @id @default(cuid())\n  title        String?\n  content      Json\n  liveUrl      String?\n  hideFromHome Boolean      @default(false)\n  authorId     String\n  createdAt    DateTime     @default(now())\n  updatedAt    DateTime     @updatedAt\n\n  author      User         @relation(fields: [authorId], references: [id], onDelete: Cascade)\n  attachments Attachment[]\n  comments    Comment[]\n  reactions   Reaction[]\n  projects    PostProject[]\n  notifications Notification[]\n\n  @@index([authorId])\n  @@index([createdAt])\n}\n\nmodel Attachment {\n  id           String          @id @default(cuid())\n  postId       String\n  type         AttachmentType\n  url          String\n  filename     String\n  mimeType     String\n  size         Int\n  width        Int?\n  height       Int?\n  thumbnailUrl String?\n  metadata     Json?\n  order        Int\n  createdAt    DateTime        @default(now())\n\n  post         Post            @relation(fields: [postId], references: [id], onDelete: Cascade)\n  comments     Comment[]\n\n  @@index([postId])\n}\n\nmodel Project {\n  id          String          @id @default(cuid())\n  name        String\n  description Json?\n  coverUrl    String?\n  createdAt   DateTime        @default(now())\n  updatedAt   DateTime        @updatedAt\n  createdById String\n\n  posts       PostProject[]\n  urls        ProjectUrl[]\n  members     ProjectMember[]\n\n  @@index([createdAt])\n}\n\nmodel PostProject {\n  postId    String\n  projectId String\n\n  post      Post    @relation(fields: [postId], references: [id], onDelete: Cascade)\n  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)\n\n  @@id([postId, projectId])\n}\n\nmodel ProjectUrl {\n  id        String  @id @default(cuid())\n  projectId String\n  title     String\n  url       String\n\n  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)\n\n  @@index([projectId])\n}\n\nmodel ProjectMember {\n  id        String   @id @default(cuid())\n  projectId String\n  userId    String\n  role      String   @default(\"MEMBER\")\n  createdAt DateTime @default(now())\n\n  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)\n  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)\n\n  @@unique([projectId, userId])\n}\n\nmodel Comment {\n  id           String    @id @default(cuid())\n  content      Json\n  authorId     String\n  postId       String\n  parentId     String?\n  attachmentId String?\n  coordinates  Json?\n  createdAt    DateTime  @default(now())\n  updatedAt    DateTime  @updatedAt\n\n  author       User      @relation(fields: [authorId], references: [id], onDelete: Cascade)\n  post         Post      @relation(fields: [postId], references: [id], onDelete: Cascade)\n  parent       Comment?  @relation(\"CommentReplies\", fields: [parentId], references: [id], onDelete: Cascade)\n  replies      Comment[] @relation(\"CommentReplies\")\n  attachment   Attachment? @relation(fields: [attachmentId], references: [id], onDelete: SetNull)\n  reactions    Reaction[]\n  notifications Notification[]\n\n  @@index([postId])\n  @@index([authorId])\n  @@index([parentId])\n  @@index([attachmentId])\n}\n\nmodel Reaction {\n  id        String   @id @default(cuid())\n  type      String\n  userId    String\n  postId    String?\n  commentId String?\n  createdAt DateTime @default(now())\n\n  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)\n  post      Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)\n  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)\n\n  @@unique([userId, postId, type])\n  @@unique([userId, commentId, type])\n  @@index([postId])\n  @@index([commentId])\n}\n\nmodel CustomEmoji {\n  id        String   @id @default(cuid())\n  name      String   @unique\n  imageUrl  String\n  createdBy String\n  createdAt DateTime @default(now())\n\n  creator   User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)\n}\n\nmodel Notification {\n  id        String           @id @default(cuid())\n  type      NotificationType\n  userId    String\n  actorId   String\n  postId    String?\n  commentId String?\n  read      Boolean          @default(false)\n  createdAt DateTime         @default(now())\n\n  user      User             @relation(\"UserNotifications\", fields: [userId], references: [id], onDelete: Cascade)\n  actor     User             @relation(\"ActorNotifications\", fields: [actorId], references: [id], onDelete: Cascade)\n  post      Post?            @relation(fields: [postId], references: [id], onDelete: Cascade)\n  comment   Comment?         @relation(fields: [commentId], references: [id], onDelete: Cascade)\n\n  @@index([userId])\n  @@index([createdAt])\n}\n\nmodel SiteSettings {\n  id                 String   @id @default(\"default\")\n  inviteToken        String   @unique @default(cuid())\n  siteName           String   @default(\"Draftboard\")\n  discordWebhookUrl  String?\n  slackWebhookUrl    String?\n  createdAt          DateTime @default(now())\n  updatedAt          DateTime @updatedAt\n}\n\nmodel Draft {\n  id          String   @id @default(cuid())\n  title       String?\n  content     Json?\n  liveUrl     String?\n  authorId    String\n  projectIds  String[] @default([])\n  createdAt   DateTime @default(now())\n  updatedAt   DateTime @updatedAt\n\n  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)\n\n  @@index([authorId])\n  @@index([updatedAt])\n}\n\nmodel PasswordResetToken {\n  id        String    @id @default(cuid())\n  userId    String\n  expiresAt DateTime\n  usedAt    DateTime?\n  createdAt DateTime  @default(now())\n\n  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)\n\n  @@index([userId])\n}\n",
        "truncated": false
      },
      {
        "path": "src/app/globals.css",
        "size": 3150,
        "reason": "global styles",
        "content": "@import \"tailwindcss\";\n\n@theme {\n  --font-sans: \"Inter\", ui-sans-serif, system-ui, sans-serif;\n  --font-mono: \"JetBrains Mono\", ui-monospace, monospace;\n\n  /* Draftboard color palette - Warm, creative aesthetic */\n  /* Light mode colors (default) */\n  --color-background: #faf9f7;\n  --color-foreground: #1a1918;\n  --color-card: #ffffff;\n  --color-card-foreground: #1a1918;\n  --color-popover: #ffffff;\n  --color-popover-foreground: #1a1918;\n  --color-primary: #1a1918;\n  --color-primary-foreground: #ffffff;\n  --color-secondary: #f5f0eb;\n  --color-secondary-foreground: #1a1918;\n  --color-muted: #f0ebe5;\n  --color-muted-foreground: #6b6966;\n  --color-accent: #1a1918;\n  --color-accent-foreground: #ffffff;\n  --color-destructive: #dc2626;\n  --color-destructive-foreground: #ffffff;\n  --color-border: #e5e0da;\n  --color-input: #e5e0da;\n  --color-ring: #1a1918;\n\n  --radius-sm: 0.375rem;\n  --radius-md: 0.5rem;\n  --radius-lg: 0.75rem;\n  --radius-xl: 1rem;\n}\n\n/* Dark mode - applied via .dark class on html element */\n:root.dark {\n  --color-background: #0f0e0d;\n  --color-foreground: #f5f4f2;\n  --color-card: #1a1918;\n  --color-card-foreground: #f5f4f2;\n  --color-popover: #1a1918;\n  --color-popover-foreground: #f5f4f2;\n  --color-primary: #f5f4f2;\n  --color-primary-foreground: #0f0e0d;\n  --color-secondary: #262422;\n  --color-secondary-foreground: #f5f4f2;\n  --color-muted: #262422;\n  --color-muted-foreground: #a8a5a0;\n  --color-accent: #f5f4f2;\n  --color-accent-foreground: #0f0e0d;\n  --color-destructive: #ef4444;\n  --color-destructive-foreground: #f5f4f2;\n  --color-border: #2e2c2a;\n  --color-input: #2e2c2a;\n  --color-ring: #f5f4f2;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply bg-background text-foreground antialiased;\n  }\n}\n\n/* Custom scrollbar */\n@layer utilities {\n  .scrollbar-thin {\n    scrollbar-width: thin;\n    scrollbar-color: var(--color-muted) transparent;\n  }\n\n  .scrollbar-thin::-webkit-scrollbar {\n    width: 6px;\n    height: 6px;\n  }\n\n  .scrollbar-thin::-webkit-scrollbar-track {\n    background: transparent;\n  }\n\n  .scrollbar-thin::-webkit-scrollbar-thumb {\n    background: var(--color-muted);\n    border-radius: 3px;\n  }\n}\n\n/* Lexical editor styles */\n.editor-container {\n  @apply relative min-h-[200px] rounded-lg border border-input bg-background;\n}\n\n.editor-input {\n  @apply min-h-[200px] p-4 outline-none;\n}\n\n.editor-placeholder {\n  @apply pointer-events-none absolute left-4 top-4 select-none text-muted-foreground/50;\n}\n\n/* Selectable decorator nodes (images, attachments) */\n.editor-image,\n.editor-attachment {\n  @apply relative cursor-pointer;\n}\n\n.editor-image:focus,\n.editor-attachment:focus,\n.editor-image.selected,\n.editor-attachment.selected {\n  @apply outline-2 outline-primary outline-offset-2 outline;\n}\n\n/* Mention styles */\n.mention {\n  @apply rounded bg-primary/10 px-1 py-0.5 font-semibold text-primary no-underline;\n}\n\n.mention:hover {\n  @apply bg-primary/20;\n}\n\n/* Ensure mentions are clickable and look like links */\na.mention {\n  @apply cursor-pointer;\n}\n\n/* Code block styles */\n.editor-code {\n  @apply my-2 block overflow-x-auto rounded-md bg-muted p-4 font-mono text-sm;\n}\n",
        "truncated": false
      },
      {
        "path": "tsconfig.json",
        "size": 602,
        "reason": "config signal",
        "content": "{\n  \"compilerOptions\": {\n    \"target\": \"ES2017\",\n    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n    \"allowJs\": true,\n    \"skipLibCheck\": true,\n    \"strict\": true,\n    \"noEmit\": true,\n    \"esModuleInterop\": true,\n    \"module\": \"esnext\",\n    \"moduleResolution\": \"bundler\",\n    \"resolveJsonModule\": true,\n    \"isolatedModules\": true,\n    \"jsx\": \"preserve\",\n    \"incremental\": true,\n    \"plugins\": [\n      {\n        \"name\": \"next\"\n      }\n    ],\n    \"paths\": {\n      \"~/*\": [\"./src/*\"]\n    }\n  },\n  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n  \"exclude\": [\"node_modules\"]\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/layout/main-nav.tsx",
        "size": 18895,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport Link from \"next/link\";\nimport { usePathname } from \"next/navigation\";\nimport { cn } from \"~/lib/utils\";\nimport { Home, FolderOpen, Bell, Plus, Settings, User, Shield, FileText, Search, LogOut } from \"lucide-react\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipTrigger,\n} from \"~/components/ui/tooltip\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { Logo } from \"~/components/ui/logo\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"~/components/ui/popover\";\nimport { signOut } from \"next-auth/react\";\nimport { api } from \"~/lib/trpc/client\";\nimport { useState } from \"react\";\nimport { SearchCommand } from \"~/components/search/SearchCommand\";\n\n// Thumbnail component with error handling for draft images\nfunction DraftThumbnail({ url }: { url: string | null }) {\n  const [hasError, setHasError] = useState(false);\n\n  if (!url || hasError) {\n    return (\n      <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded bg-muted\">\n        <FileText className=\"h-4 w-4 text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-8 w-8 shrink-0 overflow-hidden rounded bg-muted\">\n      {/* eslint-disable-next-line @next/next/no-img-element */}\n      <img\n        src={url}\n        alt=\"\"\n        className=\"h-full w-full object-cover\"\n        onError={() => setHasError(true)}\n      />\n    </div>\n  );\n}\n\nconst navItemsBeforeSearch = [\n  { href: \"/\", label: \"Home\", icon: Home },\n  { href: \"/projects\", label: \"Projects\", icon: FolderOpen },\n];\n\nconst navItemsAfterSearch = [\n  { href: \"/notifications\", label: \"Notifications\", icon: Bell },\n];\n\nconst mobileNavItemsBeforeSearch = [\n  { href: \"/\", label: \"Home\", icon: Home },\n  { href: \"/projects\", label: \"Projects\", icon: FolderOpen },\n];\n\nconst mobileNavItemsAfterSearch = [\n  { href: \"/notifications\", label: \"Notifications\", icon: Bell },\n];\n\ninterface MainNavProps {\n  user: {\n    id: string;\n    name: string;\n    email: string;\n    image?: string | null;\n    role: \"MEMBER\" | \"ADMIN\" | \"OWNER\";\n  };\n}\n\nexport function MainNav({ user }: MainNavProps) {\n  const pathname = usePathname();\n  const [composeOpen, setComposeOpen] = useState(false);\n  const [searchOpen, setSearchOpen] = useState(false);\n\n  // Fetch current user data to get fresh avatar URL (session may be stale)\n  const { data: currentUser } = api.user.me.useQuery();\n\n  // Fetch unread notification count\n  const { data: unreadCount } = api.notification.unreadCount.useQuery();\n  \n  // Hide badge when on notifications page\n  const isOnNotifications = pathname === \"/notifications\";\n  const showNotificationBadge = !isOnNotifications && (unreadCount ?? 0) > 0;\n\n  // Use fresh avatar from API if available, otherwise fall back to session\n  const avatarUrl = currentUser?.avatarUrl ?? user.image;\n\n  // Always fetch drafts to know whether to show popover or direct link\n  const { data: drafts, error: draftsError } = api.draft.list.useQuery();\n\n  // Log error for debugging\n  if (draftsError) {\n    console.error(\"Failed to fetch drafts:\", draftsError.message);\n  }\n\n  const hasDrafts = drafts && drafts.length > 0;\n\n  // Helper to format relative time\n  const formatRelativeTime = (date: Date) => {\n    const now = new Date();\n    const diff = now.getTime() - new Date(date).getTime();\n    const minutes = Math.floor(diff / 60000);\n    const hours = Math.floor(diff / 3600000);\n    const days = Math.floor(diff / 86400000);\n\n    if (minutes < 1) return \"Just now\";\n    if (minutes < 60) return `${minutes}m ago`;\n    if (hours < 24) return `${hours}h ago`;\n    return `${days}d ago`;\n  };\n\n  // Get display info for a draft\n  const getDraftDisplayInfo = (draft: {\n    id: string;\n    title: string | null;\n    preview: string | null;\n    firstImageUrl: string | null;\n    updatedAt: Date;\n  }) => {\n    if (draft.title) return draft.title;\n    if (draft.preview) return draft.preview.slice(0, 40) + (draft.preview.length > 40 ? \"...\" : \"\");\n    return \"Untitled draft\";\n  };\n\n  return (\n    <>\n      {/* Desktop Sidebar - hidden on mobile */}\n      <aside className=\"fixed left-0 top-0 z-50 hidden h-screen w-16 flex-col bg-background sm:flex\">\n        {/* Logo at top - aligned with content header */}\n        <div className=\"flex items-start justify-center pt-4\">\n          <Link href=\"/\" className=\"text-foreground transition-transform hover:scale-105\">\n            <Logo width={30} height={30} />\n          </Link>\n        </div>\n\n        {/* Centered navigation items */}\n        <nav className=\"flex flex-1 flex-col items-center justify-center gap-1\">\n          {navItemsBeforeSearch.map((item) => {\n            const isActive =\n              pathname === item.href ||\n              (item.href !== \"/\" && pathname.startsWith(item.href));\n            const Icon = item.icon;\n\n            return (\n              <Tooltip key={item.href} delayDuration={0}>\n                <TooltipTrigger asChild>\n                  <Link\n                    href={item.href}\n                    className={cn(\n                      \"flex h-12 w-12 items-center justify-center rounded-xl transition-colors\",\n                      isActive\n                        ? \"bg-secondary text-foreground\"\n                        : \"text-muted-foreground hover:bg-secondary/50 hover:text-foreground\"\n                    )}\n                  >\n                    <Icon className=\"h-6 w-6\" />\n                  </Link>\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">\n                  {item.label}\n                </TooltipContent>\n              </Tooltip>\n            );\n          })}\n\n          {/* Search button - after Projects */}\n          <Tooltip delayDuration={0}>\n            <TooltipTrigger asChild>\n              <button\n                onClick={() => setSearchOpen(true)}\n                className=\"flex h-12 w-12 items-center justify-center rounded-xl text-muted-foreground transition-colors hover:bg-secondary/50 hover:text-foreground\"\n              >\n                <Search className=\"h-6 w-6\" />\n              </button>\n            </TooltipTrigger>\n            <TooltipContent side=\"right\">\n              Search\n              <kbd className=\"ml-2 pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground\">\n                <span className=\"text-xs\">⌘</span>K\n              </kbd>\n            </TooltipContent>\n          </Tooltip>\n\n          {navItemsAfterSearch.map((item) => {\n            const isActive =\n              pathname === item.href ||\n              (item.href !== \"/\" && pathname.startsWith(item.href));\n            const Icon = item.icon;\n            const isNotifications = item.href === \"/notifications\";\n\n            return (\n              <Tooltip key={item.href} delayDuration={0}>\n                <TooltipTrigger asChild>\n                  <Link\n                    href={item.href}\n                    className={cn(\n                      \"relative flex h-12 w-12 items-center justify-center rounded-xl transition-colors\",\n                      isActive\n                        ? \"bg-secondary text-foreground\"\n                        : \"text-muted-foreground hover:bg-secondary/50 hover:text-foreground\"\n                    )}\n                  >\n                    <Icon className=\"h-6 w-6\" />\n                    {isNotifications && showNotificationBadge && (\n                      <span className=\"absolute right-1.5 top-1.5 flex h-4 min-w-4 items-center justify-center rounded-full bg-blue-500 px-1 text-[10px] font-medium text-white\">\n                        {(unreadCount ?? 0) > 99 ? \"99+\" : unreadCount}\n                      </span>\n                    )}\n                  </Link>\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">\n                  {item.label}\n                </TooltipContent>\n              </Tooltip>\n            );\n          })}\n\n          {/* Compose button - direct link if no drafts, popover if drafts exist */}\n          {hasDrafts ? (\n            <Popover open={composeOpen} onOpenChange={setComposeOpen}>\n              <Tooltip delayDuration={0}>\n                <TooltipTrigger asChild>\n                  <PopoverTrigger asChild>\n                    <button\n                      className={cn(\n                        \"flex h-12 w-12 items-center justify-center rounded-xl transition-colors hover:bg-secondary/50 hover:text-foreground\",\n                        composeOpen ? \"bg-secondary text-foreground\" : \"text-muted-foreground\"\n                      )}\n                    >\n                      <Plus className=\"h-6 w-6\" />\n                    </button>\n                  </PopoverTrigger>\n                </TooltipTrigger>\n                <TooltipContent side=\"right\">New Post</TooltipContent>\n              </Tooltip>\n              <PopoverContent side=\"right\" align=\"start\" className=\"w-72 p-0\">\n                <div className=\"p-2\">\n                  <Link\n                    href=\"/compose\"\n                    onClick={() => setComposeOpen(false)}\n                    className=\"flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm font-medium hover:bg-secondary\"\n                  >\n                    <Plus className=\"h-4 w-4\" />\n                    New post\n                  </Link>\n                </div>\n                <div className=\"border-t\" />\n                <div className=\"p-2\">\n                  <p className=\"px-3 py-1.5 text-xs font-medium text-muted-foreground\">\n                    Drafts\n                  </p>\n                  <div className=\"space-y-0.5\">\n                    {drafts.map((draft) => (\n                      <Link\n                        key={draft.id}\n                        href={`/compose?draft=${draft.id}`}\n                        onClick={() => setComposeOpen(false)}\n                        className=\"flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm hover:bg-secondary\"\n                      >\n                        <DraftThumbnail url={draft.firstImageUrl} />\n                        <div className=\"flex-1 overflow-hidden\">\n                          <p className=\"truncate font-medium\">\n                            {getDraftDisplayInfo(draft)}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {formatRelativeTime(draft.updatedAt)}\n                          </p>\n                        </div>\n                      </Link>\n                    ))}\n                  </div>\n                </div>\n              </PopoverContent>\n            </Popover>\n          ) : (\n            <Tooltip delayDuration={0}>\n              <TooltipTrigger asChild>\n                <Link\n                  href=\"/compose\"\n                  className=\"flex h-12 w-12 items-center justify-center rounded-xl text-muted-foreground transition-colors hover:bg-secondary/50 hover:text-foreground\"\n                >\n                  <Plus className=\"h-6 w-6\" />\n                </Link>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\">New Post</TooltipContent>\n            </Tooltip>\n          )}\n        </nav>\n\n        {/* Profile at bottom */}\n        <div className=\"flex flex-col items-center gap-1 pb-4\">\n          <DropdownMenu>\n            <Tooltip delayDuration={0}>\n              <TooltipTrigger asChild>\n                <DropdownMenuTrigger asChild>\n                  <button className=\"flex h-12 w-12 items-center justify-center rounded-xl transition-colors cursor-pointer hover:bg-secondary/50\">\n                    <UserAvatar avatarUrl={avatarUrl} name={user.name} className=\"h-8 w-8\" />\n                  </button>\n                </DropdownMenuTrigger>\n              </TooltipTrigger>\n              <TooltipContent side=\"right\">Profile</TooltipContent>\n            </Tooltip>\n            <DropdownMenuContent side=\"right\" align=\"end\" className=\"w-56\">\n              <DropdownMenuLabel className=\"font-normal\">\n                <div className=\"flex flex-col space-y-1\">\n                  <p className=\"text-sm font-medium leading-none\">{user.name}</p>\n                  <p className=\"text-xs leading-none text-muted-foreground\">\n                    {user.email}\n                  </p>\n                </div>\n              </DropdownMenuLabel>\n              <DropdownMenuSeparator />\n              <DropdownMenuItem asChild>\n                <Link href={`/user/${user.id}`}>\n                  <User className=\"mr-2 h-4 w-4\" />\n                  View Profile\n                </Link>\n              </DropdownMenuItem>\n              <DropdownMenuItem asChild>\n                <Link href=\"/settings\">\n                  <Settings className=\"mr-2 h-4 w-4\" />\n                  Settings\n                </Link>\n              </DropdownMenuItem>\n              {(user.role === \"ADMIN\" || user.role === \"OWNER\") && (\n                <DropdownMenuItem asChild>\n                  <Link href=\"/admin/settings\">\n                    <Shield className=\"mr-2 h-4 w-4\" />\n                    Site Admin\n                  </Link>\n                </DropdownMenuItem>\n              )}\n              <DropdownMenuSeparator />\n              <DropdownMenuItem\n                className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\"\n                onClick={() => signOut({ callbackUrl: \"/sign-in\" })}\n              >\n                <LogOut className=\"mr-2 h-4 w-4\" />\n                Sign out\n              </DropdownMenuItem>\n            </DropdownMenuContent>\n          </DropdownMenu>\n        </div>\n      </aside>\n\n      {/* Search Command Dialog */}\n      <SearchCommand open={searchOpen} onOpenChange={setSearchOpen} />\n\n      {/* Mobile Bottom Tab Bar - shown only on mobile */}\n      <nav className=\"fixed bottom-0 left-0 right-0 z-50 flex h-16 items-center justify-around border-t bg-background px-2 sm:hidden\">\n        {mobileNavItemsBeforeSearch.map((item) => {\n          const isActive =\n            pathname === item.href ||\n            (item.href !== \"/\" && pathname.startsWith(item.href));\n          const Icon = item.icon;\n\n          return (\n            <Link\n              key={item.href}\n              href={item.href}\n              className={cn(\n                \"flex h-12 w-12 flex-col items-center justify-center rounded-xl transition-colors\",\n                isActive\n                  ? \"text-foreground\"\n                  : \"text-muted-foreground\"\n              )}\n            >\n              <Icon className=\"h-6 w-6\" />\n            </Link>\n          );\n        })}\n\n        {/* Mobile Search button - after Projects */}\n        <button\n          onClick={() => setSearchOpen(true)}\n          className=\"flex h-12 w-12 flex-col items-center justify-center rounded-xl text-muted-foreground transition-colors\"\n        >\n          <Search className=\"h-6 w-6\" />\n        </button>\n\n        {mobileNavItemsAfterSearch.map((item) => {\n          const isActive =\n            pathname === item.href ||\n            (item.href !== \"/\" && pathname.startsWith(item.href));\n          const Icon = item.icon;\n          const isNotifications = item.href === \"/notifications\";\n\n          return (\n            <Link\n              key={item.href}\n              href={item.href}\n              className={cn(\n                \"relative flex h-12 w-12 flex-col items-center justify-center rounded-xl transition-colors\",\n                isActive\n                  ? \"text-foreground\"\n                  : \"text-muted-foreground\"\n              )}\n            >\n              <Icon className=\"h-6 w-6\" />\n              {isNotifications && showNotificationBadge && (\n                <span className=\"absolute right-0 top-0 flex h-4 min-w-4 items-center justify-center rounded-full bg-blue-500 px-1 text-[10px] font-medium text-white\">\n                  {(unreadCount ?? 0) > 99 ? \"99+\" : unreadCount}\n                </span>\n              )}\n            </Link>\n          );\n        })}\n\n        {/* Mobile Compose button - direct link if no drafts, popover if drafts exist */}\n        {hasDrafts ? (\n          <Popover>\n            <PopoverTrigger asChild>\n              <button className=\"flex h-12 w-12 flex-col items-center justify-center rounded-xl text-muted-foreground transition-colors\">\n                <Plus className=\"h-6 w-6\" />\n              </button>\n            </PopoverTrigger>\n            <PopoverContent side=\"top\" align=\"center\" className=\"w-72 p-0\">\n              <div className=\"p-2\">\n                <Link\n                  href=\"/compose\"\n                  className=\"flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm font-medium hover:bg-secondary\"\n                >\n                  <Plus className=\"h-4 w-4\" />\n                  New post\n                </Link>\n              </div>\n              <div className=\"border-t\" />\n              <div className=\"max-h-64 overflow-y-auto p-2\">\n                <p className=\"px-3 py-1.5 text-xs font-medium text-muted-foreground\">\n                  Drafts\n                </p>\n                <div className=\"space-y-0.5\">\n                  {drafts.map((draft) => (\n                    <Link\n                      key={draft.id}\n                      href={`/compose?draft=${draft.id}`}\n                      className=\"flex w-full items-center gap-3 rounded-md px-3 py-2 text-sm hover:bg-secondary\"\n                    >\n                      <DraftThumbnail url={draft.firstImageUrl} />\n                      <div className=\"flex-1 overflow-hidden\">\n                        <p className=\"truncate font-medium\">\n                          {getDraftDisplayInfo(draft)}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          {formatRelativeTime(draft.updatedAt)}\n                        </p>\n                      </div>\n                    </Link>\n                  ))}\n                </div>\n              </div>\n            </PopoverContent>\n          </Popover>\n        ) : (\n          <Link\n            href=\"/compose\"\n            className=\"flex h-12 w-12 flex-col items-center justify-center rounded-xl text-muted-foreground transition-colors\"\n          >\n            <Plus className=\"h-6 w-6\" />\n          </Link>\n        )}\n\n        {/* Profile tab */}\n        <Link\n          href={`/user/${user.id}`}\n          className={cn(\n            \"flex h-12 w-12 flex-col items-center justify-center rounded-xl transition-colors\",\n            pathname.startsWith(\"/user/\")\n              ? \"text-foreground\"\n              : \"text-muted-foreground\"\n          )}\n        >\n          <User className=\"h-6 w-6\" />\n        </Link>\n      </nav>\n    </>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/app/(main)/admin/settings/page.tsx",
        "size": 17812,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { Button } from \"~/components/ui/button\";\nimport { Input } from \"~/components/ui/input\";\nimport { Label } from \"~/components/ui/label\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"~/components/ui/card\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Loader2, Copy, RefreshCw, Check, Trash2, Plus, CheckCircle2, XCircle } from \"lucide-react\";\nimport { EmojiUpload, EmojiImage } from \"~/components/settings/EmojiUpload\";\n\nexport default function AdminSettingsPage() {\n  const [copied, setCopied] = useState(false);\n  const utils = api.useUtils();\n\n  const { data: settings, isLoading } = api.site.getSettings.useQuery();\n\n  const regenerateMutation = api.site.regenerateInvite.useMutation({\n    onSuccess: () => {\n      utils.site.getSettings.invalidate();\n    },\n  });\n\n  const updateMutation = api.site.updateSettings.useMutation({\n    onSuccess: () => {\n      utils.site.getSettings.invalidate();\n    },\n  });\n\n  const inviteUrl = settings\n    ? `${typeof window !== \"undefined\" ? window.location.origin : \"\"}/invite/${settings.inviteToken}`\n    : \"\";\n\n  const copyInviteLink = async () => {\n    await navigator.clipboard.writeText(inviteUrl);\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center py-8\">\n        <Loader2 className=\"h-6 w-6 animate-spin\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Invite Link</CardTitle>\n          <CardDescription>\n            Share this link with people you want to invite to Draftboard.\n            Anyone with this link can create an account.\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"inviteLink\">Invite URL</Label>\n            <div className=\"flex gap-2\">\n              <Input\n                id=\"inviteLink\"\n                value={inviteUrl}\n                readOnly\n                className=\"font-mono text-sm\"\n              />\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                onClick={copyInviteLink}\n                title=\"Copy invite link\"\n              >\n                {copied ? (\n                  <Check className=\"h-4 w-4 text-green-500\" />\n                ) : (\n                  <Copy className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n          </div>\n          <div className=\"flex items-center gap-4\">\n            <Button\n              variant=\"outline\"\n              onClick={() => regenerateMutation.mutate()}\n              disabled={regenerateMutation.isPending}\n            >\n              {regenerateMutation.isPending ? (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              ) : (\n                <RefreshCw className=\"mr-2 h-4 w-4\" />\n              )}\n              Regenerate Link\n            </Button>\n            <p className=\"text-sm text-muted-foreground\">\n              Regenerating will invalidate the current link.\n            </p>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Site Settings</CardTitle>\n          <CardDescription>\n            Configure your Draftboard instance.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <SiteNameForm \n            currentName={settings?.siteName || \"Draftboard\"} \n            onSave={(siteName) => updateMutation.mutate({ siteName })}\n            isPending={updateMutation.isPending}\n          />\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Custom Emoji</CardTitle>\n          <CardDescription>\n            Add custom emoji that can be used as reactions throughout Draftboard.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <CustomEmojiSection />\n        </CardContent>\n      </Card>\n\n      <IntegrationsSettings />\n    </div>\n  );\n}\n\nfunction SiteNameForm({\n  currentName,\n  onSave,\n  isPending,\n}: {\n  currentName: string;\n  onSave: (name: string) => void;\n  isPending: boolean;\n}) {\n  const [siteName, setSiteName] = useState(currentName);\n\n  return (\n    <form\n      onSubmit={(e) => {\n        e.preventDefault();\n        onSave(siteName);\n      }}\n      className=\"space-y-4\"\n    >\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"siteName\">Site Name</Label>\n        <Input\n          id=\"siteName\"\n          value={siteName}\n          onChange={(e) => setSiteName(e.target.value)}\n          placeholder=\"Draftboard\"\n        />\n      </div>\n      <Button type=\"submit\" disabled={isPending || siteName === currentName}>\n        {isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n        Save Changes\n      </Button>\n    </form>\n  );\n}\n\nfunction CustomEmojiSection() {\n  const [isAdding, setIsAdding] = useState(false);\n  const [newEmojiName, setNewEmojiName] = useState(\"\");\n  const [newEmojiUrl, setNewEmojiUrl] = useState<string | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const utils = api.useUtils();\n\n  const { data: emojis, isLoading } = api.reaction.listEmoji.useQuery();\n\n  const createMutation = api.reaction.createEmoji.useMutation({\n    onSuccess: () => {\n      utils.reaction.listEmoji.invalidate();\n      setIsAdding(false);\n      setNewEmojiName(\"\");\n      setNewEmojiUrl(null);\n      setError(null);\n    },\n    onError: (err) => {\n      setError(err.message);\n    },\n  });\n\n  const deleteMutation = api.reaction.deleteEmoji.useMutation({\n    onSuccess: () => {\n      utils.reaction.listEmoji.invalidate();\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!newEmojiName || !newEmojiUrl) {\n      setError(\"Please provide both a name and an image\");\n      return;\n    }\n    if (!/^[a-z0-9_]+$/.test(newEmojiName)) {\n      setError(\"Name can only contain lowercase letters, numbers, and underscores\");\n      return;\n    }\n    createMutation.mutate({ name: newEmojiName, imageUrl: newEmojiUrl });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center py-4\">\n        <Loader2 className=\"h-5 w-5 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      {emojis && emojis.length > 0 && (\n        <div className=\"space-y-2\">\n          <Label>Current Emoji</Label>\n          <div className=\"flex flex-wrap gap-2\">\n            {emojis.map((emoji) => (\n              <div\n                key={emoji.id}\n                className=\"group flex items-center gap-2 rounded-md border bg-muted/50 px-2 py-1\"\n              >\n                <EmojiImage url={emoji.imageUrl} alt={emoji.name} className=\"h-6 w-6\" />\n                <span className=\"text-sm\">:{emoji.name}:</span>\n                <Button\n                  variant=\"ghost\"\n                  size=\"icon\"\n                  className=\"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity\"\n                  onClick={() => deleteMutation.mutate({ id: emoji.id })}\n                  disabled={deleteMutation.isPending}\n                >\n                  <Trash2 className=\"h-3 w-3 text-muted-foreground hover:text-destructive\" />\n                </Button>\n              </div>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {isAdding ? (\n        <form onSubmit={handleSubmit} className=\"space-y-4 rounded-lg border p-4\">\n          <div className=\"flex items-start gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Image</Label>\n              <EmojiUpload value={newEmojiUrl} onChange={setNewEmojiUrl} />\n            </div>\n            <div className=\"flex-1 space-y-2\">\n              <Label htmlFor=\"emojiName\">Name</Label>\n              <Input\n                id=\"emojiName\"\n                value={newEmojiName}\n                onChange={(e) => setNewEmojiName(e.target.value.toLowerCase())}\n                placeholder=\"my_emoji\"\n                pattern=\"^[a-z0-9_]+$\"\n              />\n              <p className=\"text-xs text-muted-foreground\">\n                Lowercase letters, numbers, and underscores only\n              </p>\n            </div>\n          </div>\n          {error && <p className=\"text-sm text-destructive\">{error}</p>}\n          <div className=\"flex gap-2\">\n            <Button type=\"submit\" disabled={createMutation.isPending}>\n              {createMutation.isPending && (\n                <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n              )}\n              Add Emoji\n            </Button>\n            <Button\n              type=\"button\"\n              variant=\"outline\"\n              onClick={() => {\n                setIsAdding(false);\n                setNewEmojiName(\"\");\n                setNewEmojiUrl(null);\n                setError(null);\n              }}\n            >\n              Cancel\n            </Button>\n          </div>\n        </form>\n      ) : (\n        <Button variant=\"outline\" onClick={() => setIsAdding(true)}>\n          <Plus className=\"mr-2 h-4 w-4\" />\n          Add Custom Emoji\n        </Button>\n      )}\n    </div>\n  );\n}\n\nfunction IntegrationsSettings() {\n  const { data: settings, isLoading } = api.site.getSettings.useQuery();\n  const [discordUrl, setDiscordUrl] = useState(\"\");\n  const [slackUrl, setSlackUrl] = useState(\"\");\n  const [discordTestResult, setDiscordTestResult] = useState<{ success: boolean; error?: string } | null>(null);\n  const [slackTestResult, setSlackTestResult] = useState<{ success: boolean; error?: string } | null>(null);\n\n  const utils = api.useUtils();\n\n  // Initialize form values when settings load\n  useEffect(() => {\n    if (settings) {\n      setDiscordUrl(settings.discordWebhookUrl || \"\");\n      setSlackUrl(settings.slackWebhookUrl || \"\");\n    }\n  }, [settings]);\n\n  const updateMutation = api.site.updateWebhooks.useMutation({\n    onSuccess: () => {\n      utils.site.getSettings.invalidate();\n    },\n  });\n\n  const testMutation = api.site.testWebhook.useMutation();\n\n  const handleSave = (e: React.FormEvent) => {\n    e.preventDefault();\n    setDiscordTestResult(null);\n    setSlackTestResult(null);\n    updateMutation.mutate({\n      discordWebhookUrl: discordUrl,\n      slackWebhookUrl: slackUrl,\n    });\n  };\n\n  const handleTestDiscord = async () => {\n    if (!discordUrl) return;\n    setDiscordTestResult(null);\n    const result = await testMutation.mutateAsync({ type: \"discord\", url: discordUrl });\n    setDiscordTestResult(result);\n  };\n\n  const handleTestSlack = async () => {\n    if (!slackUrl) return;\n    setSlackTestResult(null);\n    const result = await testMutation.mutateAsync({ type: \"slack\", url: slackUrl });\n    setSlackTestResult(result);\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardContent className=\"py-8\">\n          <div className=\"flex justify-center\">\n            <Loader2 className=\"h-6 w-6 animate-spin\" />\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Integrations</CardTitle>\n        <CardDescription>\n          Configure webhook notifications to send new post alerts to Discord and Slack channels.\n        </CardDescription>\n      </CardHeader>\n      <CardContent>\n        <form onSubmit={handleSave} className=\"space-y-6\">\n          {/* Discord Webhook */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <svg className=\"h-5 w-5\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                <path d=\"M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z\"/>\n              </svg>\n              <Label htmlFor=\"discord-webhook\">Discord Webhook URL</Label>\n            </div>\n            <div className=\"flex gap-2\">\n              <Input\n                id=\"discord-webhook\"\n                type=\"url\"\n                placeholder=\"https://discord.com/api/webhooks/...\"\n                value={discordUrl}\n                onChange={(e) => setDiscordUrl(e.target.value)}\n                className=\"flex-1\"\n              />\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={handleTestDiscord}\n                disabled={!discordUrl || testMutation.isPending}\n              >\n                {testMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                ) : (\n                  \"Test\"\n                )}\n              </Button>\n            </div>\n            {discordTestResult && (\n              <div className={`flex items-center gap-2 text-sm ${discordTestResult.success ? \"text-green-600\" : \"text-red-600\"}`}>\n                {discordTestResult.success ? (\n                  <>\n                    <CheckCircle2 className=\"h-4 w-4\" />\n                    Test message sent successfully!\n                  </>\n                ) : (\n                  <>\n                    <XCircle className=\"h-4 w-4\" />\n                    Failed: {discordTestResult.error}\n                  </>\n                )}\n              </div>\n            )}\n            <p className=\"text-xs text-muted-foreground\">\n              Create a webhook in your Discord server: Server Settings → Integrations → Webhooks → New Webhook\n            </p>\n          </div>\n\n          {/* Slack Webhook */}\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center gap-2\">\n              <svg className=\"h-5 w-5\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                <path d=\"M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z\"/>\n              </svg>\n              <Label htmlFor=\"slack-webhook\">Slack Webhook URL</Label>\n            </div>\n            <div className=\"flex gap-2\">\n              <Input\n                id=\"slack-webhook\"\n                type=\"url\"\n                placeholder=\"https://hooks.slack.com/services/...\"\n                value={slackUrl}\n                onChange={(e) => setSlackUrl(e.target.value)}\n                className=\"flex-1\"\n              />\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={handleTestSlack}\n                disabled={!slackUrl || testMutation.isPending}\n              >\n                {testMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 animate-spin\" />\n                ) : (\n                  \"Test\"\n                )}\n              </Button>\n            </div>\n            {slackTestResult && (\n              <div className={`flex items-center gap-2 text-sm ${slackTestResult.success ? \"text-green-600\" : \"text-red-600\"}`}>\n                {slackTestResult.success ? (\n                  <>\n                    <CheckCircle2 className=\"h-4 w-4\" />\n                    Test message sent successfully!\n                  </>\n                ) : (\n                  <>\n                    <XCircle className=\"h-4 w-4\" />\n                    Failed: {slackTestResult.error}\n                  </>\n                )}\n              </div>\n            )}\n            <p className=\"text-xs text-muted-foreground\">\n              Create a Slack app and enable Incoming Webhooks: api.slack.com/apps → Create App → Incoming Webhooks\n            </p>\n          </div>\n\n          <Button type=\"submit\" disabled={updateMutation.isPending}>\n            {updateMutation.isPending && (\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            )}\n            Save Webhook Settings\n          </Button>\n\n          {updateMutation.isSuccess && (\n            <p className=\"text-sm text-green-600\">Settings saved successfully!</p>\n          )}\n        </form>\n      </CardContent>\n    </Card>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/nodes/AttachmentNode.tsx",
        "size": 16733,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport * as React from \"react\";\nimport {\n  type DOMExportOutput,\n  type EditorConfig,\n  type LexicalNode,\n  type NodeKey,\n  type SerializedLexicalNode,\n  type Spread,\n  DecoratorNode,\n  $getNodeByKey,\n} from \"lexical\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport { Suspense, useEffect, useState, useId } from \"react\";\nimport { FileIcon, Download, Play, ExternalLink, Loader2, X } from \"lucide-react\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Lightbox } from \"~/components/ui/lightbox\";\nimport { useMediaLightbox } from \"~/components/ui/media-lightbox-context\";\n\nexport type AttachmentType = \"IMAGE\" | \"VIDEO\" | \"FILE\" | \"FIGMA\" | \"LOOM\";\n\nexport type SerializedAttachmentNode = Spread<\n  {\n    attachmentType: AttachmentType;\n    url: string;\n    filename: string;\n    mimeType: string;\n    size: number;\n    thumbnailUrl?: string;\n    width?: number;\n    height?: number;\n    metadata?: Record<string, unknown>;\n  },\n  SerializedLexicalNode\n>;\n\nfunction formatFileSize(bytes: number): string {\n  if (bytes < 1024) return `${bytes} B`;\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\n  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\n}\n\n// Extract R2 key from URL if it's an R2 URL\nfunction extractR2Key(url: string): string | null {\n  // Match patterns like:\n  // https://bucket.accountid.r2.cloudflarestorage.com/uploads/userid/timestamp-filename\n  // https://custom-domain.com/uploads/userid/timestamp-filename\n  const match = url.match(/uploads\\/[^\\/]+\\/[^\\/]+$/);\n  if (match) {\n    return match[0];\n  }\n  return null;\n}\n\nfunction AttachmentComponent({\n  attachmentType,\n  url,\n  filename,\n  mimeType,\n  size,\n  thumbnailUrl,\n  width,\n  height,\n  nodeKey,\n}: {\n  attachmentType: AttachmentType;\n  url: string;\n  filename: string;\n  mimeType: string;\n  size: number;\n  thumbnailUrl?: string;\n  width?: number;\n  height?: number;\n  nodeKey: NodeKey;\n}) {\n  const [editor] = useLexicalComposerContext();\n  const [isEditable, setIsEditable] = useState(() => editor.isEditable());\n  const [displayUrl, setDisplayUrl] = useState<string | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [fallbackLightboxOpen, setFallbackLightboxOpen] = useState(false);\n\n  // Generate a stable unique ID for this attachment\n  const instanceId = useId();\n  const mediaId = `${instanceId}-${url}`;\n\n  // Try to use the shared media lightbox context (available on post detail pages)\n  const mediaLightbox = useMediaLightbox();\n\n  // Listen for editability changes\n  useEffect(() => {\n    return editor.registerEditableListener((editable) => {\n      setIsEditable(editable);\n    });\n  }, [editor]);\n\n  const handleDelete = (e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    editor.update(() => {\n      const node = $getNodeByKey(nodeKey);\n      if (node) {\n        node.remove();\n      }\n    });\n  };\n\n  const r2Key = extractR2Key(url);\n  const { data: signedUrlData, isLoading: isLoadingUrl, error: urlError } = api.upload.getDownloadUrl.useQuery(\n    { key: r2Key! },\n    {\n      enabled: !!r2Key && (attachmentType === \"IMAGE\" || attachmentType === \"VIDEO\"),\n      staleTime: 30 * 60 * 1000, // Cache for 30 minutes (URL expires in 1 hour)\n      refetchOnWindowFocus: false,\n    }\n  );\n\n  useEffect(() => {\n    if (attachmentType !== \"IMAGE\" && attachmentType !== \"VIDEO\") {\n      // For non-media types, use original URL\n      setDisplayUrl(url);\n      setIsLoading(false);\n      return;\n    }\n\n    if (!r2Key) {\n      // If we can't extract a key, try using the URL directly\n      setDisplayUrl(url);\n      setIsLoading(false);\n      return;\n    }\n\n    if (signedUrlData) {\n      setDisplayUrl(signedUrlData.url);\n      setIsLoading(false);\n    } else if (urlError) {\n      // If signed URL fails, try original URL\n      setDisplayUrl(url);\n      setIsLoading(false);\n      setError(\"Could not load signed URL, trying direct URL\");\n    } else if (isLoadingUrl) {\n      setIsLoading(true);\n    }\n  }, [attachmentType, url, r2Key, signedUrlData, urlError, isLoadingUrl]);\n\n  // Register this media item with the shared lightbox context\n  useEffect(() => {\n    if (!mediaLightbox) return;\n    if (attachmentType !== \"IMAGE\" && attachmentType !== \"VIDEO\") return;\n\n    const finalUrl = displayUrl || url;\n    if (!finalUrl || isLoading) return;\n\n    mediaLightbox.registerItem({\n      id: mediaId,\n      type: attachmentType === \"IMAGE\" ? \"image\" : \"video\",\n      url: finalUrl,\n      filename,\n      thumbnailUrl,\n    });\n\n    return () => {\n      mediaLightbox.unregisterItem(mediaId);\n    };\n  }, [mediaLightbox, mediaId, attachmentType, displayUrl, url, filename, thumbnailUrl, isLoading]);\n\n  const handleMediaClick = () => {\n    if (mediaLightbox) {\n      mediaLightbox.openAt(mediaId);\n    } else {\n      // Fallback to individual lightbox if no shared context\n      setFallbackLightboxOpen(true);\n    }\n  };\n\n  // Delete button component for reuse\n  const DeleteButton = () => (\n    <button\n      type=\"button\"\n      onClick={handleDelete}\n      className=\"absolute right-2 top-2 z-10 flex h-7 w-7 items-center justify-center rounded-full bg-black/60 text-white opacity-0 transition-opacity hover:bg-black/80 group-hover:opacity-100 focus:opacity-100 focus:outline-none focus:ring-2 focus:ring-white\"\n      aria-label=\"Remove attachment\"\n    >\n      <X className=\"h-4 w-4\" />\n    </button>\n  );\n\n  if (attachmentType === \"IMAGE\") {\n    if (isLoading) {\n      return (\n        <div className=\"my-4 flex h-48 items-center justify-center rounded-lg bg-muted\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n        </div>\n      );\n    }\n\n    return (\n      <>\n        <div className=\"group relative my-4 inline-block\">\n          {isEditable && <DeleteButton />}\n          <button\n            type=\"button\"\n            onClick={handleMediaClick}\n            className=\"block cursor-zoom-in focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-lg\"\n          >\n            <div className=\"inline-block rounded-lg bg-muted/50\">\n              <img\n                src={displayUrl || url}\n                alt={filename}\n                width={width}\n                height={height}\n                className=\"max-w-full rounded-lg\"\n                loading=\"lazy\"\n                onError={(e) => {\n                  // If image fails to load, show error state\n                  const target = e.target as HTMLImageElement;\n                  target.style.display = 'none';\n                  console.error(\"Image failed to load:\", displayUrl || url);\n                }}\n              />\n            </div>\n          </button>\n        </div>\n        {/* Fallback lightbox when not using shared context */}\n        {!mediaLightbox && (\n          <Lightbox\n            images={[{ id: \"single\", type: \"image\", url: displayUrl || url, filename }]}\n            initialIndex={0}\n            isOpen={fallbackLightboxOpen}\n            onClose={() => setFallbackLightboxOpen(false)}\n          />\n        )}\n      </>\n    );\n  }\n\n  if (attachmentType === \"VIDEO\") {\n    if (isLoading) {\n      return (\n        <div className=\"my-4 flex h-48 items-center justify-center rounded-lg bg-muted\">\n          <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n        </div>\n      );\n    }\n\n    return (\n      <>\n        <div className=\"group relative my-4 inline-block\">\n          {isEditable && <DeleteButton />}\n          <button\n            type=\"button\"\n            onClick={handleMediaClick}\n            className=\"block cursor-zoom-in focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded-lg\"\n          >\n            <div className=\"inline-block rounded-lg bg-muted/50 relative\">\n              {thumbnailUrl ? (\n                <img\n                  src={thumbnailUrl}\n                  alt={filename}\n                  className=\"max-w-full rounded-lg\"\n                  loading=\"lazy\"\n                />\n              ) : (\n                <video\n                  src={displayUrl || url}\n                  className=\"max-w-full rounded-lg pointer-events-none\"\n                  muted\n                  preload=\"metadata\"\n                >\n                  <track kind=\"captions\" />\n                </video>\n              )}\n              <div className=\"absolute inset-0 flex items-center justify-center pointer-events-none\">\n                <div className=\"rounded-full bg-black/60 p-3 transition-colors\">\n                  <Play className=\"h-8 w-8 text-white fill-white\" />\n                </div>\n              </div>\n            </div>\n          </button>\n        </div>\n        {/* Fallback lightbox when not using shared context */}\n        {!mediaLightbox && (\n          <Lightbox\n            images={[{ id: \"single\", type: \"video\", url: displayUrl || url, filename }]}\n            initialIndex={0}\n            isOpen={fallbackLightboxOpen}\n            onClose={() => setFallbackLightboxOpen(false)}\n          />\n        )}\n      </>\n    );\n  }\n\n  if (attachmentType === \"FIGMA\") {\n    return (\n      <div className=\"group relative my-4\">\n        {isEditable && <DeleteButton />}\n        <a\n          href={url}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"flex items-center gap-3 rounded-lg border border-border bg-card p-4 pr-7 transition-colors hover:bg-muted\"\n        >\n          <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-[#1e1e1e]\">\n            <svg viewBox=\"0 0 38 57\" className=\"h-6 w-6\" fill=\"none\">\n              <path\n                d=\"M19 28.5a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z\"\n                fill=\"#1ABCFE\"\n              />\n              <path\n                d=\"M0 47.5A9.5 9.5 0 0 1 9.5 38H19v9.5a9.5 9.5 0 1 1-19 0z\"\n                fill=\"#0ACF83\"\n              />\n              <path\n                d=\"M19 0v19h9.5a9.5 9.5 0 1 0 0-19H19z\"\n                fill=\"#FF7262\"\n              />\n              <path\n                d=\"M0 9.5A9.5 9.5 0 0 0 9.5 19H19V0H9.5A9.5 9.5 0 0 0 0 9.5z\"\n                fill=\"#F24E1E\"\n              />\n              <path\n                d=\"M0 28.5A9.5 9.5 0 0 0 9.5 38H19V19H9.5A9.5 9.5 0 0 0 0 28.5z\"\n                fill=\"#A259FF\"\n              />\n            </svg>\n          </div>\n          <div className=\"flex-1 overflow-hidden\">\n            <p className=\"truncate font-medium\">{filename}</p>\n            <p className=\"text-sm text-muted-foreground\">Figma Design</p>\n          </div>\n          <ExternalLink className=\"h-4 w-4 text-muted-foreground\" />\n        </a>\n      </div>\n    );\n  }\n\n  if (attachmentType === \"LOOM\") {\n    return (\n      <div className=\"group relative my-4\">\n        {isEditable && <DeleteButton />}\n        <a\n          href={url}\n          target=\"_blank\"\n          rel=\"noopener noreferrer\"\n          className=\"flex items-center gap-3 rounded-lg border border-border bg-card p-4 pr-7 transition-colors hover:bg-muted\"\n        >\n          <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-[#625df5]\">\n            <Play className=\"h-5 w-5 fill-white text-white\" />\n          </div>\n          <div className=\"flex-1 overflow-hidden\">\n            <p className=\"truncate font-medium\">{filename}</p>\n            <p className=\"text-sm text-muted-foreground\">Loom Recording</p>\n          </div>\n          <ExternalLink className=\"h-4 w-4 text-muted-foreground\" />\n        </a>\n      </div>\n    );\n  }\n\n  // Generic file attachment - use signed URL for download\n  const downloadKey = extractR2Key(url);\n  const { data: downloadUrlData } = api.upload.getDownloadUrl.useQuery(\n    { key: downloadKey! },\n    {\n      enabled: !!downloadKey,\n      staleTime: 30 * 60 * 1000,\n      refetchOnWindowFocus: false,\n    }\n  );\n\n  return (\n    <div className=\"group relative my-4\">\n      {isEditable && <DeleteButton />}\n      <a\n        href={downloadUrlData?.url || url}\n        download={filename}\n        className=\"flex items-center gap-3 rounded-lg border border-border bg-card p-4 pr-7 transition-colors hover:bg-muted\"\n      >\n        <div className=\"flex h-10 w-10 items-center justify-center rounded-lg bg-muted\">\n          <FileIcon className=\"h-5 w-5 text-muted-foreground\" />\n        </div>\n        <div className=\"flex-1 overflow-hidden\">\n          <p className=\"truncate font-medium\">{filename}</p>\n          <p className=\"text-sm text-muted-foreground\">\n            {mimeType} · {formatFileSize(size)}\n          </p>\n        </div>\n        <Download className=\"h-4 w-4 text-muted-foreground\" />\n      </a>\n    </div>\n  );\n}\n\nexport class AttachmentNode extends DecoratorNode<React.ReactElement> {\n  __attachmentType: AttachmentType;\n  __url: string;\n  __filename: string;\n  __mimeType: string;\n  __size: number;\n  __thumbnailUrl?: string;\n  __width?: number;\n  __height?: number;\n  __metadata?: Record<string, unknown>;\n\n  static getType(): string {\n    return \"attachment\";\n  }\n\n  static clone(node: AttachmentNode): AttachmentNode {\n    return new AttachmentNode(\n      node.__attachmentType,\n      node.__url,\n      node.__filename,\n      node.__mimeType,\n      node.__size,\n      node.__thumbnailUrl,\n      node.__width,\n      node.__height,\n      node.__metadata,\n      node.__key\n    );\n  }\n\n  constructor(\n    attachmentType: AttachmentType,\n    url: string,\n    filename: string,\n    mimeType: string,\n    size: number,\n    thumbnailUrl?: string,\n    width?: number,\n    height?: number,\n    metadata?: Record<string, unknown>,\n    key?: NodeKey\n  ) {\n    super(key);\n    this.__attachmentType = attachmentType;\n    this.__url = url;\n    this.__filename = filename;\n    this.__mimeType = mimeType;\n    this.__size = size;\n    this.__thumbnailUrl = thumbnailUrl;\n    this.__width = width;\n    this.__height = height;\n    this.__metadata = metadata;\n  }\n\n  createDOM(_config: EditorConfig): HTMLElement {\n    const div = document.createElement(\"div\");\n    div.className = \"editor-attachment\";\n    return div;\n  }\n\n  updateDOM(): false {\n    return false;\n  }\n\n  exportDOM(): DOMExportOutput {\n    const element = document.createElement(\"div\");\n    element.setAttribute(\"data-attachment-type\", this.__attachmentType);\n    element.setAttribute(\"data-url\", this.__url);\n    element.setAttribute(\"data-filename\", this.__filename);\n    return { element };\n  }\n\n  static importJSON(serializedNode: SerializedAttachmentNode): AttachmentNode {\n    return $createAttachmentNode({\n      attachmentType: serializedNode.attachmentType,\n      url: serializedNode.url,\n      filename: serializedNode.filename,\n      mimeType: serializedNode.mimeType,\n      size: serializedNode.size,\n      thumbnailUrl: serializedNode.thumbnailUrl,\n      width: serializedNode.width,\n      height: serializedNode.height,\n      metadata: serializedNode.metadata,\n    });\n  }\n\n  exportJSON(): SerializedAttachmentNode {\n    return {\n      type: \"attachment\",\n      version: 1,\n      attachmentType: this.__attachmentType,\n      url: this.__url,\n      filename: this.__filename,\n      mimeType: this.__mimeType,\n      size: this.__size,\n      thumbnailUrl: this.__thumbnailUrl,\n      width: this.__width,\n      height: this.__height,\n      metadata: this.__metadata,\n    };\n  }\n\n  getUrl(): string {\n    return this.__url;\n  }\n\n  getFilename(): string {\n    return this.__filename;\n  }\n\n  decorate(): React.ReactElement {\n    return (\n      <Suspense fallback={<div className=\"my-4 h-48 animate-pulse rounded-lg bg-muted\" />}>\n        <AttachmentComponent\n          attachmentType={this.__attachmentType}\n          url={this.__url}\n          filename={this.__filename}\n          mimeType={this.__mimeType}\n          size={this.__size}\n          thumbnailUrl={this.__thumbnailUrl}\n          width={this.__width}\n          height={this.__height}\n          nodeKey={this.__key}\n        />\n      </Suspense>\n    );\n  }\n\n  isInline(): boolean {\n    return false;\n  }\n\n  isKeyboardSelectable(): boolean {\n    return true;\n  }\n}\n\nexport function $createAttachmentNode({\n  attachmentType,\n  url,\n  filename,\n  mimeType,\n  size,\n  thumbnailUrl,\n  width,\n  height,\n  metadata,\n}: {\n  attachmentType: AttachmentType;\n  url: string;\n  filename: string;\n  mimeType: string;\n  size: number;\n  thumbnailUrl?: string;\n  width?: number;\n  height?: number;\n  metadata?: Record<string, unknown>;\n}): AttachmentNode {\n  return new AttachmentNode(\n    attachmentType,\n    url,\n    filename,\n    mimeType,\n    size,\n    thumbnailUrl,\n    width,\n    height,\n    metadata\n  );\n}\n\nexport function $isAttachmentNode(\n  node: LexicalNode | null | undefined\n): node is AttachmentNode {\n  return node instanceof AttachmentNode;\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/DesignTokens.stories.tsx",
        "size": 13964,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\n\nconst meta: Meta = {\n  title: \"Foundation/Design Tokens\",\n  parameters: {\n    layout: \"fullscreen\",\n  },\n};\n\nexport default meta;\ntype Story = StoryObj;\n\nconst ColorSwatch = ({\n  name,\n  variable,\n  description,\n}: {\n  name: string;\n  variable: string;\n  description?: string;\n}) => (\n  <div className=\"flex items-center gap-4 p-3 rounded-lg border border-border\">\n    <div\n      className=\"w-16 h-16 rounded-lg border border-border shadow-sm shrink-0\"\n      style={{ backgroundColor: `var(${variable})` }}\n    />\n    <div className=\"min-w-0\">\n      <p className=\"font-medium text-foreground\">{name}</p>\n      <code className=\"text-xs text-muted-foreground font-mono\">{variable}</code>\n      {description && (\n        <p className=\"text-xs text-muted-foreground mt-1\">{description}</p>\n      )}\n    </div>\n  </div>\n);\n\nconst ColorSection = ({\n  title,\n  children,\n}: {\n  title: string;\n  children: React.ReactNode;\n}) => (\n  <div className=\"space-y-4\">\n    <h3 className=\"text-lg font-semibold text-foreground border-b border-border pb-2\">\n      {title}\n    </h3>\n    <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n      {children}\n    </div>\n  </div>\n);\n\nexport const Colors: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Color Tokens</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Draftboard uses a warm, creative color palette that adapts between\n          light and dark modes. All colors are defined as CSS custom properties.\n        </p>\n      </div>\n\n      <ColorSection title=\"Base Colors\">\n        <ColorSwatch\n          name=\"Background\"\n          variable=\"--color-background\"\n          description=\"Main page background\"\n        />\n        <ColorSwatch\n          name=\"Foreground\"\n          variable=\"--color-foreground\"\n          description=\"Primary text color\"\n        />\n        <ColorSwatch\n          name=\"Card\"\n          variable=\"--color-card\"\n          description=\"Card/surface background\"\n        />\n        <ColorSwatch\n          name=\"Card Foreground\"\n          variable=\"--color-card-foreground\"\n          description=\"Text on cards\"\n        />\n        <ColorSwatch\n          name=\"Popover\"\n          variable=\"--color-popover\"\n          description=\"Popover/dropdown background\"\n        />\n        <ColorSwatch\n          name=\"Popover Foreground\"\n          variable=\"--color-popover-foreground\"\n          description=\"Text in popovers\"\n        />\n      </ColorSection>\n\n      <ColorSection title=\"Brand Colors\">\n        <ColorSwatch\n          name=\"Primary\"\n          variable=\"--color-primary\"\n          description=\"Primary actions, CTAs\"\n        />\n        <ColorSwatch\n          name=\"Primary Foreground\"\n          variable=\"--color-primary-foreground\"\n          description=\"Text on primary color\"\n        />\n        <ColorSwatch\n          name=\"Secondary\"\n          variable=\"--color-secondary\"\n          description=\"Secondary actions\"\n        />\n        <ColorSwatch\n          name=\"Secondary Foreground\"\n          variable=\"--color-secondary-foreground\"\n          description=\"Text on secondary\"\n        />\n        <ColorSwatch\n          name=\"Accent\"\n          variable=\"--color-accent\"\n          description=\"Accent highlights\"\n        />\n        <ColorSwatch\n          name=\"Accent Foreground\"\n          variable=\"--color-accent-foreground\"\n          description=\"Text on accent\"\n        />\n      </ColorSection>\n\n      <ColorSection title=\"Semantic Colors\">\n        <ColorSwatch\n          name=\"Muted\"\n          variable=\"--color-muted\"\n          description=\"Muted backgrounds\"\n        />\n        <ColorSwatch\n          name=\"Muted Foreground\"\n          variable=\"--color-muted-foreground\"\n          description=\"Muted/secondary text\"\n        />\n        <ColorSwatch\n          name=\"Destructive\"\n          variable=\"--color-destructive\"\n          description=\"Error states, delete actions\"\n        />\n        <ColorSwatch\n          name=\"Destructive Foreground\"\n          variable=\"--color-destructive-foreground\"\n          description=\"Text on destructive\"\n        />\n      </ColorSection>\n\n      <ColorSection title=\"UI Colors\">\n        <ColorSwatch\n          name=\"Border\"\n          variable=\"--color-border\"\n          description=\"Default border color\"\n        />\n        <ColorSwatch\n          name=\"Input\"\n          variable=\"--color-input\"\n          description=\"Input field borders\"\n        />\n        <ColorSwatch\n          name=\"Ring\"\n          variable=\"--color-ring\"\n          description=\"Focus ring color\"\n        />\n      </ColorSection>\n    </div>\n  ),\n};\n\nconst RadiusExample = ({ name, size }: { name: string; size: string }) => (\n  <div className=\"flex flex-col items-center gap-2\">\n    <div\n      className=\"w-20 h-20 bg-primary\"\n      style={{ borderRadius: `var(${size})` }}\n    />\n    <div className=\"text-center\">\n      <p className=\"font-medium text-foreground text-sm\">{name}</p>\n      <code className=\"text-xs text-muted-foreground font-mono\">{size}</code>\n    </div>\n  </div>\n);\n\nexport const Radius: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Border Radius</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Consistent border radius tokens used throughout the design system.\n        </p>\n      </div>\n\n      <div className=\"flex flex-wrap gap-8\">\n        <RadiusExample name=\"Small\" size=\"--radius-sm\" />\n        <RadiusExample name=\"Medium\" size=\"--radius-md\" />\n        <RadiusExample name=\"Large\" size=\"--radius-lg\" />\n        <RadiusExample name=\"XL\" size=\"--radius-xl\" />\n      </div>\n\n      <div className=\"p-4 bg-muted rounded-lg\">\n        <h4 className=\"font-medium mb-2\">Radius Values</h4>\n        <table className=\"text-sm w-full\">\n          <thead>\n            <tr className=\"text-left text-muted-foreground\">\n              <th className=\"pb-2\">Token</th>\n              <th className=\"pb-2\">Value</th>\n              <th className=\"pb-2\">Usage</th>\n            </tr>\n          </thead>\n          <tbody className=\"font-mono\">\n            <tr>\n              <td className=\"py-1\">--radius-sm</td>\n              <td>0.375rem (6px)</td>\n              <td className=\"font-sans text-muted-foreground\">\n                Badges, small elements\n              </td>\n            </tr>\n            <tr>\n              <td className=\"py-1\">--radius-md</td>\n              <td>0.5rem (8px)</td>\n              <td className=\"font-sans text-muted-foreground\">\n                Buttons, inputs\n              </td>\n            </tr>\n            <tr>\n              <td className=\"py-1\">--radius-lg</td>\n              <td>0.75rem (12px)</td>\n              <td className=\"font-sans text-muted-foreground\">\n                Dialogs, popovers\n              </td>\n            </tr>\n            <tr>\n              <td className=\"py-1\">--radius-xl</td>\n              <td>1rem (16px)</td>\n              <td className=\"font-sans text-muted-foreground\">\n                Cards, large containers\n              </td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n    </div>\n  ),\n};\n\nexport const Typography: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Typography</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Font families and type scale used in the design system.\n        </p>\n      </div>\n\n      <div className=\"space-y-6\">\n        <h3 className=\"text-lg font-semibold border-b border-border pb-2\">\n          Font Families\n        </h3>\n\n        <div className=\"space-y-4\">\n          <div className=\"p-4 rounded-lg border border-border\">\n            <p className=\"font-sans text-2xl\">Inter (Sans Serif)</p>\n            <code className=\"text-xs text-muted-foreground font-mono\">\n              --font-sans: \"Inter\", ui-sans-serif, system-ui, sans-serif\n            </code>\n            <p className=\"mt-2 text-muted-foreground\">\n              Primary font for UI elements, body text, and headings.\n            </p>\n          </div>\n\n          <div className=\"p-4 rounded-lg border border-border\">\n            <p className=\"font-mono text-2xl\">JetBrains Mono</p>\n            <code className=\"text-xs text-muted-foreground font-mono\">\n              --font-mono: \"JetBrains Mono\", ui-monospace, monospace\n            </code>\n            <p className=\"mt-2 text-muted-foreground font-sans\">\n              Used for code blocks, technical content, and tokens.\n            </p>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"space-y-6\">\n        <h3 className=\"text-lg font-semibold border-b border-border pb-2\">\n          Type Scale\n        </h3>\n\n        <div className=\"space-y-4\">\n          {[\n            { class: \"text-xs\", name: \"Extra Small\", size: \"12px\" },\n            { class: \"text-sm\", name: \"Small\", size: \"14px\" },\n            { class: \"text-base\", name: \"Base\", size: \"16px\" },\n            { class: \"text-lg\", name: \"Large\", size: \"18px\" },\n            { class: \"text-xl\", name: \"XL\", size: \"20px\" },\n            { class: \"text-2xl\", name: \"2XL\", size: \"24px\" },\n            { class: \"text-3xl\", name: \"3XL\", size: \"30px\" },\n            { class: \"text-4xl\", name: \"4XL\", size: \"36px\" },\n          ].map((item) => (\n            <div\n              key={item.class}\n              className=\"flex items-baseline gap-4 p-3 rounded-lg border border-border\"\n            >\n              <span className={item.class}>The quick brown fox</span>\n              <span className=\"text-sm text-muted-foreground ml-auto\">\n                {item.name} ({item.size})\n              </span>\n              <code className=\"text-xs font-mono text-muted-foreground\">\n                {item.class}\n              </code>\n            </div>\n          ))}\n        </div>\n      </div>\n\n      <div className=\"space-y-6\">\n        <h3 className=\"text-lg font-semibold border-b border-border pb-2\">\n          Font Weights\n        </h3>\n\n        <div className=\"space-y-4\">\n          {[\n            { class: \"font-normal\", name: \"Normal\", weight: \"400\" },\n            { class: \"font-medium\", name: \"Medium\", weight: \"500\" },\n            { class: \"font-semibold\", name: \"Semibold\", weight: \"600\" },\n            { class: \"font-bold\", name: \"Bold\", weight: \"700\" },\n          ].map((item) => (\n            <div\n              key={item.class}\n              className=\"flex items-center gap-4 p-3 rounded-lg border border-border\"\n            >\n              <span className={`text-xl ${item.class}`}>\n                The quick brown fox\n              </span>\n              <span className=\"text-sm text-muted-foreground ml-auto\">\n                {item.name} ({item.weight})\n              </span>\n              <code className=\"text-xs font-mono text-muted-foreground\">\n                {item.class}\n              </code>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  ),\n};\n\nexport const Spacing: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Spacing</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Spacing scale used for margins, padding, and gaps.\n        </p>\n      </div>\n\n      <div className=\"space-y-4\">\n        {[\n          { value: \"0.5\", px: \"2px\", name: \"0.5\" },\n          { value: \"1\", px: \"4px\", name: \"1\" },\n          { value: \"1.5\", px: \"6px\", name: \"1.5\" },\n          { value: \"2\", px: \"8px\", name: \"2\" },\n          { value: \"3\", px: \"12px\", name: \"3\" },\n          { value: \"4\", px: \"16px\", name: \"4\" },\n          { value: \"5\", px: \"20px\", name: \"5\" },\n          { value: \"6\", px: \"24px\", name: \"6\" },\n          { value: \"8\", px: \"32px\", name: \"8\" },\n          { value: \"10\", px: \"40px\", name: \"10\" },\n          { value: \"12\", px: \"48px\", name: \"12\" },\n          { value: \"16\", px: \"64px\", name: \"16\" },\n        ].map((item) => (\n          <div\n            key={item.value}\n            className=\"flex items-center gap-4 p-2 rounded-lg border border-border\"\n          >\n            <div\n              className=\"bg-primary h-4 rounded shrink-0\"\n              style={{ width: item.px }}\n            />\n            <span className=\"font-medium w-12\">{item.name}</span>\n            <code className=\"text-xs font-mono text-muted-foreground\">\n              {item.px}\n            </code>\n            <code className=\"text-xs font-mono text-muted-foreground\">\n              p-{item.name}, m-{item.name}, gap-{item.name}\n            </code>\n          </div>\n        ))}\n      </div>\n    </div>\n  ),\n};\n\nexport const Shadows: Story = {\n  render: () => (\n    <div className=\"p-8 space-y-8 bg-background min-h-screen\">\n      <div>\n        <h1 className=\"text-3xl font-bold text-foreground\">Shadows</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Shadow utilities for depth and elevation.\n        </p>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8\">\n        {[\n          { class: \"shadow-sm\", name: \"Small Shadow\" },\n          { class: \"shadow\", name: \"Default Shadow\" },\n          { class: \"shadow-md\", name: \"Medium Shadow\" },\n          { class: \"shadow-lg\", name: \"Large Shadow\" },\n          { class: \"shadow-xl\", name: \"XL Shadow\" },\n          { class: \"shadow-2xl\", name: \"2XL Shadow\" },\n        ].map((item) => (\n          <div\n            key={item.class}\n            className={`p-6 bg-card rounded-lg border border-border ${item.class}`}\n          >\n            <p className=\"font-medium\">{item.name}</p>\n            <code className=\"text-xs font-mono text-muted-foreground\">\n              {item.class}\n            </code>\n          </div>\n        ))}\n      </div>\n    </div>\n  ),\n};\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/plugins/SlashCommandPlugin.tsx",
        "size": 13392,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useEffect, useMemo, useState, useRef } from \"react\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport {\n  $createParagraphNode,\n  $getSelection,\n  $isRangeSelection,\n  COMMAND_PRIORITY_LOW,\n  KEY_ARROW_DOWN_COMMAND,\n  KEY_ARROW_UP_COMMAND,\n  KEY_ENTER_COMMAND,\n  KEY_ESCAPE_COMMAND,\n  KEY_TAB_COMMAND,\n  TextNode,\n} from \"lexical\";\nimport { $setBlocksType } from \"@lexical/selection\";\nimport { $createHeadingNode, $createQuoteNode } from \"@lexical/rich-text\";\nimport { INSERT_ORDERED_LIST_COMMAND, INSERT_UNORDERED_LIST_COMMAND } from \"@lexical/list\";\nimport { mergeRegister } from \"@lexical/utils\";\nimport { createPortal } from \"react-dom\";\nimport {\n  Heading1,\n  Heading2,\n  Heading3,\n  List,\n  ListOrdered,\n  Quote,\n  ImagePlus,\n  FileUp,\n} from \"lucide-react\";\nimport { $createAttachmentNode, type AttachmentType } from \"../nodes/AttachmentNode\";\nimport { api } from \"~/lib/trpc/client\";\nimport { cn } from \"~/lib/utils\";\n\ninterface CommandOption {\n  name: string;\n  command: string;\n  icon: React.ReactNode;\n  description?: string;\n  section: \"media\" | \"blocks\";\n}\n\nconst COMMANDS: CommandOption[] = [\n  {\n    name: \"Image\",\n    command: \"image\",\n    icon: <ImagePlus className=\"h-4 w-4\" />,\n    description: \"Upload an image\",\n    section: \"media\",\n  },\n  {\n    name: \"File\",\n    command: \"file\",\n    icon: <FileUp className=\"h-4 w-4\" />,\n    description: \"Upload any file\",\n    section: \"media\",\n  },\n  {\n    name: \"Heading 1\",\n    command: \"heading1\",\n    icon: <Heading1 className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Heading 2\",\n    command: \"heading2\",\n    icon: <Heading2 className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Heading 3\",\n    command: \"heading3\",\n    icon: <Heading3 className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Bullet List\",\n    command: \"bulletList\",\n    icon: <List className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Numbered List\",\n    command: \"numberedList\",\n    icon: <ListOrdered className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n  {\n    name: \"Quote\",\n    command: \"quote\",\n    icon: <Quote className=\"h-4 w-4\" />,\n    section: \"blocks\",\n  },\n];\n\ninterface SlashCommandPluginProps {\n  anchorElem: HTMLElement;\n}\n\nexport function SlashCommandPlugin({ anchorElem }: SlashCommandPluginProps) {\n  const [editor] = useLexicalComposerContext();\n  const [isOpen, setIsOpen] = useState(false);\n  const [query, setQuery] = useState(\"\");\n  const [selectedIndex, setSelectedIndex] = useState(0);\n  const [position, setPosition] = useState({ top: 0, left: 0 });\n  const menuRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const uploadMutation = api.upload.getUploadUrl.useMutation();\n  const pendingCommandRef = useRef<string | null>(null);\n\n  const filteredCommands = useMemo(() => {\n    if (!query) return COMMANDS;\n    const lowerQuery = query.toLowerCase();\n    return COMMANDS.filter(\n      (cmd) =>\n        cmd.name.toLowerCase().includes(lowerQuery) ||\n        cmd.description?.toLowerCase().includes(lowerQuery) ||\n        cmd.command.toLowerCase().includes(lowerQuery)\n    );\n  }, [query]);\n\n  // Reset selected index when filtered commands change\n  useEffect(() => {\n    setSelectedIndex(0);\n  }, [filteredCommands.length]);\n\n  const handleFileUpload = useCallback(\n    async (file: File) => {\n      try {\n        const result = await uploadMutation.mutateAsync({\n          filename: file.name,\n          contentType: file.type,\n          size: file.size,\n        });\n\n        const uploadResponse = await fetch(result.uploadUrl, {\n          method: \"PUT\",\n          body: file,\n          headers: {\n            \"Content-Type\": file.type,\n          },\n        });\n\n        if (!uploadResponse.ok) {\n          const errorText = await uploadResponse.text();\n          console.error(\"R2 upload failed:\", uploadResponse.status, errorText);\n          alert(`Upload failed: ${uploadResponse.status} - ${errorText || \"Unknown error\"}`);\n          return;\n        }\n\n        let attachmentType: AttachmentType = \"FILE\";\n        if (file.type.startsWith(\"image/\")) {\n          attachmentType = \"IMAGE\";\n        } else if (file.type.startsWith(\"video/\")) {\n          attachmentType = \"VIDEO\";\n        }\n\n        editor.update(() => {\n          const selection = $getSelection();\n          if ($isRangeSelection(selection)) {\n            const attachmentNode = $createAttachmentNode({\n              attachmentType,\n              url: result.publicUrl,\n              filename: file.name,\n              mimeType: file.type,\n              size: file.size,\n            });\n            selection.insertNodes([attachmentNode, $createParagraphNode()]);\n          }\n        });\n      } catch (error) {\n        console.error(\"Upload failed:\", error);\n        alert(`Upload failed: ${error instanceof Error ? error.message : \"Unknown error\"}`);\n      }\n    },\n    [editor, uploadMutation]\n  );\n\n  const executeCommand = useCallback(\n    (command: string) => {\n      editor.update(() => {\n        const selection = $getSelection();\n        if (!$isRangeSelection(selection)) return;\n\n        // Remove the slash and query text\n        const anchor = selection.anchor;\n        const anchorNode = anchor.getNode();\n        if (anchorNode instanceof TextNode) {\n          const textContent = anchorNode.getTextContent();\n          const slashIndex = textContent.lastIndexOf(\"/\");\n          if (slashIndex !== -1) {\n            const newText = textContent.slice(0, slashIndex);\n            if (newText) {\n              anchorNode.setTextContent(newText);\n              selection.setTextNodeRange(anchorNode, newText.length, anchorNode, newText.length);\n            } else {\n              anchorNode.remove();\n            }\n          }\n        }\n\n        switch (command) {\n          case \"heading1\":\n            $setBlocksType(selection, () => $createHeadingNode(\"h1\"));\n            break;\n          case \"heading2\":\n            $setBlocksType(selection, () => $createHeadingNode(\"h2\"));\n            break;\n          case \"heading3\":\n            $setBlocksType(selection, () => $createHeadingNode(\"h3\"));\n            break;\n          case \"bulletList\":\n            editor.dispatchCommand(INSERT_UNORDERED_LIST_COMMAND, undefined);\n            break;\n          case \"numberedList\":\n            editor.dispatchCommand(INSERT_ORDERED_LIST_COMMAND, undefined);\n            break;\n          case \"quote\":\n            $setBlocksType(selection, () => $createQuoteNode());\n            break;\n          case \"image\":\n          case \"file\":\n            pendingCommandRef.current = command;\n            setTimeout(() => {\n              if (fileInputRef.current) {\n                fileInputRef.current.accept = command === \"image\" ? \"image/*,video/*\" : \"*/*\";\n                fileInputRef.current.click();\n              }\n            }, 0);\n            break;\n        }\n      });\n\n      setIsOpen(false);\n      setQuery(\"\");\n    },\n    [editor]\n  );\n\n  // Listen for text changes to detect slash commands\n  useEffect(() => {\n    return editor.registerTextContentListener((text) => {\n      editor.getEditorState().read(() => {\n        const selection = $getSelection();\n        if (!$isRangeSelection(selection)) {\n          setIsOpen(false);\n          return;\n        }\n\n        const anchor = selection.anchor;\n        const anchorNode = anchor.getNode();\n\n        if (!(anchorNode instanceof TextNode)) {\n          setIsOpen(false);\n          return;\n        }\n\n        const textContent = anchorNode.getTextContent();\n        const anchorOffset = anchor.offset;\n        const textBeforeCursor = textContent.slice(0, anchorOffset);\n\n        // Find the last slash in the text before cursor\n        const slashIndex = textBeforeCursor.lastIndexOf(\"/\");\n\n        if (slashIndex === -1) {\n          setIsOpen(false);\n          return;\n        }\n\n        // Check if slash is at start of line or preceded by whitespace\n        const charBeforeSlash = textBeforeCursor[slashIndex - 1];\n        if (slashIndex > 0 && charBeforeSlash !== \" \" && charBeforeSlash !== \"\\n\") {\n          setIsOpen(false);\n          return;\n        }\n\n        // Extract query after slash\n        const queryText = textBeforeCursor.slice(slashIndex + 1);\n\n        // Don't show menu if there's a space in the query (command ended)\n        if (queryText.includes(\" \")) {\n          setIsOpen(false);\n          return;\n        }\n\n        setQuery(queryText);\n        setIsOpen(true);\n\n        // Get position for menu\n        const domSelection = window.getSelection();\n        if (domSelection && domSelection.rangeCount > 0) {\n          const range = domSelection.getRangeAt(0);\n          const rect = range.getBoundingClientRect();\n          const editorRect = anchorElem.getBoundingClientRect();\n\n          setPosition({\n            top: rect.bottom - editorRect.top + 4,\n            left: rect.left - editorRect.left,\n          });\n        }\n      });\n    });\n  }, [editor, anchorElem]);\n\n  // Handle keyboard navigation\n  useEffect(() => {\n    if (!isOpen) return;\n\n    return mergeRegister(\n      editor.registerCommand(\n        KEY_ARROW_DOWN_COMMAND,\n        (event) => {\n          event.preventDefault();\n          setSelectedIndex((prev) =>\n            prev < filteredCommands.length - 1 ? prev + 1 : 0\n          );\n          return true;\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_ARROW_UP_COMMAND,\n        (event) => {\n          event.preventDefault();\n          setSelectedIndex((prev) =>\n            prev > 0 ? prev - 1 : filteredCommands.length - 1\n          );\n          return true;\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_ENTER_COMMAND,\n        (event) => {\n          if (filteredCommands[selectedIndex]) {\n            event?.preventDefault();\n            executeCommand(filteredCommands[selectedIndex].command);\n            return true;\n          }\n          return false;\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_TAB_COMMAND,\n        (event) => {\n          if (filteredCommands[selectedIndex]) {\n            event.preventDefault();\n            executeCommand(filteredCommands[selectedIndex].command);\n            return true;\n          }\n          return false;\n        },\n        COMMAND_PRIORITY_LOW\n      ),\n      editor.registerCommand(\n        KEY_ESCAPE_COMMAND,\n        () => {\n          setIsOpen(false);\n          setQuery(\"\");\n          return true;\n        },\n        COMMAND_PRIORITY_LOW\n      )\n    );\n  }, [editor, isOpen, filteredCommands, selectedIndex, executeCommand]);\n\n  // Click outside to close\n  useEffect(() => {\n    if (!isOpen) return;\n\n    const handleClickOutside = (event: MouseEvent) => {\n      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {\n        setIsOpen(false);\n        setQuery(\"\");\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, [isOpen]);\n\n  return (\n    <>\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        className=\"hidden\"\n        onChange={(e) => {\n          const file = e.target.files?.[0];\n          if (file) {\n            handleFileUpload(file);\n          }\n          e.target.value = \"\";\n          pendingCommandRef.current = null;\n        }}\n      />\n      {isOpen && filteredCommands.length > 0 && createPortal(\n        <div\n          ref={menuRef}\n          className=\"absolute z-50 min-w-[200px] overflow-hidden rounded-lg border bg-popover p-1 shadow-lg animate-in fade-in-0 zoom-in-95\"\n          style={{ top: position.top, left: position.left }}\n        >\n          <p className=\"px-2 py-1 text-xs font-medium text-muted-foreground\">\n            Add blocks\n          </p>\n          {filteredCommands.map((option, index) => {\n            const prevOption = filteredCommands[index - 1];\n            const showDivider = prevOption && prevOption.section === \"media\" && option.section === \"blocks\";\n            \n            return (\n              <div key={option.command}>\n                {showDivider && <div className=\"my-1 h-px bg-border\" />}\n                <button\n                  type=\"button\"\n                  onClick={() => executeCommand(option.command)}\n                  onMouseEnter={() => setSelectedIndex(index)}\n                  className={cn(\n                    \"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm\",\n                    selectedIndex === index ? \"bg-muted\" : \"hover:bg-muted\"\n                  )}\n                >\n                  <div className=\"flex h-7 w-7 shrink-0 items-center justify-center rounded-md border bg-background\">\n                    {option.icon}\n                  </div>\n                  {option.description ? (\n                    <div className=\"text-left\">\n                      <p className=\"font-medium\">{option.name}</p>\n                      <p className=\"text-xs text-muted-foreground\">{option.description}</p>\n                    </div>\n                  ) : (\n                    <span>{option.name}</span>\n                  )}\n                </button>\n              </div>\n            );\n          })}\n        </div>,\n        anchorElem\n      )}\n    </>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/server/api/routers/post.ts",
        "size": 13316,
        "reason": "large source sample",
        "content": "import { TRPCError } from \"@trpc/server\";\nimport { z } from \"zod\";\nimport {\n  createTRPCRouter,\n  protectedProcedure,\n  activeUserProcedure,\n} from \"~/server/api/trpc\";\nimport { createPostSchema, updatePostSchema, paginationSchema } from \"~/lib/validators\";\nimport { sendPostNotifications } from \"~/lib/webhooks\";\nimport { extractUserMentions } from \"~/lib/utils\";\n\nexport const postRouter = createTRPCRouter({\n  create: activeUserProcedure\n    .input(createPostSchema)\n    .mutation(async ({ ctx, input }) => {\n      const post = await ctx.db.post.create({\n        data: {\n          title: input.title,\n          content: input.content,\n          liveUrl: input.liveUrl,\n          hideFromHome: input.hideFromHome,\n          authorId: ctx.session.user.id,\n          attachments: {\n            create: input.attachments.map((att) => ({\n              type: att.type,\n              url: att.url,\n              filename: att.filename,\n              mimeType: att.mimeType,\n              size: att.size,\n              width: att.width,\n              height: att.height,\n              thumbnailUrl: att.thumbnailUrl,\n              metadata: att.metadata,\n              order: att.order,\n            })),\n          },\n          projects: {\n            create: input.projectIds.map((projectId) => ({\n              projectId,\n            })),\n          },\n        },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n              reactions: true,\n            },\n          },\n        },\n      });\n\n      // Create mention notifications\n      const mentions = extractUserMentions(input.content);\n      if (mentions.length > 0) {\n        const mentionNotifications = mentions\n          .filter((mention) => mention.userId !== ctx.session.user.id) // Don't notify self\n          .map((mention) => ({\n            type: \"MENTION\" as const,\n            userId: mention.userId,\n            actorId: ctx.session.user.id,\n            postId: post.id,\n          }));\n\n        if (mentionNotifications.length > 0) {\n          await ctx.db.notification.createMany({\n            data: mentionNotifications,\n          });\n        }\n      }\n\n      // Send webhook notifications (fire and forget)\n      const settings = await ctx.db.siteSettings.findUnique({\n        where: { id: \"default\" },\n      });\n\n      if (settings?.discordWebhookUrl || settings?.slackWebhookUrl) {\n        // Get the base URL from headers or use environment variable\n        const host = ctx.headers.get(\"host\") || \"localhost:3000\";\n        const protocol = ctx.headers.get(\"x-forwarded-proto\") || \"http\";\n        const baseUrl = process.env.NEXTAUTH_URL || `${protocol}://${host}`;\n\n        sendPostNotifications(\n          {\n            id: post.id,\n            title: post.title,\n            content: post.content,\n            author: post.author,\n            attachments: post.attachments,\n            projects: post.projects,\n          },\n          settings,\n          baseUrl\n        );\n      }\n\n      return post;\n    }),\n\n  getById: protectedProcedure\n    .input(z.object({ id: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const post = await ctx.db.post.findUnique({\n        where: { id: input.id },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            include: {\n              user: {\n                select: {\n                  id: true,\n                  displayName: true,\n                },\n              },\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n            },\n          },\n        },\n      });\n\n      if (!post) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      return post;\n    }),\n\n  feed: protectedProcedure\n    .input(paginationSchema)\n    .query(async ({ ctx, input }) => {\n      const posts = await ctx.db.post.findMany({\n        where: {\n          hideFromHome: false,\n        },\n        take: input.limit + 1,\n        cursor: input.cursor ? { id: input.cursor } : undefined,\n        orderBy: { createdAt: \"desc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            where: { type: { in: [\"IMAGE\", \"VIDEO\"] } },\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n              reactions: true,\n              attachments: true,\n            },\n          },\n        },\n      });\n\n      let nextCursor: string | undefined;\n      if (posts.length > input.limit) {\n        const nextItem = posts.pop();\n        nextCursor = nextItem?.id;\n      }\n\n      return { posts, nextCursor };\n    }),\n\n  byUser: protectedProcedure\n    .input(\n      paginationSchema.extend({\n        userId: z.string(),\n      })\n    )\n    .query(async ({ ctx, input }) => {\n      const posts = await ctx.db.post.findMany({\n        where: {\n          authorId: input.userId,\n        },\n        take: input.limit + 1,\n        cursor: input.cursor ? { id: input.cursor } : undefined,\n        orderBy: { createdAt: \"desc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            where: { type: { in: [\"IMAGE\", \"VIDEO\"] } },\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n              reactions: true,\n              attachments: true,\n            },\n          },\n        },\n      });\n\n      let nextCursor: string | undefined;\n      if (posts.length > input.limit) {\n        const nextItem = posts.pop();\n        nextCursor = nextItem?.id;\n      }\n\n      return { posts, nextCursor };\n    }),\n\n  byProject: protectedProcedure\n    .input(\n      paginationSchema.extend({\n        projectId: z.string(),\n      })\n    )\n    .query(async ({ ctx, input }) => {\n      const posts = await ctx.db.post.findMany({\n        where: {\n          projects: {\n            some: {\n              projectId: input.projectId,\n            },\n          },\n        },\n        take: input.limit + 1,\n        cursor: input.cursor ? { id: input.cursor } : undefined,\n        orderBy: { createdAt: \"desc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            where: { type: { in: [\"IMAGE\", \"VIDEO\"] } },\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n          _count: {\n            select: {\n              comments: true,\n              reactions: true,\n              attachments: true,\n            },\n          },\n        },\n      });\n\n      let nextCursor: string | undefined;\n      if (posts.length > input.limit) {\n        const nextItem = posts.pop();\n        nextCursor = nextItem?.id;\n      }\n\n      return { posts, nextCursor };\n    }),\n\n  update: activeUserProcedure\n    .input(updatePostSchema)\n    .mutation(async ({ ctx, input }) => {\n      const existingPost = await ctx.db.post.findUnique({\n        where: { id: input.id },\n        select: { authorId: true },\n      });\n\n      if (!existingPost) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      if (existingPost.authorId !== ctx.session.user.id) {\n        throw new TRPCError({ code: \"FORBIDDEN\" });\n      }\n\n      // Delete existing attachments and project links if updating\n      if (input.attachments) {\n        await ctx.db.attachment.deleteMany({\n          where: { postId: input.id },\n        });\n      }\n\n      if (input.projectIds) {\n        await ctx.db.postProject.deleteMany({\n          where: { postId: input.id },\n        });\n      }\n\n      const post = await ctx.db.post.update({\n        where: { id: input.id },\n        data: {\n          title: input.title,\n          content: input.content,\n          liveUrl: input.liveUrl,\n          hideFromHome: input.hideFromHome,\n          attachments: input.attachments\n            ? {\n                create: input.attachments.map((att) => ({\n                  type: att.type,\n                  url: att.url,\n                  filename: att.filename,\n                  mimeType: att.mimeType,\n                  size: att.size,\n                  width: att.width,\n                  height: att.height,\n                  thumbnailUrl: att.thumbnailUrl,\n                  metadata: att.metadata,\n                  order: att.order,\n                })),\n              }\n            : undefined,\n          projects: input.projectIds\n            ? {\n                create: input.projectIds.map((projectId) => ({\n                  projectId,\n                })),\n              }\n            : undefined,\n        },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          attachments: {\n            orderBy: { order: \"asc\" },\n          },\n          projects: {\n            include: {\n              project: {\n                select: {\n                  id: true,\n                  name: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Create mention notifications for new mentions in updated content\n      if (input.content) {\n        const mentions = extractUserMentions(input.content);\n        if (mentions.length > 0) {\n          // Get existing mention notifications for this post to avoid duplicates\n          const existingMentionNotifications = await ctx.db.notification.findMany({\n            where: {\n              postId: post.id,\n              type: \"MENTION\",\n            },\n            select: { userId: true },\n          });\n          const existingMentionedUserIds = new Set(\n            existingMentionNotifications.map((n) => n.userId)\n          );\n\n          const newMentionNotifications = mentions\n            .filter(\n              (mention) =>\n                mention.userId !== ctx.session.user.id && // Don't notify self\n                !existingMentionedUserIds.has(mention.userId) // Don't duplicate\n            )\n            .map((mention) => ({\n              type: \"MENTION\" as const,\n              userId: mention.userId,\n              actorId: ctx.session.user.id,\n              postId: post.id,\n            }));\n\n          if (newMentionNotifications.length > 0) {\n            await ctx.db.notification.createMany({\n              data: newMentionNotifications,\n            });\n          }\n        }\n      }\n\n      return post;\n    }),\n\n  delete: activeUserProcedure\n    .input(z.object({ id: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      const existingPost = await ctx.db.post.findUnique({\n        where: { id: input.id },\n        select: { authorId: true },\n      });\n\n      if (!existingPost) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      const isAdmin =\n        ctx.session.user.role === \"ADMIN\" ||\n        ctx.session.user.role === \"OWNER\";\n\n      if (existingPost.authorId !== ctx.session.user.id && !isAdmin) {\n        throw new TRPCError({ code: \"FORBIDDEN\" });\n      }\n\n      await ctx.db.post.delete({\n        where: { id: input.id },\n      });\n\n      return { success: true };\n    }),\n});\n",
        "truncated": false
      },
      {
        "path": "src/components/reactions/ReactionButton.tsx",
        "size": 11733,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport React, { useState, useMemo, useEffect } from \"react\";\nimport { useSession } from \"next-auth/react\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"~/components/ui/popover\";\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"~/components/ui/tooltip\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Heart, Sparkles, ThumbsUp, SmilePlus, type LucideIcon } from \"lucide-react\";\nimport { cn, pluralize } from \"~/lib/utils\";\nimport { EmojiImage } from \"~/components/settings/EmojiUpload\";\nimport { ReactionsDialog } from \"./ReactionsDialog\";\n\ninterface ReactionButtonProps {\n  postId?: string;\n  commentId?: string;\n  reactions: Array<{\n    type: string;\n    userId: string;\n  }>;\n  count: number;\n}\n\ninterface DefaultReaction {\n  type: string;\n  icon: LucideIcon;\n  label: string;\n}\n\ninterface CustomEmojiReaction {\n  type: string;\n  imageUrl: string;\n  label: string;\n}\n\ntype ReactionOption = DefaultReaction | CustomEmojiReaction;\n\nfunction isCustomEmoji(reaction: ReactionOption): reaction is CustomEmojiReaction {\n  return \"imageUrl\" in reaction;\n}\n\nconst DEFAULT_REACTIONS: DefaultReaction[] = [\n  { type: \"like\", icon: ThumbsUp, label: \"Like\" },\n  { type: \"wow\", icon: Sparkles, label: \"Wow\" },\n  { type: \"cool\", icon: Heart, label: \"Cool\" },\n];\n\nexport function ReactionButton({\n  postId,\n  commentId,\n  reactions,\n  count,\n}: ReactionButtonProps) {\n  const [isOpen, setIsOpen] = useState(false);\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [dialogInitialTab, setDialogInitialTab] = useState<string | undefined>();\n  const { data: session } = useSession();\n  const utils = api.useUtils();\n  const currentUserId = session?.user?.id;\n\n  // Fetch custom emojis\n  const { data: customEmojis } = api.reaction.listEmoji.useQuery();\n\n  // Fetch detailed reactions for tooltip display (with user names)\n  const { data: detailedReactions } = api.reaction.byPost.useQuery(\n    { postId: postId! },\n    { enabled: !!postId }\n  );\n\n  const { data: detailedCommentReactions } = api.reaction.byComment.useQuery(\n    { commentId: commentId! },\n    { enabled: !!commentId }\n  );\n\n  const reactionDetails = postId ? detailedReactions : detailedCommentReactions;\n\n  // Combine default reactions with custom emojis\n  const allReactions = useMemo<ReactionOption[]>(() => {\n    const customReactions: CustomEmojiReaction[] = (customEmojis ?? []).map((emoji) => ({\n      type: `emoji:${emoji.name}`,\n      imageUrl: emoji.imageUrl,\n      label: emoji.name,\n    }));\n    return [...DEFAULT_REACTIONS, ...customReactions];\n  }, [customEmojis]);\n\n  // Get the user's current reaction from server data\n  const serverUserReaction = useMemo(\n    () => reactions.find((r) => r.userId === currentUserId)?.type ?? null,\n    [reactions, currentUserId]\n  );\n\n  // Optimistic state for the user's reaction\n  const [optimisticReaction, setOptimisticReaction] = useState<string | null>(\n    serverUserReaction\n  );\n\n  // Sync optimistic state when server data changes (after successful mutation)\n  useEffect(() => {\n    setOptimisticReaction(serverUserReaction);\n  }, [serverUserReaction]);\n\n  const toggleMutation = api.reaction.toggle.useMutation({\n    onSuccess: () => {\n      if (postId) {\n        utils.post.feed.invalidate();\n        utils.post.getById.invalidate({ id: postId });\n        utils.reaction.byPost.invalidate({ postId });\n      }\n      if (commentId) {\n        utils.comment.byPost.invalidate();\n        utils.reaction.byComment.invalidate({ commentId });\n      }\n    },\n    onError: () => {\n      // Revert to server state on error\n      setOptimisticReaction(serverUserReaction);\n    },\n  });\n\n  // Compute optimistic reactions list and counts\n  const { optimisticCount, reactionCounts } = useMemo(() => {\n    // Start with reactions from other users\n    const otherReactions = reactions.filter((r) => r.userId !== currentUserId);\n    \n    // Add optimistic user reaction if present\n    const allReactions =\n      optimisticReaction && currentUserId\n        ? [...otherReactions, { type: optimisticReaction, userId: currentUserId }]\n        : otherReactions;\n\n    // Calculate counts\n    const counts = allReactions.reduce(\n      (acc, r) => {\n        acc[r.type] = (acc[r.type] || 0) + 1;\n        return acc;\n      },\n      {} as Record<string, number>\n    );\n\n    return {\n      optimisticCount: allReactions.length,\n      reactionCounts: counts,\n    };\n  }, [reactions, currentUserId, optimisticReaction]);\n\n  const handleReaction = (type: string) => {\n    // Optimistically update\n    if (optimisticReaction === type) {\n      // Toggle off\n      setOptimisticReaction(null);\n    } else {\n      // Set new reaction (or change existing)\n      setOptimisticReaction(type);\n    }\n\n    toggleMutation.mutate({ type, postId, commentId });\n    setIsOpen(false);\n  };\n\n  const hasReactions = optimisticCount > 0;\n\n  // Helper to render a reaction icon (either Lucide icon or custom emoji)\n  const renderReactionIcon = (type: string, size: \"sm\" | \"md\" = \"md\") => {\n    const reaction = allReactions.find((r) => r.type === type);\n    if (!reaction) {\n      // Fallback for unknown reaction types\n      return <SmilePlus className={size === \"sm\" ? \"h-3 w-3\" : \"h-5 w-5\"} />;\n    }\n    \n    if (isCustomEmoji(reaction)) {\n      return (\n        <EmojiImage\n          url={reaction.imageUrl}\n          alt={reaction.label}\n          className={size === \"sm\" ? \"h-4 w-4\" : \"h-5 w-5\"}\n        />\n      );\n    }\n    \n    const Icon = reaction.icon;\n    return <Icon className={size === \"sm\" ? \"h-3 w-3\" : \"h-5 w-5\"} />;\n  };\n\n  // Get reaction label for display\n  const getReactionLabel = (type: string): string => {\n    const reaction = allReactions.find((r) => r.type === type);\n    return reaction?.label ?? type;\n  };\n\n  // Format the tooltip text for a reaction type\n  const formatReactionTooltip = (type: string): { text: string; hasMore: boolean; moreCount: number } => {\n    const users = reactionDetails?.[type] ?? [];\n    if (users.length === 0) {\n      return { text: getReactionLabel(type), hasMore: false, moreCount: 0 };\n    }\n\n    const names = users.map((u) => u.userName);\n    \n    if (names.length <= 3) {\n      return { text: names.join(\", \"), hasMore: false, moreCount: 0 };\n    }\n\n    const displayedNames = names.slice(0, 3).join(\", \");\n    const moreCount = names.length - 3;\n    return {\n      text: displayedNames,\n      hasMore: true,\n      moreCount,\n    };\n  };\n\n  const openDialogWithTab = (tab: string) => {\n    setDialogInitialTab(tab);\n    setDialogOpen(true);\n  };\n\n  return (\n    <TooltipProvider>\n      <Popover open={isOpen} onOpenChange={setIsOpen}>\n        <PopoverTrigger asChild>\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            className={cn(\n              \"gap-1 rounded-full px-2 text-muted-foreground\",\n              hasReactions && \"[&:not(:hover)]:text-primary\"\n            )}\n          >\n            {hasReactions ? (\n              <div className=\"flex gap-0.5\">\n                {Object.keys(reactionCounts)\n                  .slice(0, 3)\n                  .map((type) => (\n                    <ReactionIconWithTooltip\n                      key={type}\n                      type={type}\n                      renderIcon={renderReactionIcon}\n                      formatTooltip={formatReactionTooltip}\n                      onShowAll={() => openDialogWithTab(type)}\n                    />\n                  ))}\n              </div>\n            ) : (\n              <SmilePlus className=\"h-4 w-4\" />\n            )}\n            {optimisticCount > 0 && <span>{optimisticCount}</span>}\n          </Button>\n        </PopoverTrigger>\n        <PopoverContent className=\"w-auto p-2\" side=\"top\" align=\"start\">\n          <div className=\"flex flex-wrap gap-1 max-w-[200px]\">\n            {allReactions.map((reaction) => {\n              const userReacted = optimisticReaction === reaction.type;\n              const reactionCount = reactionCounts[reaction.type] || 0;\n\n              return (\n                <Tooltip key={reaction.type}>\n                  <TooltipTrigger asChild>\n                    <button\n                      onClick={() => handleReaction(reaction.type)}\n                      className={cn(\n                        \"flex h-10 w-10 items-center justify-center rounded-full transition-all hover:scale-110 hover:bg-muted hover:text-foreground\",\n                        userReacted && \"[&:not(:hover)]:bg-primary/10 [&:not(:hover)]:text-primary\"\n                      )}\n                    >\n                      {isCustomEmoji(reaction) ? (\n                        <EmojiImage\n                          url={reaction.imageUrl}\n                          alt={reaction.label}\n                          className=\"h-5 w-5\"\n                        />\n                      ) : (\n                        <reaction.icon className=\"h-5 w-5\" />\n                      )}\n                    </button>\n                  </TooltipTrigger>\n                  <TooltipContent>\n                    <p>\n                      {reaction.label}\n                      {reactionCount > 0 && ` (${reactionCount})`}\n                    </p>\n                  </TooltipContent>\n                </Tooltip>\n              );\n            })}\n          </div>\n        </PopoverContent>\n      </Popover>\n\n      {/* Reactions dialog */}\n      {reactionDetails && (\n        <ReactionsDialog\n          open={dialogOpen}\n          onOpenChange={setDialogOpen}\n          reactions={reactionDetails}\n          customEmojis={customEmojis}\n          initialTab={dialogInitialTab}\n        />\n      )}\n    </TooltipProvider>\n  );\n}\n\n// Separate component to handle individual reaction icon with hover tooltip\nfunction ReactionIconWithTooltip({\n  type,\n  renderIcon,\n  formatTooltip,\n  onShowAll,\n}: {\n  type: string;\n  renderIcon: (type: string, size: \"sm\" | \"md\") => React.ReactNode;\n  formatTooltip: (type: string) => { text: string; hasMore: boolean; moreCount: number };\n  onShowAll: () => void;\n}) {\n  const [tooltipOpen, setTooltipOpen] = useState(false);\n  const [hoverTimeout, setHoverTimeout] = useState<NodeJS.Timeout | null>(null);\n  const tooltip = formatTooltip(type);\n\n  const handleMouseEnter = () => {\n    const timeout = setTimeout(() => {\n      setTooltipOpen(true);\n    }, 500);\n    setHoverTimeout(timeout);\n  };\n\n  const handleMouseLeave = () => {\n    if (hoverTimeout) {\n      clearTimeout(hoverTimeout);\n      setHoverTimeout(null);\n    }\n    setTooltipOpen(false);\n  };\n\n  return (\n    <Popover open={tooltipOpen} onOpenChange={setTooltipOpen}>\n      <PopoverTrigger asChild>\n        <div\n          className=\"flex h-5 w-5 items-center justify-center\"\n          onMouseEnter={handleMouseEnter}\n          onMouseLeave={handleMouseLeave}\n        >\n          {renderIcon(type, \"sm\")}\n        </div>\n      </PopoverTrigger>\n      <PopoverContent\n        className=\"w-auto max-w-xs p-2 text-sm\"\n        side=\"top\"\n        align=\"center\"\n        onMouseEnter={() => setTooltipOpen(true)}\n        onMouseLeave={handleMouseLeave}\n        onOpenAutoFocus={(e) => e.preventDefault()}\n      >\n        <p>\n          {tooltip.text}\n          {tooltip.hasMore && (\n            <>\n              {\" and \"}\n              <button\n                className=\"font-medium text-primary hover:underline\"\n                onClick={(e) => {\n                  e.stopPropagation();\n                  setTooltipOpen(false);\n                  onShowAll();\n                }}\n              >\n                {tooltip.moreCount} {pluralize(tooltip.moreCount, \"other\")}\n              </button>\n            </>\n          )}\n        </p>\n      </PopoverContent>\n    </Popover>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/post/PostEditor.tsx",
        "size": 10961,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useCallback, useEffect, useRef, useMemo } from \"react\";\nimport { Link as LinkIcon, FolderOpen, Check, ChevronsUpDown } from \"lucide-react\";\nimport { Button } from \"~/components/ui/button\";\nimport { Input } from \"~/components/ui/input\";\nimport { Label } from \"~/components/ui/label\";\nimport { Switch } from \"~/components/ui/switch\";\nimport { Card, CardContent } from \"~/components/ui/card\";\nimport {\n  Popover,\n  PopoverContent,\n  PopoverTrigger,\n} from \"~/components/ui/popover\";\nimport {\n  Command,\n  CommandEmpty,\n  CommandGroup,\n  CommandInput,\n  CommandItem,\n  CommandList,\n} from \"~/components/ui/command\";\nimport { Editor } from \"~/components/editor/Editor\";\nimport { api } from \"~/lib/trpc/client\";\nimport type { SerializedEditorState } from \"lexical\";\nimport { cn } from \"~/lib/utils\";\n\nexport interface PostEditorData {\n  title: string;\n  content: SerializedEditorState | null;\n  liveUrl: string;\n  projects: Array<{ id: string; name: string }>;\n  hideFromHome: boolean;\n}\n\nexport interface ExtractedAttachment {\n  type: \"IMAGE\" | \"VIDEO\" | \"FILE\" | \"FIGMA\" | \"LOOM\";\n  url: string;\n  filename: string;\n  mimeType: string;\n  size: number;\n  width?: number;\n  height?: number;\n  thumbnailUrl?: string;\n  metadata?: Record<string, unknown>;\n  order: number;\n}\n\ninterface PostEditorProps {\n  initialData?: {\n    title?: string;\n    content?: SerializedEditorState | null;\n    liveUrl?: string;\n    projects?: Array<{ id: string; name: string }>;\n    hideFromHome?: boolean;\n  };\n  onChange?: (data: PostEditorData) => void;\n  editorKey?: string;\n  className?: string;\n}\n\n/**\n * Extracts attachment nodes from Lexical editor state\n */\nexport function extractAttachments(\n  content: SerializedEditorState | null\n): ExtractedAttachment[] {\n  if (!content) return [];\n\n  const attachments: ExtractedAttachment[] = [];\n  const root = content.root;\n\n  if (root && \"children\" in root && Array.isArray(root.children)) {\n    let order = 0;\n    const extract = (node: unknown): void => {\n      if (!node || typeof node !== \"object\") return;\n      const nodeObj = node as Record<string, unknown>;\n\n      if (nodeObj.type === \"attachment\") {\n        attachments.push({\n          type: nodeObj.attachmentType as ExtractedAttachment[\"type\"],\n          url: nodeObj.url as string,\n          filename: nodeObj.filename as string,\n          mimeType: nodeObj.mimeType as string,\n          size: nodeObj.size as number,\n          width: nodeObj.width as number | undefined,\n          height: nodeObj.height as number | undefined,\n          thumbnailUrl: nodeObj.thumbnailUrl as string | undefined,\n          metadata: nodeObj.metadata as Record<string, unknown> | undefined,\n          order: order++,\n        });\n      }\n\n      if (Array.isArray(nodeObj.children)) {\n        nodeObj.children.forEach(extract);\n      }\n    };\n\n    root.children.forEach(extract);\n  }\n\n  return attachments;\n}\n\nexport function PostEditor({\n  initialData,\n  onChange,\n  editorKey,\n  className,\n}: PostEditorProps) {\n  const [title, setTitle] = useState(initialData?.title || \"\");\n  const [content, setContent] = useState<SerializedEditorState | null>(\n    initialData?.content || null\n  );\n  const [liveUrl, setLiveUrl] = useState(initialData?.liveUrl || \"\");\n  const [selectedProjects, setSelectedProjects] = useState<\n    Array<{ id: string; name: string }>\n  >(initialData?.projects || []);\n  const [projectSearch, setProjectSearch] = useState(\"\");\n  const [projectsOpen, setProjectsOpen] = useState(false);\n  const [hideFromHome, setHideFromHome] = useState(initialData?.hideFromHome || false);\n\n  const titleRef = useRef<HTMLTextAreaElement>(null);\n  const isInitialMount = useRef(true);\n\n  const { data: projects } = api.project.search.useQuery(\n    { query: projectSearch || undefined },\n    { enabled: projectsOpen }\n  );\n\n  // Combine selected projects (on top) with search results, avoiding duplicates\n  const projectList = useMemo(() => {\n    const searchResults = projects || [];\n    const selectedIds = new Set(selectedProjects.map((p) => p.id));\n    const filteredResults = searchResults.filter((p) => !selectedIds.has(p.id));\n    return [...selectedProjects, ...filteredResults];\n  }, [projects, selectedProjects]);\n\n  // Button text based on selection\n  const projectButtonText = useMemo(() => {\n    if (selectedProjects.length === 0) return \"Add to project\";\n    if (selectedProjects.length === 1) return selectedProjects[0].name;\n    return `In ${selectedProjects.length} projects`;\n  }, [selectedProjects]);\n\n  // Update parent when data changes\n  useEffect(() => {\n    // Skip initial mount to avoid unnecessary callback\n    if (isInitialMount.current) {\n      isInitialMount.current = false;\n      return;\n    }\n\n    onChange?.({\n      title,\n      content,\n      liveUrl,\n      projects: selectedProjects,\n      hideFromHome,\n    });\n  }, [title, content, liveUrl, selectedProjects, hideFromHome, onChange]);\n\n  // Auto-resize title textarea on mount if it has content\n  useEffect(() => {\n    if (titleRef.current && title) {\n      titleRef.current.style.height = \"auto\";\n      titleRef.current.style.height = titleRef.current.scrollHeight + \"px\";\n    }\n  }, []);\n\n  const handleContentChange = useCallback((state: SerializedEditorState) => {\n    setContent(state);\n  }, []);\n\n  const handleTitleChange = useCallback(\n    (e: React.ChangeEvent<HTMLTextAreaElement>) => {\n      setTitle(e.target.value);\n      // Auto-resize\n      e.target.style.height = \"auto\";\n      e.target.style.height = e.target.scrollHeight + \"px\";\n    },\n    []\n  );\n\n  const toggleProject = (project: { id: string; name: string }) => {\n    const isSelected = selectedProjects.find((p) => p.id === project.id);\n    if (isSelected) {\n      setSelectedProjects(selectedProjects.filter((p) => p.id !== project.id));\n    } else {\n      setSelectedProjects([...selectedProjects, project]);\n    }\n  };\n\n  return (\n    <div className={cn(\"flex flex-1 flex-col\", className)}>\n      {/* Title */}\n      <textarea\n        ref={titleRef}\n        placeholder=\"Add a title (optional)\"\n        value={title}\n        onChange={handleTitleChange}\n        rows={1}\n        className=\"px-4 w-full resize-none border-none bg-transparent text-3xl font-semibold placeholder:text-muted-foreground/50 focus:outline-none\"\n      />\n\n      {/* Editor */}\n      <Editor\n        key={editorKey}\n        initialContent={initialData?.content}\n        onChange={handleContentChange}\n        placeholder=\"Write something, use / for commands, @ to mention...\"\n        minHeight=\"300px\"\n        showToolbar={false}\n        className=\"border-none shadow-none\"\n      />\n\n      {/* Spacer - pushes metadata to bottom when content is short */}\n      <div className=\"flex-grow\" />\n\n      {/* Post Settings */}\n      <Card className=\"mt-6\">\n        <CardContent className=\"space-y-6 pt-6\">\n          {/* Live URL */}\n          <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"liveUrl\">Live URL</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Link to a live demo or deployed version\n              </p>\n            </div>\n            <div className=\"flex items-center gap-2 sm:w-80\">\n              <LinkIcon className=\"h-4 w-4 shrink-0 text-muted-foreground\" />\n              <Input\n                id=\"liveUrl\"\n                type=\"url\"\n                placeholder=\"https://example.com\"\n                value={liveUrl}\n                onChange={(e) => setLiveUrl(e.target.value)}\n              />\n            </div>\n          </div>\n\n          {/* Projects */}\n          <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label>Projects</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Associate this post with one or more projects\n              </p>\n            </div>\n            <Popover open={projectsOpen} onOpenChange={setProjectsOpen}>\n              <PopoverTrigger asChild>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  role=\"combobox\"\n                  aria-expanded={projectsOpen}\n                  className=\"justify-between gap-2 sm:w-52\"\n                >\n                  <FolderOpen className=\"h-4 w-4 shrink-0\" />\n                  <span className=\"truncate\">{projectButtonText}</span>\n                  <ChevronsUpDown className=\"ml-auto h-3 w-3 shrink-0 opacity-50\" />\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-52 p-0\" align=\"end\">\n                <Command shouldFilter={false}>\n                  <CommandInput\n                    placeholder=\"Search projects...\"\n                    value={projectSearch}\n                    onValueChange={setProjectSearch}\n                  />\n                  <CommandList>\n                    <CommandEmpty>No projects found.</CommandEmpty>\n                    {projectList.length > 0 && (\n                      <CommandGroup>\n                        {projectList.map((project) => {\n                          const isSelected = selectedProjects.some(\n                            (p) => p.id === project.id\n                          );\n                          return (\n                            <CommandItem\n                              key={project.id}\n                              value={project.id}\n                              onSelect={() => toggleProject(project)}\n                            >\n                              <Check\n                                className={cn(\n                                  \"h-4 w-4 shrink-0\",\n                                  isSelected ? \"opacity-100\" : \"opacity-0\"\n                                )}\n                              />\n                              <FolderOpen className=\"h-4 w-4 shrink-0 text-muted-foreground\" />\n                              <span className=\"truncate\">{project.name}</span>\n                            </CommandItem>\n                          );\n                        })}\n                      </CommandGroup>\n                    )}\n                  </CommandList>\n                </Command>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Hide from Home */}\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"hideFromHome\">Hide from Home</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Post will only appear on your profile, not the Home feed\n              </p>\n            </div>\n            <Switch\n              id=\"hideFromHome\"\n              checked={hideFromHome}\n              onCheckedChange={setHideFromHome}\n            />\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/projects/ProjectDetail.tsx",
        "size": 10897,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useEffect, useRef, useCallback } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { Button } from \"~/components/ui/button\";\nimport { Badge } from \"~/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"~/components/ui/tabs\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"~/components/ui/dialog\";\nimport { api } from \"~/lib/trpc/client\";\nimport { PostCard } from \"~/components/feed/PostCard\";\nimport { GridView } from \"~/components/feed/GridView\";\nimport { formatRelativeTime, pluralize } from \"~/lib/utils\";\nimport { Link as LinkIcon, List, LayoutGrid, Loader2, FolderOpen, MoreHorizontal, Pencil, Trash2 } from \"lucide-react\";\nimport { useSession } from \"next-auth/react\";\nimport { SimpleMarkdownContent } from \"~/components/editor/SimpleMarkdownEditor\";\nimport type { SerializedEditorState } from \"lexical\";\n\n// Extract R2 key from URL\nfunction extractR2Key(url: string): string | null {\n  const urlWithoutParams = url.split('?')[0];\n  const match = urlWithoutParams?.match(/uploads\\/[^\\/]+\\/[^\\/]+$/);\n  return match ? match[0] : null;\n}\n\n// Check if URL is already a signed URL\nfunction isSignedUrl(url: string): boolean {\n  return url.includes('X-Amz-') || url.includes('x-amz-');\n}\n\n// Check if content is a Lexical editor state\nfunction isLexicalContent(content: unknown): content is SerializedEditorState {\n  if (!content || typeof content !== \"object\") return false;\n  const c = content as Record<string, unknown>;\n  return c.root !== undefined && typeof c.root === \"object\";\n}\n\n// Render project description (handles both old { text: string } and new Lexical format)\nfunction ProjectDescription({ description }: { description: unknown }) {\n  if (!description) return null;\n\n  // New Lexical format\n  if (isLexicalContent(description)) {\n    return (\n      <div className=\"mt-2\">\n        <SimpleMarkdownContent content={description} className=\"text-base\" />\n      </div>\n    );\n  }\n\n  // Old { text: string } format\n  const desc = description as { text?: string };\n  if (desc?.text) {\n    return <p className=\"mt-2 text-base\">{desc.text}</p>;\n  }\n\n  return null;\n}\n\nfunction SignedCoverImage({ url, name }: { url: string; name: string }) {\n  const alreadySigned = isSignedUrl(url);\n  const r2Key = !alreadySigned ? extractR2Key(url) : null;\n\n  const { data: signedUrlData, isLoading } = api.upload.getDownloadUrl.useQuery(\n    { key: r2Key! },\n    {\n      enabled: !!r2Key && !alreadySigned,\n      staleTime: 30 * 60 * 1000,\n      refetchOnWindowFocus: false,\n    }\n  );\n\n  const displayUrl = alreadySigned ? url : (signedUrlData?.url || url);\n\n  if (!alreadySigned && isLoading && r2Key) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center bg-muted\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <img\n      src={displayUrl}\n      alt={name}\n      className=\"h-full w-full object-cover\"\n    />\n  );\n}\n\ninterface ProjectDetailProps {\n  project: {\n    id: string;\n    name: string;\n    description: unknown;\n    coverUrl: string | null;\n    createdAt: Date;\n    createdById: string;\n    urls: Array<{\n      id: string;\n      title: string;\n      url: string;\n    }>;\n    members: Array<{\n      user: {\n        id: string;\n        displayName: string;\n        avatarUrl: string | null;\n      };\n    }>;\n    _count: {\n      posts: number;\n    };\n  };\n}\n\nexport function ProjectDetail({ project }: ProjectDetailProps) {\n  const router = useRouter();\n  const { data: session } = useSession();\n  const [viewMode, setViewMode] = useState<\"feed\" | \"grid\">(\"feed\");\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n  const loadMoreRef = useRef<HTMLDivElement>(null);\n\n  const isOwner = session?.user?.id === project.createdById;\n  const isAdmin = session?.user?.role === \"ADMIN\" || session?.user?.role === \"OWNER\";\n  const canModify = isOwner || isAdmin;\n\n  const deleteMutation = api.project.delete.useMutation({\n    onSuccess: () => {\n      router.push(\"/projects\");\n    },\n  });\n\n  const handleDelete = () => {\n    deleteMutation.mutate({ id: project.id });\n  };\n\n  const {\n    data,\n    fetchNextPage,\n    hasNextPage,\n    isFetchingNextPage,\n    isLoading,\n  } = api.post.byProject.useInfiniteQuery(\n    { projectId: project.id, limit: 10 },\n    {\n      getNextPageParam: (lastPage) => lastPage.nextCursor,\n    }\n  );\n\n  const handleObserver = useCallback(\n    (entries: IntersectionObserverEntry[]) => {\n      const [target] = entries;\n      if (target?.isIntersecting && hasNextPage && !isFetchingNextPage) {\n        fetchNextPage();\n      }\n    },\n    [fetchNextPage, hasNextPage, isFetchingNextPage]\n  );\n\n  useEffect(() => {\n    const element = loadMoreRef.current;\n    if (!element) return;\n\n    const observer = new IntersectionObserver(handleObserver, {\n      root: null,\n      rootMargin: \"100px\",\n      threshold: 0,\n    });\n\n    observer.observe(element);\n    return () => observer.disconnect();\n  }, [handleObserver]);\n\n  const posts = data?.pages.flatMap((page) => page.posts) ?? [];\n\n  return (\n    <div className=\"space-y-8\">\n      {/* Header */}\n      <header className=\"space-y-6\">\n        {project.coverUrl && (\n          <div className=\"aspect-3/1 overflow-hidden rounded-xl\">\n            <SignedCoverImage url={project.coverUrl} name={project.name} />\n          </div>\n        )}\n\n        <div className=\"flex items-start justify-between gap-4\">\n          <div className=\"flex min-w-0 flex-1 items-start gap-4\">\n            {!project.coverUrl && (\n              <div className=\"flex h-16 w-16 shrink-0 items-center justify-center rounded-xl bg-primary/10\">\n                <FolderOpen className=\"h-8 w-8 text-primary\" />\n              </div>\n            )}\n            <div className=\"space-y-1\">\n              <h1 className=\"text-3xl font-bold\">{project.name}</h1>\n              <p className=\"text-sm text-muted-foreground\">\n                Created {formatRelativeTime(new Date(project.createdAt))} ·{\" \"}\n                {project._count.posts} {pluralize(project._count.posts, \"post\")}\n              </p>\n            </div>\n          </div>\n\n          {canModify && (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\" className=\"shrink-0\">\n                  <MoreHorizontal className=\"h-5 w-5\" />\n                  <span className=\"sr-only\">Project options</span>\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem asChild>\n                  <Link href={`/projects/${project.id}/edit`} className=\"gap-2\">\n                    <Pencil className=\"h-4 w-4\" />\n                    Edit project\n                  </Link>\n                </DropdownMenuItem>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem\n                  onClick={() => setShowDeleteDialog(true)}\n                  className=\"gap-2 text-destructive focus:bg-destructive focus:text-destructive-foreground\"\n                >\n                  <Trash2 className=\"h-4 w-4\" />\n                  Delete project\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          )}\n        </div>\n\n        {/* Links */}\n        {project.urls.length > 0 && (\n          <div className=\"flex flex-wrap gap-2\">\n            {project.urls.map((url) => (\n              <a\n                key={url.id}\n                href={url.url}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n              >\n                <Badge variant=\"secondary\" className=\"gap-1.5 bg-muted py-1.5\">\n                  <LinkIcon className=\"h-3 w-3\" />\n                  {url.title}\n                </Badge>\n              </a>\n            ))}\n          </div>\n        )}\n\n        <ProjectDescription description={project.description} />\n\n        {/* Delete confirmation dialog */}\n        <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Delete project?</DialogTitle>\n              <DialogDescription>\n                This action cannot be undone. This will permanently delete the project\n                &quot;{project.name}&quot; and remove it from all posts.\n              </DialogDescription>\n            </DialogHeader>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowDeleteDialog(false)}\n                disabled={deleteMutation.isPending}\n              >\n                Cancel\n              </Button>\n              <Button\n                variant=\"destructive\"\n                onClick={handleDelete}\n                disabled={deleteMutation.isPending}\n              >\n                {deleteMutation.isPending && (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                )}\n                Delete\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </header>\n\n      {/* Posts */}\n      <section className=\"space-y-4\">\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-lg font-semibold\">Posts</h2>\n          <Tabs value={viewMode} onValueChange={(v) => setViewMode(v as \"feed\" | \"grid\")}>\n            <TabsList>\n              <TabsTrigger value=\"feed\" className=\"gap-2\">\n                <List className=\"h-4 w-4\" />\n              </TabsTrigger>\n              <TabsTrigger value=\"grid\" className=\"gap-2\">\n                <LayoutGrid className=\"h-4 w-4\" />\n              </TabsTrigger>\n            </TabsList>\n          </Tabs>\n        </div>\n\n        {isLoading ? (\n          <div className=\"flex justify-center py-8\">\n            <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n          </div>\n        ) : posts.length === 0 ? (\n          <p className=\"py-8 text-center text-sm text-muted-foreground\">\n            No posts in this project yet\n          </p>\n        ) : viewMode === \"feed\" ? (\n          <div className=\"space-y-4\">\n            {posts.map((post) => (\n              <PostCard key={post.id} post={post} />\n            ))}\n          </div>\n        ) : (\n          <GridView posts={posts} />\n        )}\n\n        <div ref={loadMoreRef} className=\"flex justify-center py-4\">\n          {isFetchingNextPage && (\n            <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n          )}\n        </div>\n      </section>\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/plugins/FloatingAddButtonPlugin.tsx",
        "size": 10469,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useEffect, useRef, useState } from \"react\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport {\n  $getSelection,\n  $isRangeSelection,\n  $createParagraphNode,\n  $getNodeByKey,\n  $isParagraphNode,\n  COMMAND_PRIORITY_LOW,\n  KEY_ARROW_DOWN_COMMAND,\n  KEY_ARROW_UP_COMMAND,\n} from \"lexical\";\nimport { createPortal } from \"react-dom\";\nimport {\n  Plus,\n  ImagePlus,\n  FileUp,\n  Heading1,\n  Heading2,\n  List,\n  ListOrdered,\n  Quote,\n  X,\n} from \"lucide-react\";\nimport { $createAttachmentNode, type AttachmentType } from \"../nodes/AttachmentNode\";\nimport { $setBlocksType } from \"@lexical/selection\";\nimport { $createHeadingNode, $createQuoteNode } from \"@lexical/rich-text\";\nimport { INSERT_ORDERED_LIST_COMMAND, INSERT_UNORDERED_LIST_COMMAND } from \"@lexical/list\";\nimport { api } from \"~/lib/trpc/client\";\nimport { cn } from \"~/lib/utils\";\n\ninterface FloatingAddButtonPluginProps {\n  anchorElem: HTMLElement;\n}\n\nexport function FloatingAddButtonPlugin({ anchorElem }: FloatingAddButtonPluginProps) {\n  const [editor] = useLexicalComposerContext();\n  const [isVisible, setIsVisible] = useState(false);\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\n  const [position, setPosition] = useState({ top: 0 });\n  const [isEmpty, setIsEmpty] = useState(false);\n  const buttonRef = useRef<HTMLDivElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const uploadMutation = api.upload.getUploadUrl.useMutation();\n\n  const updatePosition = useCallback(() => {\n    editor.getEditorState().read(() => {\n      const selection = $getSelection();\n      if (!$isRangeSelection(selection)) {\n        setIsVisible(false);\n        return;\n      }\n\n      const anchor = selection.anchor;\n      const anchorNode = anchor.getNode();\n      const topLevelElement = anchorNode.getTopLevelElement();\n\n      if (!topLevelElement) {\n        setIsVisible(false);\n        return;\n      }\n\n      // Check if the current block is empty (only for paragraphs)\n      const isEmptyParagraph = $isParagraphNode(topLevelElement) &&\n        topLevelElement.getTextContent().trim() === \"\";\n\n      setIsEmpty(isEmptyParagraph);\n\n      const key = topLevelElement.getKey();\n      const elem = editor.getElementByKey(key);\n\n      if (!elem) {\n        setIsVisible(false);\n        return;\n      }\n\n      const editorRect = anchorElem.getBoundingClientRect();\n      const elemRect = elem.getBoundingClientRect();\n\n      setPosition({\n        top: elemRect.top - editorRect.top,\n      });\n      setIsVisible(true);\n    });\n  }, [editor, anchorElem]);\n\n  useEffect(() => {\n    return editor.registerUpdateListener(({ editorState }) => {\n      editorState.read(() => {\n        updatePosition();\n      });\n    });\n  }, [editor, updatePosition]);\n\n  // Close menu when clicking outside\n  useEffect(() => {\n    if (!isMenuOpen) return;\n\n    const handleClickOutside = (e: MouseEvent) => {\n      if (buttonRef.current && !buttonRef.current.contains(e.target as Node)) {\n        setIsMenuOpen(false);\n      }\n    };\n\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, [isMenuOpen]);\n\n  const handleFileUpload = useCallback(\n    async (file: File) => {\n      setIsMenuOpen(false);\n      try {\n        const result = await uploadMutation.mutateAsync({\n          filename: file.name,\n          contentType: file.type,\n          size: file.size,\n        });\n\n        // Upload to R2\n        const uploadResponse = await fetch(result.uploadUrl, {\n          method: \"PUT\",\n          body: file,\n          headers: {\n            \"Content-Type\": file.type,\n          },\n        });\n\n        if (!uploadResponse.ok) {\n          const errorText = await uploadResponse.text();\n          console.error(\"R2 upload failed:\", uploadResponse.status, errorText);\n          alert(`Upload failed: ${uploadResponse.status} - Check CORS configuration on R2 bucket`);\n          return;\n        }\n\n        // Determine attachment type\n        let attachmentType: AttachmentType = \"FILE\";\n        if (file.type.startsWith(\"image/\")) {\n          attachmentType = \"IMAGE\";\n        } else if (file.type.startsWith(\"video/\")) {\n          attachmentType = \"VIDEO\";\n        }\n\n        // Insert attachment node\n        editor.update(() => {\n          const selection = $getSelection();\n          if ($isRangeSelection(selection)) {\n            const attachmentNode = $createAttachmentNode({\n              attachmentType,\n              url: result.publicUrl,\n              filename: file.name,\n              mimeType: file.type,\n              size: file.size,\n            });\n            selection.insertNodes([attachmentNode, $createParagraphNode()]);\n          }\n        });\n      } catch (error) {\n        console.error(\"Upload failed:\", error);\n        const message = error instanceof Error ? error.message : \"Unknown error\";\n        alert(`Upload failed: ${message}`);\n      }\n    },\n    [editor, uploadMutation]\n  );\n\n  const triggerFileInput = (accept: string) => {\n    if (fileInputRef.current) {\n      fileInputRef.current.accept = accept;\n      fileInputRef.current.click();\n    }\n  };\n\n  const insertBlock = (type: string) => {\n    setIsMenuOpen(false);\n    editor.update(() => {\n      const selection = $getSelection();\n      if (!$isRangeSelection(selection)) return;\n\n      switch (type) {\n        case \"h1\":\n          $setBlocksType(selection, () => $createHeadingNode(\"h1\"));\n          break;\n        case \"h2\":\n          $setBlocksType(selection, () => $createHeadingNode(\"h2\"));\n          break;\n        case \"bulletList\":\n          editor.dispatchCommand(INSERT_UNORDERED_LIST_COMMAND, undefined);\n          break;\n        case \"numberedList\":\n          editor.dispatchCommand(INSERT_ORDERED_LIST_COMMAND, undefined);\n          break;\n        case \"quote\":\n          $setBlocksType(selection, () => $createQuoteNode());\n          break;\n      }\n    });\n  };\n\n  if (!isVisible) return null;\n\n  return createPortal(\n    <div\n      ref={buttonRef}\n      className=\"absolute -left-5 z-10 transition-opacity\"\n      style={{ top: position.top }}\n    >\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        className=\"hidden\"\n        onChange={(e) => {\n          const file = e.target.files?.[0];\n          if (file) {\n            handleFileUpload(file);\n          }\n          e.target.value = \"\";\n        }}\n      />\n\n      <button\n        type=\"button\"\n        onClick={() => setIsMenuOpen(!isMenuOpen)}\n        className={cn(\n          \"flex h-6 w-6 items-center justify-center rounded-full border bg-background text-muted-foreground transition-all hover:bg-muted hover:text-foreground\",\n          isMenuOpen && \"rotate-45 bg-muted text-foreground\",\n          !isEmpty && \"opacity-0 hover:opacity-100\"\n        )}\n      >\n        <Plus className=\"h-4 w-4\" />\n      </button>\n\n      {isMenuOpen && (\n        <div className=\"absolute left-0 top-8 z-50 min-w-[200px] overflow-hidden rounded-lg border bg-popover p-1 shadow-lg animate-in fade-in-0 zoom-in-95\">\n          <p className=\"px-2 py-1 text-xs font-medium text-muted-foreground\">\n            Add blocks\n          </p>\n          <button\n            onClick={() => triggerFileInput(\"image/*\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <ImagePlus className=\"h-4 w-4\" />\n            </div>\n            <div className=\"text-left\">\n              <p className=\"font-medium\">Image</p>\n              <p className=\"text-xs text-muted-foreground\">Upload an image</p>\n            </div>\n          </button>\n          <button\n            onClick={() => triggerFileInput(\"*/*\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <FileUp className=\"h-4 w-4\" />\n            </div>\n            <div className=\"text-left\">\n              <p className=\"font-medium\">File</p>\n              <p className=\"text-xs text-muted-foreground\">Upload any file</p>\n            </div>\n          </button>\n          <div className=\"my-1 h-px bg-border\" />\n          <button\n            onClick={() => insertBlock(\"h1\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <Heading1 className=\"h-4 w-4\" />\n            </div>\n            <span>Heading 1</span>\n          </button>\n          <button\n            onClick={() => insertBlock(\"h2\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <Heading2 className=\"h-4 w-4\" />\n            </div>\n            <span>Heading 2</span>\n          </button>\n          <button\n            onClick={() => insertBlock(\"bulletList\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <List className=\"h-4 w-4\" />\n            </div>\n            <span>Bullet List</span>\n          </button>\n          <button\n            onClick={() => insertBlock(\"numberedList\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <ListOrdered className=\"h-4 w-4\" />\n            </div>\n            <span>Numbered List</span>\n          </button>\n          <button\n            onClick={() => insertBlock(\"quote\")}\n            className=\"flex w-full items-center gap-2 rounded-md px-2 py-1.5 text-sm hover:bg-muted\"\n          >\n            <div className=\"flex h-7 w-7 items-center justify-center rounded-md border bg-background\">\n              <Quote className=\"h-4 w-4\" />\n            </div>\n            <span>Quote</span>\n          </button>\n        </div>\n      )}\n    </div>,\n    anchorElem\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/server/api/routers/user.ts",
        "size": 10311,
        "reason": "large source sample",
        "content": "import { TRPCError } from \"@trpc/server\";\nimport { hash } from \"bcryptjs\";\nimport { z } from \"zod\";\nimport {\n  createTRPCRouter,\n  publicProcedure,\n  protectedProcedure,\n  adminProcedure,\n} from \"~/server/api/trpc\";\nimport { signUpSchema, updateProfileSchema, resetPasswordSchema } from \"~/lib/validators\";\n\n// Token expiration time: 24 hours\nconst PASSWORD_RESET_TOKEN_EXPIRY_HOURS = 24;\n\n// Extended signup schema that accepts optional invite token\nconst registerSchema = signUpSchema.extend({\n  inviteToken: z.string().optional(),\n});\n\nexport const userRouter = createTRPCRouter({\n  register: publicProcedure\n    .input(registerSchema)\n    .mutation(async ({ ctx, input }) => {\n      // Check if this is the first user (no invite needed)\n      const userCount = await ctx.db.user.count();\n      const isFirstUser = userCount === 0;\n\n      // If not first user, require valid invite token\n      if (!isFirstUser) {\n        if (!input.inviteToken) {\n          throw new TRPCError({\n            code: \"FORBIDDEN\",\n            message: \"Registration requires an invite link\",\n          });\n        }\n\n        // Validate invite token\n        const settings = await ctx.db.siteSettings.findFirst({\n          where: { inviteToken: input.inviteToken },\n        });\n\n        if (!settings) {\n          throw new TRPCError({\n            code: \"FORBIDDEN\",\n            message: \"Invalid or expired invite link\",\n          });\n        }\n      }\n\n      const existingUser = await ctx.db.user.findUnique({\n        where: { email: input.email },\n      });\n\n      if (existingUser) {\n        throw new TRPCError({\n          code: \"CONFLICT\",\n          message: \"User with this email already exists\",\n        });\n      }\n\n      const passwordHash = await hash(input.password, 12);\n\n      // First user becomes OWNER, others are MEMBER\n      const role = isFirstUser ? \"OWNER\" : \"MEMBER\";\n\n      const user = await ctx.db.user.create({\n        data: {\n          email: input.email,\n          passwordHash,\n          displayName: input.displayName,\n          role,\n        },\n        select: {\n          id: true,\n          email: true,\n          displayName: true,\n          role: true,\n        },\n      });\n\n      return { ...user, isFirstUser };\n    }),\n\n  me: protectedProcedure.query(async ({ ctx }) => {\n    const user = await ctx.db.user.findUnique({\n      where: { id: ctx.session.user.id },\n      select: {\n        id: true,\n        email: true,\n        displayName: true,\n        avatarUrl: true,\n        role: true,\n        createdAt: true,\n      },\n    });\n\n    if (!user) {\n      throw new TRPCError({ code: \"NOT_FOUND\" });\n    }\n\n    return user;\n  }),\n\n  getById: protectedProcedure\n    .input(z.object({ id: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const user = await ctx.db.user.findUnique({\n        where: { id: input.id },\n        select: {\n          id: true,\n          email: true,\n          displayName: true,\n          avatarUrl: true,\n          deactivated: true,\n          createdAt: true,\n        },\n      });\n\n      if (!user) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      return user;\n    }),\n\n  updateProfile: protectedProcedure\n    .input(updateProfileSchema)\n    .mutation(async ({ ctx, input }) => {\n      const user = await ctx.db.user.update({\n        where: { id: ctx.session.user.id },\n        data: input,\n        select: {\n          id: true,\n          email: true,\n          displayName: true,\n          avatarUrl: true,\n        },\n      });\n\n      return user;\n    }),\n\n  search: protectedProcedure\n    .input(z.object({ query: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const users = await ctx.db.user.findMany({\n        where: input.query\n          ? {\n              deactivated: false,\n              OR: [\n                { displayName: { contains: input.query, mode: \"insensitive\" } },\n                { email: { contains: input.query, mode: \"insensitive\" } },\n              ],\n            }\n          : {\n              deactivated: false,\n            },\n        select: {\n          id: true,\n          displayName: true,\n          avatarUrl: true,\n        },\n        orderBy: { displayName: \"asc\" },\n        take: 10,\n      });\n\n      return users;\n    }),\n\n  // Admin endpoints\n  list: adminProcedure\n    .input(\n      z.object({\n        cursor: z.string().optional(),\n        limit: z.number().min(1).max(100).default(50),\n      })\n    )\n    .query(async ({ ctx, input }) => {\n      const users = await ctx.db.user.findMany({\n        take: input.limit + 1,\n        cursor: input.cursor ? { id: input.cursor } : undefined,\n        orderBy: { createdAt: \"desc\" },\n        select: {\n          id: true,\n          email: true,\n          displayName: true,\n          avatarUrl: true,\n          role: true,\n          deactivated: true,\n          createdAt: true,\n        },\n      });\n\n      let nextCursor: string | undefined;\n      if (users.length > input.limit) {\n        const nextItem = users.pop();\n        nextCursor = nextItem?.id;\n      }\n\n      return { users, nextCursor };\n    }),\n\n  updateRole: adminProcedure\n    .input(\n      z.object({\n        userId: z.string(),\n        role: z.enum([\"MEMBER\", \"ADMIN\"]),\n      })\n    )\n    .mutation(async ({ ctx, input }) => {\n      // Can't change owner's role or their own role\n      const targetUser = await ctx.db.user.findUnique({\n        where: { id: input.userId },\n      });\n\n      if (!targetUser) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      if (targetUser.role === \"OWNER\") {\n        throw new TRPCError({\n          code: \"FORBIDDEN\",\n          message: \"Cannot change owner's role\",\n        });\n      }\n\n      if (input.userId === ctx.session.user.id) {\n        throw new TRPCError({\n          code: \"FORBIDDEN\",\n          message: \"Cannot change your own role\",\n        });\n      }\n\n      const user = await ctx.db.user.update({\n        where: { id: input.userId },\n        data: { role: input.role },\n        select: {\n          id: true,\n          role: true,\n        },\n      });\n\n      return user;\n    }),\n\n  setDeactivated: adminProcedure\n    .input(\n      z.object({\n        userId: z.string(),\n        deactivated: z.boolean(),\n      })\n    )\n    .mutation(async ({ ctx, input }) => {\n      // Can't deactivate owner or self\n      const targetUser = await ctx.db.user.findUnique({\n        where: { id: input.userId },\n      });\n\n      if (!targetUser) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      if (targetUser.role === \"OWNER\") {\n        throw new TRPCError({\n          code: \"FORBIDDEN\",\n          message: \"Cannot deactivate the owner account\",\n        });\n      }\n\n      if (input.userId === ctx.session.user.id) {\n        throw new TRPCError({\n          code: \"FORBIDDEN\",\n          message: \"Cannot deactivate your own account\",\n        });\n      }\n\n      const user = await ctx.db.user.update({\n        where: { id: input.userId },\n        data: { deactivated: input.deactivated },\n        select: {\n          id: true,\n          deactivated: true,\n        },\n      });\n\n      return user;\n    }),\n\n  // Password reset endpoints\n  generatePasswordResetToken: adminProcedure\n    .input(z.object({ userId: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      const targetUser = await ctx.db.user.findUnique({\n        where: { id: input.userId },\n        select: { id: true, displayName: true, email: true },\n      });\n\n      if (!targetUser) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      // Invalidate any existing unused tokens for this user\n      await ctx.db.passwordResetToken.updateMany({\n        where: {\n          userId: input.userId,\n          usedAt: null,\n        },\n        data: {\n          usedAt: new Date(), // Mark as used/expired\n        },\n      });\n\n      // Create new token\n      const expiresAt = new Date();\n      expiresAt.setHours(expiresAt.getHours() + PASSWORD_RESET_TOKEN_EXPIRY_HOURS);\n\n      const token = await ctx.db.passwordResetToken.create({\n        data: {\n          userId: input.userId,\n          expiresAt,\n        },\n      });\n\n      return {\n        token: token.id,\n        expiresAt: token.expiresAt,\n        user: targetUser,\n      };\n    }),\n\n  validatePasswordResetToken: publicProcedure\n    .input(z.object({ token: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const resetToken = await ctx.db.passwordResetToken.findUnique({\n        where: { id: input.token },\n        include: {\n          user: {\n            select: {\n              id: true,\n              displayName: true,\n              email: true,\n            },\n          },\n        },\n      });\n\n      if (!resetToken) {\n        return { valid: false, reason: \"Token not found\" };\n      }\n\n      if (resetToken.usedAt) {\n        return { valid: false, reason: \"Token has already been used\" };\n      }\n\n      if (resetToken.expiresAt < new Date()) {\n        return { valid: false, reason: \"Token has expired\" };\n      }\n\n      return {\n        valid: true,\n        user: resetToken.user,\n      };\n    }),\n\n  resetPassword: publicProcedure\n    .input(resetPasswordSchema)\n    .mutation(async ({ ctx, input }) => {\n      const resetToken = await ctx.db.passwordResetToken.findUnique({\n        where: { id: input.token },\n        include: { user: true },\n      });\n\n      if (!resetToken) {\n        throw new TRPCError({\n          code: \"NOT_FOUND\",\n          message: \"Invalid reset token\",\n        });\n      }\n\n      if (resetToken.usedAt) {\n        throw new TRPCError({\n          code: \"BAD_REQUEST\",\n          message: \"This reset link has already been used\",\n        });\n      }\n\n      if (resetToken.expiresAt < new Date()) {\n        throw new TRPCError({\n          code: \"BAD_REQUEST\",\n          message: \"This reset link has expired\",\n        });\n      }\n\n      // Hash new password\n      const passwordHash = await hash(input.password, 12);\n\n      // Update user's password and mark token as used\n      await ctx.db.$transaction([\n        ctx.db.user.update({\n          where: { id: resetToken.userId },\n          data: { passwordHash },\n        }),\n        ctx.db.passwordResetToken.update({\n          where: { id: input.token },\n          data: { usedAt: new Date() },\n        }),\n      ]);\n\n      return { success: true };\n    }),\n});\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/Command.stories.tsx",
        "size": 9845,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n} from \"./command\";\nimport { Button } from \"./button\";\nimport {\n  Calculator,\n  Calendar,\n  CreditCard,\n  Settings,\n  User,\n  Smile,\n  Search,\n  FileText,\n  Mail,\n  MessageSquare,\n} from \"lucide-react\";\nimport { useState } from \"react\";\n\nconst meta: Meta<typeof Command> = {\n  title: \"UI/Command\",\n  component: Command,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A command palette component for quick actions and search. Built on cmdk library.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof Command>;\n\nexport const Default: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Type a command or search...\" />\n      <CommandList>\n        <CommandEmpty>No results found.</CommandEmpty>\n        <CommandGroup heading=\"Suggestions\">\n          <CommandItem>\n            <Calendar className=\"mr-2 h-4 w-4\" />\n            <span>Calendar</span>\n          </CommandItem>\n          <CommandItem>\n            <Smile className=\"mr-2 h-4 w-4\" />\n            <span>Search Emoji</span>\n          </CommandItem>\n          <CommandItem>\n            <Calculator className=\"mr-2 h-4 w-4\" />\n            <span>Calculator</span>\n          </CommandItem>\n        </CommandGroup>\n        <CommandSeparator />\n        <CommandGroup heading=\"Settings\">\n          <CommandItem>\n            <User className=\"mr-2 h-4 w-4\" />\n            <span>Profile</span>\n            <CommandShortcut>⌘P</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <CreditCard className=\"mr-2 h-4 w-4\" />\n            <span>Billing</span>\n            <CommandShortcut>⌘B</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <Settings className=\"mr-2 h-4 w-4\" />\n            <span>Settings</span>\n            <CommandShortcut>⌘S</CommandShortcut>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n};\n\nexport const WithSearch: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Search documents...\" />\n      <CommandList>\n        <CommandEmpty>No documents found.</CommandEmpty>\n        <CommandGroup heading=\"Recent Documents\">\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Project Proposal.docx</span>\n          </CommandItem>\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Meeting Notes.md</span>\n          </CommandItem>\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Budget 2024.xlsx</span>\n          </CommandItem>\n        </CommandGroup>\n        <CommandSeparator />\n        <CommandGroup heading=\"Shared with me\">\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Design Guidelines.pdf</span>\n          </CommandItem>\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Brand Assets.zip</span>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Command menu configured as a document search interface.\",\n      },\n    },\n  },\n};\n\nexport const Navigation: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Go to...\" />\n      <CommandList>\n        <CommandEmpty>No pages found.</CommandEmpty>\n        <CommandGroup heading=\"Quick Navigation\">\n          <CommandItem>\n            <span className=\"mr-2\">🏠</span>\n            <span>Home</span>\n            <CommandShortcut>G H</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <span className=\"mr-2\">📊</span>\n            <span>Dashboard</span>\n            <CommandShortcut>G D</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <span className=\"mr-2\">📁</span>\n            <span>Projects</span>\n            <CommandShortcut>G P</CommandShortcut>\n          </CommandItem>\n          <CommandItem>\n            <span className=\"mr-2\">⚙️</span>\n            <span>Settings</span>\n            <CommandShortcut>G S</CommandShortcut>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Command menu for quick page navigation.\",\n      },\n    },\n  },\n};\n\nconst DialogDemo = () => {\n  const [open, setOpen] = useState(false);\n\n  return (\n    <>\n      <Button\n        variant=\"outline\"\n        onClick={() => setOpen(true)}\n        className=\"justify-between w-[250px]\"\n      >\n        <span className=\"flex items-center\">\n          <Search className=\"mr-2 h-4 w-4\" />\n          Search...\n        </span>\n        <kbd className=\"pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground\">\n          <span className=\"text-xs\">⌘</span>K\n        </kbd>\n      </Button>\n      <CommandDialog open={open} onOpenChange={setOpen}>\n        <CommandInput placeholder=\"Type a command or search...\" />\n        <CommandList>\n          <CommandEmpty>No results found.</CommandEmpty>\n          <CommandGroup heading=\"Actions\">\n            <CommandItem onSelect={() => setOpen(false)}>\n              <Mail className=\"mr-2 h-4 w-4\" />\n              <span>Compose Email</span>\n            </CommandItem>\n            <CommandItem onSelect={() => setOpen(false)}>\n              <MessageSquare className=\"mr-2 h-4 w-4\" />\n              <span>New Message</span>\n            </CommandItem>\n            <CommandItem onSelect={() => setOpen(false)}>\n              <FileText className=\"mr-2 h-4 w-4\" />\n              <span>New Document</span>\n            </CommandItem>\n          </CommandGroup>\n          <CommandSeparator />\n          <CommandGroup heading=\"Settings\">\n            <CommandItem onSelect={() => setOpen(false)}>\n              <User className=\"mr-2 h-4 w-4\" />\n              <span>Profile</span>\n              <CommandShortcut>⌘P</CommandShortcut>\n            </CommandItem>\n            <CommandItem onSelect={() => setOpen(false)}>\n              <Settings className=\"mr-2 h-4 w-4\" />\n              <span>Settings</span>\n              <CommandShortcut>⌘,</CommandShortcut>\n            </CommandItem>\n          </CommandGroup>\n        </CommandList>\n      </CommandDialog>\n    </>\n  );\n};\n\nexport const AsDialog: Story = {\n  render: () => <DialogDemo />,\n  parameters: {\n    docs: {\n      description: {\n        story:\n          \"Command menu as a modal dialog, commonly triggered by ⌘K or a search button.\",\n      },\n    },\n  },\n};\n\nexport const UserSearch: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Search users...\" />\n      <CommandList>\n        <CommandEmpty>No users found.</CommandEmpty>\n        <CommandGroup heading=\"Team Members\">\n          <CommandItem>\n            <div className=\"flex items-center\">\n              <div className=\"h-8 w-8 rounded-full bg-muted mr-2 flex items-center justify-center text-xs font-medium\">\n                JD\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">John Doe</p>\n                <p className=\"text-xs text-muted-foreground\">john@example.com</p>\n              </div>\n            </div>\n          </CommandItem>\n          <CommandItem>\n            <div className=\"flex items-center\">\n              <div className=\"h-8 w-8 rounded-full bg-muted mr-2 flex items-center justify-center text-xs font-medium\">\n                JS\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">Jane Smith</p>\n                <p className=\"text-xs text-muted-foreground\">jane@example.com</p>\n              </div>\n            </div>\n          </CommandItem>\n          <CommandItem>\n            <div className=\"flex items-center\">\n              <div className=\"h-8 w-8 rounded-full bg-muted mr-2 flex items-center justify-center text-xs font-medium\">\n                BJ\n              </div>\n              <div>\n                <p className=\"text-sm font-medium\">Bob Johnson</p>\n                <p className=\"text-xs text-muted-foreground\">bob@example.com</p>\n              </div>\n            </div>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Command menu for searching and selecting users.\",\n      },\n    },\n  },\n};\n\nexport const Disabled: Story = {\n  render: () => (\n    <Command className=\"rounded-lg border shadow-md w-[350px]\">\n      <CommandInput placeholder=\"Type a command...\" />\n      <CommandList>\n        <CommandEmpty>No results found.</CommandEmpty>\n        <CommandGroup heading=\"Actions\">\n          <CommandItem>\n            <FileText className=\"mr-2 h-4 w-4\" />\n            <span>Create Document</span>\n          </CommandItem>\n          <CommandItem disabled>\n            <Mail className=\"mr-2 h-4 w-4\" />\n            <span>Send Email (Coming Soon)</span>\n          </CommandItem>\n          <CommandItem>\n            <Settings className=\"mr-2 h-4 w-4\" />\n            <span>Settings</span>\n          </CommandItem>\n        </CommandGroup>\n      </CommandList>\n    </Command>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Command menu with a disabled item.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/app/(main)/projects/[id]/edit/page.tsx",
        "size": 9781,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useRouter, useParams } from \"next/navigation\";\nimport { Button } from \"~/components/ui/button\";\nimport { Input } from \"~/components/ui/input\";\nimport { Label } from \"~/components/ui/label\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"~/components/ui/card\";\nimport { CoverUpload } from \"~/components/projects/CoverUpload\";\nimport { SimpleMarkdownEditor } from \"~/components/editor/SimpleMarkdownEditor\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Loader2, Plus, Trash2, ArrowLeft } from \"lucide-react\";\nimport Link from \"next/link\";\nimport type { SerializedEditorState } from \"lexical\";\n\ninterface ProjectUrl {\n  title: string;\n  url: string;\n}\n\n// Check if editor state has actual content\nfunction hasContent(editorState: SerializedEditorState | null): boolean {\n  if (!editorState) return false;\n\n  const root = editorState.root;\n  if (!root || !Array.isArray(root.children)) return false;\n\n  for (const child of root.children) {\n    const childNode = child as { type: string; children?: Array<{ type: string; text?: string }> };\n    if (childNode.type === \"paragraph\" && Array.isArray(childNode.children)) {\n      for (const textNode of childNode.children) {\n        if (textNode.type === \"text\" && textNode.text?.trim()) {\n          return true;\n        }\n        // Mentions count as content\n        if (textNode.type === \"mention\") {\n          return true;\n        }\n      }\n    }\n    if (childNode.type === \"list\") {\n      return true;\n    }\n  }\n\n  return false;\n}\n\n// Check if content is a Lexical editor state\nfunction isLexicalContent(content: unknown): content is SerializedEditorState {\n  if (!content || typeof content !== \"object\") return false;\n  const c = content as Record<string, unknown>;\n  return c.root !== undefined && typeof c.root === \"object\";\n}\n\n// Convert old { text: string } format to Lexical editor state\nfunction convertOldFormatToLexical(content: unknown): SerializedEditorState | null {\n  if (!content || typeof content !== \"object\") return null;\n\n  // If it's already Lexical format, return it\n  if (isLexicalContent(content)) {\n    return content;\n  }\n\n  // Convert old { text: string } format\n  const c = content as Record<string, unknown>;\n  if (typeof c.text === \"string\" && c.text.trim()) {\n    return {\n      root: {\n        children: [\n          {\n            children: [\n              {\n                detail: 0,\n                format: 0,\n                mode: \"normal\",\n                style: \"\",\n                text: c.text,\n                type: \"text\",\n                version: 1,\n              },\n            ],\n            direction: \"ltr\",\n            format: \"\",\n            indent: 0,\n            type: \"paragraph\",\n            version: 1,\n          },\n        ],\n        direction: \"ltr\",\n        format: \"\",\n        indent: 0,\n        type: \"root\",\n        version: 1,\n      },\n    } as unknown as SerializedEditorState;\n  }\n\n  return null;\n}\n\nexport default function EditProjectPage() {\n  const router = useRouter();\n  const params = useParams();\n  const projectId = params.id as string;\n\n  const [name, setName] = useState(\"\");\n  const [description, setDescription] = useState<SerializedEditorState | null>(null);\n  const [initialDescription, setInitialDescription] = useState<SerializedEditorState | null>(null);\n  const [coverUrl, setCoverUrl] = useState<string | null>(null);\n  const [urls, setUrls] = useState<ProjectUrl[]>([]);\n  const [isInitialized, setIsInitialized] = useState(false);\n\n  const { data: project, isLoading } = api.project.getById.useQuery(\n    { id: projectId },\n    { enabled: !!projectId }\n  );\n\n  const updateMutation = api.project.update.useMutation({\n    onSuccess: () => {\n      router.push(`/projects/${projectId}`);\n    },\n  });\n\n  // Initialize form with project data\n  useEffect(() => {\n    if (project && !isInitialized) {\n      setName(project.name);\n      // Convert description to Lexical format (handles both old and new format)\n      const lexicalDesc = convertOldFormatToLexical(project.description);\n      setInitialDescription(lexicalDesc);\n      setDescription(lexicalDesc);\n      setCoverUrl(project.coverUrl);\n      setUrls(\n        project.urls.map((u) => ({\n          title: u.title,\n          url: u.url,\n        }))\n      );\n      setIsInitialized(true);\n    }\n  }, [project, isInitialized]);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!name.trim()) return;\n\n    updateMutation.mutate({\n      id: projectId,\n      name: name.trim(),\n      description: hasContent(description) ? description : null,\n      coverUrl: coverUrl,\n      urls: urls.filter((u) => u.title && u.url),\n    });\n  };\n\n  const addUrl = () => {\n    setUrls([...urls, { title: \"\", url: \"\" }]);\n  };\n\n  const updateUrl = (index: number, field: \"title\" | \"url\", value: string) => {\n    const newUrls = [...urls];\n    newUrls[index] = { ...newUrls[index]!, [field]: value };\n    setUrls(newUrls);\n  };\n\n  const removeUrl = (index: number) => {\n    setUrls(urls.filter((_, i) => i !== index));\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex justify-center py-20\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  if (!project) {\n    return (\n      <div className=\"flex flex-col items-center justify-center py-20\">\n        <p className=\"text-lg text-muted-foreground\">Project not found</p>\n        <Button asChild variant=\"link\" className=\"mt-2\">\n          <Link href=\"/projects\">Back to Projects</Link>\n        </Button>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"mx-auto max-w-2xl\">\n      <div className=\"mb-6\">\n        <Link\n          href={`/projects/${projectId}`}\n          className=\"inline-flex items-center text-sm text-muted-foreground hover:text-foreground\"\n        >\n          <ArrowLeft className=\"mr-2 h-4 w-4\" />\n          Back to project\n        </Link>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Edit Project</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleSubmit} className=\"space-y-6\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"name\">Project Name *</Label>\n              <Input\n                id=\"name\"\n                value={name}\n                onChange={(e) => setName(e.target.value)}\n                placeholder=\"My Awesome Project\"\n                required\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"description\">Description (optional)</Label>\n              <p className=\"text-xs text-muted-foreground\">\n                Supports **bold**, *italic*, [links](url), and lists\n              </p>\n              <div className=\"rounded-md border bg-background px-3 py-2 focus-within:ring-1 focus-within:ring-ring\">\n                {isInitialized && (\n                  <SimpleMarkdownEditor\n                    key={projectId} // Reset editor when project changes\n                    initialContent={initialDescription}\n                    onChange={setDescription}\n                    placeholder=\"What is this project about?\"\n                    minHeight=\"60px\"\n                  />\n                )}\n              </div>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Cover Image (optional)</Label>\n              <CoverUpload value={coverUrl} onChange={setCoverUrl} />\n            </div>\n\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <Label>Related Links</Label>\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={addUrl}\n                >\n                  <Plus className=\"mr-2 h-4 w-4\" />\n                  Add Link\n                </Button>\n              </div>\n\n              {urls.length === 0 && (\n                <p className=\"text-sm text-muted-foreground\">\n                  No links added yet\n                </p>\n              )}\n\n              {urls.map((projectUrl, index) => (\n                <div key={index} className=\"flex gap-2\">\n                  <Input\n                    placeholder=\"Link title\"\n                    value={projectUrl.title}\n                    onChange={(e) => updateUrl(index, \"title\", e.target.value)}\n                    className=\"flex-1\"\n                  />\n                  <Input\n                    type=\"url\"\n                    placeholder=\"https://...\"\n                    value={projectUrl.url}\n                    onChange={(e) => updateUrl(index, \"url\", e.target.value)}\n                    className=\"flex-2\"\n                  />\n                  <Button\n                    type=\"button\"\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    onClick={() => removeUrl(index)}\n                  >\n                    <Trash2 className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              ))}\n            </div>\n\n            <div className=\"flex gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => router.push(`/projects/${projectId}`)}\n              >\n                Cancel\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={!name.trim() || updateMutation.isPending}\n              >\n                {updateMutation.isPending && (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                )}\n                Save Changes\n              </Button>\n            </div>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/app/(main)/admin/users/page.tsx",
        "size": 8956,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  Card,\n  CardContent,\n  CardDescription,\n  CardHeader,\n  CardTitle,\n} from \"~/components/ui/card\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"~/components/ui/dialog\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport { Input } from \"~/components/ui/input\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Loader2, Copy, Check, MoreHorizontal, KeyRound, Shield, ShieldOff, UserX, UserCheck } from \"lucide-react\";\n\ninterface ResetLinkData {\n  url: string;\n  userName: string;\n  expiresAt: Date;\n}\n\nexport default function AdminUsersPage() {\n  const { data, isLoading } = api.user.list.useQuery({ limit: 50 });\n  const utils = api.useUtils();\n  const [resetLinkData, setResetLinkData] = useState<ResetLinkData | null>(null);\n  const [copied, setCopied] = useState(false);\n\n  const updateRoleMutation = api.user.updateRole.useMutation({\n    onSuccess: () => {\n      utils.user.list.invalidate();\n    },\n  });\n\n  const setDeactivatedMutation = api.user.setDeactivated.useMutation({\n    onSuccess: () => {\n      utils.user.list.invalidate();\n    },\n  });\n\n  const generateResetTokenMutation = api.user.generatePasswordResetToken.useMutation({\n    onSuccess: (data) => {\n      const baseUrl = window.location.origin;\n      const resetUrl = `${baseUrl}/reset-password/${data.token}`;\n      setResetLinkData({\n        url: resetUrl,\n        userName: data.user.displayName,\n        expiresAt: data.expiresAt,\n      });\n    },\n  });\n\n  const handleCopyLink = async () => {\n    if (resetLinkData) {\n      await navigator.clipboard.writeText(resetLinkData.url);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    }\n  };\n\n  const handleCloseDialog = () => {\n    setResetLinkData(null);\n    setCopied(false);\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardContent className=\"py-8\">\n          <div className=\"flex justify-center\">\n            <Loader2 className=\"h-6 w-6 animate-spin\" />\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <>\n      <Card>\n        <CardHeader>\n          <CardTitle>User Management</CardTitle>\n          <CardDescription>\n            Manage user roles and permissions. Users can be promoted to Admin to\n            give them access to these settings.\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"divide-y\">\n            {data?.users.map((user) => (\n              <div\n                key={user.id}\n                className=\"flex items-center justify-between py-4\"\n              >\n                <div className=\"flex items-center gap-3\">\n                  <UserAvatar avatarUrl={user.avatarUrl} name={user.displayName} />\n                  <div>\n                    <div className=\"flex items-center gap-2\">\n                      <p className=\"font-medium\">{user.displayName}</p>\n                      {user.deactivated && <DeactivatedBadge />}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">{user.email}</p>\n                  </div>\n                </div>\n                <div className=\"flex items-center gap-2\">\n                  <RoleBadge role={user.role} />\n                  {user.role !== \"OWNER\" && (\n                    <DropdownMenu>\n                      <DropdownMenuTrigger asChild>\n                        <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\">\n                          <MoreHorizontal className=\"h-4 w-4\" />\n                          <span className=\"sr-only\">Actions</span>\n                        </Button>\n                      </DropdownMenuTrigger>\n                      <DropdownMenuContent align=\"end\">\n                        {!user.deactivated && (\n                          <>\n                            <DropdownMenuItem\n                              onClick={() =>\n                                generateResetTokenMutation.mutate({ userId: user.id })\n                              }\n                              disabled={generateResetTokenMutation.isPending}\n                            >\n                              <KeyRound className=\"h-4 w-4\" />\n                              Reset Password\n                            </DropdownMenuItem>\n                            <DropdownMenuItem\n                              onClick={() =>\n                                updateRoleMutation.mutate({\n                                  userId: user.id,\n                                  role: user.role === \"ADMIN\" ? \"MEMBER\" : \"ADMIN\",\n                                })\n                              }\n                              disabled={updateRoleMutation.isPending}\n                            >\n                              {user.role === \"ADMIN\" ? (\n                                <>\n                                  <ShieldOff className=\"h-4 w-4\" />\n                                  Remove Admin\n                                </>\n                              ) : (\n                                <>\n                                  <Shield className=\"h-4 w-4\" />\n                                  Make Admin\n                                </>\n                              )}\n                            </DropdownMenuItem>\n                            <DropdownMenuSeparator />\n                          </>\n                        )}\n                        <DropdownMenuItem\n                          onClick={() =>\n                            setDeactivatedMutation.mutate({\n                              userId: user.id,\n                              deactivated: !user.deactivated,\n                            })\n                          }\n                          disabled={setDeactivatedMutation.isPending}\n                          className={user.deactivated ? \"\" : \"text-destructive focus:bg-destructive focus:text-destructive-foreground\"}\n                        >\n                          {user.deactivated ? (\n                            <>\n                              <UserCheck className=\"h-4 w-4\" />\n                              Reactivate\n                            </>\n                          ) : (\n                            <>\n                              <UserX className=\"h-4 w-4\" />\n                              Deactivate\n                            </>\n                          )}\n                        </DropdownMenuItem>\n                      </DropdownMenuContent>\n                    </DropdownMenu>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Dialog open={resetLinkData !== null} onOpenChange={(open) => !open && handleCloseDialog()}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Password Reset Link Generated</DialogTitle>\n            <DialogDescription>\n              Share this one-time link with {resetLinkData?.userName} to reset their password.\n              This link will expire in 24 hours.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"flex gap-2\">\n              <Input\n                value={resetLinkData?.url ?? \"\"}\n                readOnly\n                className=\"font-mono text-sm\"\n              />\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                onClick={handleCopyLink}\n                className=\"shrink-0\"\n              >\n                {copied ? (\n                  <Check className=\"h-4 w-4 text-green-500\" />\n                ) : (\n                  <Copy className=\"h-4 w-4\" />\n                )}\n              </Button>\n            </div>\n            <p className=\"text-sm text-muted-foreground\">\n              This link can only be used once. After the password is reset, the link becomes invalid.\n            </p>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n\nfunction RoleBadge({ role }: { role: string }) {\n  const styles = {\n    OWNER: \"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400\",\n    ADMIN: \"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400\",\n    MEMBER: \"bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-400\",\n  };\n\n  return (\n    <span\n      className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${styles[role as keyof typeof styles] || styles.MEMBER}`}\n    >\n      {role}\n    </span>\n  );\n}\n\nfunction DeactivatedBadge() {\n  return (\n    <span className=\"inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900/30 dark:text-red-400\">\n      Deactivated\n    </span>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/app/(main)/compose/page.tsx",
        "size": 8610,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState, useCallback, useEffect, useRef } from \"react\";\nimport { useRouter, useSearchParams } from \"next/navigation\";\nimport { ArrowLeft, Loader2, Trash2 } from \"lucide-react\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  PostEditor,\n  extractAttachments,\n  type PostEditorData,\n} from \"~/components/post/PostEditor\";\nimport { api } from \"~/lib/trpc/client\";\nimport type { SerializedEditorState } from \"lexical\";\n\nconst AUTOSAVE_DELAY = 1500; // 1.5 seconds debounce\n\nexport default function ComposePage() {\n  const router = useRouter();\n  const searchParams = useSearchParams();\n  const draftId = searchParams.get(\"draft\");\n\n  const [editorData, setEditorData] = useState<PostEditorData>({\n    title: \"\",\n    content: null,\n    liveUrl: \"\",\n    projects: [],\n    hideFromHome: false,\n  });\n  const [currentDraftId, setCurrentDraftId] = useState<string | null>(draftId);\n  const [isSaving, setIsSaving] = useState(false);\n  const [lastSaved, setLastSaved] = useState<Date | null>(null);\n  const [hasScrolled, setHasScrolled] = useState(false);\n\n  const autosaveTimeoutRef = useRef<NodeJS.Timeout | null>(null);\n  const isLoadedRef = useRef(false);\n  const isInitialRenderRef = useRef(true);\n  const currentDraftIdRef = useRef<string | null>(draftId);\n  // Stable key for Editor - only set once on mount to prevent remount after first save\n  const editorKeyRef = useRef<string>(draftId || \"new\");\n\n  // Load existing draft if draftId is provided\n  const { data: existingDraft, isLoading: isDraftLoading } =\n    api.draft.getById.useQuery(\n      { id: draftId! },\n      { enabled: !!draftId && !isLoadedRef.current }\n    );\n\n  // Initialize form with draft data\n  useEffect(() => {\n    if (existingDraft && !isLoadedRef.current) {\n      setEditorData({\n        title: existingDraft.title || \"\",\n        content: existingDraft.content as SerializedEditorState | null,\n        liveUrl: existingDraft.liveUrl || \"\",\n        projects: [], // Drafts don't store projects currently\n        hideFromHome: false,\n      });\n      setCurrentDraftId(existingDraft.id);\n      isLoadedRef.current = true;\n    }\n  }, [existingDraft]);\n\n  const utils = api.useUtils();\n\n  const saveDraftMutation = api.draft.save.useMutation({\n    onSuccess: (draft) => {\n      const isNewDraft = !currentDraftIdRef.current;\n      currentDraftIdRef.current = draft.id;\n      setCurrentDraftId(draft.id);\n      setLastSaved(new Date());\n      setIsSaving(false);\n      // Mark as loaded so we don't show the loading screen\n      isLoadedRef.current = true;\n      // Invalidate draft list so it appears in the menu immediately\n      utils.draft.list.invalidate();\n      // Update URL with draft ID if it's a new draft (without causing navigation)\n      if (isNewDraft && draft.id) {\n        window.history.replaceState(null, \"\", `/compose?draft=${draft.id}`);\n      }\n    },\n    onError: () => {\n      setIsSaving(false);\n    },\n  });\n\n  const deleteDraftMutation = api.draft.delete.useMutation({\n    onSuccess: () => {\n      utils.draft.list.invalidate();\n      router.push(\"/\");\n    },\n  });\n\n  const createMutation = api.post.create.useMutation({\n    onSuccess: (post) => {\n      // Delete the draft after successful publish\n      if (currentDraftId) {\n        deleteDraftMutation.mutate({ id: currentDraftId });\n      }\n      utils.draft.list.invalidate();\n      router.push(`/post/${post.id}`);\n    },\n  });\n\n  // Debounced autosave effect - watches state changes and saves after delay\n  useEffect(() => {\n    // Skip autosave on initial render\n    if (isInitialRenderRef.current) {\n      isInitialRenderRef.current = false;\n      return;\n    }\n\n    // Skip if still loading draft data\n    if (draftId && !isLoadedRef.current) {\n      return;\n    }\n\n    // Clear any existing timeout\n    if (autosaveTimeoutRef.current) {\n      clearTimeout(autosaveTimeoutRef.current);\n    }\n\n    // Only save if there's content or title\n    if (!editorData.title && !editorData.content) {\n      return;\n    }\n\n    autosaveTimeoutRef.current = setTimeout(() => {\n      setIsSaving(true);\n      saveDraftMutation.mutate({\n        id: currentDraftIdRef.current || undefined,\n        title: editorData.title || null,\n        content: editorData.content || null,\n        liveUrl: editorData.liveUrl || null,\n        projectIds: editorData.projects.map((p) => p.id),\n      });\n    }, AUTOSAVE_DELAY);\n\n    // Cleanup timeout on unmount or when dependencies change\n    return () => {\n      if (autosaveTimeoutRef.current) {\n        clearTimeout(autosaveTimeoutRef.current);\n      }\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [editorData, draftId]);\n\n  const handleEditorChange = useCallback((data: PostEditorData) => {\n    setEditorData(data);\n  }, []);\n\n  const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {\n    setHasScrolled(e.currentTarget.scrollTop > 0);\n  }, []);\n\n  const handleSubmit = () => {\n    if (!editorData.content) return;\n\n    const attachments = extractAttachments(editorData.content);\n\n    createMutation.mutate({\n      title: editorData.title || undefined,\n      content: editorData.content,\n      liveUrl: editorData.liveUrl || undefined,\n      hideFromHome: editorData.hideFromHome,\n      projectIds: editorData.projects.map((p) => p.id),\n      attachments,\n    });\n  };\n\n  const handleDeleteDraft = () => {\n    if (currentDraftId) {\n      if (confirm(\"Are you sure you want to discard this draft?\")) {\n        deleteDraftMutation.mutate({ id: currentDraftId });\n      }\n    } else {\n      router.back();\n    }\n  };\n\n  // Only show loading screen when loading an existing draft from URL (not after creating a new one)\n  if (isDraftLoading && draftId && !isLoadedRef.current) {\n    return (\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-background\">\n        <Loader2 className=\"h-8 w-8 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"fixed inset-0 z-50 flex flex-col bg-background\">\n      {/* Header */}\n      <header className={`relative z-10 flex h-14 shrink-0 items-center justify-between px-4 transition-shadow ${hasScrolled ? \"shadow-sm\" : \"\"}`}>\n        <div className=\"flex items-center gap-2\">\n          <Button\n            variant=\"ghost\"\n            size=\"icon\"\n            onClick={() => router.back()}\n            className=\"h-9 w-9\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          {currentDraftId && (\n            <Button\n              variant=\"ghost\"\n              size=\"icon\"\n              onClick={handleDeleteDraft}\n              className=\"h-9 w-9 text-muted-foreground hover:bg-destructive hover:text-destructive-foreground\"\n              disabled={deleteDraftMutation.isPending}\n            >\n              {deleteDraftMutation.isPending ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <Trash2 className=\"h-4 w-4\" />\n              )}\n            </Button>\n          )}\n        </div>\n        <div className=\"flex items-center gap-3\">\n          {/* Save indicator */}\n          <span className=\"text-xs text-muted-foreground\">\n            {isSaving ? (\n              <span className=\"flex items-center gap-1\">\n                <Loader2 className=\"h-3 w-3 animate-spin\" />\n                Saving...\n              </span>\n            ) : lastSaved ? (\n              \"Draft saved\"\n            ) : currentDraftId ? (\n              \"Draft\"\n            ) : null}\n          </span>\n          <Button\n            onClick={handleSubmit}\n            disabled={!editorData.content || createMutation.isPending}\n          >\n            {createMutation.isPending && (\n              <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n            )}\n            Publish\n          </Button>\n        </div>\n      </header>\n\n      {/* Content - scrollable */}\n      <div onScroll={handleScroll} className=\"flex-1 overflow-y-auto\">\n        <div className=\"mx-auto flex min-h-[calc(100dvh-3.5rem)] max-w-3xl flex-col px-4 py-4\">\n          <PostEditor\n            initialData={\n              existingDraft\n                ? {\n                    title: existingDraft.title || \"\",\n                    content:\n                      existingDraft.content as SerializedEditorState | null,\n                    liveUrl: existingDraft.liveUrl || \"\",\n                    projects: [],\n                  }\n                : undefined\n            }\n            onChange={handleEditorChange}\n            editorKey={editorKeyRef.current}\n          />\n        </div>\n      </div>\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/post/PostDetail.tsx",
        "size": 8582,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { useRouter } from \"next/navigation\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from \"~/components/ui/dialog\";\nimport { formatRelativeTime, pluralize } from \"~/lib/utils\";\nimport { ExternalLink, MoreHorizontal, Pencil, Trash2, Loader2, ChevronDown } from \"lucide-react\";\nimport { EditorContent } from \"~/components/editor/Editor\";\nimport { ReactionButton } from \"~/components/reactions/ReactionButton\";\nimport { api } from \"~/lib/trpc/client\";\nimport type { SerializedEditorState } from \"lexical\";\nimport { useSession } from \"next-auth/react\";\nimport { MediaLightboxProvider } from \"~/components/ui/media-lightbox-context\";\n\ninterface PostDetailProps {\n  post: {\n    id: string;\n    title: string | null;\n    content: unknown;\n    liveUrl: string | null;\n    createdAt: Date;\n    author: {\n      id: string;\n      displayName: string;\n      avatarUrl: string | null;\n    };\n    attachments: Array<{\n      id: string;\n      type: string;\n      url: string;\n      filename: string;\n      mimeType: string;\n      size: number;\n      thumbnailUrl: string | null;\n      width: number | null;\n      height: number | null;\n    }>;\n    projects: Array<{\n      project: {\n        id: string;\n        name: string;\n      };\n    }>;\n    reactions: Array<{\n      type: string;\n      userId: string;\n      user: {\n        id: string;\n        displayName: string;\n      };\n    }>;\n    _count: {\n      comments: number;\n    };\n  };\n}\n\nexport function PostDetail({ post }: PostDetailProps) {\n  const router = useRouter();\n  const { data: session } = useSession();\n  const isAuthor = session?.user?.id === post.author.id;\n  const isAdmin = session?.user?.role === \"ADMIN\" || session?.user?.role === \"OWNER\";\n  const canModify = isAuthor || isAdmin;\n  const [showDeleteDialog, setShowDeleteDialog] = useState(false);\n\n  const deleteMutation = api.post.delete.useMutation({\n    onSuccess: () => {\n      router.push(\"/\");\n    },\n  });\n\n  const handleDelete = () => {\n    deleteMutation.mutate({ id: post.id });\n  };\n\n  return (\n    <article className=\"space-y-6\">\n      {/* Header */}\n      <header className=\"space-y-4\">\n        {/* Author info */}\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Link href={`/user/${post.author.id}`}>\n              <UserAvatar avatarUrl={post.author.avatarUrl} name={post.author.displayName} className=\"h-10 w-10\" />\n            </Link>\n            <div className=\"flex flex-col\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Link\n                  href={`/user/${post.author.id}`}\n                  className=\"font-medium hover:underline\"\n                >\n                  {post.author.displayName}\n                </Link>\n                {post.projects.length > 0 && (\n                  <>\n                    <span className=\"text-muted-foreground\">·</span>\n                    {post.projects.length === 1 ? (\n                      <Link\n                        href={`/projects/${post.projects[0]?.project.id}`}\n                        className=\"text-muted-foreground hover:text-foreground hover:underline\"\n                      >\n                        in {post.projects[0]?.project.name}\n                      </Link>\n                    ) : (\n                      <DropdownMenu>\n                        <DropdownMenuTrigger className=\"flex items-center gap-1 text-muted-foreground hover:text-foreground\">\n                          in {post.projects.length} projects\n                          <ChevronDown className=\"h-3 w-3\" />\n                        </DropdownMenuTrigger>\n                        <DropdownMenuContent>\n                          {post.projects.map(({ project }) => (\n                            <DropdownMenuItem key={project.id} asChild>\n                              <Link href={`/projects/${project.id}`}>\n                                {project.name}\n                              </Link>\n                            </DropdownMenuItem>\n                          ))}\n                        </DropdownMenuContent>\n                      </DropdownMenu>\n                    )}\n                  </>\n                )}\n              </div>\n              <p className=\"text-xs text-muted-foreground\">\n                {formatRelativeTime(new Date(post.createdAt))}\n              </p>\n            </div>\n          </div>\n          {canModify && (\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button variant=\"ghost\" size=\"icon\">\n                  <MoreHorizontal className=\"h-5 w-5\" />\n                  <span className=\"sr-only\">Post options</span>\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                {isAuthor && (\n                  <DropdownMenuItem asChild>\n                    <Link href={`/post/${post.id}/edit`} className=\"gap-2\">\n                      <Pencil className=\"h-4 w-4\" />\n                      Edit post\n                    </Link>\n                  </DropdownMenuItem>\n                )}\n                {(isAuthor || isAdmin) && (\n                  <>\n                    {isAuthor && <DropdownMenuSeparator />}\n                    <DropdownMenuItem\n                      onClick={() => setShowDeleteDialog(true)}\n                      className=\"gap-2 text-destructive focus:bg-destructive focus:text-destructive-foreground\"\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                      Delete post\n                    </DropdownMenuItem>\n                  </>\n                )}\n              </DropdownMenuContent>\n            </DropdownMenu>\n          )}\n        </div>\n\n        {/* Delete confirmation dialog */}\n        <Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Delete post?</DialogTitle>\n              <DialogDescription>\n                This action cannot be undone. This will permanently delete the post\n                and all associated comments and reactions.\n              </DialogDescription>\n            </DialogHeader>\n            <DialogFooter>\n              <Button\n                variant=\"outline\"\n                onClick={() => setShowDeleteDialog(false)}\n                disabled={deleteMutation.isPending}\n              >\n                Cancel\n              </Button>\n              <Button\n                variant=\"destructive\"\n                onClick={handleDelete}\n                disabled={deleteMutation.isPending}\n              >\n                {deleteMutation.isPending && (\n                  <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />\n                )}\n                Delete\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Title */}\n        {post.title && (\n          <h1 className=\"text-3xl font-bold tracking-tight\">{post.title}</h1>\n        )}\n\n      </header>\n\n      {/* Content - attachments are rendered inline via EditorContent */}\n      <MediaLightboxProvider>\n        <div className=\"prose prose-neutral dark:prose-invert max-w-none\">\n          <EditorContent content={post.content as SerializedEditorState} />\n        </div>\n      </MediaLightboxProvider>\n\n      {/* Footer */}\n      <footer className=\"flex items-center justify-between border-t pt-4\">\n        <div className=\"flex items-center gap-4\">\n          <ReactionButton\n            postId={post.id}\n            reactions={post.reactions}\n            count={post.reactions.length}\n          />\n          <span className=\"text-sm text-muted-foreground\">\n            {post._count.comments} {pluralize(post._count.comments, \"comment\")}\n          </span>\n        </div>\n\n        {post.liveUrl && (\n          <Button variant=\"outline\" asChild>\n            <a\n              href={post.liveUrl}\n              target=\"_blank\"\n              rel=\"noopener noreferrer\"\n              className=\"gap-2\"\n            >\n              View live\n              <ExternalLink className=\"h-4 w-4\" />\n            </a>\n          </Button>\n        )}\n      </footer>\n    </article>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/search/SearchCommand.tsx",
        "size": 8488,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport * as React from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { Command } from \"cmdk\";\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\";\nimport * as VisuallyHidden from \"@radix-ui/react-visually-hidden\";\nimport { Search, FileText, FolderOpen, Loader2 } from \"lucide-react\";\nimport { cn } from \"~/lib/utils\";\nimport { api } from \"~/lib/trpc/client\";\nimport { skipToken } from \"@tanstack/react-query\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { useDebounce } from \"~/lib/hooks/useDebounce\";\n\ninterface SearchCommandProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n}\n\n// Thumbnail component with error handling\nfunction SearchThumbnail({ \n  url, \n  fallbackIcon: FallbackIcon \n}: { \n  url: string | null; \n  fallbackIcon: React.ElementType;\n}) {\n  const [hasError, setHasError] = React.useState(false);\n\n  // Reset error state when url changes\n  React.useEffect(() => {\n    setHasError(false);\n  }, [url]);\n\n  if (!url || hasError) {\n    return (\n      <div className=\"flex h-8 w-8 shrink-0 items-center justify-center rounded bg-muted\">\n        <FallbackIcon className=\"h-4 w-4 text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-8 w-8 shrink-0 overflow-hidden rounded bg-muted\">\n      {/* eslint-disable-next-line @next/next/no-img-element */}\n      <img\n        src={url}\n        alt=\"\"\n        className=\"h-full w-full object-cover\"\n        onError={() => setHasError(true)}\n      />\n    </div>\n  );\n}\n\nexport function SearchCommand({ open, onOpenChange }: SearchCommandProps) {\n  const router = useRouter();\n  const [query, setQuery] = React.useState(\"\");\n  const debouncedQuery = useDebounce(query, 300);\n\n  const { data, isLoading } = api.search.global.useQuery(\n    debouncedQuery.length > 0 ? { query: debouncedQuery } : skipToken,\n    {\n      staleTime: 1000 * 60, // 1 minute\n    }\n  );\n\n  // Reset query when closing\n  React.useEffect(() => {\n    if (!open) {\n      setQuery(\"\");\n    }\n  }, [open]);\n\n  // Handle keyboard shortcut\n  React.useEffect(() => {\n    const down = (e: KeyboardEvent) => {\n      if (e.key === \"k\" && (e.metaKey || e.ctrlKey)) {\n        e.preventDefault();\n        onOpenChange(!open);\n      }\n    };\n\n    document.addEventListener(\"keydown\", down);\n    return () => document.removeEventListener(\"keydown\", down);\n  }, [open, onOpenChange]);\n\n  const handleSelect = (href: string) => {\n    onOpenChange(false);\n    router.push(href);\n  };\n\n  const hasResults =\n    data &&\n    (data.users.length > 0 || data.posts.length > 0 || data.projects.length > 0);\n  const showEmpty = debouncedQuery.length > 0 && !isLoading && !hasResults;\n\n  return (\n    <Command.Dialog\n      open={open}\n      onOpenChange={onOpenChange}\n      label=\"Global Search\"\n      className={cn(\n        \"fixed left-1/2 top-[20%] z-50 w-full max-w-lg -translate-x-1/2\",\n        \"overflow-hidden rounded-xl border bg-background shadow-2xl\"\n      )}\n    >\n      <VisuallyHidden.Root>\n        <DialogPrimitive.Title>Search</DialogPrimitive.Title>\n      </VisuallyHidden.Root>\n      <div className=\"flex items-center border-b px-3\">\n        <Search className=\"mr-2 h-4 w-4 shrink-0 text-muted-foreground\" />\n        <Command.Input\n          value={query}\n          onValueChange={setQuery}\n          placeholder=\"Search people, posts, projects...\"\n          className=\"flex h-12 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\"\n        />\n        {isLoading && (\n          <Loader2 className=\"h-4 w-4 shrink-0 animate-spin text-muted-foreground\" />\n        )}\n      </div>\n      <Command.List className=\"max-h-[400px] overflow-y-auto p-2\">\n        {query.length === 0 && (\n          <div className=\"py-6 text-center text-sm text-muted-foreground\">\n            Start typing to search...\n          </div>\n        )}\n\n        {showEmpty && (\n          <Command.Empty className=\"py-6 text-center text-sm text-muted-foreground\">\n            No results found.\n          </Command.Empty>\n        )}\n\n        {data && data.users.length > 0 && (\n          <Command.Group className=\"mb-2\">\n            <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n              People\n            </div>\n            {data.users.map((user) => (\n              <Command.Item\n                key={user.id}\n                value={`user-${user.id}-${user.displayName}`}\n                onSelect={() => handleSelect(`/user/${user.id}`)}\n                className=\"flex cursor-pointer items-center gap-3 rounded-md px-2 py-2 text-sm outline-none aria-selected:bg-foreground/5\"\n              >\n                <UserAvatar\n                  avatarUrl={user.avatarUrl}\n                  name={user.displayName}\n                  className=\"h-8 w-8\"\n                />\n                <div className=\"flex flex-col\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className=\"font-medium\">{user.displayName}</span>\n                    {user.deactivated && (\n                      <span className=\"inline-flex items-center rounded-full bg-red-100 px-1.5 py-0.5 text-[10px] font-medium text-red-800 dark:bg-red-900/30 dark:text-red-400\">\n                        Deactivated\n                      </span>\n                    )}\n                  </div>\n                  <span className=\"text-xs text-muted-foreground\">\n                    {user.email}\n                  </span>\n                </div>\n              </Command.Item>\n            ))}\n          </Command.Group>\n        )}\n\n        {data && data.posts.length > 0 && (\n          <Command.Group className=\"mb-2\">\n            <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n              Posts\n            </div>\n            {data.posts.map((post) => (\n              <Command.Item\n                key={post.id}\n                value={`post-${post.id}-${post.title || \"untitled\"}`}\n                onSelect={() => handleSelect(`/post/${post.id}`)}\n                className=\"flex cursor-pointer items-center gap-3 rounded-md px-2 py-2 text-sm outline-none aria-selected:bg-foreground/5\"\n              >\n                <SearchThumbnail\n                  url={post.attachments[0]?.thumbnailUrl || post.attachments[0]?.url || null}\n                  fallbackIcon={FileText}\n                />\n                <div className=\"flex flex-1 flex-col overflow-hidden\">\n                  <span className=\"truncate font-medium\">\n                    {post.title || \"Untitled post\"}\n                  </span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    by {post.author.displayName}\n                  </span>\n                </div>\n              </Command.Item>\n            ))}\n          </Command.Group>\n        )}\n\n        {data && data.projects.length > 0 && (\n          <Command.Group className=\"mb-2\">\n            <div className=\"px-2 py-1.5 text-xs font-semibold text-muted-foreground\">\n              Projects\n            </div>\n            {data.projects.map((project) => (\n              <Command.Item\n                key={project.id}\n                value={`project-${project.id}-${project.name}`}\n                onSelect={() => handleSelect(`/projects/${project.id}`)}\n                className=\"flex cursor-pointer items-center gap-3 rounded-md px-2 py-2 text-sm outline-none aria-selected:bg-foreground/5\"\n              >\n                <SearchThumbnail\n                  url={project.coverUrl}\n                  fallbackIcon={FolderOpen}\n                />\n                <div className=\"flex flex-1 flex-col overflow-hidden\">\n                  <span className=\"truncate font-medium\">{project.name}</span>\n                  <span className=\"text-xs text-muted-foreground\">\n                    {project._count.posts} post{project._count.posts !== 1 ? \"s\" : \"\"}\n                  </span>\n                </div>\n              </Command.Item>\n            ))}\n          </Command.Group>\n        )}\n      </Command.List>\n      <div className=\"border-t px-3 py-2 text-xs text-muted-foreground\">\n        <kbd className=\"pointer-events-none inline-flex h-5 select-none items-center gap-1 rounded border bg-muted px-1.5 font-mono text-[10px] font-medium text-muted-foreground\">\n          <span className=\"text-xs\">⌘</span>K\n        </kbd>\n        <span className=\"ml-2\">to toggle search</span>\n      </div>\n    </Command.Dialog>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/DropdownMenu.stories.tsx",
        "size": 8258,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n} from \"./dropdown-menu\";\nimport { Button } from \"./button\";\nimport {\n  User,\n  Settings,\n  LogOut,\n  Plus,\n  Trash2,\n  Edit,\n  Copy,\n  MoreHorizontal,\n  ChevronDown,\n} from \"lucide-react\";\nimport { useState } from \"react\";\n\nconst meta: Meta<typeof DropdownMenu> = {\n  title: \"UI/DropdownMenu\",\n  component: DropdownMenu,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A dropdown menu component for displaying a list of actions or options. Built on Radix UI DropdownMenu.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof DropdownMenu>;\n\nexport const Default: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">\n          Options\n          <ChevronDown className=\"ml-2 h-4 w-4\" />\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuLabel>My Account</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem>\n          <User className=\"mr-2 h-4 w-4\" />\n          Profile\n        </DropdownMenuItem>\n        <DropdownMenuItem>\n          <Settings className=\"mr-2 h-4 w-4\" />\n          Settings\n        </DropdownMenuItem>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\">\n          <LogOut className=\"mr-2 h-4 w-4\" />\n          Log out\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n};\n\nexport const WithShortcuts: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">Edit</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuItem>\n          <Copy className=\"mr-2 h-4 w-4\" />\n          Copy\n          <DropdownMenuShortcut>⌘C</DropdownMenuShortcut>\n        </DropdownMenuItem>\n        <DropdownMenuItem>\n          <Edit className=\"mr-2 h-4 w-4\" />\n          Edit\n          <DropdownMenuShortcut>⌘E</DropdownMenuShortcut>\n        </DropdownMenuItem>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\">\n          <Trash2 className=\"mr-2 h-4 w-4\" />\n          Delete\n          <DropdownMenuShortcut>⌘⌫</DropdownMenuShortcut>\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu items with keyboard shortcuts displayed.\",\n      },\n    },\n  },\n};\n\nconst CheckboxDemo = () => {\n  const [showPanel, setShowPanel] = useState(true);\n  const [showGrid, setShowGrid] = useState(false);\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">View Options</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuLabel>Appearance</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <DropdownMenuCheckboxItem\n          checked={showPanel}\n          onCheckedChange={setShowPanel}\n        >\n          Show Panel\n        </DropdownMenuCheckboxItem>\n        <DropdownMenuCheckboxItem\n          checked={showGrid}\n          onCheckedChange={setShowGrid}\n        >\n          Show Grid\n        </DropdownMenuCheckboxItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n};\n\nexport const WithCheckboxes: Story = {\n  render: () => <CheckboxDemo />,\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu with checkbox items for toggle options.\",\n      },\n    },\n  },\n};\n\nconst RadioDemo = () => {\n  const [position, setPosition] = useState(\"bottom\");\n\n  return (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">Position</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuLabel>Panel Position</DropdownMenuLabel>\n        <DropdownMenuSeparator />\n        <DropdownMenuRadioGroup value={position} onValueChange={setPosition}>\n          <DropdownMenuRadioItem value=\"top\">Top</DropdownMenuRadioItem>\n          <DropdownMenuRadioItem value=\"bottom\">Bottom</DropdownMenuRadioItem>\n          <DropdownMenuRadioItem value=\"right\">Right</DropdownMenuRadioItem>\n        </DropdownMenuRadioGroup>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  );\n};\n\nexport const WithRadioGroup: Story = {\n  render: () => <RadioDemo />,\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu with radio items for single selection.\",\n      },\n    },\n  },\n};\n\nexport const WithSubmenu: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">Menu with Submenu</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuItem>\n          <Plus className=\"mr-2 h-4 w-4\" />\n          New Item\n        </DropdownMenuItem>\n        <DropdownMenuSub>\n          <DropdownMenuSubTrigger>\n            <User className=\"mr-2 h-4 w-4\" />\n            Invite Users\n          </DropdownMenuSubTrigger>\n          <DropdownMenuSubContent>\n            <DropdownMenuItem>Email</DropdownMenuItem>\n            <DropdownMenuItem>Message</DropdownMenuItem>\n            <DropdownMenuSeparator />\n            <DropdownMenuItem>More...</DropdownMenuItem>\n          </DropdownMenuSubContent>\n        </DropdownMenuSub>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem>\n          <Settings className=\"mr-2 h-4 w-4\" />\n          Settings\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu with nested submenus for hierarchical options.\",\n      },\n    },\n  },\n};\n\nexport const IconButton: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"ghost\" size=\"icon\">\n          <MoreHorizontal className=\"h-4 w-4\" />\n          <span className=\"sr-only\">More options</span>\n        </Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent align=\"end\">\n        <DropdownMenuItem>\n          <Edit className=\"mr-2 h-4 w-4\" />\n          Edit\n        </DropdownMenuItem>\n        <DropdownMenuItem>\n          <Copy className=\"mr-2 h-4 w-4\" />\n          Duplicate\n        </DropdownMenuItem>\n        <DropdownMenuSeparator />\n        <DropdownMenuItem className=\"text-destructive focus:bg-destructive focus:text-destructive-foreground\">\n          <Trash2 className=\"mr-2 h-4 w-4\" />\n          Delete\n        </DropdownMenuItem>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Dropdown triggered by an icon button, commonly used for row actions.\",\n      },\n    },\n  },\n};\n\nexport const WithGroups: Story = {\n  render: () => (\n    <DropdownMenu>\n      <DropdownMenuTrigger asChild>\n        <Button variant=\"outline\">Actions</Button>\n      </DropdownMenuTrigger>\n      <DropdownMenuContent className=\"w-56\">\n        <DropdownMenuGroup>\n          <DropdownMenuLabel>Edit</DropdownMenuLabel>\n          <DropdownMenuItem>Cut</DropdownMenuItem>\n          <DropdownMenuItem>Copy</DropdownMenuItem>\n          <DropdownMenuItem>Paste</DropdownMenuItem>\n        </DropdownMenuGroup>\n        <DropdownMenuSeparator />\n        <DropdownMenuGroup>\n          <DropdownMenuLabel>View</DropdownMenuLabel>\n          <DropdownMenuItem>Zoom In</DropdownMenuItem>\n          <DropdownMenuItem>Zoom Out</DropdownMenuItem>\n          <DropdownMenuItem>Reset Zoom</DropdownMenuItem>\n        </DropdownMenuGroup>\n      </DropdownMenuContent>\n    </DropdownMenu>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Menu items organized into labeled groups.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/server/api/routers/comment.ts",
        "size": 7985,
        "reason": "large source sample",
        "content": "import { TRPCError } from \"@trpc/server\";\nimport { z } from \"zod\";\nimport {\n  createTRPCRouter,\n  protectedProcedure,\n  activeUserProcedure,\n} from \"~/server/api/trpc\";\nimport { createCommentSchema, updateCommentSchema } from \"~/lib/validators\";\nimport { extractUserMentions } from \"~/lib/utils\";\n\nexport const commentRouter = createTRPCRouter({\n  create: activeUserProcedure\n    .input(createCommentSchema)\n    .mutation(async ({ ctx, input }) => {\n      // Verify post exists\n      const post = await ctx.db.post.findUnique({\n        where: { id: input.postId },\n        select: { id: true, authorId: true },\n      });\n\n      if (!post) {\n        throw new TRPCError({ code: \"NOT_FOUND\", message: \"Post not found\" });\n      }\n\n      // If replying, verify parent exists and is not already a reply\n      if (input.parentId) {\n        const parent = await ctx.db.comment.findUnique({\n          where: { id: input.parentId },\n          select: { parentId: true, authorId: true },\n        });\n\n        if (!parent) {\n          throw new TRPCError({ code: \"NOT_FOUND\", message: \"Parent comment not found\" });\n        }\n\n        // Enforce max 2 levels of nesting\n        if (parent.parentId) {\n          throw new TRPCError({\n            code: \"BAD_REQUEST\",\n            message: \"Cannot reply to a reply\",\n          });\n        }\n      }\n\n      const comment = await ctx.db.comment.create({\n        data: {\n          content: input.content,\n          postId: input.postId,\n          authorId: ctx.session.user.id,\n          parentId: input.parentId,\n          attachmentId: input.attachmentId,\n          coordinates: input.coordinates,\n        },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          replies: {\n            include: {\n              author: {\n                select: {\n                  id: true,\n                  displayName: true,\n                  avatarUrl: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Create notification for post author (if not self)\n      if (post.authorId !== ctx.session.user.id) {\n        await ctx.db.notification.create({\n          data: {\n            type: input.parentId ? \"COMMENT_REPLY\" : \"COMMENT\",\n            userId: post.authorId,\n            actorId: ctx.session.user.id,\n            postId: input.postId,\n            commentId: comment.id,\n          },\n        });\n      }\n\n      // If replying, also notify the parent comment author\n      if (input.parentId) {\n        const parent = await ctx.db.comment.findUnique({\n          where: { id: input.parentId },\n          select: { authorId: true },\n        });\n\n        if (parent && parent.authorId !== ctx.session.user.id && parent.authorId !== post.authorId) {\n          await ctx.db.notification.create({\n            data: {\n              type: \"COMMENT_REPLY\",\n              userId: parent.authorId,\n              actorId: ctx.session.user.id,\n              postId: input.postId,\n              commentId: comment.id,\n            },\n          });\n        }\n      }\n\n      // Create mention notifications\n      const mentions = extractUserMentions(input.content);\n      if (mentions.length > 0) {\n        // Collect user IDs that should NOT receive mention notifications\n        // (already notified via COMMENT or COMMENT_REPLY)\n        const excludedUserIds = new Set<string>([ctx.session.user.id]);\n        \n        // Don't send mention notification if they're already getting a comment notification\n        if (post.authorId !== ctx.session.user.id) {\n          excludedUserIds.add(post.authorId);\n        }\n\n        // Don't send mention notification to parent comment author (already notified)\n        if (input.parentId) {\n          const parent = await ctx.db.comment.findUnique({\n            where: { id: input.parentId },\n            select: { authorId: true },\n          });\n          if (parent && parent.authorId !== ctx.session.user.id) {\n            excludedUserIds.add(parent.authorId);\n          }\n        }\n\n        const mentionNotifications = mentions\n          .filter((mention) => !excludedUserIds.has(mention.userId))\n          .map((mention) => ({\n            type: \"MENTION\" as const,\n            userId: mention.userId,\n            actorId: ctx.session.user.id,\n            postId: input.postId,\n            commentId: comment.id,\n          }));\n\n        if (mentionNotifications.length > 0) {\n          await ctx.db.notification.createMany({\n            data: mentionNotifications,\n          });\n        }\n      }\n\n      return comment;\n    }),\n\n  byPost: protectedProcedure\n    .input(z.object({ postId: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const comments = await ctx.db.comment.findMany({\n        where: {\n          postId: input.postId,\n          parentId: null, // Only top-level comments\n        },\n        orderBy: { createdAt: \"asc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          replies: {\n            orderBy: { createdAt: \"asc\" },\n            include: {\n              author: {\n                select: {\n                  id: true,\n                  displayName: true,\n                  avatarUrl: true,\n                },\n              },\n              reactions: {\n                select: {\n                  type: true,\n                  userId: true,\n                },\n              },\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n        },\n      });\n\n      return comments;\n    }),\n\n  byAttachment: protectedProcedure\n    .input(z.object({ attachmentId: z.string() }))\n    .query(async ({ ctx, input }) => {\n      const comments = await ctx.db.comment.findMany({\n        where: {\n          attachmentId: input.attachmentId,\n        },\n        orderBy: { createdAt: \"asc\" },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n          reactions: {\n            select: {\n              type: true,\n              userId: true,\n            },\n          },\n        },\n      });\n\n      return comments;\n    }),\n\n  update: activeUserProcedure\n    .input(updateCommentSchema)\n    .mutation(async ({ ctx, input }) => {\n      const existingComment = await ctx.db.comment.findUnique({\n        where: { id: input.id },\n        select: { authorId: true },\n      });\n\n      if (!existingComment) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      if (existingComment.authorId !== ctx.session.user.id) {\n        throw new TRPCError({ code: \"FORBIDDEN\" });\n      }\n\n      const comment = await ctx.db.comment.update({\n        where: { id: input.id },\n        data: { content: input.content },\n        include: {\n          author: {\n            select: {\n              id: true,\n              displayName: true,\n              avatarUrl: true,\n            },\n          },\n        },\n      });\n\n      return comment;\n    }),\n\n  delete: activeUserProcedure\n    .input(z.object({ id: z.string() }))\n    .mutation(async ({ ctx, input }) => {\n      const existingComment = await ctx.db.comment.findUnique({\n        where: { id: input.id },\n        select: { authorId: true },\n      });\n\n      if (!existingComment) {\n        throw new TRPCError({ code: \"NOT_FOUND\" });\n      }\n\n      const isAdmin =\n        ctx.session.user.role === \"ADMIN\" ||\n        ctx.session.user.role === \"OWNER\";\n\n      if (existingComment.authorId !== ctx.session.user.id && !isAdmin) {\n        throw new TRPCError({ code: \"FORBIDDEN\" });\n      }\n\n      await ctx.db.comment.delete({\n        where: { id: input.id },\n      });\n\n      return { success: true };\n    }),\n});\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/SimpleMarkdownEditor.tsx",
        "size": 7742,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useEffect, useRef } from \"react\";\nimport {\n  LexicalComposer,\n  type InitialConfigType,\n} from \"@lexical/react/LexicalComposer\";\nimport { RichTextPlugin } from \"@lexical/react/LexicalRichTextPlugin\";\nimport { ContentEditable } from \"@lexical/react/LexicalContentEditable\";\nimport { HistoryPlugin } from \"@lexical/react/LexicalHistoryPlugin\";\nimport { OnChangePlugin } from \"@lexical/react/LexicalOnChangePlugin\";\nimport { LexicalErrorBoundary } from \"@lexical/react/LexicalErrorBoundary\";\nimport { MarkdownShortcutPlugin } from \"@lexical/react/LexicalMarkdownShortcutPlugin\";\nimport { ListPlugin } from \"@lexical/react/LexicalListPlugin\";\nimport { LinkPlugin } from \"@lexical/react/LexicalLinkPlugin\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport { ListItemNode, ListNode } from \"@lexical/list\";\nimport { LinkNode, AutoLinkNode } from \"@lexical/link\";\nimport {\n  BOLD_ITALIC_STAR,\n  BOLD_ITALIC_UNDERSCORE,\n  BOLD_STAR,\n  BOLD_UNDERSCORE,\n  ITALIC_STAR,\n  ITALIC_UNDERSCORE,\n  LINK,\n  ORDERED_LIST,\n  UNORDERED_LIST,\n} from \"@lexical/markdown\";\nimport type { EditorState, SerializedEditorState } from \"lexical\";\n\nimport { MentionNode } from \"./nodes/MentionNode\";\nimport { EmojiNode } from \"./nodes/EmojiNode\";\nimport { MentionPlugin } from \"./plugins/MentionPlugin\";\nimport { EmojiPlugin } from \"./plugins/EmojiPlugin\";\nimport { KeyboardShortcutsPlugin } from \"./plugins/KeyboardShortcutsPlugin\";\nimport { PasteLinkPlugin } from \"./plugins/PasteLinkPlugin\";\nimport { LinkClickPlugin } from \"./plugins/LinkClickPlugin\";\nimport { cn } from \"~/lib/utils\";\n\n// Only include the transformers we want for simple markdown\nconst SIMPLE_TRANSFORMERS = [\n  BOLD_ITALIC_STAR,\n  BOLD_ITALIC_UNDERSCORE,\n  BOLD_STAR,\n  BOLD_UNDERSCORE,\n  ITALIC_STAR,\n  ITALIC_UNDERSCORE,\n  LINK,\n  ORDERED_LIST,\n  UNORDERED_LIST,\n];\n\ninterface SimpleMarkdownEditorProps {\n  initialContent?: SerializedEditorState | null;\n  onChange?: (editorState: SerializedEditorState) => void;\n  placeholder?: string;\n  disabled?: boolean;\n  minHeight?: string;\n  className?: string;\n  autoFocus?: boolean;\n}\n\nconst theme = {\n  paragraph: \"\",\n  list: {\n    ul: \"list-disc ml-4\",\n    ol: \"list-decimal ml-4\",\n    listitem: \"\",\n  },\n  link: \"text-primary underline cursor-pointer hover:text-primary/80\",\n  text: {\n    bold: \"font-bold\",\n    italic: \"italic\",\n  },\n};\n\n// Plugin to handle submit on Enter (without shift)\nfunction SubmitOnEnterPlugin({\n  onSubmit,\n}: {\n  onSubmit?: () => void;\n}) {\n  const [editor] = useLexicalComposerContext();\n\n  useEffect(() => {\n    const handleKeyDown = (event: KeyboardEvent) => {\n      if (event.key === \"Enter\" && !event.shiftKey && onSubmit) {\n        // Check if there's an active typeahead menu (for mentions)\n        // The LexicalTypeaheadMenuPlugin adds a specific element to the DOM when active\n        const typeaheadMenu = document.querySelector('[role=\"listbox\"]');\n        if (typeaheadMenu) {\n          // Don't submit if mention dropdown is open - let the typeahead handle it\n          return;\n        }\n        \n        event.preventDefault();\n        onSubmit();\n      }\n    };\n\n    const rootElement = editor.getRootElement();\n    if (rootElement) {\n      rootElement.addEventListener(\"keydown\", handleKeyDown);\n      return () => {\n        rootElement.removeEventListener(\"keydown\", handleKeyDown);\n      };\n    }\n  }, [editor, onSubmit]);\n\n  return null;\n}\n\n// Plugin to auto-focus the editor\nfunction AutoFocusPlugin() {\n  const [editor] = useLexicalComposerContext();\n\n  useEffect(() => {\n    editor.focus();\n  }, [editor]);\n\n  return null;\n}\n\n// Internal editor component with ref access\nfunction SimpleMarkdownEditorInner({\n  initialContent,\n  onChange,\n  placeholder = \"Write something...\",\n  disabled = false,\n  minHeight = \"60px\",\n  className,\n  autoFocus = false,\n  onSubmit,\n  editorRef,\n}: SimpleMarkdownEditorProps & {\n  onSubmit?: () => void;\n  editorRef?: React.MutableRefObject<{ clear: () => void } | null>;\n}) {\n  const handleChange = useCallback(\n    (editorState: EditorState) => {\n      if (onChange) {\n        onChange(editorState.toJSON());\n      }\n    },\n    [onChange]\n  );\n\n  const initialConfig: InitialConfigType = {\n    namespace: \"SimpleMarkdownEditor\",\n    theme,\n    onError: (error: Error) => {\n      console.error(\"SimpleMarkdownEditor error:\", error);\n    },\n    nodes: [ListNode, ListItemNode, LinkNode, AutoLinkNode, MentionNode, EmojiNode],\n    editorState: initialContent ? JSON.stringify(initialContent) : undefined,\n    editable: !disabled,\n  };\n\n  return (\n    <LexicalComposer initialConfig={initialConfig}>\n      <div className={cn(\"simple-markdown-editor relative\", className)}>\n        <RichTextPlugin\n          contentEditable={\n            <ContentEditable\n              className={cn(\n                \"outline-none text-sm\",\n                disabled && \"opacity-50 cursor-not-allowed\"\n              )}\n              style={{ minHeight }}\n            />\n          }\n          placeholder={\n            <div\n              className=\"pointer-events-none absolute left-0 top-0 text-sm text-muted-foreground\"\n              style={{ minHeight }}\n            >\n              {placeholder}\n            </div>\n          }\n          ErrorBoundary={LexicalErrorBoundary}\n        />\n        <HistoryPlugin />\n        <ListPlugin />\n        <LinkPlugin />\n        <MarkdownShortcutPlugin transformers={SIMPLE_TRANSFORMERS} />\n        <OnChangePlugin onChange={handleChange} />\n        {!disabled && <KeyboardShortcutsPlugin />}\n        {!disabled && <PasteLinkPlugin />}\n        <LinkClickPlugin />\n        {!disabled && <MentionPlugin />}\n        {!disabled && <EmojiPlugin />}\n        {!disabled && onSubmit && <SubmitOnEnterPlugin onSubmit={onSubmit} />}\n        {autoFocus && <AutoFocusPlugin />}\n        {editorRef && <EditorRefPlugin editorRef={editorRef} />}\n      </div>\n    </LexicalComposer>\n  );\n}\n\n// Plugin to expose editor methods via ref\nfunction EditorRefPlugin({\n  editorRef,\n}: {\n  editorRef: React.MutableRefObject<{ clear: () => void } | null>;\n}) {\n  const [editor] = useLexicalComposerContext();\n\n  useEffect(() => {\n    editorRef.current = {\n      clear: () => {\n        editor.update(() => {\n          const root = editor.getRootElement();\n          if (root) {\n            editor.setEditorState(editor.parseEditorState('{\"root\":{\"children\":[{\"children\":[],\"direction\":null,\"format\":\"\",\"indent\":0,\"type\":\"paragraph\",\"version\":1}],\"direction\":null,\"format\":\"\",\"indent\":0,\"type\":\"root\",\"version\":1}}'));\n          }\n        });\n      },\n    };\n  }, [editor, editorRef]);\n\n  return null;\n}\n\nexport function SimpleMarkdownEditor(\n  props: SimpleMarkdownEditorProps & {\n    onSubmit?: () => void;\n    editorRef?: React.MutableRefObject<{ clear: () => void } | null>;\n  }\n) {\n  return <SimpleMarkdownEditorInner {...props} />;\n}\n\n// Read-only version for displaying content\nexport function SimpleMarkdownContent({\n  content,\n  className,\n}: {\n  content: SerializedEditorState;\n  className?: string;\n}) {\n  const initialConfig: InitialConfigType = {\n    namespace: \"SimpleMarkdownContent\",\n    theme,\n    onError: (error: Error) => {\n      console.error(\"SimpleMarkdownContent error:\", error);\n    },\n    nodes: [ListNode, ListItemNode, LinkNode, AutoLinkNode, MentionNode, EmojiNode],\n    editorState: JSON.stringify(content),\n    editable: false,\n  };\n\n  return (\n    <LexicalComposer initialConfig={initialConfig}>\n      <RichTextPlugin\n        contentEditable={\n          <ContentEditable className={cn(\"outline-none text-sm\", className)} />\n        }\n        placeholder={null}\n        ErrorBoundary={LexicalErrorBoundary}\n      />\n      <LinkClickPlugin />\n    </LexicalComposer>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/Tabs.stories.tsx",
        "size": 7719,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"./tabs\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"./card\";\nimport { Input } from \"./input\";\nimport { Label } from \"./label\";\nimport { Button } from \"./button\";\n\nconst meta: Meta<typeof Tabs> = {\n  title: \"UI/Tabs\",\n  component: Tabs,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A tabs component for switching between different views or content sections. Built on Radix UI Tabs.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof Tabs>;\n\nexport const Default: Story = {\n  render: () => (\n    <Tabs defaultValue=\"account\" className=\"w-[400px]\">\n      <TabsList>\n        <TabsTrigger value=\"account\">Account</TabsTrigger>\n        <TabsTrigger value=\"password\">Password</TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"account\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Account</CardTitle>\n            <CardDescription>\n              Make changes to your account here.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <div className=\"space-y-1\">\n              <Label htmlFor=\"name\">Name</Label>\n              <Input id=\"name\" defaultValue=\"John Doe\" />\n            </div>\n            <div className=\"space-y-1\">\n              <Label htmlFor=\"username\">Username</Label>\n              <Input id=\"username\" defaultValue=\"@johndoe\" />\n            </div>\n          </CardContent>\n        </Card>\n      </TabsContent>\n      <TabsContent value=\"password\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Password</CardTitle>\n            <CardDescription>\n              Change your password here.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-2\">\n            <div className=\"space-y-1\">\n              <Label htmlFor=\"current\">Current password</Label>\n              <Input id=\"current\" type=\"password\" />\n            </div>\n            <div className=\"space-y-1\">\n              <Label htmlFor=\"new\">New password</Label>\n              <Input id=\"new\" type=\"password\" />\n            </div>\n          </CardContent>\n        </Card>\n      </TabsContent>\n    </Tabs>\n  ),\n};\n\nexport const Simple: Story = {\n  render: () => (\n    <Tabs defaultValue=\"overview\" className=\"w-[400px]\">\n      <TabsList>\n        <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n        <TabsTrigger value=\"analytics\">Analytics</TabsTrigger>\n        <TabsTrigger value=\"reports\">Reports</TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"overview\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Overview content goes here. This is the main dashboard view.\n        </p>\n      </TabsContent>\n      <TabsContent value=\"analytics\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Analytics data and charts would be displayed here.\n        </p>\n      </TabsContent>\n      <TabsContent value=\"reports\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Report generation and export options.\n        </p>\n      </TabsContent>\n    </Tabs>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Simple tabs with text content.\",\n      },\n    },\n  },\n};\n\nexport const FullWidth: Story = {\n  render: () => (\n    <Tabs defaultValue=\"all\" className=\"w-[500px]\">\n      <TabsList className=\"w-full\">\n        <TabsTrigger value=\"all\" className=\"flex-1\">All</TabsTrigger>\n        <TabsTrigger value=\"active\" className=\"flex-1\">Active</TabsTrigger>\n        <TabsTrigger value=\"draft\" className=\"flex-1\">Draft</TabsTrigger>\n        <TabsTrigger value=\"archived\" className=\"flex-1\">Archived</TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"all\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Showing all items (24 total)\n        </p>\n      </TabsContent>\n      <TabsContent value=\"active\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Showing active items (12 total)\n        </p>\n      </TabsContent>\n      <TabsContent value=\"draft\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Showing draft items (8 total)\n        </p>\n      </TabsContent>\n      <TabsContent value=\"archived\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          Showing archived items (4 total)\n        </p>\n      </TabsContent>\n    </Tabs>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Tabs with full-width triggers that expand to fill the container.\",\n      },\n    },\n  },\n};\n\nexport const Disabled: Story = {\n  render: () => (\n    <Tabs defaultValue=\"tab1\" className=\"w-[400px]\">\n      <TabsList>\n        <TabsTrigger value=\"tab1\">Available</TabsTrigger>\n        <TabsTrigger value=\"tab2\">Also Available</TabsTrigger>\n        <TabsTrigger value=\"tab3\" disabled>\n          Coming Soon\n        </TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"tab1\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          This tab is available and accessible.\n        </p>\n      </TabsContent>\n      <TabsContent value=\"tab2\" className=\"mt-4\">\n        <p className=\"text-sm text-muted-foreground\">\n          This tab is also available.\n        </p>\n      </TabsContent>\n    </Tabs>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Tabs with a disabled trigger for unavailable options.\",\n      },\n    },\n  },\n};\n\nexport const WithForms: Story = {\n  render: () => (\n    <Tabs defaultValue=\"signup\" className=\"w-[400px]\">\n      <TabsList className=\"grid w-full grid-cols-2\">\n        <TabsTrigger value=\"signup\">Sign Up</TabsTrigger>\n        <TabsTrigger value=\"login\">Log In</TabsTrigger>\n      </TabsList>\n      <TabsContent value=\"signup\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Create Account</CardTitle>\n            <CardDescription>\n              Enter your details to create a new account.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"email\">Email</Label>\n              <Input id=\"email\" type=\"email\" placeholder=\"name@example.com\" />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"password\">Password</Label>\n              <Input id=\"password\" type=\"password\" />\n            </div>\n            <Button className=\"w-full\">Create Account</Button>\n          </CardContent>\n        </Card>\n      </TabsContent>\n      <TabsContent value=\"login\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Welcome Back</CardTitle>\n            <CardDescription>\n              Enter your credentials to sign in.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"login-email\">Email</Label>\n              <Input id=\"login-email\" type=\"email\" placeholder=\"name@example.com\" />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"login-password\">Password</Label>\n              <Input id=\"login-password\" type=\"password\" />\n            </div>\n            <Button className=\"w-full\">Sign In</Button>\n          </CardContent>\n        </Card>\n      </TabsContent>\n    </Tabs>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Tabs switching between sign up and login forms.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/lib/webhooks.ts",
        "size": 7562,
        "reason": "large source sample",
        "content": "/**\n * Webhook integrations for Discord and Slack\n * Sends notifications when new posts are created\n */\n\nimport { getWebhookImageUrl } from \"./r2\";\n\n// Extract R2 key from URL\nfunction extractR2Key(url: string): string | null {\n  const match = url.match(/uploads\\/[^\\/]+\\/[^\\/]+$/);\n  return match ? match[0] : null;\n}\n\n// Get a signed URL for webhook images (valid for 7 days)\nasync function getSignedImageUrl(url: string | null): Promise<string | null> {\n  if (!url) return null;\n  \n  const r2Key = extractR2Key(url);\n  if (!r2Key) return url; // Not an R2 URL, return as-is\n  \n  try {\n    return await getWebhookImageUrl(r2Key);\n  } catch (error) {\n    console.error(\"Failed to sign image URL for webhook:\", error);\n    return null;\n  }\n}\n\ninterface PostData {\n  id: string;\n  title: string | null;\n  content: unknown;\n  author: {\n    displayName: string;\n    avatarUrl: string | null;\n  };\n  attachments: {\n    type: string;\n    url: string;\n    thumbnailUrl: string | null;\n  }[];\n  projects: {\n    project: {\n      name: string;\n    };\n  }[];\n}\n\n/**\n * Extract plain text from Lexical JSON content\n */\nfunction extractTextFromContent(content: unknown): string {\n  if (!content || typeof content !== \"object\") return \"\";\n  \n  const root = content as { root?: { children?: unknown[] } };\n  if (!root.root?.children) return \"\";\n\n  const extractText = (nodes: unknown[]): string => {\n    return nodes\n      .map((node) => {\n        const n = node as { type?: string; text?: string; children?: unknown[] };\n        if (n.type === \"text\" && n.text) {\n          return n.text;\n        }\n        if (n.children && Array.isArray(n.children)) {\n          return extractText(n.children);\n        }\n        return \"\";\n      })\n      .join(\" \");\n  };\n\n  return extractText(root.root.children).trim();\n}\n\n/**\n * Send a notification to Discord via webhook\n */\nexport async function sendDiscordWebhook(\n  webhookUrl: string,\n  post: PostData,\n  baseUrl: string\n): Promise<boolean> {\n  try {\n    const postUrl = `${baseUrl}/post/${post.id}`;\n    const description = extractTextFromContent(post.content);\n    const projectNames = post.projects.map((p) => p.project.name).join(\", \");\n    \n    // Find the first image attachment for the embed\n    const imageAttachment = post.attachments.find((a) => a.type === \"IMAGE\");\n    const rawImageUrl = imageAttachment?.thumbnailUrl || imageAttachment?.url || null;\n    \n    // Get signed URLs for the image and avatar (valid for 7 days)\n    const [signedImageUrl, signedAvatarUrl] = await Promise.all([\n      getSignedImageUrl(rawImageUrl),\n      getSignedImageUrl(post.author.avatarUrl),\n    ]);\n\n    // Draftboard bot identity\n    const botAvatarUrl = `${baseUrl}/avatar.png`;\n\n    const embed: Record<string, unknown> = {\n      title: post.title || \"New Design Post\",\n      description: description.slice(0, 300) + (description.length > 300 ? \"...\" : \"\"),\n      url: postUrl,\n      color: 0x7c3aed, // Purple color\n      author: {\n        name: post.author.displayName,\n        icon_url: signedAvatarUrl || undefined,\n      },\n      timestamp: new Date().toISOString(),\n    };\n\n    if (projectNames) {\n      embed.fields = [\n        {\n          name: \"Projects\",\n          value: projectNames,\n          inline: true,\n        },\n      ];\n    }\n\n    if (signedImageUrl) {\n      embed.image = { url: signedImageUrl };\n    }\n\n    const response = await fetch(webhookUrl, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        username: \"Draftboard\",\n        avatar_url: botAvatarUrl,\n        embeds: [embed],\n      }),\n    });\n\n    if (!response.ok) {\n      console.error(`Discord webhook failed: ${response.status} ${response.statusText}`);\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error(\"Discord webhook error:\", error);\n    return false;\n  }\n}\n\n/**\n * Send a notification to Slack via webhook\n */\nexport async function sendSlackWebhook(\n  webhookUrl: string,\n  post: PostData,\n  baseUrl: string\n): Promise<boolean> {\n  try {\n    const postUrl = `${baseUrl}/post/${post.id}`;\n    const description = extractTextFromContent(post.content);\n    const projectNames = post.projects.map((p) => p.project.name).join(\", \");\n    \n    // Draftboard bot identity\n    const botAvatarUrl = `${baseUrl}/avatar.png`;\n    \n    // Find the first image attachment for the preview\n    const imageAttachment = post.attachments.find((a) => a.type === \"IMAGE\");\n    const rawImageUrl = imageAttachment?.thumbnailUrl || imageAttachment?.url || null;\n    \n    // Get signed URLs for the image and avatar (valid for 7 days)\n    const [imageUrl, signedAvatarUrl] = await Promise.all([\n      getSignedImageUrl(rawImageUrl),\n      getSignedImageUrl(post.author.avatarUrl),\n    ]);\n\n    const blocks: Record<string, unknown>[] = [\n      {\n        type: \"section\",\n        text: {\n          type: \"mrkdwn\",\n          text: `*<${postUrl}|${post.title || \"New Design Post\"}>*`,\n        },\n      },\n      {\n        type: \"context\",\n        elements: [\n          ...(signedAvatarUrl\n            ? [\n                {\n                  type: \"image\",\n                  image_url: signedAvatarUrl,\n                  alt_text: post.author.displayName,\n                },\n              ]\n            : []),\n          {\n            type: \"mrkdwn\",\n            text: `Posted by *${post.author.displayName}*${projectNames ? ` in ${projectNames}` : \"\"}`,\n          },\n        ],\n      },\n    ];\n\n    if (description) {\n      blocks.push({\n        type: \"section\",\n        text: {\n          type: \"plain_text\",\n          text: description.slice(0, 300) + (description.length > 300 ? \"...\" : \"\"),\n          emoji: true,\n        },\n      });\n    }\n\n    if (imageUrl) {\n      blocks.push({\n        type: \"image\",\n        image_url: imageUrl,\n        alt_text: post.title || \"Design preview\",\n      });\n    }\n\n    blocks.push({\n      type: \"actions\",\n      elements: [\n        {\n          type: \"button\",\n          text: {\n            type: \"plain_text\",\n            text: \"View Post\",\n            emoji: true,\n          },\n          url: postUrl,\n          style: \"primary\",\n        },\n      ],\n    });\n\n    const response = await fetch(webhookUrl, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        username: \"Draftboard\",\n        icon_url: botAvatarUrl,\n        blocks,\n      }),\n    });\n\n    if (!response.ok) {\n      console.error(`Slack webhook failed: ${response.status} ${response.statusText}`);\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    console.error(\"Slack webhook error:\", error);\n    return false;\n  }\n}\n\n/**\n * Send notifications to all configured webhooks\n */\nexport async function sendPostNotifications(\n  post: PostData,\n  settings: { discordWebhookUrl: string | null; slackWebhookUrl: string | null },\n  baseUrl: string\n): Promise<void> {\n  const promises: Promise<boolean>[] = [];\n\n  if (settings.discordWebhookUrl) {\n    promises.push(sendDiscordWebhook(settings.discordWebhookUrl, post, baseUrl));\n  }\n\n  if (settings.slackWebhookUrl) {\n    promises.push(sendSlackWebhook(settings.slackWebhookUrl, post, baseUrl));\n  }\n\n  if (promises.length > 0) {\n    // Fire and forget - don't block the response\n    Promise.allSettled(promises).then((results) => {\n      results.forEach((result, index) => {\n        if (result.status === \"rejected\") {\n          console.error(`Webhook ${index} failed:`, result.reason);\n        }\n      });\n    });\n  }\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/dropdown-menu.tsx",
        "size": 7449,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport * as React from \"react\";\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\";\nimport { Check, ChevronRight, Circle } from \"lucide-react\";\nimport { cn } from \"~/lib/utils\";\n\nconst DropdownMenu = DropdownMenuPrimitive.Root;\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger;\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group;\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal;\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub;\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup;\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean;\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n));\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName;\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n      className\n    )}\n    {...props}\n  />\n));\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName;\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md\",\n        \"data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n));\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName;\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean;\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&>svg]:size-4 [&>svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n));\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName;\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n));\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName;\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n));\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName;\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean;\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n));\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName;\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n));\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName;\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  );\n};\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\";\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n};\n",
        "truncated": false
      },
      {
        "path": "src/lib/validators.test.ts",
        "size": 7349,
        "reason": "large source sample",
        "content": "import { describe, it, expect } from \"vitest\";\nimport {\n  signUpSchema,\n  signInSchema,\n  updateProfileSchema,\n  createPostSchema,\n  createCommentSchema,\n  toggleReactionSchema,\n  createProjectSchema,\n  paginationSchema,\n  presignedUrlSchema,\n  createEmojiSchema,\n} from \"./validators\";\n\ndescribe(\"signUpSchema\", () => {\n  it(\"should validate valid sign up data\", () => {\n    const result = signUpSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"password123\",\n      displayName: \"John Doe\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject invalid email\", () => {\n    const result = signUpSchema.safeParse({\n      email: \"invalid-email\",\n      password: \"password123\",\n      displayName: \"John Doe\",\n    });\n    expect(result.success).toBe(false);\n  });\n\n  it(\"should reject short password\", () => {\n    const result = signUpSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"short\",\n      displayName: \"John Doe\",\n    });\n    expect(result.success).toBe(false);\n  });\n\n  it(\"should reject short display name\", () => {\n    const result = signUpSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"password123\",\n      displayName: \"J\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"signInSchema\", () => {\n  it(\"should validate valid sign in data\", () => {\n    const result = signInSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"password\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject empty password\", () => {\n    const result = signInSchema.safeParse({\n      email: \"test@example.com\",\n      password: \"\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"updateProfileSchema\", () => {\n  it(\"should validate partial updates\", () => {\n    const result = updateProfileSchema.safeParse({\n      displayName: \"New Name\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate avatar URL\", () => {\n    const result = updateProfileSchema.safeParse({\n      avatarUrl: \"https://example.com/avatar.jpg\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should allow null avatar URL\", () => {\n    const result = updateProfileSchema.safeParse({\n      avatarUrl: null,\n    });\n    expect(result.success).toBe(true);\n  });\n});\n\ndescribe(\"createPostSchema\", () => {\n  it(\"should validate minimal post\", () => {\n    const result = createPostSchema.safeParse({\n      content: { root: {} },\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate post with all fields\", () => {\n    const result = createPostSchema.safeParse({\n      title: \"My Post\",\n      content: { root: {} },\n      liveUrl: \"https://example.com\",\n      projectIds: [\"proj1\", \"proj2\"],\n      attachments: [\n        {\n          type: \"IMAGE\",\n          url: \"https://example.com/image.jpg\",\n          filename: \"image.jpg\",\n          mimeType: \"image/jpeg\",\n          size: 1000,\n          order: 0,\n        },\n      ],\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject invalid attachment type\", () => {\n    const result = createPostSchema.safeParse({\n      content: { root: {} },\n      attachments: [\n        {\n          type: \"INVALID\",\n          url: \"https://example.com/file\",\n          filename: \"file.txt\",\n          mimeType: \"text/plain\",\n          size: 100,\n          order: 0,\n        },\n      ],\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"createCommentSchema\", () => {\n  it(\"should validate basic comment\", () => {\n    const result = createCommentSchema.safeParse({\n      postId: \"post123\",\n      content: { root: {} },\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate reply comment\", () => {\n    const result = createCommentSchema.safeParse({\n      postId: \"post123\",\n      content: { root: {} },\n      parentId: \"comment456\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate attachment comment\", () => {\n    const result = createCommentSchema.safeParse({\n      postId: \"post123\",\n      content: { root: {} },\n      attachmentId: \"att789\",\n      coordinates: { x: 100, y: 200 },\n    });\n    expect(result.success).toBe(true);\n  });\n});\n\ndescribe(\"toggleReactionSchema\", () => {\n  it(\"should validate reaction on post\", () => {\n    const result = toggleReactionSchema.safeParse({\n      type: \"like\",\n      postId: \"post123\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate reaction on comment\", () => {\n    const result = toggleReactionSchema.safeParse({\n      type: \"wow\",\n      commentId: \"comment456\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject reaction without target\", () => {\n    const result = toggleReactionSchema.safeParse({\n      type: \"like\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"createProjectSchema\", () => {\n  it(\"should validate minimal project\", () => {\n    const result = createProjectSchema.safeParse({\n      name: \"My Project\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should validate project with URLs\", () => {\n    const result = createProjectSchema.safeParse({\n      name: \"My Project\",\n      urls: [\n        { title: \"Brief\", url: \"https://docs.google.com/brief\" },\n      ],\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject empty name\", () => {\n    const result = createProjectSchema.safeParse({\n      name: \"\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"paginationSchema\", () => {\n  it(\"should use default values\", () => {\n    const result = paginationSchema.parse({});\n    expect(result.limit).toBe(20);\n    expect(result.cursor).toBeUndefined();\n  });\n\n  it(\"should validate cursor\", () => {\n    const result = paginationSchema.safeParse({\n      cursor: \"cursor123\",\n      limit: 10,\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject invalid limit\", () => {\n    const result = paginationSchema.safeParse({\n      limit: 100,\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"presignedUrlSchema\", () => {\n  it(\"should validate upload request\", () => {\n    const result = presignedUrlSchema.safeParse({\n      filename: \"image.jpg\",\n      contentType: \"image/jpeg\",\n      size: 1024 * 1024, // 1MB\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject files over 100MB\", () => {\n    const result = presignedUrlSchema.safeParse({\n      filename: \"large-file.zip\",\n      contentType: \"application/zip\",\n      size: 150 * 1024 * 1024, // 150MB\n    });\n    expect(result.success).toBe(false);\n  });\n});\n\ndescribe(\"createEmojiSchema\", () => {\n  it(\"should validate valid emoji\", () => {\n    const result = createEmojiSchema.safeParse({\n      name: \"party_parrot\",\n      imageUrl: \"https://example.com/emoji.png\",\n    });\n    expect(result.success).toBe(true);\n  });\n\n  it(\"should reject invalid characters in name\", () => {\n    const result = createEmojiSchema.safeParse({\n      name: \"Party-Parrot\",\n      imageUrl: \"https://example.com/emoji.png\",\n    });\n    expect(result.success).toBe(false);\n  });\n\n  it(\"should reject short name\", () => {\n    const result = createEmojiSchema.safeParse({\n      name: \"x\",\n      imageUrl: \"https://example.com/emoji.png\",\n    });\n    expect(result.success).toBe(false);\n  });\n});\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/toolbar/ToolbarPlugin.tsx",
        "size": 7312,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useEffect, useState, useRef } from \"react\";\nimport { useLexicalComposerContext } from \"@lexical/react/LexicalComposerContext\";\nimport {\n  $getSelection,\n  $isRangeSelection,\n  $createParagraphNode,\n  FORMAT_TEXT_COMMAND,\n  SELECTION_CHANGE_COMMAND,\n  COMMAND_PRIORITY_CRITICAL,\n} from \"lexical\";\nimport { mergeRegister } from \"@lexical/utils\";\nimport { Button } from \"~/components/ui/button\";\nimport {\n  Bold,\n  Italic,\n  Underline,\n  Strikethrough,\n  Code,\n  ImagePlus,\n  Paperclip,\n} from \"lucide-react\";\nimport { cn } from \"~/lib/utils\";\nimport { $createAttachmentNode, type AttachmentType } from \"../nodes/AttachmentNode\";\nimport { api } from \"~/lib/trpc/client\";\n\nexport function ToolbarPlugin() {\n  const [editor] = useLexicalComposerContext();\n  const [isBold, setIsBold] = useState(false);\n  const [isItalic, setIsItalic] = useState(false);\n  const [isUnderline, setIsUnderline] = useState(false);\n  const [isStrikethrough, setIsStrikethrough] = useState(false);\n  const [isCode, setIsCode] = useState(false);\n  const [isUploading, setIsUploading] = useState(false);\n  const imageInputRef = useRef<HTMLInputElement>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const uploadMutation = api.upload.getUploadUrl.useMutation();\n\n  const updateToolbar = useCallback(() => {\n    const selection = $getSelection();\n    if ($isRangeSelection(selection)) {\n      setIsBold(selection.hasFormat(\"bold\"));\n      setIsItalic(selection.hasFormat(\"italic\"));\n      setIsUnderline(selection.hasFormat(\"underline\"));\n      setIsStrikethrough(selection.hasFormat(\"strikethrough\"));\n      setIsCode(selection.hasFormat(\"code\"));\n    }\n  }, []);\n\n  useEffect(() => {\n    return mergeRegister(\n      editor.registerUpdateListener(({ editorState }) => {\n        editorState.read(() => {\n          updateToolbar();\n        });\n      }),\n      editor.registerCommand(\n        SELECTION_CHANGE_COMMAND,\n        () => {\n          updateToolbar();\n          return false;\n        },\n        COMMAND_PRIORITY_CRITICAL\n      )\n    );\n  }, [editor, updateToolbar]);\n\n  const handleFileUpload = useCallback(\n    async (file: File) => {\n      setIsUploading(true);\n      try {\n        // Get presigned URL\n        const result = await uploadMutation.mutateAsync({\n          filename: file.name,\n          contentType: file.type,\n          size: file.size,\n        });\n\n        // Upload to R2\n        const uploadResponse = await fetch(result.uploadUrl, {\n          method: \"PUT\",\n          body: file,\n          headers: {\n            \"Content-Type\": file.type,\n          },\n        });\n\n        if (!uploadResponse.ok) {\n          const errorText = await uploadResponse.text();\n          console.error(\"R2 upload failed:\", uploadResponse.status, errorText);\n          alert(`Upload failed: ${uploadResponse.status} - Check CORS configuration on R2 bucket`);\n          return;\n        }\n\n        // Determine attachment type\n        let attachmentType: AttachmentType = \"FILE\";\n        if (file.type.startsWith(\"image/\")) {\n          attachmentType = \"IMAGE\";\n        } else if (file.type.startsWith(\"video/\")) {\n          attachmentType = \"VIDEO\";\n        }\n\n        // Insert attachment node\n        editor.update(() => {\n          const selection = $getSelection();\n          if ($isRangeSelection(selection)) {\n            const attachmentNode = $createAttachmentNode({\n              attachmentType,\n              url: result.publicUrl,\n              filename: file.name,\n              mimeType: file.type,\n              size: file.size,\n            });\n            selection.insertNodes([attachmentNode, $createParagraphNode()]);\n          }\n        });\n      } catch (error) {\n        console.error(\"Upload failed:\", error);\n        const message = error instanceof Error ? error.message : \"Unknown error\";\n        alert(`Upload failed: ${message}`);\n      } finally {\n        setIsUploading(false);\n      }\n    },\n    [editor, uploadMutation]\n  );\n\n  return (\n    <div className=\"relative z-20 flex items-center gap-0.5 border-b border-border px-2 py-1\">\n      {/* Hidden file inputs */}\n      <input\n        ref={imageInputRef}\n        type=\"file\"\n        accept=\"image/*,video/*\"\n        className=\"hidden\"\n        onChange={(e) => {\n          const file = e.target.files?.[0];\n          if (file) {\n            handleFileUpload(file);\n          }\n          e.target.value = \"\";\n        }}\n      />\n      <input\n        ref={fileInputRef}\n        type=\"file\"\n        accept=\"*/*\"\n        className=\"hidden\"\n        onChange={(e) => {\n          const file = e.target.files?.[0];\n          if (file) {\n            handleFileUpload(file);\n          }\n          e.target.value = \"\";\n        }}\n      />\n\n      {/* Text formatting buttons */}\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isBold && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"bold\")}\n        title=\"Bold (⌘B)\"\n      >\n        <Bold className=\"h-4 w-4\" />\n      </Button>\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isItalic && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"italic\")}\n        title=\"Italic (⌘I)\"\n      >\n        <Italic className=\"h-4 w-4\" />\n      </Button>\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isUnderline && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"underline\")}\n        title=\"Underline (⌘U)\"\n      >\n        <Underline className=\"h-4 w-4\" />\n      </Button>\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isStrikethrough && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"strikethrough\")}\n        title=\"Strikethrough\"\n      >\n        <Strikethrough className=\"h-4 w-4\" />\n      </Button>\n      <div className=\"mx-1 h-4 w-px bg-border\" />\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className={cn(\"h-8 w-8 p-0\", isCode && \"bg-muted\")}\n        onClick={() => editor.dispatchCommand(FORMAT_TEXT_COMMAND, \"code\")}\n        title=\"Inline Code\"\n      >\n        <Code className=\"h-4 w-4\" />\n      </Button>\n\n      <div className=\"mx-1 h-4 w-px bg-border\" />\n\n      {/* Direct attachment buttons */}\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"h-8 gap-1.5 px-2\"\n        disabled={isUploading}\n        onClick={() => imageInputRef.current?.click()}\n        title=\"Add image or video\"\n      >\n        <ImagePlus className=\"h-4 w-4\" />\n        <span className=\"text-xs\">Image</span>\n      </Button>\n      <Button\n        type=\"button\"\n        variant=\"ghost\"\n        size=\"sm\"\n        className=\"h-8 gap-1.5 px-2\"\n        disabled={isUploading}\n        onClick={() => fileInputRef.current?.click()}\n        title=\"Add file\"\n      >\n        <Paperclip className=\"h-4 w-4\" />\n        <span className=\"text-xs\">File</span>\n      </Button>\n\n      {isUploading && (\n        <span className=\"ml-2 text-xs text-muted-foreground\">Uploading...</span>\n      )}\n    </div>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/feed/PostCard.tsx",
        "size": 6923,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport Link from \"next/link\";\nimport { UserAvatar } from \"~/components/ui/avatar\";\nimport { Button } from \"~/components/ui/button\";\nimport { Card, CardContent, CardFooter, CardHeader } from \"~/components/ui/card\";\nimport { Badge } from \"~/components/ui/badge\";\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuTrigger,\n} from \"~/components/ui/dropdown-menu\";\nimport {\n  formatRelativeTime,\n  truncateText,\n} from \"~/lib/utils\";\nimport { MessageCircle, ExternalLink, ChevronDown, Image as ImageIcon, Play, FileIcon } from \"lucide-react\";\nimport { ReactionButton } from \"~/components/reactions/ReactionButton\";\nimport { AttachmentCarousel } from \"./AttachmentCarousel\";\n\ninterface PostCardProps {\n  post: {\n    id: string;\n    title: string | null;\n    content: unknown;\n    liveUrl: string | null;\n    createdAt: Date;\n    author: {\n      id: string;\n      displayName: string;\n      avatarUrl: string | null;\n    };\n    attachments: Array<{\n      id: string;\n      type: string;\n      url: string;\n      filename: string;\n      thumbnailUrl: string | null;\n    }>;\n    projects: Array<{\n      project: {\n        id: string;\n        name: string;\n      };\n    }>;\n    reactions: Array<{\n      type: string;\n      userId: string;\n    }>;\n    _count: {\n      comments: number;\n      reactions: number;\n      attachments: number;\n    };\n  };\n}\n\nfunction extractPlainText(content: unknown): string {\n  if (!content || typeof content !== \"object\") return \"\";\n\n  const root = (content as Record<string, unknown>).root;\n  if (!root || typeof root !== \"object\") return \"\";\n\n  const children = (root as Record<string, unknown>).children;\n  if (!Array.isArray(children)) return \"\";\n\n  const texts: string[] = [];\n\n  function extractFromNode(node: unknown): void {\n    if (!node || typeof node !== \"object\") return;\n\n    const nodeObj = node as Record<string, unknown>;\n\n    if (nodeObj.type === \"text\" && typeof nodeObj.text === \"string\") {\n      texts.push(nodeObj.text);\n    }\n\n    // Handle mention nodes - extract the display name\n    if (nodeObj.type === \"mention\" && typeof nodeObj.mentionName === \"string\") {\n      texts.push(nodeObj.mentionName);\n    }\n\n    if (Array.isArray(nodeObj.children)) {\n      nodeObj.children.forEach(extractFromNode);\n    }\n  }\n\n  children.forEach(extractFromNode);\n  return texts.join(\" \");\n}\n\nexport function PostCard({ post }: PostCardProps) {\n  const plainText = extractPlainText(post.content);\n  const truncatedContent = truncateText(plainText, 300);\n  const projectCount = post.projects.length;\n\n  return (\n    <Card className=\"overflow-hidden transition-shadow\">\n      <CardHeader className=\"px-5 pt-5 pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-3\">\n            <Link href={`/user/${post.author.id}`}>\n              <UserAvatar avatarUrl={post.author.avatarUrl} name={post.author.displayName} className=\"h-10 w-10\" />\n            </Link>\n            <div className=\"flex flex-col\">\n              <div className=\"flex items-center gap-2 text-sm\">\n                <Link\n                  href={`/user/${post.author.id}`}\n                  className=\"font-medium hover:underline\"\n                >\n                  {post.author.displayName}\n                </Link>\n                {projectCount > 0 && (\n                  <>\n                    <span className=\"text-muted-foreground\">·</span>\n                    {projectCount === 1 ? (\n                      <Link\n                        href={`/projects/${post.projects[0]?.project.id}`}\n                        className=\"text-muted-foreground hover:text-foreground hover:underline\"\n                      >\n                        in {post.projects[0]?.project.name}\n                      </Link>\n                    ) : (\n                      <DropdownMenu>\n                        <DropdownMenuTrigger className=\"flex items-center gap-1 text-muted-foreground hover:text-foreground\">\n                          in {projectCount} projects\n                          <ChevronDown className=\"h-3 w-3\" />\n                        </DropdownMenuTrigger>\n                        <DropdownMenuContent>\n                          {post.projects.map(({ project }) => (\n                            <DropdownMenuItem key={project.id} asChild>\n                              <Link href={`/projects/${project.id}`}>\n                                {project.name}\n                              </Link>\n                            </DropdownMenuItem>\n                          ))}\n                        </DropdownMenuContent>\n                      </DropdownMenu>\n                    )}\n                  </>\n                )}\n              </div>\n              <Link\n                href={`/post/${post.id}`}\n                className=\"text-xs text-muted-foreground hover:underline\"\n              >\n                {formatRelativeTime(new Date(post.createdAt))}\n              </Link>\n            </div>\n          </div>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"px-5 pb-3\">\n        <Link href={`/post/${post.id}`} className=\"block\">\n          {post.title && (\n            <h2 className=\"mb-2 text-lg font-semibold hover:underline\">\n              {post.title}\n            </h2>\n          )}\n          {truncatedContent && (\n            <p className=\"text-sm text-muted-foreground line-clamp-3\">\n              {truncatedContent}\n            </p>\n          )}\n        </Link>\n\n        {post.attachments.length > 0 && (\n          <div className=\"mt-4\">\n            <AttachmentCarousel\n              attachments={post.attachments}\n              postId={post.id}\n              totalCount={post._count.attachments}\n            />\n          </div>\n        )}\n      </CardContent>\n\n      <CardFooter className=\"px-5 pt-1 pb-3\">\n        <div className=\"flex w-full items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <ReactionButton\n              postId={post.id}\n              reactions={post.reactions}\n              count={post._count.reactions}\n            />\n            <Link href={`/post/${post.id}#comments`} scroll={false}>\n              <Button variant=\"ghost\" size=\"sm\" className=\"gap-1 rounded-full px-2 text-muted-foreground\">\n                <MessageCircle className=\"h-4 w-4\" />\n                {post._count.comments > 0 && post._count.comments}\n              </Button>\n            </Link>\n          </div>\n          {post.liveUrl && (\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <a\n                href={post.liveUrl}\n                target=\"_blank\"\n                rel=\"noopener noreferrer\"\n                className=\"gap-2\"\n              >\n                View live\n                <ExternalLink className=\"h-3.5 w-3.5\" />\n              </a>\n            </Button>\n          )}\n        </div>\n      </CardFooter>\n    </Card>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/feed/AttachmentCarousel.tsx",
        "size": 6917,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport { Play, FileIcon, Image as ImageIcon, Loader2 } from \"lucide-react\";\nimport { api } from \"~/lib/trpc/client\";\nimport { Lightbox, type LightboxMedia } from \"~/components/ui/lightbox\";\n\ninterface Attachment {\n  id: string;\n  type: string;\n  url: string;\n  filename: string;\n  thumbnailUrl: string | null;\n}\n\ninterface AttachmentCarouselProps {\n  attachments: Attachment[];\n  postId: string;\n  totalCount: number;\n}\n\n// Extract R2 key from URL\nfunction extractR2Key(url: string): string | null {\n  const match = url.match(/uploads\\/[^\\/]+\\/[^\\/]+$/);\n  return match ? match[0] : null;\n}\n\nfunction getAttachmentIcon(type: string) {\n  switch (type) {\n    case \"IMAGE\":\n      return <ImageIcon className=\"h-8 w-8\" />;\n    case \"VIDEO\":\n    case \"LOOM\":\n      return <Play className=\"h-8 w-8\" />;\n    case \"FIGMA\":\n      return (\n        <svg viewBox=\"0 0 38 57\" className=\"h-8 w-8\" fill=\"none\">\n          <path d=\"M19 28.5a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z\" fill=\"#1ABCFE\" />\n          <path d=\"M0 47.5A9.5 9.5 0 0 1 9.5 38H19v9.5a9.5 9.5 0 1 1-19 0z\" fill=\"#0ACF83\" />\n          <path d=\"M19 0v19h9.5a9.5 9.5 0 1 0 0-19H19z\" fill=\"#FF7262\" />\n          <path d=\"M0 9.5A9.5 9.5 0 0 0 9.5 19H19V0H9.5A9.5 9.5 0 0 0 0 9.5z\" fill=\"#F24E1E\" />\n          <path d=\"M0 28.5A9.5 9.5 0 0 0 9.5 38H19V19H9.5A9.5 9.5 0 0 0 0 28.5z\" fill=\"#A259FF\" />\n        </svg>\n      );\n    default:\n      return <FileIcon className=\"h-8 w-8\" />;\n  }\n}\n\nfunction SignedImage({ url, filename, className }: { url: string; filename: string; className?: string }) {\n  const r2Key = extractR2Key(url);\n  const { data: signedUrlData, isLoading } = api.upload.getDownloadUrl.useQuery(\n    { key: r2Key! },\n    {\n      enabled: !!r2Key,\n      staleTime: 30 * 60 * 1000,\n      refetchOnWindowFocus: false,\n    }\n  );\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-full w-full items-center justify-center bg-muted\">\n        <Loader2 className=\"h-6 w-6 animate-spin text-muted-foreground\" />\n      </div>\n    );\n  }\n\n  return (\n    <img\n      src={signedUrlData?.url || url}\n      alt={filename}\n      className={className}\n    />\n  );\n}\n\nexport function AttachmentCarousel({\n  attachments,\n  postId,\n  totalCount,\n}: AttachmentCarouselProps) {\n  const [lightboxOpen, setLightboxOpen] = useState(false);\n  const [lightboxIndex, setLightboxIndex] = useState(0);\n\n  const visibleAttachments = attachments.slice(0, 2);\n  const remaining = totalCount - 2;\n\n  // Get all media attachments (images and videos) for the lightbox\n  const mediaAttachments: LightboxMedia[] = attachments\n    .filter((a) => a.type === \"IMAGE\" || a.type === \"VIDEO\")\n    .map((a) => ({\n      id: a.id,\n      type: a.type === \"IMAGE\" ? \"image\" as const : \"video\" as const,\n      url: a.url,\n      filename: a.filename,\n      thumbnailUrl: a.thumbnailUrl,\n    }));\n\n  const handleMediaClick = (attachmentId: string, e: React.MouseEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const mediaIndex = mediaAttachments.findIndex((a) => a.id === attachmentId);\n    if (mediaIndex >= 0) {\n      setLightboxIndex(mediaIndex);\n      setLightboxOpen(true);\n    }\n  };\n\n  return (\n    <>\n      <div className=\"flex gap-2\">\n        {visibleAttachments.map((attachment, index) => {\n          // Images and videos open in the lightbox carousel\n          if (attachment.type === \"IMAGE\" || attachment.type === \"VIDEO\") {\n            return (\n              <button\n                key={attachment.id}\n                onClick={(e) => handleMediaClick(attachment.id, e)}\n                className=\"group relative flex-1 cursor-pointer overflow-hidden rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2\"\n              >\n                <div className=\"relative aspect-video w-full overflow-hidden bg-muted\">\n                  {attachment.type === \"IMAGE\" ? (\n                    <SignedImage\n                      url={attachment.thumbnailUrl || attachment.url}\n                      filename={attachment.filename}\n                      className=\"h-full w-full object-cover transition-transform duration-200 ease-in-out group-hover:scale-[1.02]\"\n                    />\n                  ) : (\n                    <>\n                      {attachment.thumbnailUrl ? (\n                        <SignedImage\n                          url={attachment.thumbnailUrl}\n                          filename={attachment.filename}\n                          className=\"h-full w-full object-cover transition-transform duration-200 ease-in-out group-hover:scale-[1.02]\"\n                        />\n                      ) : (\n                        <div className=\"flex h-full items-center justify-center\">\n                          <Play className=\"h-8 w-8 text-muted-foreground\" />\n                        </div>\n                      )}\n                      <div className=\"absolute inset-0 flex items-center justify-center bg-black/20 pointer-events-none\">\n                        <div className=\"flex h-12 w-12 items-center justify-center rounded-full bg-white/90\">\n                          <Play className=\"h-5 w-5 text-foreground\" />\n                        </div>\n                      </div>\n                    </>\n                  )}\n                  {index === 1 && remaining > 0 && (\n                    <div className=\"absolute inset-0 flex items-center justify-center bg-black/60 text-white\">\n                      <span className=\"text-2xl font-semibold\">+{remaining}</span>\n                    </div>\n                  )}\n                </div>\n              </button>\n            );\n          }\n\n          // Other attachment types link to the post\n          return (\n            <Link\n              key={attachment.id}\n              href={`/post/${postId}#attachment-${attachment.id}`}\n              className=\"group relative flex-1 cursor-pointer overflow-hidden rounded-lg\"\n            >\n              <div className=\"relative flex aspect-video w-full items-center justify-center bg-muted\">\n                <div className=\"flex flex-col items-center gap-2 text-muted-foreground\">\n                  {getAttachmentIcon(attachment.type)}\n                  <span className=\"max-w-[80%] truncate text-sm\">\n                    {attachment.filename}\n                  </span>\n                </div>\n                {index === 1 && remaining > 0 && (\n                  <div className=\"absolute inset-0 flex items-center justify-center bg-black/60 text-white\">\n                    <span className=\"text-2xl font-semibold\">+{remaining}</span>\n                  </div>\n                )}\n              </div>\n            </Link>\n          );\n        })}\n      </div>\n\n      <Lightbox\n        images={mediaAttachments}\n        initialIndex={lightboxIndex}\n        isOpen={lightboxOpen}\n        onClose={() => setLightboxOpen(false)}\n      />\n    </>\n  );\n}\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/Dialog.stories.tsx",
        "size": 6817,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport {\n  Dialog,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n  DialogClose,\n} from \"./dialog\";\nimport { Button } from \"./button\";\nimport { Input } from \"./input\";\nimport { Label } from \"./label\";\nimport { Textarea } from \"./textarea\";\n\nconst meta: Meta<typeof Dialog> = {\n  title: \"UI/Dialog\",\n  component: Dialog,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A modal dialog component for focused user interactions. Built on Radix UI Dialog for accessibility.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof Dialog>;\n\nexport const Default: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\">Open Dialog</Button>\n      </DialogTrigger>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Dialog Title</DialogTitle>\n          <DialogDescription>\n            This is a description of what this dialog does.\n          </DialogDescription>\n        </DialogHeader>\n        <p className=\"text-sm text-muted-foreground\">\n          Dialog content goes here. You can put any content you want.\n        </p>\n        <DialogFooter>\n          <DialogClose asChild>\n            <Button variant=\"outline\">Cancel</Button>\n          </DialogClose>\n          <Button>Confirm</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n};\n\nexport const WithForm: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button>Create Project</Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-[425px]\">\n        <DialogHeader>\n          <DialogTitle>Create Project</DialogTitle>\n          <DialogDescription>\n            Add a new project to your workspace. Click save when you're done.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"grid gap-4 py-4\">\n          <div className=\"grid gap-2\">\n            <Label htmlFor=\"name\">Name</Label>\n            <Input id=\"name\" placeholder=\"Project name\" />\n          </div>\n          <div className=\"grid gap-2\">\n            <Label htmlFor=\"description\">Description</Label>\n            <Textarea\n              id=\"description\"\n              placeholder=\"Describe your project...\"\n              rows={3}\n            />\n          </div>\n        </div>\n        <DialogFooter>\n          <DialogClose asChild>\n            <Button variant=\"outline\">Cancel</Button>\n          </DialogClose>\n          <Button type=\"submit\">Save Project</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Dialog with a form for creating new content.\",\n      },\n    },\n  },\n};\n\nexport const Confirmation: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button variant=\"destructive\">Delete Item</Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-[400px]\">\n        <DialogHeader>\n          <DialogTitle>Are you sure?</DialogTitle>\n          <DialogDescription>\n            This action cannot be undone. This will permanently delete the item\n            and remove it from our servers.\n          </DialogDescription>\n        </DialogHeader>\n        <DialogFooter>\n          <DialogClose asChild>\n            <Button variant=\"outline\">Cancel</Button>\n          </DialogClose>\n          <Button variant=\"destructive\">Delete</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Confirmation dialog for destructive actions.\",\n      },\n    },\n  },\n};\n\nexport const LongContent: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\">View Terms</Button>\n      </DialogTrigger>\n      <DialogContent className=\"max-h-[80vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle>Terms of Service</DialogTitle>\n          <DialogDescription>\n            Please read our terms of service carefully.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"space-y-4 text-sm text-muted-foreground\">\n          <p>\n            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do\n            eiusmod tempor incididunt ut labore et dolore magna aliqua.\n          </p>\n          <p>\n            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris\n            nisi ut aliquip ex ea commodo consequat.\n          </p>\n          <p>\n            Duis aute irure dolor in reprehenderit in voluptate velit esse\n            cillum dolore eu fugiat nulla pariatur.\n          </p>\n          <p>\n            Excepteur sint occaecat cupidatat non proident, sunt in culpa qui\n            officia deserunt mollit anim id est laborum.\n          </p>\n          <p>\n            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do\n            eiusmod tempor incididunt ut labore et dolore magna aliqua.\n          </p>\n          <p>\n            Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris\n            nisi ut aliquip ex ea commodo consequat.\n          </p>\n        </div>\n        <DialogFooter>\n          <DialogClose asChild>\n            <Button variant=\"outline\">Decline</Button>\n          </DialogClose>\n          <Button>Accept</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Dialog with scrollable long content.\",\n      },\n    },\n  },\n};\n\nexport const CustomWidth: Story = {\n  render: () => (\n    <Dialog>\n      <DialogTrigger asChild>\n        <Button variant=\"outline\">Wide Dialog</Button>\n      </DialogTrigger>\n      <DialogContent className=\"sm:max-w-[700px]\">\n        <DialogHeader>\n          <DialogTitle>Wide Dialog</DialogTitle>\n          <DialogDescription>\n            This dialog is wider for displaying more content.\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"grid grid-cols-2 gap-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label>Column 1</Label>\n            <Input placeholder=\"First input\" />\n            <Input placeholder=\"Second input\" />\n          </div>\n          <div className=\"space-y-2\">\n            <Label>Column 2</Label>\n            <Input placeholder=\"Third input\" />\n            <Input placeholder=\"Fourth input\" />\n          </div>\n        </div>\n        <DialogFooter>\n          <Button>Save Changes</Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Dialog with custom width for more complex layouts.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/components/ui/Toast.stories.tsx",
        "size": 6782,
        "reason": "large source sample",
        "content": "import type { Meta, StoryObj } from \"@storybook/nextjs-vite\";\nimport {\n  Toast,\n  ToastProvider,\n  ToastViewport,\n  ToastTitle,\n  ToastDescription,\n  ToastAction,\n  ToastClose,\n} from \"./toast\";\nimport { Button } from \"./button\";\nimport { useState } from \"react\";\n\nconst meta: Meta<typeof Toast> = {\n  title: \"UI/Toast\",\n  component: Toast,\n  parameters: {\n    layout: \"centered\",\n    docs: {\n      description: {\n        component:\n          \"A toast notification component for displaying brief messages. Built on Radix UI Toast.\",\n      },\n    },\n  },\n  tags: [\"autodocs\"],\n};\n\nexport default meta;\ntype Story = StoryObj<typeof Toast>;\n\n// Static toast examples (not interactive)\nexport const Default: Story = {\n  render: () => (\n    <div className=\"relative w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg bg-background\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Scheduled: Catch up</div>\n          <div className=\"text-sm opacity-90\">\n            Friday, February 10, 2024 at 5:57 PM\n          </div>\n        </div>\n      </div>\n    </div>\n  ),\n};\n\nexport const Variants: Story = {\n  render: () => (\n    <div className=\"space-y-4 w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg bg-background\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Default Toast</div>\n          <div className=\"text-sm opacity-90\">\n            This is a default toast notification.\n          </div>\n        </div>\n      </div>\n\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border-destructive bg-destructive text-destructive-foreground p-4 pr-6 shadow-lg\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Destructive Toast</div>\n          <div className=\"text-sm opacity-90\">\n            Something went wrong. Please try again.\n          </div>\n        </div>\n      </div>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Toast variants for different message types - default and destructive.\",\n      },\n    },\n  },\n};\n\nexport const WithAction: Story = {\n  render: () => (\n    <div className=\"w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg bg-background\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Item deleted</div>\n          <div className=\"text-sm opacity-90\">\n            The item has been moved to trash.\n          </div>\n        </div>\n        <Button variant=\"outline\" size=\"sm\" className=\"shrink-0\">\n          Undo\n        </Button>\n      </div>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Toast with an action button for undo or other quick actions.\",\n      },\n    },\n  },\n};\n\nexport const SuccessMessage: Story = {\n  render: () => (\n    <div className=\"w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border border-green-200 bg-green-50 text-green-900 p-4 pr-6 shadow-lg dark:border-green-800 dark:bg-green-950 dark:text-green-100\">\n        <div className=\"grid gap-1\">\n          <div className=\"text-sm font-semibold\">Success!</div>\n          <div className=\"text-sm opacity-90\">\n            Your changes have been saved successfully.\n          </div>\n        </div>\n      </div>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Custom styled success toast using Tailwind classes.\",\n      },\n    },\n  },\n};\n\nexport const TitleOnly: Story = {\n  render: () => (\n    <div className=\"w-[380px]\">\n      <div className=\"pointer-events-auto relative flex w-full items-center justify-between space-x-2 overflow-hidden rounded-md border p-4 pr-6 shadow-lg bg-background\">\n        <div className=\"text-sm font-semibold\">Copied to clipboard!</div>\n      </div>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Simple toast with just a title for quick confirmations.\",\n      },\n    },\n  },\n};\n\n// Interactive demo\nconst ToastDemo = () => {\n  const [open, setOpen] = useState(false);\n  const [variant, setVariant] = useState<\"default\" | \"destructive\">(\"default\");\n\n  return (\n    <ToastProvider>\n      <div className=\"flex gap-2\">\n        <Button\n          variant=\"outline\"\n          onClick={() => {\n            setVariant(\"default\");\n            setOpen(true);\n          }}\n        >\n          Show Toast\n        </Button>\n        <Button\n          variant=\"destructive\"\n          onClick={() => {\n            setVariant(\"destructive\");\n            setOpen(true);\n          }}\n        >\n          Show Error\n        </Button>\n      </div>\n\n      <Toast open={open} onOpenChange={setOpen} variant={variant}>\n        <div className=\"grid gap-1\">\n          <ToastTitle>\n            {variant === \"default\" ? \"Notification\" : \"Error\"}\n          </ToastTitle>\n          <ToastDescription>\n            {variant === \"default\"\n              ? \"Your action was completed successfully.\"\n              : \"Something went wrong. Please try again.\"}\n          </ToastDescription>\n        </div>\n        <ToastClose />\n      </Toast>\n\n      <ToastViewport />\n    </ToastProvider>\n  );\n};\n\nexport const Interactive: Story = {\n  render: () => <ToastDemo />,\n  parameters: {\n    docs: {\n      description: {\n        story:\n          \"Interactive demo showing how to trigger toasts programmatically. Click the buttons to show different toast types.\",\n      },\n    },\n  },\n};\n\nexport const UsageExample: Story = {\n  render: () => (\n    <div className=\"space-y-4 p-4 bg-muted/50 rounded-lg max-w-md\">\n      <h4 className=\"font-medium\">Using Toasts in Your App</h4>\n      <p className=\"text-sm text-muted-foreground\">\n        Draftboard uses a toast hook pattern for triggering notifications. Import and use it like this:\n      </p>\n      <pre className=\"p-3 bg-background rounded text-xs overflow-x-auto\">\n{`import { useToast } from \"~/components/ui/use-toast\"\n\nfunction MyComponent() {\n  const { toast } = useToast()\n\n  return (\n    <Button onClick={() => {\n      toast({\n        title: \"Saved!\",\n        description: \"Your changes have been saved.\",\n      })\n    }}>\n      Save\n    </Button>\n  )\n}`}\n      </pre>\n    </div>\n  ),\n  parameters: {\n    docs: {\n      description: {\n        story: \"Code example showing how to use the toast system in your components.\",\n      },\n    },\n  },\n};\n",
        "truncated": false
      },
      {
        "path": "src/components/editor/Editor.tsx",
        "size": 6689,
        "reason": "large source sample",
        "content": "\"use client\";\n\nimport { useCallback, useState } from \"react\";\nimport {\n  LexicalComposer,\n  type InitialConfigType,\n} from \"@lexical/react/LexicalComposer\";\nimport { RichTextPlugin } from \"@lexical/react/LexicalRichTextPlugin\";\nimport { ContentEditable } from \"@lexical/react/LexicalContentEditable\";\nimport { HistoryPlugin } from \"@lexical/react/LexicalHistoryPlugin\";\nimport { OnChangePlugin } from \"@lexical/react/LexicalOnChangePlugin\";\nimport { LexicalErrorBoundary } from \"@lexical/react/LexicalErrorBoundary\";\nimport { MarkdownShortcutPlugin } from \"@lexical/react/LexicalMarkdownShortcutPlugin\";\nimport { ListPlugin } from \"@lexical/react/LexicalListPlugin\";\nimport { LinkPlugin } from \"@lexical/react/LexicalLinkPlugin\";\nimport { HeadingNode, QuoteNode } from \"@lexical/rich-text\";\nimport { ListItemNode, ListNode } from \"@lexical/list\";\nimport { LinkNode, AutoLinkNode } from \"@lexical/link\";\nimport { CodeNode, CodeHighlightNode } from \"@lexical/code\";\nimport { TRANSFORMERS } from \"@lexical/markdown\";\nimport type { EditorState, SerializedEditorState } from \"lexical\";\n\nimport { MentionNode } from \"./nodes/MentionNode\";\nimport { EmojiNode } from \"./nodes/EmojiNode\";\nimport { ImageNode } from \"./nodes/ImageNode\";\nimport { AttachmentNode } from \"./nodes/AttachmentNode\";\nimport { MentionPlugin } from \"./plugins/MentionPlugin\";\nimport { EmojiPlugin } from \"./plugins/EmojiPlugin\";\nimport { SlashCommandPlugin } from \"./plugins/SlashCommandPlugin\";\nimport { DragDropPlugin } from \"./plugins/DragDropPlugin\";\nimport { FloatingAddButtonPlugin } from \"./plugins/FloatingAddButtonPlugin\";\nimport { NodeDeletionPlugin } from \"./plugins/NodeDeletionPlugin\";\nimport { PasteLinkPlugin } from \"./plugins/PasteLinkPlugin\";\nimport { PasteFilePlugin } from \"./plugins/PasteFilePlugin\";\nimport { LinkClickPlugin } from \"./plugins/LinkClickPlugin\";\nimport { ToolbarPlugin } from \"./toolbar/ToolbarPlugin\";\nimport { cn } from \"~/lib/utils\";\n\ninterface EditorProps {\n  initialContent?: SerializedEditorState | null;\n  onChange?: (editorState: SerializedEditorState) => void;\n  placeholder?: string;\n  editable?: boolean;\n  showToolbar?: boolean;\n  minHeight?: string;\n  className?: string;\n}\n\nconst theme = {\n  paragraph: \"mb-2\",\n  heading: {\n    h1: \"text-3xl font-semibold mb-4 mt-6\",\n    h2: \"text-2xl font-semibold mb-3 mt-5\",\n    h3: \"text-xl font-semibold mb-2 mt-4\",\n  },\n  list: {\n    ul: \"list-disc ml-4 mb-2\",\n    ol: \"list-decimal ml-4 mb-2\",\n    listitem: \"mb-1\",\n  },\n  quote: \"border-l-4 border-primary/30 pl-4 italic text-muted-foreground my-4\",\n  code: \"font-mono bg-muted px-1.5 py-0.5 rounded text-sm\",\n  codeHighlight: {\n    atrule: \"text-purple-500\",\n    attr: \"text-yellow-500\",\n    boolean: \"text-purple-500\",\n    builtin: \"text-cyan-500\",\n    cdata: \"text-gray-500\",\n    char: \"text-green-500\",\n    class: \"text-yellow-500\",\n    \"class-name\": \"text-yellow-500\",\n    comment: \"text-gray-500\",\n    constant: \"text-purple-500\",\n    deleted: \"text-red-500\",\n    doctype: \"text-gray-500\",\n    entity: \"text-red-500\",\n    function: \"text-blue-500\",\n    important: \"text-purple-500\",\n    inserted: \"text-green-500\",\n    keyword: \"text-purple-500\",\n    namespace: \"text-purple-500\",\n    number: \"text-purple-500\",\n    operator: \"text-gray-500\",\n    prolog: \"text-gray-500\",\n    property: \"text-red-500\",\n    punctuation: \"text-gray-500\",\n    regex: \"text-green-500\",\n    selector: \"text-green-500\",\n    string: \"text-green-500\",\n    symbol: \"text-purple-500\",\n    tag: \"text-red-500\",\n    url: \"text-blue-500\",\n    variable: \"text-orange-500\",\n  },\n  link: \"text-primary underline cursor-pointer hover:text-primary/80\",\n  text: {\n    bold: \"font-bold\",\n    italic: \"italic\",\n    underline: \"underline\",\n    strikethrough: \"line-through\",\n    code: \"font-mono bg-muted px-1.5 py-0.5 rounded text-sm\",\n  },\n};\n\nexport function Editor({\n  initialContent,\n  onChange,\n  placeholder = \"Start writing, type / for commands or click + to add...\",\n  editable = true,\n  showToolbar = true,\n  minHeight = \"200px\",\n  className,\n}: EditorProps) {\n  const [floatingAnchorElem, setFloatingAnchorElem] =\n    useState<HTMLDivElement | null>(null);\n\n  const onRef = useCallback((elem: HTMLDivElement | null) => {\n    if (elem !== null) {\n      setFloatingAnchorElem(elem);\n    }\n  }, []);\n\n  const handleChange = useCallback(\n    (editorState: EditorState) => {\n      if (onChange) {\n        onChange(editorState.toJSON());\n      }\n    },\n    [onChange]\n  );\n\n  const initialConfig: InitialConfigType = {\n    namespace: \"DraftboardEditor\",\n    theme,\n    onError: (error: Error) => {\n      console.error(\"Lexical error:\", error);\n    },\n    nodes: [\n      HeadingNode,\n      QuoteNode,\n      ListNode,\n      ListItemNode,\n      LinkNode,\n      AutoLinkNode,\n      CodeNode,\n      CodeHighlightNode,\n      MentionNode,\n      EmojiNode,\n      ImageNode,\n      AttachmentNode,\n    ],\n    editorState: initialContent ? JSON.stringify(initialContent) : undefined,\n    editable,\n  };\n\n  return (\n    <LexicalComposer initialConfig={initialConfig}>\n      <div className={cn(editable && \"editor-container\", \"relative\", className)}>\n        {showToolbar && editable && <ToolbarPlugin />}\n        <div className=\"relative\" ref={onRef}>\n          <RichTextPlugin\n            contentEditable={\n              <ContentEditable\n                className={cn(editable && \"editor-input\", \"outline-none\")}\n                style={{ minHeight }}\n              />\n            }\n            placeholder={\n              <div className=\"editor-placeholder\">{placeholder}</div>\n            }\n            ErrorBoundary={LexicalErrorBoundary}\n          />\n        </div>\n        <HistoryPlugin />\n        <ListPlugin />\n        <LinkPlugin />\n        <MarkdownShortcutPlugin transformers={TRANSFORMERS} />\n        <OnChangePlugin onChange={handleChange} />\n        {editable && <MentionPlugin />}\n        {editable && <EmojiPlugin />}\n        {editable && <NodeDeletionPlugin />}\n        {editable && <PasteLinkPlugin />}\n        {editable && <PasteFilePlugin />}\n        <LinkClickPlugin />\n        {editable && floatingAnchorElem && (\n          <>\n            <SlashCommandPlugin anchorElem={floatingAnchorElem} />\n            <DragDropPlugin />\n            <FloatingAddButtonPlugin anchorElem={floatingAnchorElem} />\n          </>\n        )}\n      </div>\n    </LexicalComposer>\n  );\n}\n\n// Read-only version for displaying content\nexport function EditorContent({\n  content,\n  className,\n}: {\n  content: SerializedEditorState;\n  className?: string;\n}) {\n  return (\n    <Editor\n      initialContent={content}\n      editable={false}\n      showToolbar={false}\n      minHeight=\"auto\"\n      className={className}\n    />\n  );\n}\n",
        "truncated": false
      }
    ]
  },
  "stack": {
    "version": "1.0.0",
    "frontend": [
      {
        "category": "frontend",
        "name": "Next.js",
        "version": "15.3.7",
        "confidence": 0.85,
        "evidence": [
          "package.json: dependency next"
        ]
      },
      {
        "category": "frontend",
        "name": "React",
        "version": "19.1.0",
        "confidence": 0.8,
        "evidence": [
          "package.json: dependency react"
        ]
      }
    ],
    "backend": [],
    "db": [
      {
        "category": "db",
        "name": "Prisma",
        "version": "6.8.2",
        "confidence": 0.8,
        "evidence": [
          "package.json: dependency prisma"
        ]
      }
    ],
    "auth": [
      {
        "category": "auth",
        "name": "NextAuth",
        "version": "5.0.0-beta.25",
        "confidence": 0.78,
        "evidence": [
          "package.json: auth dependency"
        ]
      }
    ],
    "infra": [],
    "language": [
      {
        "category": "language",
        "name": "TypeScript",
        "confidence": 0.76,
        "evidence": [
          "GitHub languages API (99.07000000000001% share)"
        ]
      },
      {
        "category": "language",
        "name": "CSS",
        "confidence": 0.76,
        "evidence": [
          "GitHub languages API (0.52% share)"
        ]
      },
      {
        "category": "language",
        "name": "MDX",
        "confidence": 0.76,
        "evidence": [
          "GitHub languages API (0.4% share)"
        ]
      }
    ],
    "lowConfidenceFindings": []
  },
  "architecture": {
    "version": "1.0.0",
    "components": [
      {
        "id": "frontend",
        "name": "Next.js",
        "role": "Client UI layer",
        "tech": [
          "Next.js"
        ],
        "inputs": [
          "HTTP response",
          "user interactions"
        ],
        "outputs": [
          "API requests"
        ],
        "confidence": 0.65
      },
      {
        "id": "backend",
        "name": "Backend",
        "role": "Application/API layer",
        "tech": [
          "Backend"
        ],
        "inputs": [
          "API requests"
        ],
        "outputs": [
          "Business responses",
          "Data queries"
        ],
        "confidence": 0.62
      },
      {
        "id": "database",
        "name": "Prisma",
        "role": "Persistence layer",
        "tech": [
          "Prisma"
        ],
        "inputs": [
          "Data queries"
        ],
        "outputs": [
          "Stored records"
        ],
        "confidence": 0.58
      },
      {
        "id": "auth",
        "name": "NextAuth",
        "role": "Identity and access",
        "tech": [
          "NextAuth"
        ],
        "inputs": [
          "Auth requests"
        ],
        "outputs": [
          "Tokens/claims"
        ],
        "confidence": 0.56
      }
    ],
    "edges": [
      {
        "from": "frontend",
        "to": "backend",
        "type": "request"
      },
      {
        "from": "backend",
        "to": "database",
        "type": "data"
      },
      {
        "from": "frontend",
        "to": "auth",
        "type": "request"
      },
      {
        "from": "auth",
        "to": "backend",
        "type": "event"
      }
    ]
  },
  "intent": {
    "version": "1.0.0",
    "system_purpose": "Draftboard is an internal design sharing platform for teams to post designs, ideas, and work in progress. It provides a social feed for distributed teams to share work openly, preventing design work from disappearing into Slack threads or Figma files. Users can create posts with rich content, organize them into projects, comment with threaded discussions, add reactions, and receive notifications for team interactions.",
    "core_features": [
      "Reverse chronological feed with list and grid view modes for browsing posts",
      "Rich text editor (Lexical) with markdown shortcuts, @mentions, slash commands, drag-and-drop, paste support, and automatic draft saving",
      "Multi-attachment support for images, videos, files, Figma links, and Loom recordings with carousel viewer",
      "Project organization with cover images, descriptions, team members, and multiple URLs",
      "Threaded comments (2 levels deep) with attachment-specific commenting and coordinate-based annotations",
      "Reaction system with built-in reactions (like, wow, cool) and custom emoji upload support",
      "Notification center for comments, replies, mentions, and reactions",
      "Full-text search across posts, projects, and people via command palette",
      "Optional Discord and Slack webhook integrations for new post announcements",
      "Admin panel for user management, invite link generation, and site settings configuration",
      "User profiles with avatar upload and activity history",
      "Role-based access control (OWNER, ADMIN, MEMBER) with user deactivation",
      "Password reset flow with secure token-based authentication",
      "Dark mode and light theme support with user preference persistence",
      "Progressive Web App (PWA) with mobile optimization and home screen installation",
      "Cloudflare R2 integration for file storage with presigned URL generation"
    ],
    "user_flows": [
      "New user: First user self-registers and becomes OWNER, subsequent users register via invite link and become MEMBER",
      "Sign in: Users authenticate with email/password, deactivated users are redirected to deactivated page",
      "Password reset: User requests reset from sign-in page, receives token, sets new password via token link",
      "Create post: User navigates to /compose, uses rich editor to create content with attachments, assigns to projects, optionally hides from home feed, saves (triggers webhooks and mention notifications)",
      "Browse feed: User views home page with list or grid layout, infinite scroll loads more posts, can filter by project",
      "View post: User clicks post to see /post/[id] detail page with full content, attachments, comments, and reactions",
      "Edit post: Post author navigates to /post/[id]/edit, modifies content/attachments/projects, saves changes",
      "Comment: User adds comment on post or attachment with optional coordinates, can reply to comments (max 2 levels), mentions notify users",
      "React: User clicks reaction button on post or comment, selects from built-in or custom emoji, can view all reactors in dialog",
      "Search: User opens command palette (Cmd/Ctrl+K), searches posts/projects/users, navigates to result",
      "Create project: User navigates to /projects/new, enters name/description, uploads cover, adds URLs and team members",
      "View project: User clicks project to see /projects/[id] with posts feed, details, members, and URLs",
      "Notifications: User views /notifications for activity feed, marks as read by viewing, receives real-time updates",
      "Settings: User navigates to /settings, updates profile (display name, avatar), views account info",
      "Admin users: Admin navigates to /admin/users, views all users with stats, can promote/demote roles, deactivate users",
      "Admin settings: Admin navigates to /admin/settings, manages site name, invite token regeneration, webhook URLs, custom emoji"
    ],
    "business_rules": [
      "First registered user automatically receives OWNER role, all subsequent users require valid invite token and become MEMBER",
      "Only ADMIN and OWNER roles can access /admin routes and manage users/settings",
      "Deactivated users cannot access main application routes and are redirected to /deactivated page",
      "Users cannot deactivate themselves, only admins can deactivate other users",
      "Comment threading limited to 2 levels maximum (no replies to replies)",
      "Users cannot reply to their own posts with notifications, but mentions still trigger notifications",
      "Mention notifications excluded for users already receiving comment/reply notifications for same action",
      "Password reset tokens expire after 24 hours",
      "Invite tokens are site-wide and regeneratable by admins only",
      "Post authors can edit and delete their own posts",
      "Comment authors can edit and delete their own comments",
      "Project creators and members can edit project details",
      "Attachments stored in Cloudflare R2 with presigned URLs for private access",
      "File uploads support images (IMAGE), videos (VIDEO), generic files (FILE), Figma embeds (FIGMA), and Loom embeds (LOOM)",
      "Posts can be hidden from home feed while remaining visible on project pages and direct links",
      "Webhook notifications (Discord/Slack) sent asynchronously on post creation if configured",
      "Search requires authentication and only returns active (non-deactivated) users",
      "Reactions are unique per user per entity (post or comment)",
      "Draft auto-save stores content in database associated with user"
    ],
    "data_contracts": [
      "User: { id: cuid, email: unique string, passwordHash: string, displayName: string, avatarUrl?: string, role: MEMBER|ADMIN|OWNER, deactivated: boolean, createdAt: DateTime, updatedAt: DateTime }",
      "Post: { id: cuid, title?: string, content: JSON (Lexical state), liveUrl?: string, hideFromHome: boolean, authorId: string, createdAt: DateTime, updatedAt: DateTime }",
      "Attachment: { id: cuid, postId: string, type: IMAGE|VIDEO|FILE|FIGMA|LOOM, url: string, filename: string, mimeType: string, size: int, width?: int, height?: int, thumbnailUrl?: string, metadata?: JSON, order: int, createdAt: DateTime }",
      "Project: { id: cuid, name: string, description?: JSON (Lexical state), coverUrl?: string, createdById: string, createdAt: DateTime, updatedAt: DateTime }",
      "ProjectMember: { id: cuid, projectId: string, userId: string, role: string (default 'MEMBER'), createdAt: DateTime }",
      "ProjectUrl: { id: cuid, projectId: string, title: string, url: string }",
      "Comment: { id: cuid, content: JSON (Lexical state), authorId: string, postId: string, parentId?: string, attachmentId?: string, coordinates?: JSON, createdAt: DateTime, updatedAt: DateTime }",
      "Reaction: { id: cuid, userId: string, postId?: string, commentId?: string, emojiId?: string, emoji: string, createdAt: DateTime }",
      "Notification: { id: cuid, type: COMMENT|COMMENT_REPLY|REACTION_POST|REACTION_COMMENT|MENTION, userId: string, actorId: string, postId?: string, commentId?: string, read: boolean, createdAt: DateTime }",
      "CustomEmoji: { id: cuid, name: string, url: string, uploadedById: string, createdAt: DateTime }",
      "SiteSettings: { id: 'default', siteName: string, inviteToken: string, discordWebhookUrl?: string, slackWebhookUrl?: string, updatedAt: DateTime }",
      "Draft: { id: cuid, userId: string, postId?: string, content: JSON, createdAt: DateTime, updatedAt: DateTime }",
      "PasswordResetToken: { id: cuid, userId: string, token: string, expiresAt: DateTime, used: boolean, createdAt: DateTime }"
    ],
    "invariants": [
      "Exactly one SiteSettings record exists with id='default'",
      "User email addresses are unique across the system",
      "First user in system always has role OWNER",
      "At least one OWNER or ADMIN must exist in the system at all times",
      "Comment parent relationships form maximum 2-level tree (parent.parentId must be null)",
      "Attachment order values are sequential integers starting from 0 within a post",
      "Each reaction is unique per user per entity (post or comment)",
      "Notification actorId and userId are different (users don't notify themselves)",
      "Password reset tokens become invalid after expiration or use",
      "Deactivated users cannot have active sessions",
      "PostProject, ProjectMember, and Notification are junction tables with cascade delete on parent removal",
      "Lexical editor state stored as JSON maintains valid AST structure",
      "Coordinates for comments stored as JSON with x,y numeric properties",
      "R2 URLs are presigned for private attachments before client access",
      "Webhook URLs must be valid HTTPS endpoints if configured"
    ],
    "assumptions": [
      "Cloudflare R2 bucket configured with appropriate CORS settings for direct uploads",
      "PostgreSQL database supports JSON column type for Lexical content storage",
      "NextAuth session tokens stored in JWT format with server-side secret",
      "Prisma connection pooling handles concurrent user requests efficiently",
      "R2 presigned URLs expire after reasonable timeframe (implementation dependent)",
      "Webhook endpoints (Discord/Slack) accept JSON payloads with post metadata",
      "Image thumbnails generated client-side or by R2 custom domain worker",
      "User avatar and project cover images served from R2 public URL or presigned",
      "Infinite scroll pagination uses cursor-based approach with nextCursor",
      "Search uses database full-text search (Prisma native or PostgreSQL FTS)",
      "Mentions extracted from Lexical JSON via custom utility function",
      "Mobile PWA functionality requires manifest.json and service worker setup",
      "Turbopack used in development for faster builds",
      "Storybook configured for UI component development and testing",
      "Vitest and Testing Library used for unit and integration tests"
    ],
    "unknowns": [
      "Maximum file size limits for attachment uploads",
      "R2 presigned URL expiration duration configuration",
      "Rate limiting implementation for API endpoints",
      "Webhook retry logic on failure",
      "Image compression or optimization pipeline before R2 upload",
      "Video thumbnail generation method (client-side, R2 transform, external service)",
      "Search ranking algorithm and indexing strategy",
      "Notification delivery mechanism (polling interval, WebSocket, SSE)",
      "Draft auto-save debounce interval and conflict resolution",
      "Custom emoji file size and format restrictions",
      "Pagination limit values and whether configurable per route",
      "Figma and Loom embed metadata extraction process",
      "Comment coordinate system origin and units for attachment annotations",
      "Session expiration duration and refresh strategy",
      "Concurrent edit handling for posts and comments",
      "Soft delete vs hard delete strategy for user-generated content",
      "Backup and disaster recovery procedures for PostgreSQL and R2",
      "GDPR compliance and data export functionality",
      "Observability and error tracking integration (Sentry, etc.)",
      "CDN configuration for R2 public assets"
    ],
    "confidenceBySection": {
      "system_purpose": 0.95,
      "core_features": 0.92,
      "user_flows": 0.88,
      "business_rules": 0.85,
      "data_contracts": 0.93,
      "invariants": 0.87,
      "assumptions": 0.75,
      "unknowns": 0.8
    }
  },
  "plan": {
    "version": "1.0.0",
    "targetAgent": "claude-code",
    "structured": {
      "systemOverview": "Draftboard is an internal design sharing platform built on Next.js with Prisma and NextAuth. It provides a social feed for distributed teams to post designs, ideas, and work-in-progress with rich media attachments, threaded comments, reactions, and notifications. The system uses Cloudflare R2 for file storage, supports role-based access control (OWNER/ADMIN/MEMBER), and includes admin tools for user management, site configuration, and webhook integrations.",
      "architectureDescription": "Next.js App Router handles frontend rendering and API routes. NextAuth manages authentication with JWT sessions. Prisma ORM connects to PostgreSQL for persistence with models for User, Post, Attachment, Project, Comment, Reaction, Notification, CustomEmoji, SiteSettings, Draft, and PasswordResetToken. Cloudflare R2 stores uploaded files with presigned URL access. Lexical editor state is stored as JSON in the database. Webhook notifications to Discord/Slack fire asynchronously on post creation. The first registered user becomes OWNER; subsequent users register via invite token and become MEMBER. Deactivated users are redirected to /deactivated. Comment threading is limited to 2 levels. Infinite scroll uses cursor-based pagination.",
      "routeMap": [
        {
          "path": "/",
          "purpose": "Home feed displaying reverse chronological posts with optional grid/list view toggle and project filter",
          "layout": "Sticky top header with view mode toggle (list/grid), search trigger (Cmd+K), notification bell, profile menu, and 'New Post' action. Main content region with infinite scroll feed. Empty state shown when no posts exist. Loading skeleton during fetch. No sidebar.",
          "components": [
            "StickyHeader with action cluster",
            "FeedViewToggle (list/grid)",
            "PostCard or PostGridItem",
            "InfiniteScrollTrigger",
            "LoadingSkeleton",
            "EmptyFeedState"
          ],
          "logic": [
            "Fetch posts ordered by createdAt DESC with cursor pagination",
            "Filter by project if query param present",
            "Exclude hideFromHome=true posts unless viewing project context",
            "Show author avatar, displayName, post title, content preview, attachments, reaction counts",
            "Click post to navigate to /post/[id]",
            "Infinite scroll loads next page when trigger enters viewport"
          ]
        },
        {
          "path": "/compose",
          "purpose": "Rich text editor for creating new posts with attachments and project assignment",
          "layout": "Sticky top header with 'Cancel' and 'Publish' actions, save status indicator. Full-width editor canvas with Lexical rich text, attachment upload zone below editor, project multi-select, 'Hide from home feed' checkbox. No sidebar. Bottom padding for comfortable editing.",
          "components": [
            "StickyHeader with save status",
            "LexicalEditor with markdown shortcuts, @mentions, slash commands",
            "AttachmentUploadZone with drag-and-drop",
            "AttachmentCarousel for uploaded files",
            "ProjectMultiSelect",
            "HideFromHomeFeedCheckbox",
            "AutosaveDraftIndicator"
          ],
          "logic": [
            "Initialize Lexical editor with empty state or draft if exists",
            "Auto-save draft to database every 2 seconds on content change",
            "Extract @mentions from Lexical JSON and validate against users",
            "Upload attachments to R2 via presigned URLs, store metadata in DB with order field",
            "On publish: create Post record, create Attachment records, create PostProject junction records, trigger webhook notifications, send mention notifications",
            "Validate title and content not empty before publish",
            "Clear draft after successful publish"
          ]
        },
        {
          "path": "/post/[id]",
          "purpose": "Full post detail view with attachments, threaded comments, and reactions",
          "layout": "Contextual header with post metadata (author avatar, displayName, createdAt, project badges) and actions (Edit if author, Delete if author). Primary content region with full Lexical-rendered content. Attachment carousel below content with coordinate-based comment indicators. Comment thread list with 2-level nesting. Reaction bar at bottom of post with built-in + custom emoji picker. Secondary rail on desktop showing project details and related posts.",
          "components": [
            "ContextHeader with author info and actions",
            "LexicalRenderer for post content",
            "AttachmentCarousel with coordinate comment markers",
            "ReactionBar with emoji picker",
            "CommentThread with reply nesting",
            "CommentComposer with Lexical editor",
            "SecondaryRail with project context"
          ],
          "logic": [
            "Fetch post with author, attachments ordered by order field, projects, comments with nested replies (max 2 levels), reactions grouped by emoji",
            "Render Lexical JSON into HTML preserving mentions, formatting, embeds",
            "Show Edit/Delete actions only if current user is post author",
            "For attachments: display based on type (IMAGE: img tag, VIDEO: video player, FILE: download link, FIGMA: embed iframe, LOOM: embed iframe)",
            "Click attachment to open fullscreen viewer with coordinate comment overlay",
            "Add reaction: upsert Reaction record, show optimistic UI, create REACTION_POST notification for post author",
            "Add comment: create Comment record, send COMMENT notification to post author and mentioned users, send webhook if top-level",
            "Reply to comment: create Comment with parentId, send COMMENT_REPLY notification to parent author and mentioned users",
            "Exclude notifications if user is author of target entity",
            "Mark related notifications as read when viewing post"
          ]
        },
        {
          "path": "/post/[id]/edit",
          "purpose": "Edit existing post with same editor capabilities as compose",
          "layout": "Identical to /compose layout but pre-populated with existing post data",
          "components": [
            "StickyHeader with save status and 'Cancel'/'Save' actions",
            "LexicalEditor initialized with existing content JSON",
            "AttachmentUploadZone with existing attachments",
            "ProjectMultiSelect with current selections",
            "HideFromHomeFeedCheckbox with current value"
          ],
          "logic": [
            "Fetch post with attachments and projects, verify current user is author, redirect if not",
            "Initialize Lexical editor with post.content JSON",
            "Display existing attachments with delete option",
            "Allow adding new attachments, maintain order field sequence",
            "On save: update Post record, upsert PostProject junctions, update/delete Attachment records",
            "Extract new @mentions and send notifications",
            "Do not trigger webhook on edit",
            "Navigate back to /post/[id] after save"
          ]
        },
        {
          "path": "/projects",
          "purpose": "Grid view of all projects with cover images and metadata",
          "layout": "Sticky top header with 'New Project' action. Grid of project cards (3-4 columns on desktop, 1-2 on mobile). Each card shows cover image, project name, description preview, member avatars, post count. Empty state if no projects exist.",
          "components": [
            "StickyHeader with 'New Project' button",
            "ProjectGrid",
            "ProjectCard with cover, name, description, members, post count",
            "EmptyProjectsState"
          ],
          "logic": [
            "Fetch all projects with member count, post count, cover URL",
            "Click project card to navigate to /projects/[id]",
            "Only show 'New Project' action to authenticated users"
          ]
        },
        {
          "path": "/projects/new",
          "purpose": "Create new project with name, description, cover image, team members, and URLs",
          "layout": "Centered form card (max-width 600px) with fields stacked vertically. Header with 'Cancel' and 'Create' actions. Cover image upload at top, name input, Lexical description editor, team member multi-select, URL list with add/remove.",
          "components": [
            "FormCard with header actions",
            "CoverImageUpload with drag-and-drop",
            "NameInput (required)",
            "LexicalEditor for description",
            "TeamMemberMultiSelect",
            "URLListEditor with add/remove rows"
          ],
          "logic": [
            "Upload cover image to R2, get presigned URL",
            "Validate name is not empty",
            "On create: insert Project record with createdById, create ProjectMember records for selected users with role='MEMBER', create ProjectUrl records for each URL",
            "Navigate to /projects/[id] after creation"
          ]
        },
        {
          "path": "/projects/[id]",
          "purpose": "Project detail page with posts feed, description, members, and URLs",
          "layout": "Hero header with cover image, project name, description, edit action (if creator or member). Tab navigation for 'Posts', 'Members', 'URLs'. Posts tab shows filtered feed (same as home but filtered to this project). Members tab shows avatar list with role badges. URLs tab shows clickable link list. Secondary rail on desktop with quick stats.",
          "components": [
            "ProjectHero with cover, name, description, edit button",
            "TabNavigation",
            "PostFeed filtered by project",
            "MemberList with avatars and roles",
            "URLList with external link icons",
            "SecondaryRail with stats"
          ],
          "logic": [
            "Fetch project with posts, members, URLs",
            "Show edit action if current user is project creator or member",
            "Posts tab: fetch posts where PostProject.projectId matches, apply same feed logic as home",
            "Members tab: display ProjectMember records with user info",
            "URLs tab: render ProjectUrl records as links",
            "Click edit to navigate to /projects/[id]/edit"
          ]
        },
        {
          "path": "/projects/[id]/edit",
          "purpose": "Edit project details, members, and URLs",
          "layout": "Same form layout as /projects/new but pre-populated with existing data",
          "components": [
            "FormCard with 'Cancel'/'Save' actions",
            "CoverImageUpload with current cover",
            "NameInput with current name",
            "LexicalEditor with current description",
            "TeamMemberMultiSelect with current members",
            "URLListEditor with current URLs"
          ],
          "logic": [
            "Fetch project, verify current user is creator or member, redirect if not",
            "Pre-populate all fields with existing data",
            "On save: update Project record, sync ProjectMember records (add/remove), sync ProjectUrl records (add/remove/update)",
            "Navigate back to /projects/[id] after save"
          ]
        },
        {
          "path": "/notifications",
          "purpose": "Activity feed showing comments, replies, mentions, and reactions",
          "layout": "Full-width list with sticky top header. Each notification item shows actor avatar, action description, timestamp, target post/comment preview. Unread notifications have accent border. Empty state if no notifications. Mark as read on view.",
          "components": [
            "StickyHeader with 'Mark all read' action",
            "NotificationList",
            "NotificationItem with avatar, description, timestamp, preview",
            "EmptyNotificationsState"
          ],
          "logic": [
            "Fetch notifications for current user ordered by createdAt DESC",
            "Group by date (Today, Yesterday, This Week, Older)",
            "Show actor displayName, action type (commented on, replied to, mentioned you in, reacted to), target post title or comment preview",
            "Mark notification as read when viewed (update read=true)",
            "Click notification to navigate to target post or comment",
            "Polling or real-time updates to show new notifications without refresh"
          ]
        },
        {
          "path": "/settings",
          "purpose": "User profile settings: display name and avatar upload",
          "layout": "Centered card (max-width 600px) with sections stacked vertically. Avatar upload with current avatar preview. Display name input. Email (read-only). Account created date (read-only). Save button at bottom.",
          "components": [
            "SettingsCard",
            "AvatarUpload with preview",
            "DisplayNameInput",
            "ReadOnlyEmailField",
            "AccountMetadata",
            "SaveButton"
          ],
          "logic": [
            "Fetch current user data",
            "Upload avatar to R2, get presigned URL",
            "Validate displayName not empty",
            "On save: update User record (displayName, avatarUrl)",
            "Show success toast after save"
          ]
        },
        {
          "path": "/admin/users",
          "purpose": "Admin panel for user management: view all users, promote/demote roles, deactivate users",
          "layout": "Sticky top header with 'Regenerate Invite Link' action. Table with columns: Avatar, Name, Email, Role, Posts, Comments, Status, Actions. Each row has role dropdown (MEMBER/ADMIN/OWNER) and Deactivate/Activate toggle. Floating action menu in bottom-right with 'Invite User' (shows invite link dialog).",
          "components": [
            "StickyHeader with invite link action",
            "UserTable with sortable columns",
            "UserRow with avatar, name, email, role dropdown, stats, status badge, action buttons",
            "FloatingActionMenu with invite link dialog",
            "RoleDropdown with MEMBER/ADMIN/OWNER",
            "DeactivateToggle"
          ],
          "logic": [
            "Verify current user role is ADMIN or OWNER, redirect to / if not",
            "Fetch all users with post count, comment count, role, deactivated status",
            "Change role: update User.role, show optimistic UI, prevent demoting last OWNER",
            "Deactivate user: update User.deactivated=true, prevent user from deactivating themselves",
            "Regenerate invite link: update SiteSettings.inviteToken with new random token, show dialog with link",
            "Show invite link in dialog with copy button"
          ]
        },
        {
          "path": "/admin/settings",
          "purpose": "Admin panel for site-wide settings: site name, webhook URLs, custom emoji",
          "layout": "Card-based layout with sections: Site Settings (name), Integrations (Discord/Slack webhook URLs), Custom Emoji (upload and list). Each section has card with header, fields, and save action.",
          "components": [
            "SettingsCard with section header",
            "SiteNameInput",
            "WebhookURLInput for Discord and Slack",
            "CustomEmojiUpload",
            "CustomEmojiList with delete action",
            "SaveButton per section"
          ],
          "logic": [
            "Verify current user role is ADMIN or OWNER, redirect to / if not",
            "Fetch SiteSettings (id='default'), ensure record exists",
            "Update site name: update SiteSettings.siteName",
            "Update webhook URLs: validate HTTPS, update SiteSettings.discordWebhookUrl and slackWebhookUrl",
            "Upload custom emoji: upload to R2, create CustomEmoji record with name and URL",
            "Delete custom emoji: delete CustomEmoji record, remove from R2",
            "Show success toast after each save"
          ]
        },
        {
          "path": "/invite/[token]",
          "purpose": "Registration page for new users via invite link",
          "layout": "Centered registration form card (max-width 400px) with fields: Email, Password, Display Name. Header shows 'Join Draftboard'. Submit button labeled 'Create Account'. Link to sign-in if already have account.",
          "components": [
            "RegistrationCard",
            "EmailInput",
            "PasswordInput with strength indicator",
            "DisplayNameInput",
            "SubmitButton",
            "SignInLink"
          ],
          "logic": [
            "Validate token matches SiteSettings.inviteToken, show error if invalid",
            "Check if any users exist: if none, create user with role=OWNER; if users exist, create with role=MEMBER",
            "Validate email unique, password meets requirements, displayName not empty",
            "Hash password with bcrypt",
            "Create User record, sign in with NextAuth",
            "Navigate to / after registration"
          ]
        },
        {
          "path": "/reset-password/[token]",
          "purpose": "Password reset form for users who requested reset",
          "layout": "Centered form card (max-width 400px) with new password input, confirm password input, submit button. Header shows 'Reset Password'. Link to sign-in.",
          "components": [
            "ResetPasswordCard",
            "NewPasswordInput with strength indicator",
            "ConfirmPasswordInput",
            "SubmitButton",
            "SignInLink"
          ],
          "logic": [
            "Validate token exists in PasswordResetToken table, not expired (expiresAt > now), not used",
            "Validate new password meets requirements, matches confirmation",
            "Hash new password with bcrypt",
            "Update User.passwordHash",
            "Mark PasswordResetToken.used=true",
            "Show success message, redirect to sign-in"
          ]
        },
        {
          "path": "/deactivated",
          "purpose": "Information page for deactivated users",
          "layout": "Centered card with heading 'Account Deactivated', body text explaining status, contact admin message. No navigation or actions available.",
          "components": [
            "DeactivatedCard with heading and message"
          ],
          "logic": [
            "Show static message explaining account is deactivated",
            "Provide contact information for admin",
            "Sign out link to clear session"
          ]
        }
      ],
      "moduleList": [
        "app/layout.tsx - Root layout with NextAuth provider, theme provider, command palette wrapper",
        "app/page.tsx - Home feed page with view toggle and infinite scroll",
        "app/compose/page.tsx - Post creation page with Lexical editor",
        "app/post/[id]/page.tsx - Post detail page with comments and reactions",
        "app/post/[id]/edit/page.tsx - Post edit page",
        "app/projects/page.tsx - Projects grid page",
        "app/projects/new/page.tsx - New project form",
        "app/projects/[id]/page.tsx - Project detail page with tabs",
        "app/projects/[id]/edit/page.tsx - Project edit form",
        "app/notifications/page.tsx - Notifications feed",
        "app/settings/page.tsx - User settings page",
        "app/admin/users/page.tsx - Admin user management",
        "app/admin/settings/page.tsx - Admin site settings",
        "app/invite/[token]/page.tsx - User registration via invite",
        "app/reset-password/[token]/page.tsx - Password reset form",
        "app/deactivated/page.tsx - Deactivated account message",
        "app/api/posts/route.ts - GET posts with pagination, POST create post",
        "app/api/posts/[id]/route.ts - GET post detail, PATCH update, DELETE post",
        "app/api/comments/route.ts - POST create comment",
        "app/api/comments/[id]/route.ts - PATCH update, DELETE comment",
        "app/api/reactions/route.ts - POST add/remove reaction",
        "app/api/projects/route.ts - GET projects, POST create project",
        "app/api/projects/[id]/route.ts - GET project, PATCH update, DELETE project",
        "app/api/notifications/route.ts - GET notifications, PATCH mark read",
        "app/api/users/route.ts - GET users (admin), PATCH update user",
        "app/api/admin/settings/route.ts - GET/PATCH site settings",
        "app/api/admin/invite-token/route.ts - POST regenerate invite token",
        "app/api/upload/presigned-url/route.ts - POST generate R2 presigned URL",
        "app/api/webhooks/notify/route.ts - POST trigger Discord/Slack webhooks",
        "app/api/auth/[...nextauth]/route.ts - NextAuth configuration",
        "components/lexical/LexicalEditor.tsx - Rich text editor with plugins",
        "components/lexical/LexicalRenderer.tsx - Render Lexical JSON to HTML",
        "components/ui/Button.tsx - Button variants (primary, ghost, destructive)",
        "components/ui/Input.tsx - Input with validation states",
        "components/ui/Card.tsx - Card container with header/content",
        "components/ui/Avatar.tsx - User avatar with fallback",
        "components/ui/Badge.tsx - Badge for tags and status",
        "components/ui/Dialog.tsx - Modal dialog primitive",
        "components/ui/Sheet.tsx - Bottom sheet primitive",
        "components/ui/Dropdown.tsx - Dropdown menu primitive",
        "components/ui/Toast.tsx - Toast notification",
        "components/PostCard.tsx - Post preview card for feed",
        "components/PostGridItem.tsx - Post preview for grid view",
        "components/AttachmentCarousel.tsx - Attachment viewer with navigation",
        "components/CommentThread.tsx - Nested comment list with replies",
        "components/ReactionBar.tsx - Reaction picker and display",
        "components/NotificationItem.tsx - Notification list item",
        "components/CommandPalette.tsx - Search and navigation (Cmd+K)",
        "components/FloatingActionMenu.tsx - Bottom-right FAB with actions",
        "lib/prisma.ts - Prisma client singleton",
        "lib/auth.ts - NextAuth configuration and helpers",
        "lib/r2.ts - Cloudflare R2 client and presigned URL helpers",
        "lib/webhooks.ts - Discord and Slack webhook notification helpers",
        "lib/notifications.ts - Create and send notification logic",
        "lib/mentions.ts - Extract @mentions from Lexical JSON",
        "lib/validations.ts - Zod schemas for API validation",
        "prisma/schema.prisma - Database schema with all models",
        "prisma/migrations/ - Database migration files"
      ],
      "functionalityLogic": [
        "Authentication: NextAuth with credentials provider, JWT sessions, password hashing with bcrypt, session checks in API routes and pages",
        "Authorization: Middleware checks user role (OWNER/ADMIN/MEMBER) for admin routes, post/comment author checks for edit/delete, deactivated user redirect to /deactivated",
        "Post creation: Lexical editor state saved as JSON, auto-save draft every 2 seconds, extract @mentions, upload attachments to R2 with presigned URLs, create Post and Attachment records in transaction, create PostProject junctions, trigger webhooks, send mention notifications",
        "Post editing: Load existing post, verify author, update Post record, sync attachments (add/remove), sync projects, extract new @mentions, send new notifications",
        "Comments: Two-level threading (parent.parentId must be null), Lexical content as JSON, optional attachmentId and coordinates for attachment-specific comments, create COMMENT or COMMENT_REPLY notifications, exclude notifications for comment author",
        "Reactions: Unique per user per entity (post or comment), upsert Reaction record, create REACTION_POST or REACTION_COMMENT notification, display grouped by emoji with count",
        "Notifications: Create on comment/reply/mention/reaction, exclude if user is target author, mark as read when viewing notification or target post, real-time updates via polling or WebSocket",
        "Projects: Create with name/description/cover/members/URLs, project creators and members can edit, posts can be assigned to multiple projects via PostProject junction, project feed filters posts by project",
        "File uploads: Generate presigned URL for R2 upload, client uploads directly to R2, server stores metadata in Attachment table with type (IMAGE/VIDEO/FILE/FIGMA/LOOM), order field for carousel sequence, presigned URLs for private access",
        "Search: Command palette (Cmd+K) with full-text search across posts, projects, users, search only active (non-deactivated) users, navigate to result on select",
        "Webhooks: On post creation, send JSON payload to Discord and Slack webhook URLs if configured, async/background job, retry on failure",
        "User management: First user becomes OWNER, subsequent users register via invite token as MEMBER, admins can promote/demote roles, deactivate users (cannot deactivate self), regenerate invite token",
        "Password reset: User requests reset from sign-in, create PasswordResetToken with 24-hour expiration, send email with token link, validate token on reset page, update password and mark token used",
        "Drafts: Auto-save post content to Draft table on compose page, load draft on page load, clear draft after publish",
        "Feed: Reverse chronological order by createdAt, cursor-based pagination with nextCursor, filter by project, exclude hideFromHome=true posts unless in project context, infinite scroll loads next page",
        "View modes: List view (full post cards with preview) and grid view (compact cards with image), toggle persisted in user preference or localStorage"
      ],
      "interfaces": [
        "POST /api/posts - Create post: { title?, content: JSON, liveUrl?, hideFromHome: boolean, projectIds: string[], attachments: Attachment[] } → { postId: string }",
        "GET /api/posts - List posts: { cursor?, projectId?, limit: number } → { posts: Post[], nextCursor?: string }",
        "GET /api/posts/[id] - Get post detail → { post: Post, author: User, attachments: Attachment[], projects: Project[], comments: Comment[], reactions: Reaction[] }",
        "PATCH /api/posts/[id] - Update post: { title?, content: JSON, liveUrl?, hideFromHome: boolean, projectIds: string[], attachments: Attachment[] } → { success: boolean }",
        "DELETE /api/posts/[id] - Delete post → { success: boolean }",
        "POST /api/comments - Create comment: { content: JSON, postId: string, parentId?: string, attachmentId?: string, coordinates?: { x: number, y: number } } → { commentId: string }",
        "PATCH /api/comments/[id] - Update comment: { content: JSON } → { success: boolean }",
        "DELETE /api/comments/[id] - Delete comment → { success: boolean }",
        "POST /api/reactions - Add/remove reaction: { postId?: string, commentId?: string, emoji: string, emojiId?: string } → { success: boolean }",
        "GET /api/projects - List projects → { projects: Project[] }",
        "POST /api/projects - Create project: { name: string, description?: JSON, coverUrl?: string, memberIds: string[], urls: { title: string, url: string }[] } → { projectId: string }",
        "GET /api/projects/[id] - Get project detail → { project: Project, posts: Post[], members: User[], urls: ProjectUrl[] }",
        "PATCH /api/projects/[id] - Update project: { name: string, description?: JSON, coverUrl?: string, memberIds: string[], urls: ProjectUrl[] } → { success: boolean }",
        "GET /api/notifications - List notifications: { cursor?, limit: number } → { notifications: Notification[], nextCursor?: string }",
        "PATCH /api/notifications - Mark notifications read: { notificationIds: string[] } → { success: boolean }",
        "GET /api/users - List all users (admin only) → { users: User[] }",
        "PATCH /api/users/[id] - Update user: { displayName?: string, avatarUrl?: string, role?: Role, deactivated?: boolean } → { success: boolean }",
        "GET /api/admin/settings - Get site settings (admin only) → { settings: SiteSettings }",
        "PATCH /api/admin/settings - Update site settings (admin only): { siteName?: string, discordWebhookUrl?: string, slackWebhookUrl?: string } → { success: boolean }",
        "POST /api/admin/invite-token - Regenerate invite token (admin only) → { inviteToken: string }",
        "POST /api/upload/presigned-url - Generate presigned URL: { filename: string, contentType: string, size: number } → { uploadUrl: string, fileUrl: string }",
        "POST /api/webhooks/notify - Trigger webhooks: { postId: string } → { success: boolean }"
      ],
      "dataModels": [
        "User: { id: cuid, email: unique string, passwordHash: string, displayName: string, avatarUrl?: string, role: enum(MEMBER,ADMIN,OWNER), deactivated: boolean, createdAt: DateTime, updatedAt: DateTime }",
        "Post: { id: cuid, title?: string, content: JSON, liveUrl?: string, hideFromHome: boolean default false, authorId: string, author: User, createdAt: DateTime, updatedAt: DateTime, attachments: Attachment[], projects: Project[], comments: Comment[], reactions: Reaction[] }",
        "Attachment: { id: cuid, postId: string, post: Post, type: enum(IMAGE,VIDEO,FILE,FIGMA,LOOM), url: string, filename: string, mimeType: string, size: int, width?: int, height?: int, thumbnailUrl?: string, metadata?: JSON, order: int, createdAt: DateTime }",
        "Project: { id: cuid, name: string, description?: JSON, coverUrl?: string, createdById: string, createdBy: User, createdAt: DateTime, updatedAt: DateTime, members: ProjectMember[], urls: ProjectUrl[], posts: Post[] }",
        "ProjectMember: { id: cuid, projectId: string, project: Project, userId: string, user: User, role: string default 'MEMBER', createdAt: DateTime }",
        "ProjectUrl: { id: cuid, projectId: string, project: Project, title: string, url: string }",
        "Comment: { id: cuid, content: JSON, authorId: string, author: User, postId: string, post: Post, parentId?: string, parent?: Comment, replies: Comment[], attachmentId?: string, attachment?: Attachment, coordinates?: JSON, createdAt: DateTime, updatedAt: DateTime, reactions: Reaction[] }",
        "Reaction: { id: cuid, userId: string, user: User, postId?: string, post?: Post, commentId?: string, comment?: Comment, emojiId?: string, customEmoji?: CustomEmoji, emoji: string, createdAt: DateTime } - Unique constraint: [userId, postId, commentId]",
        "Notification: { id: cuid, type: enum(COMMENT,COMMENT_REPLY,REACTION_POST,REACTION_COMMENT,MENTION), userId: string, user: User, actorId: string, actor: User, postId?: string, post?: Post, commentId?: string, comment?: Comment, read: boolean default false, createdAt: DateTime }",
        "CustomEmoji: { id: cuid, name: string, url: string, uploadedById: string, uploadedBy: User, createdAt: DateTime }",
        "SiteSettings: { id: string default 'default', siteName: string, inviteToken: string, discordWebhookUrl?: string, slackWebhookUrl?: string, updatedAt: DateTime }",
        "Draft: { id: cuid, userId: string, user: User, postId?: string, content: JSON, createdAt: DateTime, updatedAt: DateTime }",
        "PasswordResetToken: { id: cuid, userId: string, user: User, token: string, expiresAt: DateTime, used: boolean default false, createdAt: DateTime }"
      ],
      "databaseDesign": [
        "Create Prisma schema with datasource postgresql and generator client",
        "Add cuid() default for all id fields",
        "Add indexes: User.email unique, Reaction unique [userId, postId, commentId], PasswordResetToken.token unique, SiteSettings.id fixed as 'default'",
        "Add indexes for performance: Post.createdAt desc, Post.authorId, Comment.postId, Comment.parentId, Notification.userId + createdAt desc, ProjectMember.projectId + userId",
        "Add cascade deletes: Post delete → cascade Attachment/Comment/Reaction/Notification, Comment delete → cascade child Comments/Reactions/Notifications, Project delete → cascade ProjectMember/ProjectUrl/PostProject",
        "Add onDelete: SetNull for optional foreign keys like Comment.parentId, Comment.attachmentId, Reaction.emojiId",
        "Add @updatedAt directive to Post, Project, User, SiteSettings for automatic timestamp updates",
        "Create initial migration with schema.prisma as source",
        "Seed script: create SiteSettings record with id='default', generate random inviteToken, set default siteName",
        "Add fulltext search index on Post.title and Post.content if using PostgreSQL FTS"
      ],
      "designSystem": {
        "visualDirection": "Technical workspace with high information density, strong hierarchy, restrained accents, and explicit state feedback. Layered surfaces with crisp borders and subtle shadows for depth. Disciplined spacing and alignment. Utility-driven composition with Tailwind CSS.",
        "styleLanguage": [
          "Utility-first with Tailwind CSS for all styling",
          "Component primitives from shadcn/ui with app-level token overrides",
          "High-contrast text on neutral backgrounds for legibility",
          "Restrained use of color: neutral base with single accent family",
          "Consistent border treatment (1px solid) for cards, inputs, buttons",
          "Subtle layered surfaces: bg-background, bg-card, bg-muted for hierarchy"
        ],
        "colorPalette": [
          "Primary: #1A1918 (dark charcoal) for text and strong UI elements",
          "Secondary: #F5F4F2 (warm off-white) for backgrounds and surfaces",
          "Accent: Derive from primary with HSL adjustments for interactive states",
          "Semantic tokens: green for success, red for danger, yellow for warning, blue for info",
          "Neutral scale: background #FFFFFF, card #F5F4F2, muted #E8E7E5, border #D1D0CE, muted-foreground #6B6A68, foreground #1A1918",
          "Dark mode: invert with background #1A1918, card #2A2928, muted #3A3938, border #4A4948"
        ],
        "typography": [
          "Primary UI font: system font stack (ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif)",
          "Monospace font: ui-monospace, 'SF Mono', 'Consolas', monospace for technical metadata and code",
          "Heading scale: h1 (2.25rem/600), h2 (1.875rem/600), h3 (1.5rem/600), h4 (1.25rem/600), h5 (1.125rem/600), h6 (1rem/600)",
          "Body: base (1rem/400), small (0.875rem/400), xs (0.75rem/400)",
          "Line height: tight (1.25) for headings, normal (1.5) for body, relaxed (1.75) for long-form content",
          "Font weight: 400 regular, 500 medium for emphasis, 600 semibold for headings"
        ],
        "radiusSystem": [
          "r-xs: 2px for tight controls (badges, small buttons)",
          "r-sm: 4px for inputs, small cards",
          "r-md: 6px for buttons, standard cards (default)",
          "r-lg: 8px for modals, sheets, large cards",
          "r-xl: 12px for special surfaces (hero sections, cover images)"
        ],
        "pageLayoutPatterns": [
          "Shell: fixed top header (h-14) with brand, navigation, search trigger, notifications, profile. Main content region with max-w-7xl centered, px-4 sm:px-6 lg:px-8",
          "Feed page: sticky header with actions, feed container max-w-3xl, infinite scroll with loading trigger",
          "Detail page: contextual header with breadcrumb/back, content max-w-4xl, secondary rail max-w-xs on lg+ screens",
          "Form page: centered card max-w-2xl, fields stacked with gap-6, sticky footer with actions",
          "Admin page: full-width table with sticky header, floating action menu bottom-right",
          "Responsive breakpoints: sm 640px, md 768px, lg 1024px, xl 1280px"
        ],
        "components": [
          "Button: variants (default, ghost, outline, destructive), sizes (sm, default, lg), loading state with spinner, disabled state with opacity-50",
          "Input: border-border focus:ring-2 ring-accent, error state with border-destructive, helper text below",
          "Card: bg-card border border-border rounded-r-md shadow-sm, CardHeader with title/description, CardContent with p-6",
          "Avatar: rounded-full with fallback initials, ring-2 ring-background for layering",
          "Badge: rounded-r-xs px-2 py-0.5 text-xs, variants (default, success, warning, danger, outline)",
          "Dialog: fixed inset-0 bg-black/50 backdrop-blur-sm, centered card with max-w-lg, close button top-right, footer with actions",
          "Sheet: fixed bottom-0 inset-x-0 bg-card rounded-t-r-lg, drag handle, close button, max-h-[90vh] overflow-auto",
          "Dropdown: floating menu with shadow-lg, items with hover:bg-muted, dividers, keyboard navigation",
          "Toast: fixed bottom-4 right-4, bg-card border shadow-lg, auto-dismiss after 5s, variants for success/error/info",
          "Skeleton: bg-muted animate-pulse, preserve layout dimensions during loading",
          "EmptyState: centered icon + heading + description, optional action button"
        ],
        "motion": [
          "Fast: 150ms for hover states, button presses, small UI transitions",
          "Standard: 250ms for modal/sheet entry, dropdown open, page transitions",
          "Slow: 350ms for large surface animations, page-level state changes",
          "Easing: ease-out for entry, ease-in for exit, ease-in-out for bidirectional",
          "Spring easing for modals: cubic-bezier(0.34, 1.56, 0.64, 1)",
          "Honor prefers-reduced-motion: disable animations if user preference set"
        ],
        "distinctiveTraits": [
          "Consistent 1px border treatment across all surfaces",
          "Mono + UI typography pairing for technical identity",
          "Restrained use of color: single accent family with semantic tokens",
          "High information density with disciplined spacing (4px base unit)",
          "Explicit state feedback: loading spinners, success toasts, error messages",
          "Utility-driven composition: no custom CSS, all Tailwind classes"
        ],
        "statesAndFeedback": [
          "Hover: bg-muted for interactive surfaces, underline for links",
          "Focus: ring-2 ring-accent for keyboard navigation",
          "Active: scale-95 for buttons, bg-accent for selected items",
          "Disabled: opacity-50 cursor-not-allowed",
          "Loading: spinner with sr-only text, skeleton for content placeholders",
          "Error: border-destructive with text-destructive message below, icon for visibility",
          "Success: toast with checkmark icon, green accent, auto-dismiss",
          "Empty: centered icon + heading + description, call-to-action button"
        ]
      },
      "behaviorRules": [
        "First user self-registers and becomes OWNER, all subsequent registrations require valid invite token and create MEMBER role",
        "Admin routes (/admin/*) require role ADMIN or OWNER, redirect to / if unauthorized",
        "Deactivated users redirected to /deactivated on any protected route access",
        "Users cannot deactivate themselves, only admins can deactivate other users",
        "At least one OWNER or ADMIN must exist in system at all times (prevent demoting last OWNER)",
        "Post edit and delete actions only visible to post author",
        "Comment edit and delete actions only visible to comment author",
        "Project edit action only visible to project creator and members",
        "Comment threading limited to 2 levels: can reply to top-level comment but not to reply",
        "Notifications not sent if actor is the target entity author (e.g., user cannot notify themselves by commenting on own post)",
        "Mention notifications excluded if user already receiving comment/reply notification for same action",
        "Password reset tokens expire after 24 hours, become invalid after use",
        "Invite token is site-wide, regenerated by admins only, shown in dialog on /admin/users",
        "Post hideFromHome flag hides post from home feed but visible on project pages and direct links",
        "Webhook notifications sent asynchronously on post creation if discordWebhookUrl or slackWebhookUrl configured",
        "Search (command palette) requires authentication, only returns active users (deactivated=false)",
        "Reactions are unique per user per entity (post or comment), clicking again removes reaction",
        "Draft auto-save every 2 seconds on compose page, draft cleared after successful publish",
        "File uploads: client generates presigned URL from API, uploads directly to R2, server stores metadata",
        "Attachment order field determines carousel sequence, must be sequential integers starting from 0",
        "Lexical editor content stored as JSON, rendered on post detail page preserving mentions and formatting",
        "Infinite scroll uses cursor-based pagination with nextCursor from last item id",
        "Command palette (Cmd+K) opens search overlay, Esc closes, arrow keys navigate results, Enter selects",
        "Floating action menu on /admin/users fixed to bottom-right, shows invite link dialog on click",
        "Notifications marked as read when viewing notification page or target post/comment",
        "Real-time notification updates via polling every 30 seconds or WebSocket connection if implemented"
      ],
      "buildSteps": [
        "1. Initialize Next.js project with TypeScript, Tailwind CSS, ESLint: npx create-next-app@latest --typescript --tailwind --eslint",
        "2. Install dependencies: npm install prisma @prisma/client next-auth bcryptjs @lexical/react lexical @aws-sdk/client-s3 @aws-sdk/s3-request-presigner zod react-hook-form",
        "3. Install dev dependencies: npm install -D @types/bcryptjs @types/node tsx",
        "4. Initialize Prisma: npx prisma init --datasource-provider postgresql",
        "5. Define Prisma schema in prisma/schema.prisma with all models (User, Post, Attachment, Project, ProjectMember, ProjectUrl, Comment, Reaction, Notification, CustomEmoji, SiteSettings, Draft, PasswordResetToken) and relations",
        "6. Create initial migration: npx prisma migrate dev --name init",
        "7. Create lib/prisma.ts with PrismaClient singleton for connection pooling",
        "8. Configure NextAuth in app/api/auth/[...nextauth]/route.ts with credentials provider, JWT session, password verification with bcrypt",
        "9. Create lib/auth.ts with getServerSession helper and role check utilities",
        "10. Configure Cloudflare R2 client in lib/r2.ts with S3Client and presigned URL generation",
        "11. Create seed script prisma/seed.ts to initialize SiteSettings record with id='default', generate random inviteToken",
        "12. Run seed: npx prisma db seed",
        "13. Install shadcn/ui CLI: npx shadcn-ui@latest init, configure with Tailwind and component path",
        "14. Add shadcn components: npx shadcn-ui@latest add button input card avatar badge dialog sheet dropdown-menu toast",
        "15. Create design system tokens in tailwind.config.ts extending theme with custom colors (primary #1A1918, secondary #F5F4F2), radius scale (xs 2px, sm 4px, md 6px, lg 8px, xl 12px), font families",
        "16. Build Lexical editor component in components/lexical/LexicalEditor.tsx with RichTextPlugin, AutoFocusPlugin, MentionPlugin, MarkdownShortcutPlugin, DragDropPastePlugin",
        "17. Build Lexical renderer in components/lexical/LexicalRenderer.tsx to convert JSON state to HTML",
        "18. Create API route app/api/posts/route.ts for GET (list with pagination) and POST (create with transaction)",
        "19. Create API route app/api/posts/[id]/route.ts for GET (detail), PATCH (update), DELETE (with author check)",
        "20. Create API route app/api/comments/route.ts for POST (create with notification logic)",
        "21. Create API route app/api/comments/[id]/route.ts for PATCH (update), DELETE (with author check)",
        "22. Create API route app/api/reactions/route.ts for POST (upsert with unique constraint, notification)",
        "23. Create API route app/api/projects/route.ts for GET (list), POST (create with transaction)",
        "24. Create API route app/api/projects/[id]/route.ts for GET (detail), PATCH (update with sync logic), DELETE",
        "25. Create API route app/api/notifications/route.ts for GET (list with pagination), PATCH (mark read)",
        "26. Create API route app/api/users/route.ts for GET (admin only, all users), PATCH (update user with role/deactivation checks)",
        "27. Create API route app/api/admin/settings/route.ts for GET/PATCH (admin only, SiteSettings)",
        "28. Create API route app/api/admin/invite-token/route.ts for POST (regenerate token)",
        "29. Create API route app/api/upload/presigned-url/route.ts for POST (generate R2 presigned URL with validation)",
        "30. Create API route app/api/webhooks/notify/route.ts for POST (send Discord/Slack webhook with post data)",
        "31. Create lib/notifications.ts with helper functions to create COMMENT, COMMENT_REPLY, REACTION_POST, REACTION_COMMENT, MENTION notifications with exclusion logic",
        "32. Create lib/mentions.ts with function to extract @mentions from Lexical JSON state and validate against User table",
        "33. Create lib/webhooks.ts with functions to format and send Discord/Slack webhook payloads",
        "34. Create lib/validations.ts with Zod schemas for API request validation",
        "35. Build home page app/page.tsx with feed, view toggle (list/grid), infinite scroll using IntersectionObserver",
        "36. Build compose page app/compose/page.tsx with LexicalEditor, attachment upload zone, project multi-select, hideFromHome checkbox, auto-save draft logic",
        "37. Build post detail page app/post/[id]/page.tsx with content render, attachment carousel, comment thread, reaction bar",
        "38. Build post edit page app/post/[id]/edit/page.tsx with same editor as compose, pre-populated with existing data",
        "39. Build projects list page app/projects/page.tsx with grid layout, project cards with cover/name/stats",
        "40. Build new project page app/projects/new/page.tsx with form for name/description/cover/members/URLs",
        "41. Build project detail page app/projects/[id]/page.tsx with tabs (Posts, Members, URLs), filtered feed for Posts tab",
        "42. Build project edit page app/projects/[id]/edit/page.tsx with same form as new, pre-populated",
        "43. Build notifications page app/notifications/page.tsx with list grouped by date, mark read on view",
        "44. Build settings page app/settings/page.tsx with avatar upload, displayName input, account metadata",
        "45. Build admin users page app/admin/users/page.tsx with table, role dropdown, deactivate toggle, floating action menu with invite link dialog",
        "46. Build admin settings page app/admin/settings/page.tsx with sections for site name, webhook URLs, custom emoji upload/list",
        "47. Build invite registration page app/invite/[token]/page.tsx with form, token validation, first user becomes OWNER logic",
        "48. Build password reset page app/reset-password/[token]/page.tsx with form, token validation, password update",
        "49. Build deactivated page app/deactivated/page.tsx with static message and sign-out link",
        "50. Build root layout app/layout.tsx with NextAuthProvider, theme provider (light/dark mode), command palette wrapper",
        "51. Create components/CommandPalette.tsx with search input, results list (posts/projects/users), keyboard navigation",
        "52. Create components/PostCard.tsx with author info, content preview, attachment previews, reaction counts, click to detail",
        "53. Create components/PostGridItem.tsx with compact layout, cover image, title, hover overlay",
        "54. Create components/AttachmentCarousel.tsx with image viewer, video player, file download, navigation arrows, coordinate comment overlay",
        "55. Create components/CommentThread.tsx with nested structure (max 2 levels), reply button, edit/delete actions",
        "56. Create components/ReactionBar.tsx with emoji picker (built-in + custom), reaction counts, reactors dialog",
        "57. Create components/NotificationItem.tsx with actor avatar, action description, timestamp, target preview, unread indicator",
        "58. Create components/FloatingActionMenu.tsx with fixed bottom-right position, elevated surface, quick actions",
        "59. Create middleware.ts to check auth status, redirect deactivated users to /deactivated, protect admin routes",
        "60. Add environment variables to .env: DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL, R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_BUCKET_NAME",
        "61. Configure next.config.js with images domains for R2 URLs, experimental features if needed",
        "62. Create public/manifest.json for PWA with name, icons, theme color, start URL",
        "63. Add service worker registration in app/layout.tsx for PWA offline support",
        "64. Write unit tests with Vitest for lib helpers (notifications, mentions, webhooks)",
        "65. Write integration tests with Testing Library for key flows (post creation, comment threading, reactions)",
        "66. Run type checking: npx tsc --noEmit",
        "67. Run linting: npm run lint",
        "68. Run tests: npm run test",
        "69. Build production bundle: npm run build",
        "70. Deploy to Vercel or similar platform with environment variables configured"
      ],
      "testExpectations": [
        "User registration: First user receives OWNER role, subsequent users with valid invite token receive MEMBER role, invalid token shows error",
        "Authentication: Sign in with valid credentials succeeds, invalid credentials show error, deactivated users redirect to /deactivated",
        "Post creation: Valid post with content saves successfully, attachments upload to R2 and store metadata, projects assigned via junction table, webhook fires if configured, mentions send notifications",
        "Post editing: Only post author can edit, updates save correctly, new attachments add with incremented order, removed attachments delete from R2",
        "Comment threading: Top-level comments save with postId, replies save with parentId, replies to replies blocked (max 2 levels), notifications sent to parent author and mentioned users",
        "Reactions: Clicking reaction adds record with unique constraint, clicking again removes, notification sent to entity author, reaction counts display correctly",
        "Notifications: Created on comment/reply/mention/reaction, excluded if actor is entity author, marked as read when viewing, displayed in chronological order",
        "Projects: Created with name/description/cover/members/URLs, project feed filters posts correctly, edit syncs members and URLs, delete cascades to junction tables",
        "File uploads: Presigned URL generated for R2, client uploads directly, metadata saved with type/size/mime, presigned URLs for private access",
        "Search: Command palette opens on Cmd+K, searches posts/projects/users, navigates to result on Enter, closes on Esc",
        "Admin users: Role changes update correctly, cannot demote last OWNER, cannot deactivate self, deactivated users cannot access main routes",
        "Admin settings: Site name updates, webhook URLs validate HTTPS, custom emoji uploads to R2 and saves record",
        "Password reset: Token generated with 24-hour expiration, valid token allows password update, used token invalid, expired token invalid",
        "Drafts: Content auto-saves every 2 seconds, loads on compose page visit, clears after publish",
        "Feed: Posts display in reverse chronological order, infinite scroll loads next page, hideFromHome flag filters correctly",
        "View modes: List and grid views toggle correctly, preference persists across sessions",
        "Responsive: All pages render correctly on mobile/tablet/desktop, floating action menu visible on mobile, secondary rail hidden on small screens"
      ],
      "constraints": [
        "Next.js App Router required (not Pages Router)",
        "Prisma as sole ORM, no raw SQL queries except for search optimization",
        "NextAuth for authentication, no custom auth implementation",
        "Cloudflare R2 for file storage, no local filesystem storage",
        "Lexical for rich text editing, state stored as JSON in database",
        "Tailwind CSS for all styling, no custom CSS files or CSS-in-JS",
        "shadcn/ui for component primitives, no other component library",
        "PostgreSQL as database, no other database system",
        "TypeScript strict mode enabled, no JavaScript files",
        "Comment threading maximum 2 levels deep",
        "At least one OWNER or ADMIN must exist in system",
        "Password reset tokens expire after 24 hours",
        "Reactions unique per user per entity (post or comment)",
        "SiteSettings record id fixed as 'default', exactly one record exists",
        "Attachment order field must be sequential integers starting from 0",
        "Webhook URLs must be valid HTTPS endpoints",
        "User email addresses must be unique across system"
      ],
      "nonGoals": [
        "Real-time collaborative editing of posts (use auto-save drafts instead)",
        "Video transcoding or thumbnail generation (store original files only)",
        "Email delivery system for notifications (in-app notifications only, webhooks for external)",
        "User-to-user direct messaging (use comments on posts)",
        "Fine-grained permissions per project or post (use role-based access only)",
        "Content moderation or reporting system",
        "Analytics dashboard for post views or engagement metrics",
        "Export functionality for user data (future GDPR consideration)",
        "Multi-language internationalization (English only)",
        "Mobile native apps (PWA only)",
        "Third-party OAuth providers (email/password only)",
        "Image editing or cropping tools (use external tools before upload)",
        "Versioning or revision history for posts and comments",
        "Tags or categories beyond projects",
        "Following users or customized feeds",
        "Post scheduling or draft publishing workflows beyond auto-save",
        "Rate limiting or abuse prevention (implement later if needed)",
        "Observability integration (Sentry, Datadog) in initial build"
      ]
    },
    "prompt": "# Plan: Draftboard Implementation Blueprint\n\n## TL;DR\n- Goal: Draftboard is an internal design sharing platform built on Next.js with Prisma and NextAuth. It provides a social feed for distributed teams to post designs, ideas, and work-in-progress with rich media attachments, threaded comments, reactions, and notifications. The system uses Cloudflare R2 for file storage, supports role-based access control (OWNER/ADMIN/MEMBER), and includes admin tools for user management, site configuration, and webhook integrations.\n- Recommended approach: incremental implementation aligned to existing architecture boundaries and route-level layout fidelity.\n- This plan is intentionally concise on context and verbose on implementation details, design fidelity, and UI behavior.\n\n## Phase 1: Initial Understanding\n### Repository Context\n- Repository: `hrescak/Draftboard`\n- Branch analyzed: `main`\n- Scan mode: `deep` | sampled files: 38 | token estimate: 82273\n- Target agent: `claude-code`\n\n### Key Files Inspected\n- `README.md` - project readme\n- `package.json` - dependency manifest\n- `src/app/(main)/admin/settings/page.tsx` - large source sample\n- `src/app/(main)/projects/[id]/edit/page.tsx` - large source sample\n- `src/app/(main)/admin/users/page.tsx` - large source sample\n- `src/app/(main)/compose/page.tsx` - large source sample\n- `src/server/api/routers/post.ts` - large source sample\n- `src/server/api/routers/user.ts` - large source sample\n- `src/server/api/routers/comment.ts` - large source sample\n- `tsconfig.json` - config signal\n\n### Confirmed Stack + Architecture Signals\n- Frontend: Next.js, React\n- Backend: Not detected\n- Database: Prisma\n- Auth: NextAuth\n- Infrastructure: Not detected\n- Language: TypeScript, CSS, MDX\n\n- Next.js (Client UI layer) -> Next.js\n- Backend (Application/API layer) -> Backend\n- Prisma (Persistence layer) -> Prisma\n- NextAuth (Identity and access) -> NextAuth\n\n## Phase 2: Design\n### Requirements and Constraints\n- First user self-registers and becomes OWNER, all subsequent registrations require valid invite token and create MEMBER role\n- Admin routes (/admin/*) require role ADMIN or OWNER, redirect to / if unauthorized\n- Deactivated users redirected to /deactivated on any protected route access\n- Users cannot deactivate themselves, only admins can deactivate other users\n- At least one OWNER or ADMIN must exist in system at all times (prevent demoting last OWNER)\n- Post edit and delete actions only visible to post author\n- Comment edit and delete actions only visible to comment author\n- Project edit action only visible to project creator and members\n- Comment threading limited to 2 levels: can reply to top-level comment but not to reply\n- Notifications not sent if actor is the target entity author (e.g., user cannot notify themselves by commenting on own post)\n- Mention notifications excluded if user already receiving comment/reply notification for same action\n- Password reset tokens expire after 24 hours, become invalid after use\n\n### Route Blueprints (Layout + Interaction Fidelity)\n### `/`\n- Purpose: Home feed displaying reverse chronological posts with optional grid/list view toggle and project filter\n- Layout: Sticky top header with view mode toggle (list/grid), search trigger (Cmd+K), notification bell, profile menu, and 'New Post' action. Main content region with infinite scroll feed. Empty state shown when no posts exist. Loading skeleton during fetch. No sidebar.\n- Components: StickyHeader with action cluster, FeedViewToggle (list/grid), PostCard or PostGridItem, InfiniteScrollTrigger, LoadingSkeleton, EmptyFeedState\n- Functionality logic: Fetch posts ordered by createdAt DESC with cursor pagination | Filter by project if query param present | Exclude hideFromHome=true posts unless viewing project context | Show author avatar, displayName, post title, content preview, attachments, reaction counts | Click post to navigate to /post/[id] | Infinite scroll loads next page when trigger enters viewport\n\n### `/compose`\n- Purpose: Rich text editor for creating new posts with attachments and project assignment\n- Layout: Sticky top header with 'Cancel' and 'Publish' actions, save status indicator. Full-width editor canvas with Lexical rich text, attachment upload zone below editor, project multi-select, 'Hide from home feed' checkbox. No sidebar. Bottom padding for comfortable editing.\n- Components: StickyHeader with save status, LexicalEditor with markdown shortcuts, @mentions, slash commands, AttachmentUploadZone with drag-and-drop, AttachmentCarousel for uploaded files, ProjectMultiSelect, HideFromHomeFeedCheckbox, AutosaveDraftIndicator\n- Functionality logic: Initialize Lexical editor with empty state or draft if exists | Auto-save draft to database every 2 seconds on content change | Extract @mentions from Lexical JSON and validate against users | Upload attachments to R2 via presigned URLs, store metadata in DB with order field | On publish: create Post record, create Attachment records, create PostProject junction records, trigger webhook notifications, send mention notifications | Validate title and content not empty before publish | Clear draft after successful publish\n\n### `/post/[id]`\n- Purpose: Full post detail view with attachments, threaded comments, and reactions\n- Layout: Contextual header with post metadata (author avatar, displayName, createdAt, project badges) and actions (Edit if author, Delete if author). Primary content region with full Lexical-rendered content. Attachment carousel below content with coordinate-based comment indicators. Comment thread list with 2-level nesting. Reaction bar at bottom of post with built-in + custom emoji picker. Secondary rail on desktop showing project details and related posts.\n- Components: ContextHeader with author info and actions, LexicalRenderer for post content, AttachmentCarousel with coordinate comment markers, ReactionBar with emoji picker, CommentThread with reply nesting, CommentComposer with Lexical editor, SecondaryRail with project context\n- Functionality logic: Fetch post with author, attachments ordered by order field, projects, comments with nested replies (max 2 levels), reactions grouped by emoji | Render Lexical JSON into HTML preserving mentions, formatting, embeds | Show Edit/Delete actions only if current user is post author | For attachments: display based on type (IMAGE: img tag, VIDEO: video player, FILE: download link, FIGMA: embed iframe, LOOM: embed iframe) | Click attachment to open fullscreen viewer with coordinate comment overlay | Add reaction: upsert Reaction record, show optimistic UI, create REACTION_POST notification for post author | Add comment: create Comment record, send COMMENT notification to post author and mentioned users, send webhook if top-level | Reply to comment: create Comment with parentId, send COMMENT_REPLY notification to parent author and mentioned users | Exclude notifications if user is author of target entity | Mark related notifications as read when viewing post\n\n### `/post/[id]/edit`\n- Purpose: Edit existing post with same editor capabilities as compose\n- Layout: Identical to /compose layout but pre-populated with existing post data\n- Components: StickyHeader with save status and 'Cancel'/'Save' actions, LexicalEditor initialized with existing content JSON, AttachmentUploadZone with existing attachments, ProjectMultiSelect with current selections, HideFromHomeFeedCheckbox with current value\n- Functionality logic: Fetch post with attachments and projects, verify current user is author, redirect if not | Initialize Lexical editor with post.content JSON | Display existing attachments with delete option | Allow adding new attachments, maintain order field sequence | On save: update Post record, upsert PostProject junctions, update/delete Attachment records | Extract new @mentions and send notifications | Do not trigger webhook on edit | Navigate back to /post/[id] after save\n\n### `/projects`\n- Purpose: Grid view of all projects with cover images and metadata\n- Layout: Sticky top header with 'New Project' action. Grid of project cards (3-4 columns on desktop, 1-2 on mobile). Each card shows cover image, project name, description preview, member avatars, post count. Empty state if no projects exist.\n- Components: StickyHeader with 'New Project' button, ProjectGrid, ProjectCard with cover, name, description, members, post count, EmptyProjectsState\n- Functionality logic: Fetch all projects with member count, post count, cover URL | Click project card to navigate to /projects/[id] | Only show 'New Project' action to authenticated users\n\n### `/projects/new`\n- Purpose: Create new project with name, description, cover image, team members, and URLs\n- Layout: Centered form card (max-width 600px) with fields stacked vertically. Header with 'Cancel' and 'Create' actions. Cover image upload at top, name input, Lexical description editor, team member multi-select, URL list with add/remove.\n- Components: FormCard with header actions, CoverImageUpload with drag-and-drop, NameInput (required), LexicalEditor for description, TeamMemberMultiSelect, URLListEditor with add/remove rows\n- Functionality logic: Upload cover image to R2, get presigned URL | Validate name is not empty | On create: insert Project record with createdById, create ProjectMember records for selected users with role='MEMBER', create ProjectUrl records for each URL | Navigate to /projects/[id] after creation\n\n### `/projects/[id]`\n- Purpose: Project detail page with posts feed, description, members, and URLs\n- Layout: Hero header with cover image, project name, description, edit action (if creator or member). Tab navigation for 'Posts', 'Members', 'URLs'. Posts tab shows filtered feed (same as home but filtered to this project). Members tab shows avatar list with role badges. URLs tab shows clickable link list. Secondary rail on desktop with quick stats.\n- Components: ProjectHero with cover, name, description, edit button, TabNavigation, PostFeed filtered by project, MemberList with avatars and roles, URLList with external link icons, SecondaryRail with stats\n- Functionality logic: Fetch project with posts, members, URLs | Show edit action if current user is project creator or member | Posts tab: fetch posts where PostProject.projectId matches, apply same feed logic as home | Members tab: display ProjectMember records with user info | URLs tab: render ProjectUrl records as links | Click edit to navigate to /projects/[id]/edit\n\n### `/projects/[id]/edit`\n- Purpose: Edit project details, members, and URLs\n- Layout: Same form layout as /projects/new but pre-populated with existing data\n- Components: FormCard with 'Cancel'/'Save' actions, CoverImageUpload with current cover, NameInput with current name, LexicalEditor with current description, TeamMemberMultiSelect with current members, URLListEditor with current URLs\n- Functionality logic: Fetch project, verify current user is creator or member, redirect if not | Pre-populate all fields with existing data | On save: update Project record, sync ProjectMember records (add/remove), sync ProjectUrl records (add/remove/update) | Navigate back to /projects/[id] after save\n\n### `/notifications`\n- Purpose: Activity feed showing comments, replies, mentions, and reactions\n- Layout: Full-width list with sticky top header. Each notification item shows actor avatar, action description, timestamp, target post/comment preview. Unread notifications have accent border. Empty state if no notifications. Mark as read on view.\n- Components: StickyHeader with 'Mark all read' action, NotificationList, NotificationItem with avatar, description, timestamp, preview, EmptyNotificationsState\n- Functionality logic: Fetch notifications for current user ordered by createdAt DESC | Group by date (Today, Yesterday, This Week, Older) | Show actor displayName, action type (commented on, replied to, mentioned you in, reacted to), target post title or comment preview | Mark notification as read when viewed (update read=true) | Click notification to navigate to target post or comment | Polling or real-time updates to show new notifications without refresh\n\n### `/settings`\n- Purpose: User profile settings: display name and avatar upload\n- Layout: Centered card (max-width 600px) with sections stacked vertically. Avatar upload with current avatar preview. Display name input. Email (read-only). Account created date (read-only). Save button at bottom.\n- Components: SettingsCard, AvatarUpload with preview, DisplayNameInput, ReadOnlyEmailField, AccountMetadata, SaveButton\n- Functionality logic: Fetch current user data | Upload avatar to R2, get presigned URL | Validate displayName not empty | On save: update User record (displayName, avatarUrl) | Show success toast after save\n\n### `/admin/users`\n- Purpose: Admin panel for user management: view all users, promote/demote roles, deactivate users\n- Layout: Sticky top header with 'Regenerate Invite Link' action. Table with columns: Avatar, Name, Email, Role, Posts, Comments, Status, Actions. Each row has role dropdown (MEMBER/ADMIN/OWNER) and Deactivate/Activate toggle. Floating action menu in bottom-right with 'Invite User' (shows invite link dialog).\n- Components: StickyHeader with invite link action, UserTable with sortable columns, UserRow with avatar, name, email, role dropdown, stats, status badge, action buttons, FloatingActionMenu with invite link dialog, RoleDropdown with MEMBER/ADMIN/OWNER, DeactivateToggle\n- Functionality logic: Verify current user role is ADMIN or OWNER, redirect to / if not | Fetch all users with post count, comment count, role, deactivated status | Change role: update User.role, show optimistic UI, prevent demoting last OWNER | Deactivate user: update User.deactivated=true, prevent user from deactivating themselves | Regenerate invite link: update SiteSettings.inviteToken with new random token, show dialog with link | Show invite link in dialog with copy button\n\n### `/admin/settings`\n- Purpose: Admin panel for site-wide settings: site name, webhook URLs, custom emoji\n- Layout: Card-based layout with sections: Site Settings (name), Integrations (Discord/Slack webhook URLs), Custom Emoji (upload and list). Each section has card with header, fields, and save action.\n- Components: SettingsCard with section header, SiteNameInput, WebhookURLInput for Discord and Slack, CustomEmojiUpload, CustomEmojiList with delete action, SaveButton per section\n- Functionality logic: Verify current user role is ADMIN or OWNER, redirect to / if not | Fetch SiteSettings (id='default'), ensure record exists | Update site name: update SiteSettings.siteName | Update webhook URLs: validate HTTPS, update SiteSettings.discordWebhookUrl and slackWebhookUrl | Upload custom emoji: upload to R2, create CustomEmoji record with name and URL | Delete custom emoji: delete CustomEmoji record, remove from R2 | Show success toast after each save\n\n### Module + Interface Implementation Plan\n#### Modules\n- app/layout.tsx - Root layout with NextAuth provider, theme provider, command palette wrapper\n- app/page.tsx - Home feed page with view toggle and infinite scroll\n- app/compose/page.tsx - Post creation page with Lexical editor\n- app/post/[id]/page.tsx - Post detail page with comments and reactions\n- app/post/[id]/edit/page.tsx - Post edit page\n- app/projects/page.tsx - Projects grid page\n- app/projects/new/page.tsx - New project form\n- app/projects/[id]/page.tsx - Project detail page with tabs\n- app/projects/[id]/edit/page.tsx - Project edit form\n- app/notifications/page.tsx - Notifications feed\n\n#### Functionality logic\n- Authentication: NextAuth with credentials provider, JWT sessions, password hashing with bcrypt, session checks in API routes and pages\n- Authorization: Middleware checks user role (OWNER/ADMIN/MEMBER) for admin routes, post/comment author checks for edit/delete, deactivated user redirect to /deactivated\n- Post creation: Lexical editor state saved as JSON, auto-save draft every 2 seconds, extract @mentions, upload attachments to R2 with presigned URLs, create Post and Attachment records in transaction, create PostProject junctions, trigger webhooks, send mention notifications\n- Post editing: Load existing post, verify author, update Post record, sync attachments (add/remove), sync projects, extract new @mentions, send new notifications\n- Comments: Two-level threading (parent.parentId must be null), Lexical content as JSON, optional attachmentId and coordinates for attachment-specific comments, create COMMENT or COMMENT_REPLY notifications, exclude notifications for comment author\n- Reactions: Unique per user per entity (post or comment), upsert Reaction record, create REACTION_POST or REACTION_COMMENT notification, display grouped by emoji with count\n- Notifications: Create on comment/reply/mention/reaction, exclude if user is target author, mark as read when viewing notification or target post, real-time updates via polling or WebSocket\n- Projects: Create with name/description/cover/members/URLs, project creators and members can edit, posts can be assigned to multiple projects via PostProject junction, project feed filters posts by project\n- File uploads: Generate presigned URL for R2 upload, client uploads directly to R2, server stores metadata in Attachment table with type (IMAGE/VIDEO/FILE/FIGMA/LOOM), order field for carousel sequence, presigned URLs for private access\n- Search: Command palette (Cmd+K) with full-text search across posts, projects, users, search only active (non-deactivated) users, navigate to result on select\n- Webhooks: On post creation, send JSON payload to Discord and Slack webhook URLs if configured, async/background job, retry on failure\n- User management: First user becomes OWNER, subsequent users register via invite token as MEMBER, admins can promote/demote roles, deactivate users (cannot deactivate self), regenerate invite token\n\n#### Interfaces\n- POST /api/posts - Create post: { title?, content: JSON, liveUrl?, hideFromHome: boolean, projectIds: string[], attachments: Attachment[] } → { postId: string }\n- GET /api/posts - List posts: { cursor?, projectId?, limit: number } → { posts: Post[], nextCursor?: string }\n- GET /api/posts/[id] - Get post detail → { post: Post, author: User, attachments: Attachment[], projects: Project[], comments: Comment[], reactions: Reaction[] }\n- PATCH /api/posts/[id] - Update post: { title?, content: JSON, liveUrl?, hideFromHome: boolean, projectIds: string[], attachments: Attachment[] } → { success: boolean }\n- DELETE /api/posts/[id] - Delete post → { success: boolean }\n- POST /api/comments - Create comment: { content: JSON, postId: string, parentId?: string, attachmentId?: string, coordinates?: { x: number, y: number } } → { commentId: string }\n- PATCH /api/comments/[id] - Update comment: { content: JSON } → { success: boolean }\n- DELETE /api/comments/[id] - Delete comment → { success: boolean }\n- POST /api/reactions - Add/remove reaction: { postId?: string, commentId?: string, emoji: string, emojiId?: string } → { success: boolean }\n- GET /api/projects - List projects → { projects: Project[] }\n\n### Data + Database Design\n#### Data Models (Priority Set)\n- User: { id: cuid, email: unique string, passwordHash: string, displayName: string, avatarUrl?: string, role: enum(MEMBER,ADMIN,OWNER), deactivated: boolean, createdAt: DateTime, updatedAt: DateTime }\n- Post: { id: cuid, title?: string, content: JSON, liveUrl?: string, hideFromHome: boolean default false, authorId: string, author: User, createdAt: DateTime, updatedAt: DateTime, attachments: Attachment[], projects: Project[], comments: Comment[], reactions: Reaction[] }\n- Attachment: { id: cuid, postId: string, post: Post, type: enum(IMAGE,VIDEO,FILE,FIGMA,LOOM), url: string, filename: string, mimeType: string, size: int, width?: int, height?: int, thumbnailUrl?: string, metadata?: JSON, order: int, createdAt: DateTime }\n- Project: { id: cuid, name: string, description?: JSON, coverUrl?: string, createdById: string, createdBy: User, createdAt: DateTime, updatedAt: DateTime, members: ProjectMember[], urls: ProjectUrl[], posts: Post[] }\n- ProjectMember: { id: cuid, projectId: string, project: Project, userId: string, user: User, role: string default 'MEMBER', createdAt: DateTime }\n- ProjectUrl: { id: cuid, projectId: string, project: Project, title: string, url: string }\n- Comment: { id: cuid, content: JSON, authorId: string, author: User, postId: string, post: Post, parentId?: string, parent?: Comment, replies: Comment[], attachmentId?: string, attachment?: Attachment, coordinates?: JSON, createdAt: DateTime, updatedAt: DateTime, reactions: Reaction[] }\n- Reaction: { id: cuid, userId: string, user: User, postId?: string, post?: Post, commentId?: string, comment?: Comment, emojiId?: string, customEmoji?: CustomEmoji, emoji: string, createdAt: DateTime } - Unique constraint: [userId, postId, commentId]\n\n#### Database design\n- Create Prisma schema with datasource postgresql and generator client\n- Add cuid() default for all id fields\n- Add indexes: User.email unique, Reaction unique [userId, postId, commentId], PasswordResetToken.token unique, SiteSettings.id fixed as 'default'\n- Add indexes for performance: Post.createdAt desc, Post.authorId, Comment.postId, Comment.parentId, Notification.userId + createdAt desc, ProjectMember.projectId + userId\n- Add cascade deletes: Post delete → cascade Attachment/Comment/Reaction/Notification, Comment delete → cascade child Comments/Reactions/Notifications, Project delete → cascade ProjectMember/ProjectUrl/PostProject\n- Add onDelete: SetNull for optional foreign keys like Comment.parentId, Comment.attachmentId, Reaction.emojiId\n- Add @updatedAt directive to Post, Project, User, SiteSettings for automatic timestamp updates\n- Create initial migration with schema.prisma as source\n- Seed script: create SiteSettings record with id='default', generate random inviteToken, set default siteName\n- Add fulltext search index on Post.title and Post.content if using PostgreSQL FTS\n\n### Design System (Detailed, Implementable)\n#### Visual Direction\n- Technical workspace with high information density, strong hierarchy, restrained accents, and explicit state feedback. Layered surfaces with crisp borders and subtle shadows for depth. Disciplined spacing and alignment. Utility-driven composition with Tailwind CSS.\n\n#### Color Tokens (Use Exact Hex)\n- Background: `#0F0E0D`\n- Surface: `#1A1918` | Surface Alt: `#262422`\n- Text: `#F3F4F6` | Muted Text: `#9CA3AF`\n- Border: `#374151`\n- Primary: `#3B82F6` | Primary Hover: `#2563EB`\n- Accent: `#14B8A6`\n- Semantic: success `#22C55E`, warning `#F59E0B`, danger `#EF4444`\n\n#### Typography + Radius\n- Primary UI font: system font stack (ui-sans-serif, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif)\n- Monospace font: ui-monospace, 'SF Mono', 'Consolas', monospace for technical metadata and code\n- Heading scale: h1 (2.25rem/600), h2 (1.875rem/600), h3 (1.5rem/600), h4 (1.25rem/600), h5 (1.125rem/600), h6 (1rem/600)\n- Radius scale: sm=8px, md=12px, lg=16px, xl=24px\n\n#### Button and Component Styling Contract\n- Primary buttons: filled style with strong contrast text, subtle lift on hover, and medium radius.\n- Secondary buttons: bordered surface-alt background with same vertical rhythm as primary buttons.\n- Ghost buttons: low-emphasis text style for tertiary actions without losing focus states.\n- Cards and panels: thin border, medium-to-large radius, and restrained elevation to maintain dense information layout.\n- Inputs: surface-alt background, explicit border, and predictable focus ring behavior.\n\n#### Layout + Positioning Contract\n- Preserve left navigation shell instead of replacing with full-height sidebar alternatives unless original uses it.\n- Preserve floating action/menu behavior (bottom-right fixed, elevated, quick-access) and avoid replacing it with static side navigation.\n- Keep sticky top navigation/action bar behavior to preserve browsing context during scroll.\n- Retain keyboard command palette entry points (Cmd/Ctrl+K) with matching action taxonomy.\n\n#### Motion + Interaction\n- Fast: 150ms for hover states, button presses, small UI transitions\n- Standard: 250ms for modal/sheet entry, dropdown open, page transitions\n- Slow: 350ms for large surface animations, page-level state changes\n- Detected transition/animation signals in source; keep micro-motion concise and functional.\n\n#### CSS Blueprint (Reference Implementation)\n```css\n:root {\n  --color-bg: #0F0E0D;\n  --color-surface: #1A1918;\n  --color-surface-alt: #262422;\n  --color-text: #F3F4F6;\n  --color-text-muted: #9CA3AF;\n  --color-border: #374151;\n  --color-primary: #3B82F6;\n  --color-primary-hover: #2563EB;\n  --color-accent: #14B8A6;\n  --color-success: #22C55E;\n  --color-warning: #F59E0B;\n  --color-danger: #EF4444;\n  --radius-sm: 8px;\n  --radius-md: 12px;\n  --radius-lg: 16px;\n  --radius-xl: 24px;\n}\n\n.btn-primary {\n  border: 1px solid transparent;\n  background: var(--color-primary);\n  color: #ffffff;\n  border-radius: var(--radius-md);\n  padding: 10px 14px;\n  font-weight: 600;\n  transition: transform 120ms ease, background-color 120ms ease;\n}\n.btn-primary:hover { background: var(--color-primary-hover); transform: translateY(-1px); }\n.btn-secondary {\n  border: 1px solid var(--color-border);\n  background: var(--color-surface-alt);\n  color: var(--color-text);\n  border-radius: var(--radius-md);\n  padding: 10px 14px;\n}\n.btn-ghost {\n  border: 1px solid transparent;\n  background: transparent;\n  color: var(--color-text-muted);\n  border-radius: var(--radius-sm);\n  padding: 8px 12px;\n}\n.app-shell { display: grid; grid-template-columns: 240px minmax(0, 1fr); min-height: 100vh; }\n.app-sidebar { position: sticky; top: 0; height: 100vh; border-right: 1px solid var(--color-border); background: var(--color-surface); }\n.floating-menu { position: fixed; right: 24px; bottom: 24px; display: flex; gap: 8px; padding: 10px; border: 1px solid var(--color-border); border-radius: 999px; background: var(--color-surface); box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18); }\n.surface-card { border: 1px solid var(--color-border); border-radius: var(--radius-lg); background: var(--color-surface); }\n.input { border: 1px solid var(--color-border); border-radius: var(--radius-md); background: var(--color-surface-alt); color: var(--color-text); }\n@keyframes menu-in { from { opacity: 0; transform: translateY(8px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }\n```\n\n## Phase 3: Review\n### Alignment Checklist\n- Each user-facing route has explicit purpose, layout, component plan, and functionality logic.\n- Layout fidelity is preserved (floating menus, sticky headers, command palettes, shell pattern) from source signals.\n- Behavior rules map to enforceable logic paths and interface contracts.\n- Data contracts are reflected in data models and database/index/migration guidance.\n- Design system tokens and distinctive UI traits are consistently applied across routes.\n\n### Assumptions to Confirm\n- Cloudflare R2 bucket configured with appropriate CORS settings for direct uploads\n- PostgreSQL database supports JSON column type for Lexical content storage\n- NextAuth session tokens stored in JWT format with server-side secret\n- Prisma connection pooling handles concurrent user requests efficiently\n- R2 presigned URLs expire after reasonable timeframe (implementation dependent)\n- Webhook endpoints (Discord/Slack) accept JSON payloads with post metadata\n\n### Risks and Edge Cases\n- Unknown to validate: Maximum file size limits for attachment uploads\n- Unknown to validate: R2 presigned URL expiration duration configuration\n- Unknown to validate: Rate limiting implementation for API endpoints\n- Unknown to validate: Webhook retry logic on failure\n- Unknown to validate: Image compression or optimization pipeline before R2 upload\n- Unknown to validate: Video thumbnail generation method (client-side, R2 transform, external service)\n- Scope boundary: Real-time collaborative editing of posts (use auto-save drafts instead)\n- Scope boundary: Video transcoding or thumbnail generation (store original files only)\n\n## Phase 4: Final Plan\n### Recommended Approach\n- Implement the plan as a single coherent approach (no parallel competing implementations).\n- Follow the ordered steps below; preserve interaction and visual behavior before introducing structural changes.\n\n### Implementation Steps\n1. 1. Initialize Next.js project with TypeScript, Tailwind CSS, ESLint: npx create-next-app@latest --typescript --tailwind --eslint\n2. 2. Install dependencies: npm install prisma @prisma/client next-auth bcryptjs @lexical/react lexical @aws-sdk/client-s3 @aws-sdk/s3-request-presigner zod react-hook-form\n3. 3. Install dev dependencies: npm install -D @types/bcryptjs @types/node tsx\n4. 4. Initialize Prisma: npx prisma init --datasource-provider postgresql\n5. 5. Define Prisma schema in prisma/schema.prisma with all models (User, Post, Attachment, Project, ProjectMember, ProjectUrl, Comment, Reaction, Notification, CustomEmoji, SiteSettings, Draft, PasswordResetToken) and relations\n6. 6. Create initial migration: npx prisma migrate dev --name init\n7. 7. Create lib/prisma.ts with PrismaClient singleton for connection pooling\n8. 8. Configure NextAuth in app/api/auth/[...nextauth]/route.ts with credentials provider, JWT session, password verification with bcrypt\n9. 9. Create lib/auth.ts with getServerSession helper and role check utilities\n10. 10. Configure Cloudflare R2 client in lib/r2.ts with S3Client and presigned URL generation\n11. 11. Create seed script prisma/seed.ts to initialize SiteSettings record with id='default', generate random inviteToken\n12. 12. Run seed: npx prisma db seed\n13. 13. Install shadcn/ui CLI: npx shadcn-ui@latest init, configure with Tailwind and component path\n14. 14. Add shadcn components: npx shadcn-ui@latest add button input card avatar badge dialog sheet dropdown-menu toast\n15. 15. Create design system tokens in tailwind.config.ts extending theme with custom colors (primary #1A1918, secondary #F5F4F2), radius scale (xs 2px, sm 4px, md 6px, lg 8px, xl 12px), font families\n16. 16. Build Lexical editor component in components/lexical/LexicalEditor.tsx with RichTextPlugin, AutoFocusPlugin, MentionPlugin, MarkdownShortcutPlugin, DragDropPastePlugin\n17. 17. Build Lexical renderer in components/lexical/LexicalRenderer.tsx to convert JSON state to HTML\n18. 18. Create API route app/api/posts/route.ts for GET (list with pagination) and POST (create with transaction)\n19. 19. Create API route app/api/posts/[id]/route.ts for GET (detail), PATCH (update), DELETE (with author check)\n20. 20. Create API route app/api/comments/route.ts for POST (create with notification logic)\n21. 21. Create API route app/api/comments/[id]/route.ts for PATCH (update), DELETE (with author check)\n22. 22. Create API route app/api/reactions/route.ts for POST (upsert with unique constraint, notification)\n23. 23. Create API route app/api/projects/route.ts for GET (list), POST (create with transaction)\n24. 24. Create API route app/api/projects/[id]/route.ts for GET (detail), PATCH (update with sync logic), DELETE\n25. 25. Create API route app/api/notifications/route.ts for GET (list with pagination), PATCH (mark read)\n26. 26. Create API route app/api/users/route.ts for GET (admin only, all users), PATCH (update user with role/deactivation checks)\n27. 27. Create API route app/api/admin/settings/route.ts for GET/PATCH (admin only, SiteSettings)\n28. 28. Create API route app/api/admin/invite-token/route.ts for POST (regenerate token)\n29. 29. Create API route app/api/upload/presigned-url/route.ts for POST (generate R2 presigned URL with validation)\n30. 30. Create API route app/api/webhooks/notify/route.ts for POST (send Discord/Slack webhook with post data)\n31. 31. Create lib/notifications.ts with helper functions to create COMMENT, COMMENT_REPLY, REACTION_POST, REACTION_COMMENT, MENTION notifications with exclusion logic\n32. 32. Create lib/mentions.ts with function to extract @mentions from Lexical JSON state and validate against User table\n33. 33. Create lib/webhooks.ts with functions to format and send Discord/Slack webhook payloads\n34. 34. Create lib/validations.ts with Zod schemas for API request validation\n35. 35. Build home page app/page.tsx with feed, view toggle (list/grid), infinite scroll using IntersectionObserver\n36. 36. Build compose page app/compose/page.tsx with LexicalEditor, attachment upload zone, project multi-select, hideFromHome checkbox, auto-save draft logic\n37. 37. Build post detail page app/post/[id]/page.tsx with content render, attachment carousel, comment thread, reaction bar\n38. 38. Build post edit page app/post/[id]/edit/page.tsx with same editor as compose, pre-populated with existing data\n39. 39. Build projects list page app/projects/page.tsx with grid layout, project cards with cover/name/stats\n40. 40. Build new project page app/projects/new/page.tsx with form for name/description/cover/members/URLs\n41. 41. Build project detail page app/projects/[id]/page.tsx with tabs (Posts, Members, URLs), filtered feed for Posts tab\n42. 42. Build project edit page app/projects/[id]/edit/page.tsx with same form as new, pre-populated\n43. 43. Build notifications page app/notifications/page.tsx with list grouped by date, mark read on view\n44. 44. Build settings page app/settings/page.tsx with avatar upload, displayName input, account metadata\n45. 45. Build admin users page app/admin/users/page.tsx with table, role dropdown, deactivate toggle, floating action menu with invite link dialog\n46. 46. Build admin settings page app/admin/settings/page.tsx with sections for site name, webhook URLs, custom emoji upload/list\n47. 47. Build invite registration page app/invite/[token]/page.tsx with form, token validation, first user becomes OWNER logic\n48. 48. Build password reset page app/reset-password/[token]/page.tsx with form, token validation, password update\n49. 49. Build deactivated page app/deactivated/page.tsx with static message and sign-out link\n50. 50. Build root layout app/layout.tsx with NextAuthProvider, theme provider (light/dark mode), command palette wrapper\n51. 51. Create components/CommandPalette.tsx with search input, results list (posts/projects/users), keyboard navigation\n52. 52. Create components/PostCard.tsx with author info, content preview, attachment previews, reaction counts, click to detail\n53. 53. Create components/PostGridItem.tsx with compact layout, cover image, title, hover overlay\n54. 54. Create components/AttachmentCarousel.tsx with image viewer, video player, file download, navigation arrows, coordinate comment overlay\n55. 55. Create components/CommentThread.tsx with nested structure (max 2 levels), reply button, edit/delete actions\n56. 56. Create components/ReactionBar.tsx with emoji picker (built-in + custom), reaction counts, reactors dialog\n57. 57. Create components/NotificationItem.tsx with actor avatar, action description, timestamp, target preview, unread indicator\n58. 58. Create components/FloatingActionMenu.tsx with fixed bottom-right position, elevated surface, quick actions\n59. 59. Create middleware.ts to check auth status, redirect deactivated users to /deactivated, protect admin routes\n60. 60. Add environment variables to .env: DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL, R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_BUCKET_NAME\n61. 61. Configure next.config.js with images domains for R2 URLs, experimental features if needed\n62. 62. Create public/manifest.json for PWA with name, icons, theme color, start URL\n63. 63. Add service worker registration in app/layout.tsx for PWA offline support\n64. 64. Write unit tests with Vitest for lib helpers (notifications, mentions, webhooks)\n65. 65. Write integration tests with Testing Library for key flows (post creation, comment threading, reactions)\n66. 66. Run type checking: npx tsc --noEmit\n67. 67. Run linting: npm run lint\n68. 68. Run tests: npm run test\n69. 69. Build production bundle: npm run build\n70. 70. Deploy to Vercel or similar platform with environment variables configured\n\n### Testing\n- User registration: First user receives OWNER role, subsequent users with valid invite token receive MEMBER role, invalid token shows error\n- Authentication: Sign in with valid credentials succeeds, invalid credentials show error, deactivated users redirect to /deactivated\n- Post creation: Valid post with content saves successfully, attachments upload to R2 and store metadata, projects assigned via junction table, webhook fires if configured, mentions send notifications\n- Post editing: Only post author can edit, updates save correctly, new attachments add with incremented order, removed attachments delete from R2\n- Comment threading: Top-level comments save with postId, replies save with parentId, replies to replies blocked (max 2 levels), notifications sent to parent author and mentioned users\n- Reactions: Clicking reaction adds record with unique constraint, clicking again removes, notification sent to entity author, reaction counts display correctly\n- Notifications: Created on comment/reply/mention/reaction, excluded if actor is entity author, marked as read when viewing, displayed in chronological order\n- Projects: Created with name/description/cover/members/URLs, project feed filters posts correctly, edit syncs members and URLs, delete cascades to junction tables\n- File uploads: Presigned URL generated for R2, client uploads directly, metadata saved with type/size/mime, presigned URLs for private access\n- Search: Command palette opens on Cmd+K, searches posts/projects/users, navigates to result on Enter, closes on Esc\n- Admin users: Role changes update correctly, cannot demote last OWNER, cannot deactivate self, deactivated users cannot access main routes\n- Admin settings: Site name updates, webhook URLs validate HTTPS, custom emoji uploads to R2 and saves record\n- Password reset: Token generated with 24-hour expiration, valid token allows password update, used token invalid, expired token invalid\n- Drafts: Content auto-saves every 2 seconds, loads on compose page visit, clears after publish\n- Feed: Posts display in reverse chronological order, infinite scroll loads next page, hideFromHome flag filters correctly\n- View modes: List and grid views toggle correctly, preference persists across sessions\n- Responsive: All pages render correctly on mobile/tablet/desktop, floating action menu visible on mobile, secondary rail hidden on small screens\n\n### Rollout and Migration Notes\n- Create Prisma schema with datasource postgresql and generator client\n- Add cuid() default for all id fields\n- Add indexes: User.email unique, Reaction unique [userId, postId, commentId], PasswordResetToken.token unique, SiteSettings.id fixed as 'default'\n- Add indexes for performance: Post.createdAt desc, Post.authorId, Comment.postId, Comment.parentId, Notification.userId + createdAt desc, ProjectMember.projectId + userId\n- Add cascade deletes: Post delete → cascade Attachment/Comment/Reaction/Notification, Comment delete → cascade child Comments/Reactions/Notifications, Project delete → cascade ProjectMember/ProjectUrl/PostProject\n- Add onDelete: SetNull for optional foreign keys like Comment.parentId, Comment.attachmentId, Reaction.emojiId\n\n## Implementation Prompt (LLM Ready)\n```markdown\nImplement hrescak/Draftboard using this plan.\nTarget agent: claude-code.\n\n## Priority Order\n1. Preserve original route/layout interaction model (do not replace floating menus with static sidebars unless source actually uses sidebar-first shell).\n2. Preserve business behavior and data contracts with explicit validations.\n3. Apply the specified design tokens and component recipes consistently.\n\n## Objective\nDraftboard is an internal design sharing platform built on Next.js with Prisma and NextAuth. It provides a social feed for distributed teams to post designs, ideas, and work-in-progress with rich media attachments, threaded comments, reactions, and notifications. The system uses Cloudflare R2 for file storage, supports role-based access control (OWNER/ADMIN/MEMBER), and includes admin tools for user management, site configuration, and webhook integrations.\n\n## Route Fidelity Requirements\n- /: Sticky top header with view mode toggle (list/grid), search trigger (Cmd+K), notification bell, profile menu, and 'New Post' action. Main content region with infinite scroll feed. Empty state shown when no posts exist. Loading skeleton during fetch. No sidebar. Components: StickyHeader with action cluster, FeedViewToggle (list/grid), PostCard or PostGridItem, InfiniteScrollTrigger. Logic: Fetch posts ordered by createdAt DESC with cursor pagination | Filter by project if query param present | Exclude hideFromHome=true posts unless viewing project context | Show author avatar, displayName, post title, content preview, attachments, reaction counts | Click post to navigate to /post/[id] | Infinite scroll loads next page when trigger enters viewport\n- /compose: Sticky top header with 'Cancel' and 'Publish' actions, save status indicator. Full-width editor canvas with Lexical rich text, attachment upload zone below editor, project multi-select, 'Hide from home feed' checkbox. No sidebar. Bottom padding for comfortable editing. Components: StickyHeader with save status, LexicalEditor with markdown shortcuts, @mentions, slash commands, AttachmentUploadZone with drag-and-drop, AttachmentCarousel for uploaded files. Logic: Initialize Lexical editor with empty state or draft if exists | Auto-save draft to database every 2 seconds on content change | Extract @mentions from Lexical JSON and validate against users | Upload attachments to R2 via presigned URLs, store metadata in DB with order field | On publish: create Post record, create Attachment records, create PostProject junction records, trigger webhook notifications, send mention notifications | Validate title and content not empty before publish | Clear draft after successful publish\n- /post/[id]: Contextual header with post metadata (author avatar, displayName, createdAt, project badges) and actions (Edit if author, Delete if author). Primary content region with full Lexical-rendered content. Attachment carousel below content with coordinate-based comment indicators. Comment thread list with 2-level nesting. Reaction bar at bottom of post with built-in + custom emoji picker. Secondary rail on desktop showing project details and related posts. Components: ContextHeader with author info and actions, LexicalRenderer for post content, AttachmentCarousel with coordinate comment markers, ReactionBar with emoji picker. Logic: Fetch post with author, attachments ordered by order field, projects, comments with nested replies (max 2 levels), reactions grouped by emoji | Render Lexical JSON into HTML preserving mentions, formatting, embeds | Show Edit/Delete actions only if current user is post author | For attachments: display based on type (IMAGE: img tag, VIDEO: video player, FILE: download link, FIGMA: embed iframe, LOOM: embed iframe) | Click attachment to open fullscreen viewer with coordinate comment overlay | Add reaction: upsert Reaction record, show optimistic UI, create REACTION_POST notification for post author | Add comment: create Comment record, send COMMENT notification to post author and mentioned users, send webhook if top-level | Reply to comment: create Comment with parentId, send COMMENT_REPLY notification to parent author and mentioned users | Exclude notifications if user is author of target entity | Mark related notifications as read when viewing post\n- /post/[id]/edit: Identical to /compose layout but pre-populated with existing post data Components: StickyHeader with save status and 'Cancel'/'Save' actions, LexicalEditor initialized with existing content JSON, AttachmentUploadZone with existing attachments, ProjectMultiSelect with current selections. Logic: Fetch post with attachments and projects, verify current user is author, redirect if not | Initialize Lexical editor with post.content JSON | Display existing attachments with delete option | Allow adding new attachments, maintain order field sequence | On save: update Post record, upsert PostProject junctions, update/delete Attachment records | Extract new @mentions and send notifications | Do not trigger webhook on edit | Navigate back to /post/[id] after save\n- /projects: Sticky top header with 'New Project' action. Grid of project cards (3-4 columns on desktop, 1-2 on mobile). Each card shows cover image, project name, description preview, member avatars, post count. Empty state if no projects exist. Components: StickyHeader with 'New Project' button, ProjectGrid, ProjectCard with cover, name, description, members, post count, EmptyProjectsState. Logic: Fetch all projects with member count, post count, cover URL | Click project card to navigate to /projects/[id] | Only show 'New Project' action to authenticated users\n- /projects/new: Centered form card (max-width 600px) with fields stacked vertically. Header with 'Cancel' and 'Create' actions. Cover image upload at top, name input, Lexical description editor, team member multi-select, URL list with add/remove. Components: FormCard with header actions, CoverImageUpload with drag-and-drop, NameInput (required), LexicalEditor for description. Logic: Upload cover image to R2, get presigned URL | Validate name is not empty | On create: insert Project record with createdById, create ProjectMember records for selected users with role='MEMBER', create ProjectUrl records for each URL | Navigate to /projects/[id] after creation\n- /projects/[id]: Hero header with cover image, project name, description, edit action (if creator or member). Tab navigation for 'Posts', 'Members', 'URLs'. Posts tab shows filtered feed (same as home but filtered to this project). Members tab shows avatar list with role badges. URLs tab shows clickable link list. Secondary rail on desktop with quick stats. Components: ProjectHero with cover, name, description, edit button, TabNavigation, PostFeed filtered by project, MemberList with avatars and roles. Logic: Fetch project with posts, members, URLs | Show edit action if current user is project creator or member | Posts tab: fetch posts where PostProject.projectId matches, apply same feed logic as home | Members tab: display ProjectMember records with user info | URLs tab: render ProjectUrl records as links | Click edit to navigate to /projects/[id]/edit\n- /projects/[id]/edit: Same form layout as /projects/new but pre-populated with existing data Components: FormCard with 'Cancel'/'Save' actions, CoverImageUpload with current cover, NameInput with current name, LexicalEditor with current description. Logic: Fetch project, verify current user is creator or member, redirect if not | Pre-populate all fields with existing data | On save: update Project record, sync ProjectMember records (add/remove), sync ProjectUrl records (add/remove/update) | Navigate back to /projects/[id] after save\n- /notifications: Full-width list with sticky top header. Each notification item shows actor avatar, action description, timestamp, target post/comment preview. Unread notifications have accent border. Empty state if no notifications. Mark as read on view. Components: StickyHeader with 'Mark all read' action, NotificationList, NotificationItem with avatar, description, timestamp, preview, EmptyNotificationsState. Logic: Fetch notifications for current user ordered by createdAt DESC | Group by date (Today, Yesterday, This Week, Older) | Show actor displayName, action type (commented on, replied to, mentioned you in, reacted to), target post title or comment preview | Mark notification as read when viewed (update read=true) | Click notification to navigate to target post or comment | Polling or real-time updates to show new notifications without refresh\n- /settings: Centered card (max-width 600px) with sections stacked vertically. Avatar upload with current avatar preview. Display name input. Email (read-only). Account created date (read-only). Save button at bottom. Components: SettingsCard, AvatarUpload with preview, DisplayNameInput, ReadOnlyEmailField. Logic: Fetch current user data | Upload avatar to R2, get presigned URL | Validate displayName not empty | On save: update User record (displayName, avatarUrl) | Show success toast after save\n\n## Non-negotiable Rules\n- First user self-registers and becomes OWNER, all subsequent registrations require valid invite token and create MEMBER role\n- Admin routes (/admin/*) require role ADMIN or OWNER, redirect to / if unauthorized\n- Deactivated users redirected to /deactivated on any protected route access\n- Users cannot deactivate themselves, only admins can deactivate other users\n- At least one OWNER or ADMIN must exist in system at all times (prevent demoting last OWNER)\n- Post edit and delete actions only visible to post author\n- Comment edit and delete actions only visible to comment author\n- Project edit action only visible to project creator and members\n- Comment threading limited to 2 levels: can reply to top-level comment but not to reply\n- Notifications not sent if actor is the target entity author (e.g., user cannot notify themselves by commenting on own post)\n\n## Build Order\n1. 1. Initialize Next.js project with TypeScript, Tailwind CSS, ESLint: npx create-next-app@latest --typescript --tailwind --eslint\n2. 2. Install dependencies: npm install prisma @prisma/client next-auth bcryptjs @lexical/react lexical @aws-sdk/client-s3 @aws-sdk/s3-request-presigner zod react-hook-form\n3. 3. Install dev dependencies: npm install -D @types/bcryptjs @types/node tsx\n4. 4. Initialize Prisma: npx prisma init --datasource-provider postgresql\n5. 5. Define Prisma schema in prisma/schema.prisma with all models (User, Post, Attachment, Project, ProjectMember, ProjectUrl, Comment, Reaction, Notification, CustomEmoji, SiteSettings, Draft, PasswordResetToken) and relations\n6. 6. Create initial migration: npx prisma migrate dev --name init\n7. 7. Create lib/prisma.ts with PrismaClient singleton for connection pooling\n8. 8. Configure NextAuth in app/api/auth/[...nextauth]/route.ts with credentials provider, JWT session, password verification with bcrypt\n9. 9. Create lib/auth.ts with getServerSession helper and role check utilities\n10. 10. Configure Cloudflare R2 client in lib/r2.ts with S3Client and presigned URL generation\n11. 11. Create seed script prisma/seed.ts to initialize SiteSettings record with id='default', generate random inviteToken\n12. 12. Run seed: npx prisma db seed\n13. 13. Install shadcn/ui CLI: npx shadcn-ui@latest init, configure with Tailwind and component path\n14. 14. Add shadcn components: npx shadcn-ui@latest add button input card avatar badge dialog sheet dropdown-menu toast\n15. 15. Create design system tokens in tailwind.config.ts extending theme with custom colors (primary #1A1918, secondary #F5F4F2), radius scale (xs 2px, sm 4px, md 6px, lg 8px, xl 12px), font families\n16. 16. Build Lexical editor component in components/lexical/LexicalEditor.tsx with RichTextPlugin, AutoFocusPlugin, MentionPlugin, MarkdownShortcutPlugin, DragDropPastePlugin\n17. 17. Build Lexical renderer in components/lexical/LexicalRenderer.tsx to convert JSON state to HTML\n18. 18. Create API route app/api/posts/route.ts for GET (list with pagination) and POST (create with transaction)\n19. 19. Create API route app/api/posts/[id]/route.ts for GET (detail), PATCH (update), DELETE (with author check)\n20. 20. Create API route app/api/comments/route.ts for POST (create with notification logic)\n21. 21. Create API route app/api/comments/[id]/route.ts for PATCH (update), DELETE (with author check)\n22. 22. Create API route app/api/reactions/route.ts for POST (upsert with unique constraint, notification)\n23. 23. Create API route app/api/projects/route.ts for GET (list), POST (create with transaction)\n24. 24. Create API route app/api/projects/[id]/route.ts for GET (detail), PATCH (update with sync logic), DELETE\n25. 25. Create API route app/api/notifications/route.ts for GET (list with pagination), PATCH (mark read)\n26. 26. Create API route app/api/users/route.ts for GET (admin only, all users), PATCH (update user with role/deactivation checks)\n27. 27. Create API route app/api/admin/settings/route.ts for GET/PATCH (admin only, SiteSettings)\n28. 28. Create API route app/api/admin/invite-token/route.ts for POST (regenerate token)\n29. 29. Create API route app/api/upload/presigned-url/route.ts for POST (generate R2 presigned URL with validation)\n30. 30. Create API route app/api/webhooks/notify/route.ts for POST (send Discord/Slack webhook with post data)\n31. 31. Create lib/notifications.ts with helper functions to create COMMENT, COMMENT_REPLY, REACTION_POST, REACTION_COMMENT, MENTION notifications with exclusion logic\n32. 32. Create lib/mentions.ts with function to extract @mentions from Lexical JSON state and validate against User table\n33. 33. Create lib/webhooks.ts with functions to format and send Discord/Slack webhook payloads\n34. 34. Create lib/validations.ts with Zod schemas for API request validation\n35. 35. Build home page app/page.tsx with feed, view toggle (list/grid), infinite scroll using IntersectionObserver\n36. 36. Build compose page app/compose/page.tsx with LexicalEditor, attachment upload zone, project multi-select, hideFromHome checkbox, auto-save draft logic\n37. 37. Build post detail page app/post/[id]/page.tsx with content render, attachment carousel, comment thread, reaction bar\n38. 38. Build post edit page app/post/[id]/edit/page.tsx with same editor as compose, pre-populated with existing data\n39. 39. Build projects list page app/projects/page.tsx with grid layout, project cards with cover/name/stats\n40. 40. Build new project page app/projects/new/page.tsx with form for name/description/cover/members/URLs\n41. 41. Build project detail page app/projects/[id]/page.tsx with tabs (Posts, Members, URLs), filtered feed for Posts tab\n42. 42. Build project edit page app/projects/[id]/edit/page.tsx with same form as new, pre-populated\n43. 43. Build notifications page app/notifications/page.tsx with list grouped by date, mark read on view\n44. 44. Build settings page app/settings/page.tsx with avatar upload, displayName input, account metadata\n45. 45. Build admin users page app/admin/users/page.tsx with table, role dropdown, deactivate toggle, floating action menu with invite link dialog\n46. 46. Build admin settings page app/admin/settings/page.tsx with sections for site name, webhook URLs, custom emoji upload/list\n47. 47. Build invite registration page app/invite/[token]/page.tsx with form, token validation, first user becomes OWNER logic\n48. 48. Build password reset page app/reset-password/[token]/page.tsx with form, token validation, password update\n49. 49. Build deactivated page app/deactivated/page.tsx with static message and sign-out link\n50. 50. Build root layout app/layout.tsx with NextAuthProvider, theme provider (light/dark mode), command palette wrapper\n51. 51. Create components/CommandPalette.tsx with search input, results list (posts/projects/users), keyboard navigation\n52. 52. Create components/PostCard.tsx with author info, content preview, attachment previews, reaction counts, click to detail\n53. 53. Create components/PostGridItem.tsx with compact layout, cover image, title, hover overlay\n54. 54. Create components/AttachmentCarousel.tsx with image viewer, video player, file download, navigation arrows, coordinate comment overlay\n55. 55. Create components/CommentThread.tsx with nested structure (max 2 levels), reply button, edit/delete actions\n56. 56. Create components/ReactionBar.tsx with emoji picker (built-in + custom), reaction counts, reactors dialog\n57. 57. Create components/NotificationItem.tsx with actor avatar, action description, timestamp, target preview, unread indicator\n58. 58. Create components/FloatingActionMenu.tsx with fixed bottom-right position, elevated surface, quick actions\n59. 59. Create middleware.ts to check auth status, redirect deactivated users to /deactivated, protect admin routes\n60. 60. Add environment variables to .env: DATABASE_URL, NEXTAUTH_SECRET, NEXTAUTH_URL, R2_ACCOUNT_ID, R2_ACCESS_KEY_ID, R2_SECRET_ACCESS_KEY, R2_BUCKET_NAME\n61. 61. Configure next.config.js with images domains for R2 URLs, experimental features if needed\n62. 62. Create public/manifest.json for PWA with name, icons, theme color, start URL\n63. 63. Add service worker registration in app/layout.tsx for PWA offline support\n64. 64. Write unit tests with Vitest for lib helpers (notifications, mentions, webhooks)\n65. 65. Write integration tests with Testing Library for key flows (post creation, comment threading, reactions)\n66. 66. Run type checking: npx tsc --noEmit\n67. 67. Run linting: npm run lint\n68. 68. Run tests: npm run test\n69. 69. Build production bundle: npm run build\n70. 70. Deploy to Vercel or similar platform with environment variables configured\n\n## Test Gates\n- User registration: First user receives OWNER role, subsequent users with valid invite token receive MEMBER role, invalid token shows error\n- Authentication: Sign in with valid credentials succeeds, invalid credentials show error, deactivated users redirect to /deactivated\n- Post creation: Valid post with content saves successfully, attachments upload to R2 and store metadata, projects assigned via junction table, webhook fires if configured, mentions send notifications\n- Post editing: Only post author can edit, updates save correctly, new attachments add with incremented order, removed attachments delete from R2\n- Comment threading: Top-level comments save with postId, replies save with parentId, replies to replies blocked (max 2 levels), notifications sent to parent author and mentioned users\n- Reactions: Clicking reaction adds record with unique constraint, clicking again removes, notification sent to entity author, reaction counts display correctly\n- Notifications: Created on comment/reply/mention/reaction, excluded if actor is entity author, marked as read when viewing, displayed in chronological order\n- Projects: Created with name/description/cover/members/URLs, project feed filters posts correctly, edit syncs members and URLs, delete cascades to junction tables\n- File uploads: Presigned URL generated for R2, client uploads directly, metadata saved with type/size/mime, presigned URLs for private access\n- Search: Command palette opens on Cmd+K, searches posts/projects/users, navigates to result on Enter, closes on Esc\n- Admin users: Role changes update correctly, cannot demote last OWNER, cannot deactivate self, deactivated users cannot access main routes\n- Admin settings: Site name updates, webhook URLs validate HTTPS, custom emoji uploads to R2 and saves record\n- Password reset: Token generated with 24-hour expiration, valid token allows password update, used token invalid, expired token invalid\n- Drafts: Content auto-saves every 2 seconds, loads on compose page visit, clears after publish\n- Feed: Posts display in reverse chronological order, infinite scroll loads next page, hideFromHome flag filters correctly\n- View modes: List and grid views toggle correctly, preference persists across sessions\n- Responsive: All pages render correctly on mobile/tablet/desktop, floating action menu visible on mobile, secondary rail hidden on small screens\n```"
  },
  "stages": [
    {
      "id": "fetch",
      "label": "Fetch repository",
      "status": "done",
      "startedAt": "2026-02-06T14:19:53.956Z",
      "finishedAt": "2026-02-06T14:19:55.039Z"
    },
    {
      "id": "ingest",
      "label": "Ingest workspace",
      "status": "done",
      "startedAt": "2026-02-06T14:19:55.039Z",
      "finishedAt": "2026-02-06T14:19:55.612Z"
    },
    {
      "id": "stack",
      "label": "Stack detection",
      "status": "done",
      "startedAt": "2026-02-06T14:19:55.612Z",
      "finishedAt": "2026-02-06T14:19:55.613Z"
    },
    {
      "id": "arch",
      "label": "Architecture extraction",
      "status": "done",
      "startedAt": "2026-02-06T14:19:55.613Z",
      "finishedAt": "2026-02-06T14:20:41.486Z"
    },
    {
      "id": "intent",
      "label": "Intent extraction",
      "status": "done",
      "startedAt": "2026-02-06T14:20:41.486Z",
      "finishedAt": "2026-02-06T14:22:31.403Z"
    },
    {
      "id": "plan",
      "label": "Plan compilation",
      "status": "done",
      "startedAt": "2026-02-06T14:22:31.403Z",
      "finishedAt": "2026-02-06T14:27:00.039Z"
    }
  ]
}